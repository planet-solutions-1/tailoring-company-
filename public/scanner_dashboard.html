<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner | School Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }

        .scan-overlay {
            width: 250px;
            height: 250px;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 24px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body class="bg-slate-900 h-screen flex flex-col items-center justify-center p-4">

    <!-- Auth Guard Removed for Public Access -->

    <!-- Main Card -->
    <div
        class="bg-white w-full max-w-md rounded-3xl overflow-hidden shadow-2xl relative animate-in fade-in zoom-in-95 duration-300">

        <!-- Header -->
        <div class="p-6 text-center border-b border-slate-100 bg-slate-50/50">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight font-brand">Scan Filter QR</h1>
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-1">Point Camera at Code</p>
        </div>

        <!-- Scanner Viewport -->
        <div class="relative bg-black h-[400px]">
            <div id="reader" style="width: 100%; height: 100%;"></div>
            <!-- CSS Overlay is handled by html5-qrcode natively usually, but we can style it -->
        </div>

        <!-- Status & Actions -->
        <div class="p-6 text-center space-y-4">
            <p id="statusMsg" class="text-sm font-bold text-slate-500 animate-pulse">Initializing Camera...</p>

            <button onclick="window.location.href='index.html'"
                class="w-full py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-sm transition-colors border border-slate-200">
                Admin Login
            </button>
        </div>
    </div>

    <script>
        const html5QrCode = new Html5Qrcode("reader");
        const statusEl = document.getElementById('statusMsg');

        const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 } };

        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`Code matched = ${decodedText}`, decodedResult);

            try {
                // Check if it's our JSON format
                const data = JSON.parse(decodedText);

                if (data.f) {
                    // Valid Filter QR
                    html5QrCode.stop().then(() => {
                        statusEl.innerText = "âœ… QR Verified! Redirecting...";
                        statusEl.className = "text-sm font-bold text-emerald-600";

                        // Deep Link Redirect
                        // Encode the JSON back to a clean string
                        const filterParam = encodeURIComponent(decodedText);
                        setTimeout(() => {
                            window.location.href = `student_view.html?filters=${filterParam}`;
                        }, 500);
                    });
                } else {
                    statusEl.innerText = "âš ï¸ Invalid QR Format";
                    statusEl.className = "text-sm font-bold text-amber-500";
                }
            } catch (e) {
                // Not a JSON QR
                statusEl.innerText = "âš ï¸ Not a Dashboard Filter QR";
                statusEl.className = "text-sm font-bold text-rose-500";
            }
        };

        const onScanFailure = (error) => {
            // handle scan failure, usually better to ignore and keep scanning.
        };

        // Start
        html5QrCode.start({ facingMode: "environment" }, qrConfig, onScanSuccess, onScanFailure)
            .then(() => {
                statusEl.innerText = "Scanning...";
                statusEl.className = "text-sm font-bold text-slate-500 animate-pulse";
            })
            .catch(err => {
                statusEl.innerText = "ðŸš« Camera Error: " + err;
                statusEl.className = "text-sm font-bold text-rose-600";
            });
    </script>
</body>

</html>