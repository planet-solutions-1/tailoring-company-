<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tailoring Data Center | Planet Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #1c1917;
            --rice-paper: #fafaf9;
            --seal-red: #be123c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--rice-paper);
            color: #44403c;
        }

        .font-ink {
            font-family: 'Noto Serif JP', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="company_dashboard.html"
                    class="text-stone-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-wider">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Admin
                </a>
                <div class="h-6 w-px bg-stone-700"></div>
                <h1 class="font-ink text-xl flex items-center gap-2"><span class="text-rose-600 text-2xl">●</span>
                    Tailoring Data Center</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadPDF()"
                    class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Download PDF
                </button>
                <button onclick="openLogs()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Logs
                </button>
                <button onclick="downloadExcel()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="8" x2="8" y2="8"></line>
                        <line x1="16" y1="16" x2="8" y2="16"></line>
                        <line x1="10" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Download Excel
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 max-w-[1920px] mx-auto w-full space-y-4">

        <!-- Filters -->
        <div class="glass-panel p-4 rounded-xl flex flex-wrap gap-4 items-end sticky top-20 z-40">
            <!-- School -->
            <div class="w-full sm:w-auto">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">School</label>
                <select id="f-school" onchange="renderTable()"
                    class="w-full sm:w-48 border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm">
                    <option value="all">All Schools</option>
                </select>
            </div>

            <!-- Pattern -->
            <div class="w-full sm:w-auto">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Pattern</label>
                <select id="f-pattern" onchange="renderTable()"
                    class="w-full sm:w-48 border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm">
                    <option value="all">All Patterns</option>
                </select>
            </div>

            <!-- Item Type (CRITICAL) -->
            <div class="w-full sm:w-auto flex-1">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Measurement Type (Item)</label>
                <select id="f-item" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm font-medium text-stone-700 bg-amber-50/50">
                    <option value="all">-- Select Item to View Measurements --</option>
                </select>
            </div>

            <!-- Meta Filters -->
            <div class="w-[30%] sm:w-24">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Class</label>
                <input type="text" id="f-class" onkeyup="renderTable()" placeholder="All"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
            </div>
            <div class="w-[30%] sm:w-24">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Gender</label>
                <select id="f-gender" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
                    <option value="all">All</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="w-[30%] sm:w-32">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Status</label>
                <select id="f-packed" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="packed">Packed</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div
            class="glass-panel rounded-xl overflow-hidden shadow-xl border border-stone-200 flex-1 min-h-[500px] flex flex-col">
            <div class="overflow-auto flex-1 h-full">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-stone-50 text-stone-500 uppercase text-xs sticky top-0 z-20 shadow-sm" id="thead">
                        <!-- JS injected -->
                    </thead>
                    <tbody id="tbody" class="divide-y divide-stone-100 bg-white text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t bg-stone-50 text-right text-xs text-stone-500 font-mono" id="row-count">Loading...
            </div>
        </div>

    </main>

    <!-- Qty Modal -->
    <div id="qty-modal"
        class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-stone-900 text-white px-4 py-3 flex justify-between items-center">
                <h3 class="font-bold">Quantity: <span id="qty-student-name" class="font-mono text-amber-400"></span>
                </h3>
                <button onclick="closeQtyModal()" class="text-stone-400 hover:text-white">&times;</button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto" id="qty-list">
                <!-- Inputs injected here -->
            </div>
            <div class="p-4 bg-gray-50 flex justify-end gap-2 border-t">
                <button onclick="closeQtyModal()"
                    class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded text-sm text-gray-700">Cancel</button>
                <button onclick="saveQty()"
                    class="px-3 py-1 bg-rose-600 hover:bg-rose-700 text-white rounded text-sm font-bold shadow">Save
                    Quantities</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'login.html';

        // --- DATA ---
        let allStudents = [];
        let patterns = [];
        let schools = [];

        // --- CONFIG ---
        const boysItems = [{ name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" }];
        const girlsItems = [{ name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" }, { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" }, { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" }, { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }];
        const allItems = [...boysItems, ...girlsItems];

        // List of items for Quantity Modal (Derived usually, but hardcoded for now)
        const qtyItems = [
            "Shirt (Formal)", "Track Tshirt", "Uniform Tshirt", "Jerkin", "Pullover",
            "Pant (Formal)", "Track Pant", "Shorts (Formal)", "Track Shorts",
            "Skirt", "Pinafore", "Kurtha", "Frock"
        ];

        // --- INIT ---
        async function init() {
            const itemSel = document.getElementById('f-item');
            allItems.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.name;
                opt.text = i.name;
                itemSel.appendChild(opt);
            });

            await Promise.all([
                fetchData(),
                fetchPatterns(),
                fetchSchools()
            ]);

            renderTable();
        }
        init();

        async function fetchData() {
            try {
                // Determine fetch URL based on User Role (stored in token or session)
                // For simplicity, we try to get user info from 'sessionStorage' if available,
                // or we can decode the token. Assuming 'user' object might be saved.

                let user = null;
                try { user = JSON.parse(sessionStorage.getItem('user')); } catch (e) { }

                let url = `${API_BASE}/data/all_students`; // Default for Company

                if (user && user.role !== 'company' && user.school_id) {
                    url = `${API_BASE}/data/students/${user.school_id}`;
                }

                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

                if (res.status === 403) {
                    // Fallback/Retry logic or just alert
                    console.error("Access denied to all_students, trying specific school if known...");
                    // If we are here, it means we might be a tailor who tried all_students. 
                    // Ideally we catch this earlier.
                }

                if (!res.ok) throw new Error("Failed to load students");
                allStudents = await res.json();
            } catch (e) {
                console.error(e);
                alert("Error loading data: " + e.message);
            }
        }

        async function fetchPatterns() {
            try {
                const res = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                patterns = await res.json();
                const sel = document.getElementById('f-pattern');
                patterns.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.name} (${p.school_name})`;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchSchools() {
            try {
                const res = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                schools = await res.json();
                const sel = document.getElementById('f-school');
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        // --- RENDER ---
        function renderTable() {
            const fSchool = document.getElementById('f-school').value;
            const fPattern = document.getElementById('f-pattern').value;
            const fItem = document.getElementById('f-item').value;
            const fClass = document.getElementById('f-class').value.toLowerCase();
            const fGender = document.getElementById('f-gender').value;
            const fPacked = document.getElementById('f-packed').value;

            // 1. FILTER
            const data = allStudents.filter(s => {
                if (fSchool !== 'all' && s.school_id != fSchool) return false;
                if (fPattern !== 'all' && s.pattern_id != fPattern) return false;
                if (fGender !== 'all' && s.gender !== fGender) return false;
                if (fPacked === 'packed' && !s.is_packed) return false;
                if (fPacked === 'pending' && s.is_packed) return false;
                if (fClass && !(s.class || '').toLowerCase().includes(fClass)) return false;
                if (s.pattern_id) return false; // Hide if already patterned
                if (fItem !== 'all') {
                    const def = allItems.find(x => x.name === fItem);
                    if (def && s.gender && def.type && s.gender !== def.type) return false;
                }
                return true;
            });

            // 2. SETUP COLUMNS
            let cols = [];
            if (fItem !== 'all') {
                const def = allItems.find(x => x.name === fItem);
                if (def) cols = def.cols;
            }

            let headers = ['No.', 'School', 'Name', 'Class', 'Att.', 'Qty'];
            // If item selected, add measurement cols
            if (cols.length > 0) headers.push(...cols);
            else headers.push("Measurements");
            headers.push("Status");

            const thead = document.getElementById('thead');
            thead.innerHTML = `<tr>${headers.map(h => `<th class="px-4 py-3 text-left text-xs font-bold text-stone-500 uppercase tracking-wider border-b bg-stone-50">${h}</th>`).join('')}</tr>`;

            const tbody = document.getElementById('tbody');
            tbody.innerHTML = '';

            data.forEach((student, idx) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors border-b border-stone-100";

                const m = getMeasurementsSafe(student);
                const isAbsent = student.is_absent === 1;
                const qtys = student.item_quantities || {};
                const qtyCount = countQtys(qtys);

                // 1. Basic Info
                let html = `
                    <td class="px-4 py-3 whitespace-nowrap text-xs text-mono text-stone-400 font-bold">${idx + 1}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-stone-700">${student.school_name}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-bold text-stone-800">${student.name} <div class="text-[10px] font-mono font-normal text-stone-400">Roll: ${student.roll_no || '-'}</div></td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-stone-500">${student.class || '-'} (${student.gender?.[0] || '?'})</td>
                `;

                // 2. Attendance Toggle
                // Using a nicer toggle
                html += `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" class="sr-only peer" onchange="toggleAttendance(${student.id}, this)" ${!isAbsent ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-stone-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-600"></div>
                            <span class="ml-2 text-xs font-bold ${isAbsent ? 'text-rose-600' : 'text-emerald-700'}">${isAbsent ? 'ABS' : 'PRE'}</span>
                        </label>
                    </td>
                `;

                // 3. Qty Button
                html += `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <button onclick="openQtyModal(${student.id}, '${student.name.replace(/'/g, "")}')" 
                            class="text-xs px-2 py-1 rounded border font-bold transition-all ${qtyCount > 0 ? 'bg-amber-100 text-amber-800 border-amber-300 shadow-sm' : 'text-stone-400 border-stone-200 hover:border-stone-400 bg-white'}">
                            ${qtyCount > 0 ? qtyCount + ' Items' : '+ Add'}
                        </button>
                    </td>
                `;

                // 4. Measurements
                const disabled = isAbsent ? 'disabled style="background-color:#f5f5f4; color:#a8a29e;"' : 'style="background-color:#fffbeb;"';

                if (cols.length > 0) {
                    cols.forEach(col => {
                        const val = m[col.toLowerCase()] || '';
                        html += `<td class="px-4 py-3 whitespace-nowrap">
                            <input type="text" value="${val}" ${disabled}
                                class="w-12 p-2 text-center border border-stone-200 rounded focus:ring-1 focus:ring-rose-500 font-mono font-bold text-stone-900"
                                onchange="updateMeasurement(${student.id}, '${col.toLowerCase()}', this.value)"
                            >
                        </td>`;
                    });
                } else {
                    html += `<td class="px-4 py-3 text-xs text-stone-400 italic">Select Item Type from Filters</td>`;
                }

                // 5. Status
                const statusColor = student.is_packed ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700';
                html += `<td class="px-4 py-3 whitespace-nowrap"><span class="px-2 py-1 inline-flex text-[10px] font-bold uppercase rounded-full ${statusColor}">${student.is_packed ? 'Packed' : 'Pending'}</span></td>`;

                tr.innerHTML = html;
                tbody.appendChild(tr);
            });

            document.getElementById('row-count').innerText = `Showing ${data.length} Records`;
            window.filteredData = data;
            window.currentCols = cols;
        }

        // --- LOGIC ---

        function countQtys(q) {
            if (!q) return 0;
            let sum = 0;
            Object.values(q).forEach(v => sum += v);
            return sum;
        }

        async function toggleAttendance(id, checkbox) {
            const isPresent = checkbox.checked;
            const isAbsent = !isPresent;

            // Updates
            const row = checkbox.closest('tr');
            const inputs = row.querySelectorAll('input[type="text"]');
            const label = checkbox.parentElement.querySelector('span');

            label.innerText = isAbsent ? 'ABS' : 'PRE';
            label.className = `ml-2 text-xs font-bold ${isAbsent ? 'text-rose-600' : 'text-emerald-700'}`;

            inputs.forEach(inp => {
                inp.disabled = isAbsent;
                if (isAbsent) {
                    inp.style.backgroundColor = '#f5f5f4';
                    inp.style.color = '#a8a29e';
                } else {
                    inp.style.backgroundColor = '#fffbeb';
                    inp.style.color = '#1c1917';
                }
            });

            await saveStudentData(id, { is_absent: isAbsent ? 1 : 0 });

            // Update local model
            const s = allStudents.find(x => x.id === id);
            if (s) s.is_absent = isAbsent ? 1 : 0;
        }

        let currentQtyStudentId = null;

        function openQtyModal(id, name) {
            currentQtyStudentId = id;
            document.getElementById('qty-student-name').innerText = name;
            document.getElementById('qty-modal').classList.remove('hidden');

            const s = allStudents.find(x => x.id === id);
            const qtys = s?.item_quantities || {};

            let html = '';
            qtyItems.forEach(item => {
                const val = qtys[item] || '';
                html += `
                    <div class="flex items-center justify-between p-3 border-b hover:bg-stone-50">
                        <span class="text-sm font-medium text-stone-700">${item}</span>
                        <input type="number" class="w-16 p-1 border rounded text-center font-bold" min="0" placeholder="0" value="${val}" id="qty-input-${item.replace(/\s/g, '-')}">
                    </div>
                `;
            });
            document.getElementById('qty-list').innerHTML = html;
        }

        async function saveQty() {
            if (!currentQtyStudentId) return;

            const newQtys = {};
            let hasData = false;

            qtyItems.forEach(item => {
                const id = `qty-input-${item.replace(/\s/g, '-')}`;
                const val = document.getElementById(id).value;
                if (val && parseInt(val) > 0) {
                    newQtys[item] = parseInt(val);
                    hasData = true;
                }
            });

            // Verify
            await saveStudentData(currentQtyStudentId, { item_quantities: hasData ? newQtys : null });

            // Update Local
            const s = allStudents.find(x => x.id === currentQtyStudentId);
            if (s) s.item_quantities = hasData ? newQtys : null;

            closeQtyModal();
            renderTable(); // Refresh button count
        }

        function closeQtyModal() {
            document.getElementById('qty-modal').classList.add('hidden');
            currentQtyStudentId = null;
        }

        // Generic Save
        async function saveStudentData(id, payload) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;

            // Merge with existing state from `s` to ensure we don't nullify other fields
            // Backend expects: student_id, data, remarks, is_absent, item_quantities
            // If we send null for `data`, it fails.

            const finalPayload = {
                student_id: id,
                data: s.measurements ? (typeof s.measurements === 'string' ? JSON.parse(s.measurements) : s.measurements) : {},
                remarks: s.remarks,
                is_absent: s.is_absent,
                item_quantities: s.item_quantities
            };

            // Override with new payload
            Object.assign(finalPayload, payload);

            try {
                const res = await fetch(`${API_BASE}/data/measurements`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(finalPayload)
                });
                if (!res.ok) throw new Error("Save error");
            } catch (e) { console.error(e); }
        }

        async function updateMeasurement(id, key, value) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;

            let m = getMeasurementsSafe(s);
            m[key] = value;
            s.measurements = m; // Update local

            await saveStudentData(id, { data: m });
        }

        function getMeasurementsSafe(s) {
            if (typeof s.measurements === 'string') { try { return JSON.parse(s.measurements); } catch (e) { return {}; } }
            return s.measurements || {};
        }

        // --- EXPORT ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];
            const item = document.getElementById('f-item').value;
            const timestamp = new Date().toLocaleString();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Tailoring Production Data", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${timestamp} | Filter: ${item}`, 14, 22);

            let headers = ['School', 'Name', 'Class', 'Att.', 'Quantities'];
            if (cols.length > 0) headers.push(...cols);
            else headers.push("Measurements");
            headers.push("Status");

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const isAbsent = s.is_absent === 1;
                const qtyStr = s.item_quantities ? Object.entries(s.item_quantities).map(([k, v]) => `${k}:${v}`).join(', ') : '-';

                const row = [
                    s.school_name,
                    s.name,
                    `${s.class || ''} (${s.gender?.[0] || '?'})`,
                    isAbsent ? 'ABSENT' : 'Present',
                    qtyStr
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push('Select Item...');
                }

                row.push(s.is_packed ? 'Packed' : 'Pending');
                return row;
            });

            doc.autoTable({
                head: [headers],
                body: body,
                startY: 28,
                theme: 'grid',
                headStyles: { fillColor: [60, 60, 60], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 }
            });

            doc.save("Tailoring_Report.pdf");
        }

        function downloadExcel() {
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];

            const exportData = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = {
                    "School": s.school_name,
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Attendance": s.is_absent === 1 ? 'ABSENT' : 'Present',
                    "Quantities": s.item_quantities ? Object.entries(s.item_quantities).map(([k, v]) => `${k}:${v}`).join(', ') : '',
                    "Status": s.is_packed ? "Packed" : "Pending"
                };

                if (cols.length > 0) {
                    cols.forEach(k => row[k] = m[k.toLowerCase()] || '');
                } else {
                    row["Measurements"] = "Select Item to View";
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "TailoringData");
            XLSX.writeFile(wb, "Tailoring_Production_Data.xlsx");
        }

    </script>

    <!-- LOGS MODAL -->
    <div id="logs-modal"
        class="fixed inset-0 bg-black/50 hidden z-[70] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col overflow-hidden">
            <div class="p-4 bg-stone-900 text-white flex justify-between items-center">
                <h3 class="font-brand font-bold text-lg">My Activity Logs</h3>
                <button onclick="document.getElementById('logs-modal').classList.add('hidden')"
                    class="text-stone-400 hover:text-white">✕</button>
            </div>
            <div class="p-4 border-b flex justify-between bg-stone-50">
                <p class="text-xs text-stone-500 font-bold uppercase tracking-wider mt-2">Retention: 7 Days</p>
                <div class="flex gap-2">
                    <button onclick="fetchUserLogs()"
                        class="px-3 py-1 bg-white border rounded text-xs font-bold hover:bg-stone-50">Refresh</button>

                </div>
            </div>
            <div class="flex-1 overflow-auto p-4">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-stone-100 border-b border-stone-200">
                            <th class="p-3 text-xs font-bold text-stone-500 uppercase">Time</th>
                            <th class="p-3 text-xs font-bold text-stone-500 uppercase">Action</th>
                            <th class="p-3 text-xs font-bold text-stone-500 uppercase">Details</th>
                        </tr>
                    </thead>
                    <tbody id="userLogsBody" class="divide-y divide-stone-100">
                        <tr>
                            <td colspan="3" class="p-8 text-center text-stone-400">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // LOGS LOGIC
        function openLogs() {
            document.getElementById('logs-modal').classList.remove('hidden');
            fetchUserLogs();
        }

        async function fetchUserLogs() {
            const tbody = document.getElementById('userLogsBody');
            tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-stone-400">Loading...</td></tr>';
            try {
                const res = await fetch(`${API_BASE}/data/logs?days=7`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();
                if (res.ok && Array.isArray(data)) {
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-stone-400">No logs found.</td></tr>';
                    } else {
                        tbody.innerHTML = data.map(l => `
                            <tr>
                                <td class="p-3 text-xs font-mono text-stone-500">${new Date(l.created_at).toLocaleString()}</td>
                                <td class="p-3 text-xs font-bold text-stone-700">${l.action}</td>
                                <td class="p-3 text-xs text-stone-600">${l.details}</td>
                            </tr>
                        `).join('');
                    }
                    window.currentUserLogs = data;
                } else {
                    tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-rose-500">Error loading logs.</td></tr>';
                }
            } catch (e) { tbody.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-rose-500">Connection Failed.</td></tr>'; }
        }

        function downloadUserLogs(fmt) {
            const data = window.currentUserLogs || [];
            if (data.length === 0) return alert("No data.");
            let csv = "Time,Action,Details\n";
            data.forEach(l => csv += `"${new Date(l.created_at).toLocaleString()}","${l.action}","${(l.details || '').replace(/"/g, '""')}"\n`);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'My_Logs.csv'; a.click();
        }
    </script>
    <script src="js/logger.js"></script>
    <script>
        window.addEventListener('load', () => {
            const u = sessionStorage.getItem('username');
            if (u && Logger) Logger.log('TAILOR_DASHBOARD_LOAD', `Loaded by ${u}`);
        });
    </script>
</body>

</html>