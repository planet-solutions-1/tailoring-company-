<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Planet Solutions</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Three.js & Vanilla Tilt -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.0/vanilla-tilt.min.js"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            /* Fallback */
            color: white;
            overflow: hidden;
            /* Prevent scroll */
        }

        /* 3D Glass Card */
        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 100px -20px rgba(99, 102, 241, 0.3) inset;
            /* Indigo Glow */
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        /* Input Group Animation */
        .input-group {
            position: relative;
        }

        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            color: white;
            outline: none;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            border-color: #6366f1;
            /* Indigo 500 */
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
            background: rgba(15, 23, 42, 0.8);
        }

        .input-label {
            position: absolute;
            left: 1.25rem;
            top: 1rem;
            font-size: 0.875rem;
            color: #94a3b8;
            /* Slate 400 */
            pointer-events: none;
            transition: all 0.3s ease;
            background: transparent;
            padding: 0 0.25rem;
        }

        /* Float Label Logic */
        .input-field:focus~.input-label,
        .input-field:not(:placeholder-shown)~.input-label {
            top: -0.6rem;
            left: 1rem;
            font-size: 0.75rem;
            color: #818cf8;
            /* Indigo 400 */
            background: #0f172a;
            font-weight: 600;
            border-radius: 4px;
        }

        /* Button Glow */
        .btn-3d {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.6);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-3d:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 20px 30px -10px rgba(99, 102, 241, 0.8);
        }

        .btn-3d:active {
            transform: translateY(1px) scale(0.98);
        }

        /* Loader */
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Floating Anim */
        .float-anim {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 relative">

    <!-- 3D Background Canvas -->
    <div id="canvas-container" class="absolute inset-0 z-0 bg-[#0f172a]"></div>

    <!-- Main Card -->
    <div class="glass-card w-full max-w-[420px] p-8 md:p-12 rounded-3xl relative z-10 float-anim" data-tilt
        data-tilt-max="5" data-tilt-speed="400" data-tilt-glare data-tilt-max-glare="0.2">

        <!-- Logo Area -->
        <div class="text-center mb-10 transform translate-z-20">
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-indigo-700 text-white mb-4 shadow-xl shadow-indigo-500/30">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="animate-pulse">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path>
                </svg>
            </div>
            <h1
                class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 tracking-tight">
                Planet Solutions</h1>
            <p class="text-indigo-300 text-xs mt-2 uppercase tracking-[0.2em] font-bold">Uniform Management System</p>
        </div>

        <!-- Form -->
        <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-6">

            <div class="input-group">
                <input type="text" id="username" required class="input-field" placeholder=" " autocomplete="off">
                <label for="username" class="input-label">USERNAME / ID</label>
            </div>

            <div class="input-group">
                <input type="password" id="password" required class="input-field" placeholder=" ">
                <label for="password" class="input-label">PASSWORD</label>
            </div>

            <button type="submit" id="loginBtn"
                class="btn-3d w-full text-white font-bold py-4 rounded-xl shadow-lg mt-4 flex justify-center items-center gap-3 uppercase tracking-wider text-sm">
                <span>Access Dashboard</span>
                <div id="btnLoader" class="loader hidden"></div>
            </button>
        </form>

        <!-- Error Message -->
        <div id="errorMessage"
            class="hidden mt-6 bg-rose-500/10 text-rose-300 text-sm px-4 py-3 rounded-xl border border-rose-500/20 flex items-center gap-3 animate-bounce">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span id="errorText" class="font-bold">Invalid credentials</span>
        </div>

        <!-- Footer -->
        <p class="mt-8 text-center text-slate-500 text-[10px] font-bold uppercase tracking-widest opacity-60">
            &copy; <span id="year">2026</span> Secure Enterprise System
        </p>
    </div>

    <!-- ORIGINAL JS LOGIC (PRESERVED) -->
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        async function handleLogin(e) {
            e.preventDefault();
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginBtn = document.getElementById('loginBtn');
            const btnLoader = document.getElementById('btnLoader');
            const btnText = loginBtn.querySelector('span');
            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            const username = usernameInput.value;
            const password = passwordInput.value;

            // Simple Client Side Validation
            if (!username.trim() || !password.trim()) {
                errorText.textContent = "Please enter both username and password.";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Reset State
            errorDiv.classList.add('hidden');
            loginBtn.disabled = true;
            btnText.textContent = "Verifying...";
            btnLoader.classList.remove('hidden');
            usernameInput.disabled = true;
            passwordInput.disabled = true;

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    // Success
                    sessionStorage.setItem('token', data.accessToken);
                    sessionStorage.setItem('role', data.role);
                    sessionStorage.setItem('schoolId', data.schoolId || '');

                    // Safe User Object Parsing
                    const safeUser = data.user || { username: username, school_name: '' };
                    sessionStorage.setItem('username', safeUser.username);
                    sessionStorage.setItem('schoolName', safeUser.school_name || '');

                    // Redirect Flow
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectUrl = urlParams.get('redirect');
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                        return;
                    }

                    // Robust Role Handling (Trimming is key)
                    const role = (data.role || '').trim().toLowerCase();
                    switch (role) {
                        case 'company':
                            window.location.href = '/company';
                            break;
                        case 'admin':
                            window.location.href = '/admin';
                            break;
                        case 'production_manager':
                            window.location.href = '/production';
                            break;
                        case 'school':
                            window.location.href = '/school';
                            break;
                        case 'tailor':
                            window.location.href = '/tailor';
                            break;
                        case 'packing':
                            window.location.href = '/packing';
                            break;
                        default:
                            throw new Error(`Unknown user role: ${data.role}`);
                    }
                } else {
                    throw new Error(data.error || "Login Failed");
                }

            } catch (err) {
                console.error("Login Error:", err);
                errorText.textContent = err.message;
                errorDiv.classList.remove('hidden');

                // Re-enable UI
                loginBtn.disabled = false;
                btnText.textContent = "Access Dashboard";
                btnLoader.classList.add('hidden');
                usernameInput.disabled = false;
                passwordInput.disabled = false;
            }
        }
    </script>
    <script src="js/logger.js"></script>

    <!-- NEW 3D BACKGROUND LOGIC (THREE.JS) -->
    <script>
        // Init 3D Scene
        const initThreeJS = () => {
            const container = document.getElementById('canvas-container');
            if (!container) return;

            const scene = new THREE.Scene();
            // Fog for depth
            scene.fog = new THREE.FogExp2(0x0f172a, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Particles
            const geometry = new THREE.BufferGeometry();
            const particlesCount = 1200;
            const posArray = new Float32Array(particlesCount * 3);

            for (let i = 0; i < particlesCount * 3; i++) {
                // Spread particles in a wide volume
                posArray[i] = (Math.random() - 0.5) * 150;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

            const material = new THREE.PointsMaterial({
                size: 0.25,
                color: 0x6366f1, // Indigo
                transparent: true,
                opacity: 0.8,
            });

            const particlesMesh = new THREE.Points(geometry, material);
            scene.add(particlesMesh);

            // Lines connecting particles (Mesh Network)
            // Too heavy for CPU to calculate all connections. 
            // Let's create a secondary Icosahedron wireframe for the "Tech Planet" feel.

            const planetGeo = new THREE.IcosahedronGeometry(15, 2);
            const planetMat = new THREE.MeshBasicMaterial({
                color: 0x6366f1,
                wireframe: true,
                transparent: true,
                opacity: 0.1
            });
            const planet = new THREE.Mesh(planetGeo, planetMat);
            scene.add(planet);

            // Interactive Mouse
            let mouseX = 0;
            let mouseY = 0;
            let targetX = 0;
            let targetY = 0;

            const windowHalfX = window.innerWidth / 2;
            const windowHalfY = window.innerHeight / 2;

            document.addEventListener('mousemove', (event) => {
                mouseX = (event.clientX - windowHalfX);
                mouseY = (event.clientY - windowHalfY);
            });

            // Animate
            const clock = new THREE.Clock();

            const animate = () => {
                requestAnimationFrame(animate);
                const elapsedTime = clock.getElapsedTime();

                targetX = mouseX * 0.001;
                targetY = mouseY * 0.001;

                // Rotate Planet
                planet.rotation.y += 0.002;
                planet.rotation.x += 0.001;

                // Move Particles - Wave Effect
                particlesMesh.rotation.y = -0.1 * elapsedTime;

                // Mouse Interaction
                particlesMesh.rotation.x += 0.05 * (targetY - particlesMesh.rotation.x);
                particlesMesh.rotation.y += 0.05 * (targetX - particlesMesh.rotation.y);

                renderer.render(scene, camera);
            };

            animate();

            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        // Initialize only if WebGL available
        window.addEventListener('load', initThreeJS);
    </script>
</body>

</html>