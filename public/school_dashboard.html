<!-- SCHOOL DASHBOARD v4 (Fixed Delete & 404s) -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Command Center | Premium Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'seal-red': '#be123c',
                        'ink-black': '#1c1917',
                        'rice-paper': '#fafaf9',
                        'gold-accent': '#b45309',
                        'indigo-ink': '#312e81',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Claymorphism Palette */
            --bg-body: #FDF4FF;
            /* Very soft pink/purple pastel */
            --bg-card: #FFFFFF;
            /* White clay */
            --text-heading: #4A4A68;
            /* Soft Indigo-Grey */
            --text-body: #8D8D9D;
            /* Softer Grey */

            --clay-shadow-out: 10px 10px 20px rgba(170, 170, 204, 0.4), -10px -10px 20px #FFFFFF;
            --clay-shadow-in: inset 5px 5px 10px rgba(170, 170, 204, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 1);

            --primary: #818CF8;
            /* Soft Indigo */
            --glass-border: transparent;
            /* No borders in clay */
        }

        body {
            font-family: 'Outfit', sans-serif;
            /* Rounder, friendlier font */
            background-color: var(--bg-body);
            color: var(--text-heading);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout Structure */
        .app-layout {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* CLAY CARD - The Star Show */
        .clay-card {
            background-color: var(--bg-card);
            border-radius: 32px;
            /* Super rounded */
            border: none;
            box-shadow: var(--clay-shadow-out);
            position: relative;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            /* Bouncy transition */
        }

        /* Inner lighting for volume */
        .clay-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 32px;
            box-shadow: var(--clay-shadow-in);
            pointer-events: none;
        }

        .clay-card:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 15px 15px 30px rgba(170, 170, 204, 0.4), -15px -15px 30px #FFFFFF;
        }

        /* Sidebar */
        .sidebar-clay {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
            height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 50;
        }

        /* Navigation Buttons - Floating Clay */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            margin: 0 12px 8px 12px;
            color: #64748b;
            /* slate-500 */
            border-radius: 16px;
            /* rounded-2xl */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            background-color: transparent;
        }

        .nav-item:hover {
            background: #fff;
            box-shadow: 5px 5px 10px rgba(170, 170, 204, 0.2), -5px -5px 10px #fff;
            color: var(--primary);
            transform: scale(1.02);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 6px 6px 12px rgba(129, 140, 248, 0.4), inset 2px 2px 4px rgba(255, 255, 255, 0.3), inset -2px -2px 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* Header */
        .header-clay {
            background: transparent;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            z-index: 40;
        }

        /* Typography */
        .font-brand {
            font-family: 'Outfit', sans-serif;
        }

        /* Stats Icons - Floating Circles */
        .stat-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 6px 6px 12px rgba(170, 170, 204, 0.3), -6px -6px 12px #fff;
        }

        /* Custom Scrollbar - Soft */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 20px;
            border: 2px solid var(--bg-body);
        }

        /* Dialog Override */
        dialog {
            background: transparent;
            border: none;
            padding: 0;
            max-width: 100vw;
            max-height: 100vh;
        }

        dialog::backdrop {
            background: rgba(253, 244, 255, 0.8);
            backdrop-filter: blur(8px);
        }

        /* Compact Mode Override */
        body.compact-mode table td,
        body.compact-mode table th {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
            font-size: 0.85rem;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden bg-[#FDF4FF] text-slate-600 font-brand">

    <!-- Mobile Backdrop -->
    <div id="sidebarBackdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity opacity-0"></div>

    <!-- Sidebar (Clay) -->
    <aside id="mainSidebar"
        class="w-72 sidebar-clay fixed inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 lg:static lg:flex transition-transform duration-300 pt-6 pb-6 pl-4 flex-col bg-white">
        <div class="px-6 py-4 flex items-center mb-6">
            <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-br from-indigo-400 to-indigo-600 flex items-center justify-center shrink-0 text-white font-bold text-2xl shadow-lg shadow-indigo-300 mr-4">
                S</div>
            <div>
                <h1 class="font-brand text-slate-700 text-xl font-extrabold tracking-tight">School<span
                        class="text-indigo-500">Admin</span></h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest pl-0.5">Clay Edition</p>
            </div>
        </div>

        <nav class="flex-1 py-6 space-y-2">
            <div onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span class="text-sm">Dashboard</span>
            </div>
            <div onclick="switchTab('students')" id="nav-students" class="nav-item mx-4">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span class="text-sm">Student Data</span>
            </div>
            <div onclick="switchTab('support')" id="nav-support" class="nav-item mx-4">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                    </path>
                </svg>
                <span class="text-sm">Support</span>
            </div>
            <div onclick="switchTab('settings')" id="nav-settings" class="nav-item mx-4">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                <span class="text-sm">Settings</span>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-200">
            <div class="bg-white/50 border border-white/60 p-3 rounded-2xl cursor-pointer hover:bg-white transition-all shadow-sm"
                onclick="logout()">
                <div class="flex items-center gap-3">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=random"
                        class="w-10 h-10 rounded-full shadow-md">
                    <div class="overflow-hidden">
                        <p class="text-xs font-bold text-slate-700 truncate" id="userSchoolName">Loading...</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wide">Log Out</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 h-full overflow-hidden flex flex-col relative w-full">
        <!-- Background Decor -->
        <div
            class="absolute top-0 right-0 w-96 h-96 bg-rose-200/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none">
        </div>

        <!-- Header -->
        <header class="header-clay shrink-0 flex items-center gap-4">
            <button onclick="toggleSidebar()"
                class="lg:hidden p-2 text-slate-500 hover:bg-slate-100 rounded-xl transition-colors">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="20" y2="12"></line>
                    <line x1="4" y1="18" x2="20" y2="18"></line>
                </svg>
            </button>
            <div>
                <h2 class="font-brand text-2xl md:text-3xl font-extrabold text-slate-700 tracking-tight" id="pageTitle">
                    Overview</h2>
                <p class="text-slate-400 text-sm font-medium mt-1 ml-1 hide-on-mobile">Welcome back, Admin ðŸ‘‹</p>
            </div>
        </header>

        <!-- Content Area -->
        <div class="flex-1 overflow-y-auto p-8 pt-4" id="mainContainer">
            <!-- Content Injected via JS -->
        </div>
    </main>

    <!-- VIEWS TEMPLATES -->

    <!-- 1. DASHBOARD VIEW -->
    <template id="view-dashboard">
        <div class="max-w-6xl mx-auto space-y-8">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 p-2">
                <!-- Total Students -->
                <div class="clay-card p-8 bg-gradient-to-br from-indigo-50 to-white">
                    <div class="flex justify-between items-start mb-6">
                        <div class="stat-icon-wrapper bg-indigo-50 text-indigo-500">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <span
                            class="text-xs font-bold text-white bg-green-400 px-3 py-1.5 rounded-full shadow-md shadow-green-200">+12%</span>
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-2">Total Students</p>
                        <h3 class="font-brand text-4xl font-black text-slate-700" id="dashTotal">--</h3>
                    </div>
                </div>

                <!-- Orders Pending -->
                <div class="clay-card p-8 bg-gradient-to-br from-amber-50 to-white">
                    <div class="flex justify-between items-start mb-6">
                        <div class="stat-icon-wrapper bg-amber-50 text-amber-500">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <span
                            class="text-xs font-bold text-white bg-amber-400 px-3 py-1.5 rounded-full shadow-md shadow-amber-200">Pending</span>
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-2">Orders Pending</p>
                        <h3 class="font-brand text-4xl font-black text-slate-700" id="dashPending">--</h3>
                    </div>
                </div>

                <!-- Completed -->
                <div class="clay-card p-8 bg-gradient-to-br from-emerald-50 to-white">
                    <div class="flex justify-between items-start mb-6">
                        <div class="stat-icon-wrapper bg-emerald-50 text-emerald-500">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                    </div>
                    <div>
                        <p class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-2">Completed</p>
                        <h3 class="font-brand text-4xl font-black text-slate-700" id="dashCompleted">--</h3>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-4">
                <div class="clay-card p-6 flex flex-col items-center justify-center bg-white/60">
                    <h3 class="font-brand text-lg font-bold text-slate-700 mb-4 w-full text-left">Gender Distribution
                    </h3>
                    <div class="h-64 w-full flex justify-center">
                        <canvas id="chartGender"></canvas>
                    </div>
                </div>
                <div class="clay-card p-6 flex flex-col items-center justify-center bg-white/60">
                    <h3 class="font-brand text-lg font-bold text-slate-700 mb-4 w-full text-left">House Distribution
                    </h3>
                    <div class="h-64 w-full flex justify-center">
                        <canvas id="chartHouse"></canvas>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-2 mt-4">
                <!-- Bulk Import -->
                <div class="clay-card p-8 flex items-center justify-between cursor-pointer group"
                    onclick="openImportModal()">
                    <div class="flex items-center gap-6">
                        <div
                            class="w-16 h-16 rounded-2xl bg-indigo-100 flex items-center justify-center text-indigo-500 shadow-inner">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2.5">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </div>
                        <div>
                            <h3
                                class="font-brand text-xl font-bold text-slate-700 group-hover:text-indigo-600 transition-colors">
                                Bulk Import</h3>
                            <p class="text-slate-400 text-sm font-medium">Excel / CSV Support</p>
                        </div>
                    </div>
                    <div
                        class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-indigo-500 group-hover:text-white transition-all shadow-sm">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Support -->
            <div class="clay-card p-8 flex items-center justify-between cursor-pointer group"
                onclick="switchTab('support')">
                <div class="flex items-center gap-6">
                    <div
                        class="w-16 h-16 rounded-2xl bg-pink-100 flex items-center justify-center text-pink-500 shadow-inner">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <path
                                d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3
                            class="font-brand text-xl font-bold text-slate-700 group-hover:text-pink-600 transition-colors">
                            Support Hub</h3>
                        <p class="text-slate-400 text-sm font-medium">Tickets & Help</p>
                    </div>
                </div>
                <div
                    class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400 group-hover:bg-pink-500 group-hover:text-white transition-all shadow-sm">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </div>
            </div>
        </div>
        </div>
    </template>

    <!-- 2. STUDENTS VIEW -->
    <template id="view-students">
        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 h-full flex flex-col">
            <!-- Toolbar -->
            <div class="clay-card p-6 flex flex-wrap gap-4 items-center justify-between shrink-0">
                <div
                    class="flex items-center gap-3 flex-1 min-w-[200px] bg-slate-50/50 px-4 py-3 rounded-2xl border-none shadow-inner focus-within:bg-white focus-within:shadow-md transition-all">
                    <svg class="text-slate-400" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search by Name, Roll No..."
                        class="bg-transparent border-none outline-none text-sm w-full placeholder-slate-400 font-brand font-medium"
                        oninput="renderStudents()">
                </div>
                <div class="flex items-center gap-3">
                    <select id="filterClass"
                        class="bg-white border-none shadow-sm rounded-xl text-sm px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-300 font-medium text-slate-600"
                        onchange="populateSections(); renderStudents()">
                        <option value="">All Classes</option>
                    </select>
                    <select id="filterSection"
                        class="bg-white border-none shadow-sm rounded-xl text-sm px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-300 font-medium text-slate-600"
                        onchange="renderStudents()">
                        <option value="">All Sections</option>
                    </select>
                </div>
                <div class="flex items-center gap-3 pl-2">
                    <!-- Bulk Actions (Hidden by default) -->
                    <button id="bulkDeleteBtn" onclick="bulkDelete()"
                        class="hidden p-3 rounded-xl bg-rose-50 hover:bg-rose-100 text-rose-500 font-bold text-xs uppercase tracking-wider shadow-sm transition-all flex items-center gap-2">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                        Delete Selected
                    </button>

                    <button onclick="exportData('pdf')"
                        class="p-3 rounded-xl bg-slate-50 hover:bg-white text-slate-500 hover:text-rose-500 hover:shadow-lg hover:translate-y-[-2px] transition-all shadow-sm"
                        title="Export PDF"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg></button>
                    <button onclick="exportData('excel')"
                        class="p-3 rounded-xl bg-slate-50 hover:bg-white text-slate-500 hover:text-emerald-500 hover:shadow-lg hover:translate-y-[-2px] transition-all shadow-sm"
                        title="Export Excel"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="8" y1="13" x2="16" y2="17"></line>
                            <line x1="16" y1="13" x2="8" y2="17"></line>
                        </svg></button>
                    <button onclick="generateBatchQr()"
                        class="p-3 rounded-xl bg-slate-50 hover:bg-white text-slate-500 hover:text-indigo-500 hover:shadow-lg hover:translate-y-[-2px] transition-all shadow-sm"
                        title="Generate Filter QR"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5">
                            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                            <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                            <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                            <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                            <rect x="7" y="7" width="10" height="10" rx="2"></rect>
                        </svg></button>
                    <button onclick="window.location.href='scanner_dashboard.html'"
                        class="p-3 rounded-xl bg-slate-50 hover:bg-white text-slate-500 hover:text-rose-500 hover:shadow-lg hover:translate-y-[-2px] transition-all shadow-sm"
                        title="Open QR Scanner"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2.5">
                            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
                            <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
                            <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
                            <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
                            <rect x="7" y="7" width="10" height="10" rx="2" stroke-dasharray="2 2"></rect>
                            <circle cx="12" cy="12" r="1" fill="currentColor"></circle>
                        </svg></button>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                    </svg></button>
                </div>
            </div>

            <!-- Data Grid -->
            <div class="clay-card flex-1 overflow-hidden flex flex-col p-6">
                <div class="overflow-x-auto flex-1 custom-scrollbar rounded-2xl">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-indigo-50/50 sticky top-0 z-10">
                            <tr>
                                <th
                                    class="p-5 w-10 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand rounded-l-xl">
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)"
                                        class="rounded text-indigo-500 focus:ring-indigo-500 cursor-pointer">
                                </th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Roll No</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Admission No</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Name</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Gender</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Class</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Section</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    House</th>
                                <th
                                    class="p-5 text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand">
                                    Order Status</th>
                                <th
                                    class="p-5 text-right text-[11px] font-extrabold text-indigo-400 uppercase tracking-widest font-brand rounded-r-xl">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="text-sm divide-y divide-slate-100">
                            <!-- Rows -->
                        </tbody>
                    </table>
                </div>
                <div
                    class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center text-xs text-slate-400 font-bold uppercase tracking-wider">
                    <span id="recordCount">0 Students</span>
                    <div id="paginationControls" class="flex gap-2">
                        <!-- Controls injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 3. SUPPORT VIEW (UPDATED) -->
    <template id="view-support">
        <div class="max-w-6xl mx-auto h-full flex flex-col animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Header Action -->
            <div class="flex justify-end items-center mb-6">
                <!-- Title removed (handled by global header) -->
                <button onclick="openComplaintModal()"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2.5 rounded-xl shadow-md shadow-indigo-200 font-bold text-sm flex items-center gap-2 transition-all hover:-translate-y-0.5">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2.5">
                        <path d="M12 5v14M5 12h14" />
                    </svg>
                    <span>New Ticket</span>
                </button>
            </div>

            <!-- History List -->
            <!-- History List -->
            <div id="complaintsList" class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-10">
                <!-- Cards injected here -->
                <!-- Cards injected here -->
                <!-- Empty state handled in JS -->
            </div>
        </div>
    </template>

    <!-- NEW TICKET MODAL -->
    <dialog id="complaintModal" class="bg-transparent">
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div
                class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto border border-slate-200 relative animate-in zoom-in-95 duration-200">

                <!-- Modal Header -->
                <div class="sticky top-0 bg-white z-10 p-6 border-b border-slate-100 flex justify-between items-center">
                    <div>
                        <h3 class="font-brand text-xl font-bold text-slate-800">Submit New Ticket</h3>
                        <p class="text-slate-500 text-xs font-medium">Please fill all details</p>
                    </div>
                    <button onclick="closeComplaintModal()"
                        class="w-8 h-8 rounded-full bg-stone-100 hover:bg-stone-200 flex items-center justify-center transition-colors">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="p-8">
                    <form onsubmit="submitComplaint(event)" id="complaintForm" class="space-y-6">

                        <!-- Student Info Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Name -->
                            <div class="lg:col-span-2">
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Student
                                    Name</label>
                                <input type="text" id="c_name" required
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 focus:ring-2 focus:ring-rose-500/20 transition-all">
                            </div>
                            <!-- Reg No -->
                            <div>
                                <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Reg
                                    No.</label>
                                <input type="text" id="c_reg" required
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 focus:ring-2 focus:ring-rose-500/20 transition-all">
                            </div>
                            <!-- Gender -->
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Gender</label>
                                <select id="c_gender" onchange="updatePatternOptions()"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 cursor-pointer">
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>

                        <!-- Class Info Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Class</label>
                                <input type="text" id="c_class" placeholder="e.g. X"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 transition-all">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Section
                                    / Div</label>
                                <input type="text" id="c_sec" placeholder="e.g. A"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 transition-all">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">House</label>
                                <select id="c_house"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 cursor-pointer">
                                    <option value="Red">Red</option>
                                    <option value="Blue">Blue</option>
                                    <option value="Green">Green</option>
                                    <option value="Yellow">Yellow</option>
                                </select>
                            </div>
                        </div>

                        <!-- Dynamic Defective Items List -->
                        <div class="col-span-full bg-stone-50 rounded-xl p-4 border border-stone-200">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-stone-500 uppercase tracking-wider">Defective
                                    Items</label>
                                <button type="button" onclick="addDefectRow()"
                                    class="text-xs font-bold text-rose-600 hover:text-rose-700 flex items-center gap-1">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Add Item
                                </button>
                            </div>

                            <div id="defectItemsContainer" class="space-y-3">
                                <!-- Rows injected via JS -->
                            </div>
                            <p id="emptyItemsMsg" class="text-xs text-stone-400 italic text-center py-2">No items added.
                                Click "Add Item" to start.</p>
                        </div>

                        <!-- Issue Details -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Pattern
                                    Name</label>
                                <select id="c_pattern"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 cursor-pointer">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Issue /
                                    Complaint</label>
                                <select id="c_issue_type"
                                    class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 cursor-pointer">
                                    <option value="Size Mismatch">Size Mismatch</option>
                                    <option value="Stiching Defect">Stiching Defect</option>
                                    <option value="Fabric Issue">Fabric Issue</option>
                                    <option value="Missing Item">Missing Item</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label
                                class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Description</label>
                            <textarea id="c_desc" rows="3" required
                                class="w-full bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-rose-500 resize-none"
                                placeholder="Describe the issue..."></textarea>
                        </div>

                        <!-- Images -->
                        <div>
                            <label
                                class="block text-xs font-bold text-stone-400 uppercase tracking-wider mb-2">Attachments
                                (Multiple)</label>
                            <div class="border-2 border-dashed border-stone-200 rounded-xl p-4 flex items-center justify-center gap-4 cursor-pointer hover:bg-rose-50/50 hover:border-rose-300 transition-all"
                                onclick="document.getElementById('compFiles').click()">
                                <svg class="text-stone-400" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                                <!-- COMPLAINT DETAIL MODAL -->
                            </div>
                            <input type="file" id="compFiles" multiple accept="image/*" class="hidden"
                                onchange="handleFileSelect(event)">
                            <div id="imagePreviewContainer" class="flex flex-wrap gap-2 mt-4"></div>
                        </div>

                        <!-- Submit -->
                        <div class="pt-4 border-t border-stone-100 flex justify-end gap-3">
                            <button type="button" onclick="closeComplaintModal()"
                                class="px-6 py-3 rounded-xl font-bold text-stone-500 hover:bg-stone-100 transition-colors text-sm">Cancel</button>
                            <button type="submit"
                                class="bg-stone-900 text-white px-8 py-3 rounded-xl font-bold uppercase tracking-wider text-sm hover:bg-rose-700 shadow-lg hover:shadow-rose-900/20 transition-all flex items-center gap-2">
                                <span>Submit Ticket</span>
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13" />
                                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                                </svg>
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </dialog>

    <!-- 4. SETTINGS VIEW -->
    <template id="view-settings">
        <div class="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500 max-w-5xl mx-auto">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- LEft Column: Profile -->
                <div class="md:col-span-1 space-y-6">
                    <!-- Profile Card -->
                    <div class="clay-card p-6 text-center">
                        <div
                            class="w-24 h-24 rounded-3xl bg-gradient-to-br from-indigo-400 to-indigo-600 mx-auto flex items-center justify-center text-white text-4xl font-bold mb-4 shadow-lg shadow-indigo-200">
                            S
                        </div>
                        <h3 class="font-brand text-xl font-bold text-slate-800 mb-1" id="settingsSchoolName">School Name
                        </h3>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Administrator</p>

                        <div class="flex flex-col gap-3">
                            <div class="bg-indigo-50 p-3 rounded-xl flex items-center gap-3">
                                <span
                                    class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-indigo-500 shadow-sm font-bold">#</span>
                                <div class="text-left">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">School ID</p>
                                    <p class="text-sm font-bold text-indigo-700" id="settingsSchoolId">--</p>
                                </div>
                            </div>
                            <button onclick="logout()"
                                class="w-full py-3 rounded-xl bg-rose-50 text-rose-500 font-bold hover:bg-rose-500 hover:text-white transition-all shadow-sm hover:shadow-rose-200">
                                Log Out
                            </button>
                        </div>
                    </div>

                    <!-- Additional Info -->
                    <div class="clay-card p-6">
                        <h4 class="font-brand text-sm font-bold text-slate-700 mb-4">Support Contact</h4>
                        <p class="text-xs text-slate-500 leading-relaxed mb-4">
                            Need help? Contact the platform super admin for critical issues.
                        </p>
                        <a href="mailto:support@clayadmin.com"
                            class="flex items-center gap-2 text-indigo-500 text-sm font-bold hover:underline">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                                <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                            </svg>
                            support@clayadmin.com
                        </a>
                    </div>
                </div>

                <!-- Right Column: Settings Forms -->
                <div class="md:col-span-2 space-y-8">

                    <!-- QR Security (New) -->
                    <div class="clay-card p-8 bg-gradient-to-br from-indigo-50 to-white">
                        <div class="flex items-center gap-4 mb-6 border-b border-indigo-100 pb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <path d="M3 14h7v7H3z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-brand text-xl font-bold text-slate-800">Filter QR Security</h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wide">Default Access
                                    Control</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-6">
                            <div class="flex-1">
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Default
                                    Access PIN</label>
                                <input type="text" id="page_qr_pin" maxlength="6"
                                    class="w-full bg-white border border-indigo-100 rounded-xl px-4 py-3 text-sm font-mono font-bold text-indigo-600 focus:ring-2 focus:ring-indigo-200 outline-none transition-all shadow-inner"
                                    placeholder="e.g. 1234">
                                <p class="text-[10px] text-slate-400 mt-2">This PIN is auto-embedded when you generate a
                                    Filter QR.</p>
                            </div>
                            <div class="pt-6">
                                <button onclick="saveQrPinSettings()"
                                    class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl transition-all active:scale-95">
                                    Save PIN
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Security -->
                    <div class="clay-card p-8">
                        <div class="flex items-center gap-4 mb-6 border-b border-stone-100 pb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-100 flex items-center justify-center text-amber-600">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-brand text-xl font-bold text-slate-800">Security</h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wide">Password &
                                    Authentication</p>
                            </div>
                        </div>

                        <form onsubmit="handlePasswordChange(event)" class="space-y-4 max-w-md">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label
                                        class="block text-xs font-bold text-slate-400 uppercase tracking-wider">Current
                                        Password</label>
                                    <button type="button"
                                        onclick="alert('Please contact your Super Admin to reset your password.')"
                                        class="text-xs font-bold text-indigo-500 hover:text-indigo-600 hover:underline">Forgot?</button>
                                </div>
                                <input type="password" id="old_pass" required
                                    class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">New
                                    Password</label>
                                <input type="password" id="new_pass" required minlength="6"
                                    class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Confirm
                                    New Password</label>
                                <input type="password" id="confirm_pass" required minlength="6"
                                    class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            </div>
                            <div class="pt-2">
                                <button type="submit"
                                    class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-xl transition-all active:scale-95">Update
                                    Password</button>
                            </div>
                        </form>
                    </div>

                    <!-- Data Backup -->
                    <div class="clay-card p-8 bg-gradient-to-br from-indigo-50 to-white">
                        <div class="flex items-center gap-4 mb-6 border-b border-stone-200 pb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center text-indigo-600">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-brand text-xl font-bold text-slate-800">Data Backup</h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wide">Export & Safe
                                    Keeping</p>
                            </div>
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <p class="font-bold text-slate-700">Student Database</p>
                                <p class="text-xs text-slate-400">Download active & recently deleted records</p>
                                <p id="backupTimer" class="text-xs mt-1 font-medium"></p>
                            </div>
                            <button onclick="exportData('backup')"
                                class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold rounded-xl shadow-lg shadow-indigo-200 transition-all flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download Excel
                            </button>
                        </div>
                    </div>

                    <!-- Preferences (Mock) -->
                    <div class="clay-card p-8 bg-gradient-to-br from-slate-50 to-white">
                        <div class="flex items-center gap-4 mb-6 border-b border-stone-200 pb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-emerald-100 flex items-center justify-center text-emerald-600">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z">
                                    </path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </div>
                            <div>
                                <h3 class="font-brand text-xl font-bold text-slate-800">Preferences</h3>
                                <p class="text-xs text-slate-400 font-bold uppercase tracking-wide">App Settings</p>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <!-- Browser Notifications -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-slate-700">Browser Notifications</p>
                                    <p class="text-xs text-slate-400">Get desktop alerts for support replies</p>
                                </div>
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" onchange="toggleNotifications(this)" id="toggle_notify"
                                        class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer checked:right-0 checked:border-emerald-500 checked:bg-emerald-500" />
                                    <label for="toggle_notify"
                                        class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>

                            <!-- Compact View -->
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-bold text-slate-700">Dense Table Mode</p>
                                    <p class="text-xs text-slate-400">Show more rows on screen</p>
                                </div>
                                <div
                                    class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" onchange="toggleCompactView(this)" id="toggle_view"
                                        class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                                    <label for="toggle_view"
                                        class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer"></label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <script>
        // === DATA STORE ===
        let allStudents = [];
        // Sync Helper
        async function syncToServer() {
            try {
                console.log("Syncing to server...");
                const res = await fetch('/api/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ students: allStudents })
                });
                if (res.ok) console.log("Sync Complete");
                else console.error("Sync Failed");
            } catch (e) { console.error("Sync Net Error", e); }
        }
        let lastComplaints = []; // For notification tracking
        let currentView = 'dashboard';
        const schoolId = parseInt(sessionStorage.getItem('schoolId'));
        const token = sessionStorage.getItem('token');
        let selectedFiles = [];

        // === INIT ===
        async function fetchSchoolDetails() {
            try {
                // Attempt to fetch school details using the ID
                const res = await fetch(`/api/schools/${schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const schoolData = await res.json();
                    if (schoolData && schoolData.name) {
                        sessionStorage.setItem('schoolName', schoolData.name);
                        // Update UI immediately if elements exist
                        const el = document.getElementById('userSchoolName');
                        if (el) el.innerText = schoolData.name;
                        const setsEl = document.getElementById('settingsSchoolName');
                        if (setsEl) setsEl.innerText = schoolData.name;
                        return;
                    }
                }
            } catch (e) {
                console.warn("Could not fetch school details automatically", e);
            }
        }

        // === INIT ===
        async function init() {
            if (!token || !schoolId) {
                window.location.href = 'index.html';
                return;
            }

            try {
                // 1. Fetch Basic Identity First (School Name)
                await fetchSchoolDetails();

                // Show Default Tab (Render UI First)
                switchTab('dashboard');

                // Fetch Data (Populate UI)
                await fetchData();

                // Prune Deleted History (Local Backup Maintenance)
                if (typeof pruneDeletedHistory === 'function') pruneDeletedHistory();

                // Set School Name (Live Update from Storage or Fallback)
                const storedName = sessionStorage.getItem('schoolName');
                const dispName = storedName || `School #${schoolId}`;

                const el = document.getElementById('userSchoolName');
                if (el) el.innerText = dispName;

                // Restore Preferences
                if (localStorage.getItem('compactMode') === 'true') {
                    document.body.classList.add('compact-mode');
                }

                // CHECK FOR URL FILTERS (Deep Linking from Scanner)
                const urlParams = new URLSearchParams(window.location.search);
                const filterParam = urlParams.get('filters');
                if (filterParam) {
                    try {
                        const decodedObj = JSON.parse(decodeURIComponent(filterParam));
                        // Filters structure: { c: Class, sec: Section, h: House }
                        if (decodedObj.c) {
                            const cEl = document.getElementById('filter_class');
                            if (cEl) cEl.value = decodedObj.c;
                        }
                        if (decodedObj.sec) {
                            const sEl = document.getElementById('filter_section');
                            if (sEl) sEl.value = decodedObj.sec;
                        }
                        if (decodedObj.h) {
                            const hEl = document.getElementById('filter_house');
                            if (hEl) hEl.value = decodedObj.h;
                        }

                        // Apply after brief delay to ensure UI ready
                        setTimeout(() => {
                            filterStudents();
                            console.log("Deep Linked Filters Applied:", decodedObj);
                            // Optional: Clean URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }, 500);

                    } catch (e) {
                        console.warn("Invalid Deep Link Filters", e);
                    }
                }

                // Auto-Refresh Support Tickets for Notifications (Every 60s)
                setInterval(() => {
                    fetchMyComplaints();
                }, 60000);

            } catch (e) {
                console.error("Init Error", e);
                alert("Failed to load data. Please refresh.");
            }
        }

        async function fetchData() {
            console.log(`Fetching data for School #${schoolId} with token: ${token ? 'Present' : 'Missing'}`);
            try {
                const res = await fetch(`/api/data/students/${schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 404) throw new Error("API Endpoint Not Found (404)");
                if (res.status === 401) throw new Error("Unauthorized (401) - Please Login Again");
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);

                allStudents = await res.json();

                // Live Update UI
                renderDashboardStats();
                populateFilters();
                // Only render table if we are on the students view or just generally safe to call (it checks if element exists)
                renderStudents();

            } catch (err) {
                console.error("Fetch Error:", err);
                // Only alert if we really have no data to show, or show toast
                if (allStudents.length === 0) alert(`Connection Issue: ${err.message}`);
            }
        }

        // === NAVIGATION ===
        async function switchTab(tabId) {
            document.querySelectorAll('.nav-item').forEach(b => {
                // Robust matching by ID instead of text
                const isActive = b.id === `nav-${tabId}`;
                b.classList.toggle('active', isActive);

                // Remove text-slate-400 if active, else add it
                if (isActive) {
                    b.classList.remove('text-slate-500');
                    b.classList.add('text-white');
                } else {
                    b.classList.add('text-slate-500');
                    b.classList.remove('text-white');
                }
            });

            const content = document.getElementById('mainContainer');
            const tpl = document.getElementById(`view-${tabId}`);
            if (tpl) {
                content.innerHTML = '';
                content.appendChild(tpl.content.cloneNode(true));

                // Update Page Title
                const titles = {
                    'dashboard': 'Overview',
                    'students': 'Student Data',
                    'support': 'Support Center',
                    'settings': 'Settings'
                };
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) pageTitle.innerText = titles[tabId] || 'Dashboard';

                // Initialize specific tab logic
                if (tabId === 'dashboard') renderDashboardStats();
                if (tabId === 'students') {
                    populateFilters(); // Ensure filters are ready
                    renderStudents();
                }
                if (tabId === 'support') fetchMyComplaints();
                if (tabId === 'settings') renderSettings();
            }
        }

        // === SETTINGS LOGIC ===
        function renderSettings() {
            updateBackupTimer();
            // Populate Profile Data from Session
            document.getElementById('settingsSchoolName').innerText = sessionStorage.getItem('schoolName') || 'School Info';
            document.getElementById('settingsSchoolId').innerText = schoolId || '--';

            // Restore Toggle States
            // 1. Notifications
            const notifyToggle = document.getElementById('toggle_notify');
            if (notifyToggle) {
                notifyToggle.checked = (Notification.permission === 'granted');
            }

            // 2. Compact Mode
            const compactToggle = document.getElementById('toggle_view');
            if (compactToggle) {
                compactToggle.checked = (localStorage.getItem('compactMode') === 'true');
            }

            // 3. QR PIN
            const pinInput = document.getElementById('page_qr_pin');
            if (pinInput) {
                pinInput.value = localStorage.getItem('default_qr_pin') || '';
            }
        }

        function saveQrPinSettings() {
            const pin = document.getElementById('page_qr_pin').value.trim();
            if (pin) {
                localStorage.setItem('default_qr_pin', pin);
                alert("Settings Saved! Default PIN: " + pin);
            } else {
                localStorage.removeItem('default_qr_pin');
                alert("Settings Saved! No Default PIN set (will fallback to 1234).");
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            const oldPass = document.getElementById('old_pass').value;
            const newPass = document.getElementById('new_pass').value;
            const confirmPass = document.getElementById('confirm_pass').value;

            if (newPass !== confirmPass) {
                alert("New passwords do not match!");
                return;
            }

            try {
                // Mock API call - Replace with actual endpoint if available
                // const res = await fetch('/api/auth/change-password', { ... });

                // For now, consistent with prototype status:
                alert("Password Update Simulated.\n(Backend integration required for persistence)");

                // Reset form
                e.target.reset();
            } catch (err) {
                console.error(err);
                alert("Failed to update password.");
            }
        }

        function toggleNotifications(cb) {
            if (cb.checked) {
                if (!("Notification" in window)) {
                    alert("This browser does not support desktop notifications.");
                    cb.checked = false;
                    return;
                }
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification("Notifications Enabled", { body: "You will now receive alerts for support tickets." });
                    } else {
                        cb.checked = false;
                        alert("Notification permission denied.");
                    }
                });
            }
        }

        function toggleCompactView(cb) {
            if (cb.checked) {
                document.body.classList.add('compact-mode');
                localStorage.setItem('compactMode', 'true');
                // Optional: You could update table styles here dynamically logic
                // For now, we'll just show the concept
            } else {
                document.body.classList.remove('compact-mode');
                localStorage.setItem('compactMode', 'false');
            }
        }

        // === DASHBOARD LOGIC ===
        let genderChart = null;
        let houseChart = null;

        function renderDashboardStats() {
            const total = allStudents.length;

            // Stats Calculation
            const completedCount = allStudents.filter(s => s.order_status === 'Completed').length;
            const pendingCount = total - completedCount;

            // Update Text Stats
            document.getElementById('dashTotal').innerText = total;
            document.getElementById('dashPending').innerText = pendingCount;
            document.getElementById('dashCompleted').innerText = completedCount;

            // --- CHARTS LOGIC ---

            // 1. Gender Data
            const genderCounts = allStudents.reduce((acc, s) => {
                const g = (s.gender || 'Unknown').trim();
                acc[g] = (acc[g] || 0) + 1;
                return acc;
            }, {});

            // 2. House Data
            const houseCounts = allStudents.reduce((acc, s) => {
                const h = (s.house || 'Unknown').trim();
                acc[h] = (acc[h] || 0) + 1;
                return acc;
            }, {});

            // Render Charts
            renderGenderChart(genderCounts);
            renderHouseChart(houseCounts);
        }

        function renderGenderChart(data) {
            const ctx = document.getElementById('chartGender');
            if (!ctx) return;

            if (genderChart) genderChart.destroy();

            genderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#6366f1', '#ec4899', '#94a3b8'], // Indigo, Pink, Slate
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Outfit' } } }
                    }
                }
            });
        }

        function renderHouseChart(data) {
            const ctx = document.getElementById('chartHouse');
            if (!ctx) return;

            if (houseChart) houseChart.destroy();

            // Dynamic Colors for Houses
            const houseColors = {
                'Red': '#ef4444',
                'Green': '#22c55e',
                'Blue': '#3b82f6',
                'Yellow': '#eab308'
            };
            const labels = Object.keys(data);
            const bgColors = labels.map(l => {
                const k = Object.keys(houseColors).find(c => l.toLowerCase().includes(c.toLowerCase()));
                return k ? houseColors[k] : '#cbd5e1'; // Default Slate
            });

            houseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: bgColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Outfit' } } }
                    }
                }
            });
        }

        // === STUDENTS LOGIC ===

        // Global selection state
        let selectedStudents = new Set();
        // Store currently filtered list for bulk actions
        let currentFilteredList = [];
        let currentPage = 1;
        const ITEMS_PER_PAGE = 50;

        function populateFilters() {
            const classSelect = document.getElementById('filterClass');
            if (!classSelect) return;

            // Only populate if empty (or reset needed)
            if (classSelect.options.length <= 1) {
                // Filter out Trash
                const activeClasses = allStudents.filter(s => s.status !== 'Trash').map(s => s.class).filter(Boolean);
                const classes = [...new Set(activeClasses)].sort();
                classes.forEach(c => classSelect.add(new Option(c, c)));
            }
        }

        function populateSections() {
            const classVal = document.getElementById('filterClass').value;
            const secSelect = document.getElementById('filterSection');

            while (secSelect.options.length > 1) {
                secSelect.remove(1);
            }

            if (!classVal) return;

            const sections = [...new Set(
                allStudents
                    .filter(s => s.status !== 'Trash' && s.class == classVal)
                    .map(s => s.section)
                    .filter(Boolean)
            )].sort();

            sections.forEach(s => secSelect.add(new Option(s, s)));
        }

        // === RENDER TABLE ===
        function renderStudents() {
            const tbody = document.getElementById('studentsTableBody');
            if (!tbody) return;

            const search = document.getElementById('searchInput').value.toLowerCase();
            const fClass = document.getElementById('filterClass').value;
            const fSec = document.getElementById('filterSection').value;

            populateFilters();

            // Filter Logic (Exclude Trash)
            const filtered = allStudents.filter(s => {
                if (s.status === 'Trash') return false; // Hide Deleted

                const matchSearch = (s.name?.toLowerCase().includes(search) || String(s.roll_no).toLowerCase().includes(search));
                const matchClass = !fClass || s.class == fClass;
                const matchSec = !fSec || s.section == fSec;
                return matchSearch && matchClass && matchSec;
            });

            currentFilteredList = filtered; // Update Global List
            document.getElementById('recordCount').innerText = `${filtered.length} Students Found`;

            // Pagination
            const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE) || 1;
            if (currentPage > totalPages) currentPage = 1;
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const paginated = filtered.slice(start, start + ITEMS_PER_PAGE);

            // Empty State
            if (paginated.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center py-10 text-slate-400 font-bold">No students found</td></tr>`;
                renderPaginationControls(totalPages);
                return;
            }

            // Render Rows
            tbody.innerHTML = paginated.map(s => {
                // ... same row rendering ...
                return `
                <tr class="hover:bg-indigo-50/50 transition-colors group border-b border-indigo-50/30 last:border-none">
            <td class="p-4">
                <input type="checkbox" onchange="toggleSelection('${s.admission_no || s.temp_id}')" ${selectedStudents.has(String(s.admission_no || s.temp_id)) ? 'checked' : ''} class="rounded text-indigo-500 focus:ring-indigo-500 cursor-pointer student-checkbox" value="${s.admission_no || s.temp_id}">
            </td>
            <td class="p-4 font-mono text-indigo-400 font-bold">${s.roll_no || '-'}</td>
            <td class="p-4 text-slate-600 font-medium">${s.admission_no}</td>
            <td class="p-4 font-bold text-slate-700">${s.name}</td>
            <td class="p-4 text-slate-500">${s.gender || '-'}</td>
            <td class="p-4 text-slate-600 font-bold">${s.class || '-'}</td>
            <td class="p-4 text-slate-600 font-bold">${s.section || '-'}</td>
            <td class="p-4 text-slate-600">${s.house || '-'}</td>
            <td class="p-4">
                <span class="px-3 py-1 rounded-full text-xs font-bold uppercase shadow-sm ${s.order_status === 'Completed' ? 'bg-emerald-100 text-emerald-600' : (s.order_status === 'Stitching' ? 'bg-amber-100 text-amber-600' : 'bg-slate-100 text-slate-500')}">
                    ${s.order_status || 'Pending'}
                </span>
            </td>
            <td class="p-4 text-right">
                <div class="flex items-center justify-end gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="generateIdCard('${s.admission_no || s.temp_id}')" class="p-2 rounded-lg hover:bg-emerald-100 text-emerald-500 transition-colors" title="View ID Card">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    </button>
                    <button onclick="openEditStudentModal('${s.admission_no || s.temp_id}')" class="p-2 rounded-lg hover:bg-indigo-100 text-indigo-500 transition-colors" title="Edit">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </button>
                    <button onclick="deleteStudent('${s.admission_no || s.temp_id}')" class="p-2 rounded-lg hover:bg-rose-100 text-rose-500 transition-colors" title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </td>
        </tr>
            `}).join('');

            renderPaginationControls(totalPages);
            updateBulkActionUI();
        }

        async function exportData(type) {
            // 'excel' = Active Only (Standard Export)
            // 'backup' = Active + Locally Archived Deleted Items (Settings > Backup)

            let dataToExport = [];

            if (type === 'backup') {
                // 1. Get Live Data
                dataToExport = [...allStudents];

                // 2. Append Archived Deleted Data from LocalStorage
                try {
                    const history = JSON.parse(localStorage.getItem('deleted_history') || '[]');
                    // Add a visual marker for deleted items
                    const archived = history.map(h => ({ ...h, status: 'Trash (Archived)' }));
                    dataToExport = [...dataToExport, ...archived];
                } catch (e) {
                    console.error("Backup merge failed", e);
                }

                // Sort: Active first, then Trash
                dataToExport.sort((a, b) => (String(a.status).includes('Trash') ? 1 : -1));

            } else {
                // Standard Excel Export: Use current view
                dataToExport = (typeof currentFilteredList !== 'undefined' && currentFilteredList.length > 0)
                    ? currentFilteredList
                    : allStudents;
            }

            if (dataToExport.length === 0) return alert("No data to export!");

            if (type === 'excel' || type === 'backup') {
                const ws = XLSX.utils.json_to_sheet(dataToExport.map(s => ({
                    "Admission No": s.admission_no,
                    "Student Name": s.name,
                    "Roll No": s.roll_no,
                    "Class": s.class,
                    "Section": s.section,
                    "House": s.house,
                    "Status": s.status || 'Active',
                    "Deleted At": s.deleted_at || ''
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Students");
                XLSX.writeFile(wb, `School_Data_${type == 'backup' ? 'FULL_BACKUP_WithARCHIVE' : 'Export'}_${new Date().toISOString().slice(0, 10)}.xlsx`);
            } else if (type === 'pdf') {
                const doc = new jspdf.jsPDF();
                doc.autoTable({
                    head: [['Adm No', 'Name', 'Class', 'Roll No']],
                    body: dataToExport.map(s => [s.admission_no, s.name, `${s.class} ${s.section || ''}`, s.roll_no]),
                });
                doc.save('students.pdf');
            }
        }

        function renderPaginationControls(totalPages) {
            const container = document.getElementById('paginationControls');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = `
        <button onclick="changePage(${currentPage - 1})" disabled="${currentPage === 1}" class="px-3 py-1 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 disabled:opacity-50 transition-colors">Prev</button>
        <span class="text-sm font-bold text-slate-600">Page ${currentPage} of ${totalPages}</span>
        <button onclick="changePage(${currentPage + 1})" disabled="${currentPage === totalPages}" class="px-3 py-1 rounded-lg border border-slate-200 text-slate-500 hover:bg-slate-50 disabled:opacity-50 transition-colors">Next</button>
    `;
            container.innerHTML = html;
        }

        function changePage(newPage) {
            currentPage = newPage;
            renderStudents();
        }

        function updateBulkActionUI() {
            const btn = document.getElementById('bulkDeleteBtn');
            if (selectedStudents.size > 0) {
                btn.classList.remove('hidden');
                btn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> Delete (${selectedStudents.size})`;
            } else {
                btn.classList.add('hidden');
            }

            const allChecked = currentFilteredList.length > 0 && currentFilteredList.every(s => selectedStudents.has(String(s.admission_no || s.temp_id)));
            document.getElementById('selectAllCheckbox').checked = allChecked;
            document.getElementById('selectAllCheckbox').indeterminate = selectedStudents.size > 0 && !allChecked;
        }

        function toggleSelection(key) {
            key = String(key);
            if (selectedStudents.has(key)) {
                selectedStudents.delete(key);
            } else {
                selectedStudents.add(key);
            }
            renderStudents();
        }

        function toggleSelectAll(checkbox) {
            if (checkbox.checked) {
                currentFilteredList.forEach(s => selectedStudents.add(String(s.admission_no || s.temp_id)));
            } else {
                currentFilteredList.forEach(s => selectedStudents.delete(String(s.admission_no || s.temp_id)));
            }
            renderStudents();
        }

        // --- CRUD Logic ---

        let deletedItemsStash = [];
        let undoTimer = null;

        function deleteStudent(key) {
            if (!confirm("Are you sure you want to delete this student?")) return;

            // Find item
            const idx = allStudents.findIndex(s => String(s.admission_no || s.temp_id) === String(key));
            if (idx === -1) {
                if (allStudents[key]) {
                    executeDelete([allStudents[key]]);
                }
                return;
            }
            executeDelete([allStudents[idx]]);
        }

        function bulkDelete() {
            if (selectedStudents.size === 0) return;
            if (!confirm(`Delete ${selectedStudents.size} students?`)) return;

            const toDelete = [];
            selectedStudents.forEach(key => {
                const s = allStudents.find(st => String(st.admission_no || st.temp_id) === String(key));
                if (s) toDelete.push(s);
            });

            executeDelete(toDelete);
        }

        // === DELETION & BACKUP LOGIC ===

        function updateBackupTimer() {
            const el = document.getElementById('backupTimer');
            if (!el) return;

            const deletedHistory = JSON.parse(localStorage.getItem('deleted_history') || '[]');

            if (deletedHistory.length === 0) {
                el.innerHTML = `<span class="text-emerald-500 flex items-center gap-1">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    Bin Empty (Auto-Delete Active)
                </span>`;
                return;
            }

            // Find oldest item (closest to expiry)
            const oldest = deletedHistory.reduce((a, b) => new Date(a.deleted_at) < new Date(b.deleted_at) ? a : b);
            const deletedAt = new Date(oldest.deleted_at).getTime();
            const retentionPeriod = 5 * 24 * 60 * 60 * 1000; // 5 Days
            const expiresAt = deletedAt + retentionPeriod;
            const now = Date.now();
            const diff = expiresAt - now;

            if (diff <= 0) {
                el.innerText = "Cleanup pending...";
            } else {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                el.innerHTML = `<span class="text-amber-600 font-bold">Next Cleanup: ${days}d ${hours}h</span>`;
            }
        }

        function pruneDeletedHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('deleted_history') || '[]');
                const now = new Date().getTime();
                const fiveDays = 5 * 24 * 60 * 60 * 1000;

                const validHistory = history.filter(item => (now - new Date(item.deleted_at).getTime()) < fiveDays);

                if (history.length !== validHistory.length) {
                    localStorage.setItem('deleted_history', JSON.stringify(validHistory));
                }
            } catch (e) {
                console.error("Prune error", e);
                localStorage.setItem('deleted_history', '[]'); // Reset if corrupt
            }
        }

        // === ID CARD LOGIC ===
        function generateIdCard(key) {
            const student = allStudents.find(s => (s.admission_no || s.temp_id) == key);
            if (!student) return alert("Student not found!");

            document.getElementById('idName').innerText = student.name;
            document.getElementById('idClass').innerText = (student.class || 'Class') + ' - ' + (student.section || '');
            document.getElementById('idRoll').innerText = "Roll: " + (student.roll_no || '--');
            document.getElementById('idAdm').innerText = student.admission_no || '--';
            document.getElementById('idHouse').innerText = student.house || '-';
            document.getElementById('idSchoolName').innerText = sessionStorage.getItem('schoolName') || 'School Info';

            // Status Logic - Extended
            const statusEl = document.getElementById('idStatus');
            const status = (student.order_status || 'Pending');
            statusEl.innerText = status;

            // Dynamic Status Colors
            statusEl.className = "px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wide ";
            if (['Completed', 'Delivered'].includes(status)) {
                statusEl.classList.add('bg-emerald-100', 'text-emerald-600');
            } else if (['Stitching', 'Packing'].includes(status)) {
                statusEl.classList.add('bg-amber-100', 'text-amber-600');
            } else {
                statusEl.classList.add('bg-slate-100', 'text-slate-500');
            }

            // Measurements Logic - Dynamic Grid
            const measContainer = document.getElementById('idMeasurements');
            measContainer.innerHTML = '';

            if (student.measurements && Array.isArray(student.measurements) && student.measurements.length > 0) {
                // Item | Size | Qty
                const header = document.createElement('div');
                header.className = "grid grid-cols-3 text-[9px] text-slate-400 border-b border-slate-100 pb-1 mb-1";
                header.innerHTML = `<span>Item</span><span>Size</span><span>Qty</span>`;
                measContainer.appendChild(header);

                student.measurements.forEach(m => {
                    const row = document.createElement('div');
                    row.className = "grid grid-cols-3 py-1 border-b border-slate-50 last:border-0";
                    row.innerHTML = `
                        <span class="text-left font-bold text-slate-700 truncate" title="${m.name}">${m.name}</span>
                        <span class="font-mono text-slate-600">${m.size}</span>
                        <span class="text-slate-500">${m.qty || 1}</span>
                     `;
                    measContainer.appendChild(row);
                });
            } else {
                measContainer.innerHTML = '<div class="text-slate-300 italic py-2 text-[10px]">No measurements found</div>';
            }

            // Generate QR with JSON Data (Client Side Optimization)
            const qrData = JSON.stringify({
                id: student.admission_no,
                n: student.name,
                c: student.class,
                s: student.section,
                st: student.status
            });

            // Clear Previous
            const qrContainer = document.getElementById('idQrCodeContainer');
            if (qrContainer) {
                qrContainer.innerHTML = '';
                try {
                    new QRCode(qrContainer, {
                        text: qrData,
                        width: 128,
                        height: 128,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (e) {
                    console.error("QR Gen Error", e);
                    qrContainer.innerText = "QR Error";
                }
            }

            document.getElementById('idCardModal').showModal();
        }

        async function downloadIdCard() {
            const element = document.getElementById('printableIdCard');
            if (!element) return;

            // Visual Feedback
            const btn = document.querySelector('button[title="Download Card"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) btn.innerText = "Generating...";

            try {
                // Wait for any images/fonts
                await new Promise(r => setTimeout(r, 500));

                const canvas = await html2canvas(element, {
                    scale: 3, // High Quality
                    backgroundColor: "#ffffff",
                    useCORS: true // Allow cross-origin images
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;

                // ID Card Size approx 350px width -> ~92mm
                // PDF A4 is 210mm. Let's make it a small Card PDF or fit to page.
                // Let's make a custom size PDF matching the card aspect ratio + margin
                const pdfWidth = 100; // mm
                const pdfHeight = (canvas.height / canvas.width) * pdfWidth;

                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: [pdfWidth + 20, pdfHeight + 20] // Padding
                });

                doc.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
                doc.save(`ID_Card_${document.getElementById('idAdm').innerText}.pdf`);

            } catch (err) {
                console.error("Card Export Error", err);
                alert("Failed to create PDF. Please try again.");
            } finally {
                if (btn) btn.innerHTML = originalText;
            }
        }

        function printIdCard() {
            const printContent = document.getElementById('printableIdCard');
            const WinPrint = window.open('', '', 'left=0,top=0,width=800,height=900,toolbar=0,scrollbars=0,status=0');

            // ROBUST PRINT: Clone the entire Head (Tailwind, Fonts, Styles)
            WinPrint.document.write(`
                <html>
                  <head>
                    ${document.head.innerHTML}
                    <style>
                        /* Print Overrides */
                        body { 
                            background: white !important; 
                            -webkit-print-color-adjust: exact; 
                            print-color-adjust: exact;
                        }
                        /* Ensure text visibility */
                        * { color: black !important; text-shadow: none !important; }
                    </style>
                  </head>
            <body class="flex items-center justify-center min-h-screen bg-white">
                <div class="border border-slate-200 rounded-3xl overflow-hidden shadow-none w-[350px]">
                    ${printContent.innerHTML}
                </div>
            </body>
            </html>
            `);

            WinPrint.document.close();
            WinPrint.focus();

            // Wait for resources (fonts/images)
            setTimeout(() => {
                WinPrint.print();
                WinPrint.close();
            }, 1000);
        }

        async function executeDelete(items) {
            // 0. ANIMATION (Visual Feedback)
            const idsToRemove = new Set(items.map(i => i.admission_no));

            // Apply Animation Class to visible rows
            document.querySelectorAll('#studentsTableBody tr').forEach(row => {
                // Find identifying cell (Admission No is usually in 2nd column or similar, but we need reliability)
                // Let's rely on checkbox value if present, or just generic index if matched?
                // Better: The render function puts checkboxes with values.
                const checkbox = row.querySelector('input[type="checkbox"]');
                if (checkbox && idsToRemove.has(checkbox.value)) {
                    row.style.transition = "all 0.5s ease";
                    row.style.opacity = "0";
                    row.style.transform = "translateX(-20px)";
                    row.style.backgroundColor = "#ffe4e6"; // Red tint
                }
            });

            // Wait for Animation
            await new Promise(r => setTimeout(r, 400));

            // 1. Local Backup (Browser Storage) - PROTECTED
            try {
                // Only save history if count is small to avoid Quota Exceeded
                if (items.length <= 20) {
                    let history = JSON.parse(localStorage.getItem('deleted_history') || '[]');
                    const timestamp = new Date().toISOString();

                    items.forEach(item => {
                        history.push({ ...item, status: 'Trash', deleted_at: timestamp });
                    });

                    // Cap History size at 50 items
                    if (history.length > 50) history = history.slice(-50);

                    localStorage.setItem('deleted_history', JSON.stringify(history));
                } else {
                    console.warn("Bulk delete: Skipping Undo History storage to prevent Quota Limits.");
                }
            } catch (e) {
                console.warn("Storage Quota Exceeded (Undo disabled for this action)", e);
            }

            // 2. Optimistic UI Removal
            allStudents = allStudents.filter(s => !idsToRemove.has(s.admission_no));
            renderStudents(); // Re-render instantly after animation

            // 3. Perform HARD DELETE on Server
            // Use Parallel Requests for speed, but throttle if huge
            // For 2000 items, parallel is too much. Sequential is too slow.
            // Ideally backend supports BULK DELETE. But we only have /api/data/students/:id
            // We'll proceed optimistically.

            // We will NOT await every single delete to keep UI responsive. 
            // We run it in background.
            (async () => {
                let successCount = 0;
                for (const item of items) {
                    try {
                        const id = item.admission_no || item.id;
                        await fetch(`/api/data/students/${id}`, { method: 'DELETE' });
                        successCount++;
                    } catch (e) { console.error("Del Err", e); }
                }
                console.log(`Background Delete Complete: ${successCount}/${items.length}`);
            })();

            // 4. Update UI
            showUndoToast(`${items.length} Student${items.length > 1 ? 's' : ''} deleted`);
            updateBulkActionUI();
        }

        function showUndoToast(msg) {
            const toast = document.getElementById('undoToast');
            document.getElementById('undoMsg').innerText = msg;

            if (undoTimer) clearTimeout(undoTimer);

            toast.classList.remove('translate-y-20', 'opacity-0', 'pointer-events-none');

            // Auto dismiss after 20s
            undoTimer = setTimeout(() => {
                dismissUndo();
                deletedItemsStash = [];
            }, 20000);
        }

        function dismissUndo() {
            const toast = document.getElementById('undoToast');
            toast.classList.add('translate-y-20', 'opacity-0', 'pointer-events-none');
        }

        function undoDelete() {
            if (deletedItemsStash.length === 0) return;

            // Restore
            allStudents.push(...deletedItemsStash);

            deletedItemsStash = [];
            renderStudents();
            backupData();
            dismissUndo();
        }

        function openEditStudentModal(key) {
            const s = allStudents.find(st => String(st.admission_no || st.temp_id) === String(key));
            if (!s) return;

            document.getElementById('edit_original_adm').value = s.admission_no;
            document.getElementById('edit_name').value = s.name;
            document.getElementById('edit_adm').value = s.admission_no;
            document.getElementById('edit_roll').value = s.roll_no;
            document.getElementById('edit_gender').value = s.gender;
            document.getElementById('edit_class').value = s.class;
            document.getElementById('edit_sec').value = s.section;
            document.getElementById('edit_house').value = s.house || ''; // Populate House
            // document.getElementById('edit_status').value = s.order_status || 'Pending'; // Removed

            document.getElementById('editStudentModal').showModal();
        }

        function saveStudentEdit() {
            const originalAdm = document.getElementById('edit_original_adm').value;
            const idx = allStudents.findIndex(s => String(s.admission_no) === String(originalAdm));

            if (idx === -1) return;

            allStudents[idx] = {
                ...allStudents[idx],
                name: document.getElementById('edit_name').value,
                admission_no: document.getElementById('edit_adm').value,
                roll_no: document.getElementById('edit_roll').value,
                gender: document.getElementById('edit_gender').value,
                class: document.getElementById('edit_class').value,
                section: document.getElementById('edit_sec').value,
                house: document.getElementById('edit_house').value // Save House
                // order_status: Preserved automatically as valid property from spread
            };

            renderStudents();
            backupData();
            document.getElementById('editStudentModal').close();
        }

        // --- Backup System ---
        function backupData() {
            const backups = JSON.parse(localStorage.getItem('student_backups') || '[]');
            const today = new Date().toISOString().split('T')[0];

            // Check if backup for today exists
            const existingIdx = backups.findIndex(b => b.date === today);
            const snapshot = { date: today, data: allStudents, ts: Date.now() };

            if (existingIdx >= 0) {
                backups[existingIdx] = snapshot;
            } else {
                backups.unshift(snapshot);
                if (backups.length > 4) backups.pop(); // Keep 4 days
            }

            localStorage.setItem('student_backups', JSON.stringify(backups));
        }

        async function handleBulkImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!confirm("Start import? This will add new students.")) {
                e.target.value = '';
                return;
            }

            reader.onload = async (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    let success = 0;
                    for (const row of json) {
                        // Map row keys to API expected keys
                        const payload = {
                            school_id: schoolId,
                            admission_no: row['Adm No'] || row['ADMISSION NO'],
                            roll_no: row['Roll No'] || row['ROLL NO'],
                            name: row['Name'] || row['NAME'],
                            class: row['Class'] || row['CLASS'],
                            section: row['Section'] || row['SECTION'],
                            house: row['House'] || row['HOUSE'],
                            gender: row['Gender'] || row['GENDER']
                        };

                        if (payload.admission_no && payload.name) {
                            await fetch('/api/data/student', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                                body: JSON.stringify(payload)
                            });
                            success++;
                        }
                    }

                    alert(`Imported ${success} students successfully!`);
                    await fetchData();
                    if (currentView === 'dashboard') renderDashboardStats();
                } catch (err) {
                    console.error(err);
                    alert("Import failed: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function exportData(type) {
            // Use currentFilteredList if available, else allStudents
            const dataToExport = (typeof currentFilteredList !== 'undefined' && currentFilteredList.length > 0) ?
                currentFilteredList : allStudents;

            if (dataToExport.length === 0) return alert("No data to export!");

            // ... (rest of logic using dataToExport instead of allStudents)
            // Need to change the implementation slightly to pass dataToExport

            if (type === 'excel') {
                const ws = XLSX.utils.json_to_sheet(dataToExport.map(s => ({
                    "Admission No": s.admission_no,
                    "Roll No": s.roll_no,
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "House": s.house,
                    "Status": s.order_status
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Students");
                XLSX.writeFile(wb, `Students_Export_${new Date().toISOString().slice(0, 10)}.xlsx`);
            } else if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.text("Student List Report", 14, 15);
                doc.setFontSize(10);
                doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 22);

                const tableColumn = ["Roll No", "Adm No", "Name", "Class", "Section", "Gender", "House", "Status"];
                const tableRows = [];

                dataToExport.forEach(s => {
                    const studentData = [
                        s.roll_no || '-',
                        s.admission_no || '-',
                        s.name || '-',
                        s.class || '-',
                        s.section || '-',
                        s.gender || '-',
                        s.house || '-',
                        s.order_status || 'Pending'
                    ];
                    tableRows.push(studentData);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: 25,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [79, 70, 229] } // Indigo-600
                });

                doc.save(`Students_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            }
        }

        // === SUPPORT LOGIC ===
        let editingComplaintId = null; // Track if we are editing

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            // Append to existing selectedFiles instead of replacing
            selectedFiles = [...selectedFiles, ...files];
            renderImagePreviews();
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderImagePreviews();
        }

        function renderImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            selectedFiles.forEach((f, i) => {
                const div = document.createElement('div');
                div.className = "relative inline-block shrink-0 h-16 w-16 group";

                const img = document.createElement('img');
                img.src = URL.createObjectURL(f);
                img.className = "h-full w-full rounded border border-stone-200 object-cover";

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = "Ã—";
                removeBtn.className = "absolute -top-2 -right-2 bg-rose-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow-sm opacity-0 group-hover:opacity-100 transition-opacity";
                removeBtn.onclick = (e) => { e.preventDefault(); removeFile(i); };

                div.appendChild(img);
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }

        // === MODAL LOGIC ===
        const boysPatterns = [
            "BOYS - FORMAL SHIRT", "BOYS - TRACK T-SHIRT", "BOYS - UNIFORM T-SHIRT",
            "BOYS - JERKIN", "BOYS - PULLOVER", "BOYS - FORMAL PANT",
            "BOYS - TRACK PANT", "BOYS - FORMAL SHORTS", "BOYS - TRACK SHORTS",
            "BOYS - PANT SPECIAL CASE"
        ];
        const girlsPatterns = [
            "GIRLS - FORMAL SHIRT", "GIRLS - TRACK T-SHIRT", "GIRLS - UNIFORM T-SHIRT",
            "GIRLS - JERKIN", "GIRLS - FULL SLEEVE SHIRT", "GIRLS - PULLOVER",
            "GIRLS - KURTHA SHIRT", "GIRLS - SPECIAL FROCKS", "GIRLS - FORMAL PANT",
            "GIRLS - TRACK PANT", "GIRLS - TRACK SHORTS", "GIRLS - PINOFORE",
            "GIRLS - SKIRT", "GIRLS - PANT SPECIAL CASE"
        ];

        // Ensure gender change updates existing rows or warns?
        // For simplicity, we just re-render or let user manage.
        // Actually, let's refresh ALL pattern dropdowns when gender changes
        function updatePatternOptions() {
            const gender = document.getElementById('c_gender').value;
            const patterns = gender === 'Male' ? boysPatterns : girlsPatterns;

            // Update all existing pattern selects
            document.querySelectorAll('.pattern-select').forEach(select => {
                const currentVal = select.value;
                select.innerHTML = patterns.map(p => `<option value="${p}">${p}</option>`).join('');
                if (patterns.includes(currentVal)) select.value = currentVal;
            });
        }

        function addDefectRow() {
            const container = document.getElementById('defectItemsContainer');
            const documentFragment = document.createDocumentFragment();
            const rowId = 'row_' + Date.now();

            const div = document.createElement('div');
            div.className = "defect-row grid grid-cols-1 md:grid-cols-12 gap-2 items-start bg-slate-50 p-4 rounded-2xl border-none shadow-inner animate-in slide-in-from-right-2";
            div.id = rowId;

            const gender = document.getElementById('c_gender').value;
            const patterns = gender === 'Male' ? boysPatterns : girlsPatterns;
            const patternOptions = patterns.map(p => `<option value="${p}">${p}</option>`).join('');

            div.innerHTML = `
<div class="md:col-span-5">
    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Pattern</label>
    <select
        class="pattern-select w-full bg-white border-none shadow-sm rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200">
        ${patternOptions}
    </select>
</div>
<div class="md:col-span-6">
    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Issue</label>
    <select onchange="handleIssueChange(this)"
        class="issue-select w-full bg-white border-none shadow-sm rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200">
        <option value="Size Mismatch">Size Mismatch</option>
        <option value="Stiching Defect">Stiching Defect</option>
        <option value="Fabric Issue">Fabric Issue</option>
        <option value="Missing Item">Missing Item</option>
        <option value="Other">Other (Specify)</option>
    </select>
    <input type="text" placeholder="Specify issue..."
        class="other-issue-input hidden w-full mt-2 bg-white border-none shadow-sm rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-200 outline-none">
</div>
<div class="md:col-span-1 flex items-center justify-center pt-6">
    <button type="button" onclick="document.getElementById('${rowId}').remove(); checkEmptyMsg();"
        class="text-slate-400 hover:text-rose-500 p-2 rounded-full hover:bg-rose-50 transition-all">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>
</div>
`;

            container.appendChild(div);
            checkEmptyMsg();
        }

        function checkEmptyMsg() {
            const count = document.getElementById('defectItemsContainer').children.length;
            const msg = document.getElementById('emptyItemsMsg');
            if (count === 0) msg.classList.remove('hidden');
            else msg.classList.add('hidden');
        }

        function handleIssueChange(select) {
            const input = select.closest('div').querySelector('.other-issue-input');
            if (select.value === 'Other') {
                input.classList.remove('hidden');
                input.required = true;
            } else {
                input.classList.add('hidden');
                input.required = false;
            }
        }

        function openComplaintModal() {
            const modal = document.getElementById('complaintModal');
            if (modal) {
                modal.showModal();
                // If empty, add one row by default
                if (document.getElementById('defectItemsContainer').children.length === 0) {
                    addDefectRow();
                }
            }
        }

        function closeComplaintModal() {
            const modal = document.getElementById('complaintModal');
            if (modal) modal.close();
            // Reset form
            document.getElementById('complaintForm').reset();
            selectedFiles = [];
            renderImagePreviews();
            editingComplaintId = null;
            document.getElementById('defectItemsContainer').innerHTML = '';
            checkEmptyMsg(); // Ensure empty message is shown if container is cleared
        }

        async function submitComplaint(e) {
            e.preventDefault();
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="enso-loader w-4 h-4 border-2"></div> Processing...';

            // Gather Data
            const student_name = document.getElementById('c_name').value;
            const student_reg_no = document.getElementById('c_reg').value;
            const gender = document.getElementById('c_gender').value;
            const cls = document.getElementById('c_class').value;
            const section = document.getElementById('c_sec').value;
            const house = document.getElementById('c_house').value;

            // Gather Defect Items
            const rows = document.querySelectorAll('.defect-row');
            if (rows.length === 0) {
                alert("Please add at least one item defect.");
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                return;
            }

            const items = Array.from(rows).map(row => {
                const p = row.querySelector('.pattern-select').value;
                const iSelect = row.querySelector('.issue-select');
                const issueVal = iSelect.value;
                const otherVal = row.querySelector('.other-issue-input').value;
                const finalIssue = (issueVal === 'Other' && otherVal) ? otherVal : issueVal;
                return { pattern: p, issue: finalIssue };
            });

            // Aggregate for Legacy DB Columns
            const pattern_name = items.map(x => x.pattern).join(', ');
            // Format Issue Type clearly: "Shirt (Size), Pant (Tear)"
            const issue_type = items.map(x => `${x.pattern.split('-').pop().trim()} (${x.issue})`).join(', ');

            // Calculate Max Rating based on issues (e.g. if any logic needed, otherwise default 3)
            const rating = 3;

            const comment = document.getElementById('c_desc').value;
            let imageUrls = [];

            try {
                // Upload new files
                if (selectedFiles.length > 0) {
                    const fd = new FormData();
                    selectedFiles.forEach(f => fd.append('images', f));
                    const upRes = await fetch('/api/data/upload', { method: 'POST', body: fd });
                    if (!upRes.ok) throw new Error("Upload failed");
                    imageUrls = (await upRes.json()).urls;
                }

                const payload = {
                    school_id: schoolId,
                    student_name, student_reg_no, gender,
                    class: cls, section, house,
                    pattern_name, issue_type,
                    rating,
                    comment,
                    image_url: JSON.stringify(imageUrls)
                };

                const url = editingComplaintId ? `/api/data/complaints/${editingComplaintId}` : '/api/data/complaints';
                const method = editingComplaintId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error("Submission failed");

                alert(editingComplaintId ? "Ticket Updated!" : "Ticket Submitted!");

                closeComplaintModal();
                fetchMyComplaints();

                // Clear dynamic items
                document.getElementById('defectItemsContainer').innerHTML = '';

            } catch (err) {
                alert("Error: " + err.message);
                submitBtn.innerHTML = originalText;
            } finally {
                submitBtn.disabled = false;
                if (submitBtn.innerText !== originalText) submitBtn.innerHTML = originalText;
            }
        }

        async function deleteComplaint(id) {
            if (!confirm("Are you sure you want to delete this ticket?")) return;
            try {
                const res = await fetch(`/api/data/complaints/${id}`, {
                    method: 'DELETE', headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (res.ok) {
                    fetchMyComplaints();
                } else alert("Failed to delete");
            } catch (e) { console.error(e); }
        }

        // === BULK IMPORT ENGINE ===
        let importQueue = [];
        let importFilesList = [];

        function openImportModal() {
            // Reset
            importQueue = [];
            importFilesList = [];
            // Reset View to List (Fix: user stuck in manual entry)
            if (document.getElementById('manualEntryForm')) hideManualEntryForm();

            document.getElementById('importFileList').innerHTML = '';
            document.getElementById('multiFileImport').value = '';
            renderImportPreview();

            // Show
            const modal = document.getElementById('importModal');
            modal.classList.remove('hidden');
        }

        function handleFileSelection(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function handleDrop(e) {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        async function processFiles(files) {
            for (const file of files) {
                // Add to visual list
                importFilesList.push(file);
                renderfileList();

                // Parse
                await parseExcelData(file);
            }
        }

        function renderfileList() {
            const container = document.getElementById('importFileList');
            container.innerHTML = importFilesList.map((f, i) => `
<div
    class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold flex items-center gap-2 shadow-sm border border-indigo-100">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    </svg>
    <span class="max-w-[100px] truncate">${f.name}</span>
    <button onclick="removeImportFile(${i})" class="hover:text-rose-500">Ã—</button>
</div>
`).join('');
        }

        function removeImportFile(index) {
            importFilesList.splice(index, 1);
            // In a real app we might want to un-parse the data too, but for now we just clear queue and re-parse leftover or just clear all.
            // Simpler strategy: Clear queue and re-parse remaining files.
            importQueue = [];
            renderfileList();
            processFiles(importFilesList); // Re-process
        }

        function normalizeHeader(key) {
            const k = key.toString().toUpperCase().trim().replace(/[^A-Z0-9]/g, '');
            // Map Standard Fields
            if (['ROLLNO', 'ROLL', 'ID', 'NO'].includes(k)) return 'roll_no';
            if (['NAME', 'STUDENTNAME', 'STUDENT', 'FULLNAME'].includes(k)) return 'name';
            if (['GENDER', 'SEX', 'M/F'].includes(k)) return 'gender';
            if (['CLASS', 'GRADE', 'STD'].includes(k)) return 'class';
            if (['SECTION', 'SEC', 'DIVISION', 'DIV'].includes(k)) return 'section';
            if (['HOUSE', 'TEAM', 'GROUP'].includes(k)) return 'house';
            if (['ADMNO', 'ADMISSIONNO', 'REGNO', 'ADMNNO', 'REGISTRATIONNO'].includes(k)) return 'admission_no';
            if (['STATUS', 'ORDERSTATUS', 'STATE'].includes(k)) return 'order_status';

            // Return original cleaned key for potential measurement mapping
            return key.trim();
        }

        function parseExcelData(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    workbook.SheetNames.forEach(sheetName => {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        rows.forEach(row => {
                            const newRow = {};
                            const measurements = [];
                            const standardKeys = ['roll_no', 'name', 'gender', 'class', 'section', 'house', 'admission_no', 'order_status',
                                'status'];

                            Object.keys(row).forEach(key => {
                                const norm = normalizeHeader(key);
                                if (standardKeys.includes(norm)) {
                                    newRow[norm] = row[key];
                                } else {
                                    // MEASUREMENT MAPPING
                                    const val = row[key];
                                    if (val && String(val).trim() !== '') {
                                        measurements.push({
                                            name: norm || key, // Use norm or original key
                                            size: val,
                                            qty: 1
                                        });
                                    }
                                }
                            });

                            // Enrich / Validate
                            if (newRow.name) {
                                importQueue.push({
                                    roll_no: newRow.roll_no || '-',
                                    name: newRow.name,
                                    gender: newRow.gender || '-',
                                    class: newRow.class || '-',
                                    section: newRow.section || '-',
                                    house: newRow.house || '-',
                                    admission_no: newRow.admission_no || '-',
                                    order_status: newRow.order_status || 'Pending',
                                    status: 'Active',
                                    measurements: measurements
                                });
                            }
                        });
                    });
                    renderImportPreview();
                    resolve();
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function renderImportPreview() {
            const tbody = document.getElementById('importPreviewBody');
            document.getElementById('previewCount').innerText = importQueue.length + " Records";

            if (importQueue.length === 0) {
                tbody.innerHTML = `
<tr id="emptyPreviewState">
    <td colspan="9" class="p-10 text-center text-stone-300 font-medium">
        No data loaded. Upload files or add manually.
    </td>
</tr>
`;
                return;
            }

            tbody.innerHTML = importQueue.map((row, i) => `
<tr class="hover:bg-stone-50 transition-colors border-b border-stone-50 last:border-none group">
    <td class="p-3 font-bold text-stone-600">${row.roll_no}</td>
    <td class="p-3 font-bold text-stone-800">${row.name}</td>
    <td class="p-3 text-stone-600">${row.gender}</td>
    <td class="p-3 text-stone-600">${row.class}</td>
    <td class="p-3 text-stone-600">${row.house}</td>
    <td class="p-3 text-stone-600">${row.admission_no}</td>
    <td class="p-3">
        <span
            class="px-2 py-0.5 rounded text-[10px] font-bold bg-amber-50 text-amber-600 uppercase tracking-wide">Ready</span>
    </td>
    <td class="p-3 text-right">
        <button onclick="removeImportRow(${i})"
            class="text-stone-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-all font-bold text-lg">Ã—</button>
    </td>
</tr>
`).join('');
        }

        function removeImportRow(i) {
            importQueue.splice(i, 1);
            renderImportPreview();
        }

        function showManualEntryForm() {
            document.getElementById('importListView').classList.add('hidden');
            document.getElementById('importModalFooter').classList.add('hidden'); // Hide global footer
            document.getElementById('manualEntryForm').classList.remove('hidden');

            // Focus Name
            setTimeout(() => document.getElementById('m_name').focus(), 100);
        }

        function hideManualEntryForm() {
            document.getElementById('manualEntryForm').classList.add('hidden');
            document.getElementById('importModalFooter').classList.remove('hidden'); // Show global footer
            document.getElementById('importListView').classList.remove('hidden');

            // Clear inputs
            ['m_name', 'm_roll', 'm_adm', 'm_class', 'm_sec', 'm_house'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('m_gender').value = '-';
        }

        function saveManualEntry() {
            const name = document.getElementById('m_name').value.trim();
            if (!name) {
                alert("Student Name is required!");
                return;
            }

            const newStudent = {
                roll_no: document.getElementById('m_roll').value.trim() || '-',
                name: name,
                gender: document.getElementById('m_gender').value,
                class: document.getElementById('m_class').value.trim() || '-',
                section: document.getElementById('m_sec').value.trim() || '-',
                house: document.getElementById('m_house').value.trim() || '-',
                admission_no: document.getElementById('m_adm').value.trim() || '-',
                order_status: 'Pending',
                status: 'Active'
            };

            importQueue.unshift(newStudent); // Add to top
            renderImportPreview();
            hideManualEntryForm();

            // Show toast or highlight
            // alert("Added " + name);
        }

        // Replaced old addManualRow with the functions above

        function clearImportdata() {
            if (confirm("Clear all import data?")) {
                openImportModal(); // Resets
            }
        }

        async function processUpload() {
            if (importQueue.length === 0) return alert("No data to import!");

            const btn = document.querySelector('#importModal button[onclick="processUpload()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
    <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
    </path>
</svg> Importing...`;
            btn.disabled = true;

            let success = 0;
            let updated = 0;
            let skipped = 0;
            let errors = 0;

            try {
                // Sequential Processing
                for (const student of importQueue) {
                    const payload = {
                        school_id: schoolId,
                        admission_no: student.admission_no,
                        roll_no: student.roll_no,
                        name: student.name,
                        gender: student.gender,
                        class: student.class,
                        section: student.section,
                        house: student.house,
                        status: student.status,
                        order_status: student.order_status,
                        measurements: student.measurements // Include measurements directly
                    };

                    // Check for Duplicates (Admission No)
                    const existing = allStudents.find(s =>
                        String(s.admission_no) === String(student.admission_no)
                    );

                    try {
                        if (existing) {
                            // DUPLICATE FOUND
                            if (confirm(`Duplicate found: ${student.name} (Adm: ${student.admission_no}).\nUpdate existing record?`)) {
                                // Update existing student in allStudents array
                                const existingIndex = allStudents.findIndex(s => String(s.admission_no) === String(student.admission_no));
                                if (existingIndex !== -1) {
                                    allStudents[existingIndex] = { ...allStudents[existingIndex], ...payload };
                                }
                                updated++;
                            } else {
                                skipped++;
                                continue;
                            }
                        } else {
                            // NEW RECORD  - Assign a pseudo-ID
                            allStudents.push({ ...payload, id: Date.now() + Math.random() });
                            success++;
                        }
                    } catch (e) {
                        console.error(e);
                        errors++;
                    }
                }

                // 4. Update UI & SYNC
                allStudents = [...allStudents]; // Refresh ref
                await syncToServer(); // PUSH DATA TO SERVER

                alert(`Report:\nâœ… Created: ${success}\nðŸ”„ Updated: ${updated}\nâ­ï¸ Skipped: ${skipped}\nâŒ Errors: ${errors}`);

                // Clear Queue on success
                importQueue = [];
                importFilesList = [];
                renderfileList();
                renderImportPreview();

                document.getElementById('importModal').classList.add('hidden');

                renderStudents(); // Refresh main table
                renderDashboardStats();

            } catch (e) {
                alert("Critical Error: " + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function editComplaint(index) {
            const c = window.myComplaints[index];
            if (!c) return;

            editingComplaintId = c.id;

            // 1. Fill Text Fields
            document.getElementById('c_name').value = c.student_name || '';
            document.getElementById('c_reg').value = c.student_reg_no || '';
            document.getElementById('c_gender').value = c.gender || 'Male';
            document.getElementById('c_class').value = c.class || '';
            document.getElementById('c_sec').value = c.section || '';
            document.getElementById('c_house').value = c.house || 'Red';
            document.getElementById('c_desc').value = c.comment || '';

            // 2. Clear & Fill Dynamic Items
            const container = document.getElementById('defectItemsContainer');
            container.innerHTML = '';

            // Try to parse items from pattern/issue strings
            // Limitation: If pattern_name is string "A, B" and issue is "X, Y", mapping is tricky without structured data.
            // For now, we will add ONE row with the string values if they exist, or just leave empty for user to re-enter.
            // Better approach: Just reset items and ask user to re-enter details for clarity,
            // OR (Preferred) pre-fill the first row with available text.
            if (c.pattern_name) {
                // Heuristic: Split by comma and try to split match
                const pats = c.pattern_name.split(',');
                // Just add one row with the raw text if standard parsing fails, or reset.
                const div = document.createElement('div');
                div.className = 'defect-row grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-2xl border-none shadow-inner relative animate-in slide-in-from-left-2 fade-in';
                div.innerHTML = `
<div>
    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Pattern</label>
    <select
        class="pattern-select w-full bg-white border-none shadow-sm rounded-xl px-2 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-200">
        <option value="${c.pattern_name}">${c.pattern_name} (Current)</option>
    </select>
</div>
<div>
    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Issue</label>
    <select
        class="issue-select w-full bg-white border-none shadow-sm rounded-xl px-2 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-200">
        <option value="Other">Other</option>
    </select>
    <input type="text"
        class="other-issue-input w-full mt-2 bg-white border-none shadow-sm rounded-xl px-2 py-2 text-xs outline-none focus:ring-2 focus:ring-indigo-200"
        value="${c.issue_type || ''}" placeholder="Issue details">
</div>
<button type="button" onclick="this.closest('.defect-row').remove()"
    class="absolute -top-2 -right-2 w-8 h-8 bg-rose-50 hover:bg-rose-100 text-rose-500 rounded-full flex items-center justify-center shadow-sm transition-colors text-lg font-bold">&times;</button>
`;
                container.appendChild(div);
            }

            // 3. UI Updates
            openComplaintModal();
            // Change Modal Title via DOM
            // Note: openComplaintModal resets title, so we must override after opening or modify logic.
            // Let's modify logic in openComplaintModal or just hack it here after a timeout/direct access
            setTimeout(() => {
                document.querySelector('#complaintModal h3').innerText = "Edit Ticket";
            }, 50);
        }

        async function deleteComplaint(id) {
            if (!confirm("Are you sure you want to delete this ticket?")) return;
            try {
                const res = await fetch(`/api/data/complaints/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Delete failed");
                alert("Ticket Deleted!");
                fetchMyComplaints(); // Live Update
            } catch (e) {
                console.error(e);
                alert("Error deleting ticket: " + e.message);
            }
        }

        function viewComplaint(index) {
            const c = window.myComplaints[index];
            if (!c) return;
            let imgs = [];
            try { imgs = JSON.parse(c.image_url || '[]'); } catch (e) { }
            if (!Array.isArray(imgs)) imgs = [c.image_url];

            const content = `
<div class="space-y-8">
    <!-- Status Header -->
    <div class="flex justify-between items-start border-b border-indigo-50 pb-6">
        <div class="flex gap-4">
            <div
                class="w-14 h-14 rounded-2xl bg-indigo-100 flex items-center justify-center text-indigo-500 font-brand font-bold text-xl shadow-inner shrink-0">
                ${c.student_name ? c.student_name.charAt(0) : '?'}
            </div>
            <div>
                <h3 class="font-brand text-2xl text-slate-700 font-bold">${c.student_name || 'Unknown Student'}</h3>
                <p class="text-slate-400 text-sm font-medium mt-1">
                    ${c.student_reg_no || '-'} â€¢ ${c.class || ''} ${c.section || ''} â€¢ ${c.gender || ''}
                </p>
            </div>
        </div>
        <div class="text-right">
            <span
                class="px-4 py-1.5 rounded-full text-xs font-extrabold uppercase tracking-wide ${c.status === 'Resolved' ? 'bg-emerald-100 text-emerald-600' : 'bg-amber-100 text-amber-600'}">${c.status}</span>
            <p class="text-[10px] text-slate-300 mt-2 uppercase tracking-wider font-bold">${new
                    Date(c.created_at).toLocaleString()}</p>
        </div>
    </div>

    <!-- Defect Details -->
    <div class="bg-slate-50 rounded-2xl p-6 border-none shadow-inner">
        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-4">Reported Defects</p>
        <div class="grid grid-cols-2 gap-6">
            <div>
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">Patterns</p>
                <p class="text-slate-700 font-bold text-lg">${c.pattern_name || '-'}</p>
            </div>
            <div>
                <p class="text-xs text-slate-400 font-bold uppercase mb-1">Issues</p>
                <p class="text-rose-500 font-bold text-lg">${c.issue_type || '-'}</p>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div>
        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-2">Description</p>
        <p class="text-slate-600 text-base leading-relaxed whitespace-pre-wrap font-medium">"${c.comment}"</p>
    </div>

    <!-- Images -->
    ${imgs.length ? `
    <div>
        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-3">Attachments</p>
        <div class="grid grid-cols-3 gap-3">
            ${imgs.map(u => `<img src="${u}"
                onerror="this.onerror=null; this.src='https://via.placeholder.com/150?text=Image+Not+Found'"
                class="w-full h-32 object-cover rounded-2xl border-none shadow-sm cursor-pointer hover:scale-[1.02] transition-transform"
                onclick="window.open('${u}')">`).join('')}
        </div>
    </div>` : ''}

    <!-- Reply -->
    ${c.reply ? `
    <div class="bg-indigo-50/50 rounded-2xl p-6 border border-indigo-50 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-20 h-20 bg-indigo-100 rounded-bl-full opacity-50 pointer-events-none">
        </div>
        <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest mb-2">Response from Company</p>
        <p class="text-indigo-800 text-sm font-medium leading-relaxed">${c.reply}</p>
    </div>` : ''}

</div>
`;

            document.getElementById('detailModalContent').innerHTML = content;

            const modal = document.getElementById('complaintDetailModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex'); // Ensure flex is added for centering
            }
        }

        async function fetchMyComplaints() {
            const list = document.getElementById('complaintsList');
            if (!list) return;

            // Update UI for Edit Mode Reset
            if (!editingComplaintId) {
                const title = document.querySelector('#view-support h3.ink-brush-title');
                if (title) title.innerText = "New Request";
                const btn = document.querySelector('#view-support button[type="submit"]');
                if (btn) btn.innerText = "Submit Ticket";
            }

            try {
                const res = await fetch('/api/data/my_complaints', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (!res.ok || data.error) {
                    throw new Error(data.error || `Server Error: ${res.status}`);
                }

                // CHECK FOR REPLIES (Notification System)
                if (lastComplaints.length > 0) {
                    data.forEach(ticket => {
                        const oldTicket = lastComplaints.find(t => t.id === ticket.id);
                        // If we have an old version, and it had NO reply, but now HAS reply
                        if (oldTicket && !oldTicket.reply && ticket.reply) {
                            if (Notification.permission === "granted") {
                                new Notification("New Support Reply ðŸ’¬", {
                                    body: `Ticket #${ticket.id}: ${ticket.reply}`,
                                    icon: '/favicon.ico' // Optional
                                });
                            }
                        }
                    });
                }
                lastComplaints = data; // Update cache

                // GLOBAL DATA STORE (Fixes Click Issues)
                window.myComplaints = data;

                if (!Array.isArray(data) || data.length === 0) {
                    list.innerHTML = `
<div class="flex flex-col items-center justify-center h-full text-center p-8 opacity-60 col-span-full">
    <div
        class="w-32 h-32 bg-white rounded-full flex items-center justify-center mb-6 shadow-[inset_4px_4px_8px_rgba(0,0,0,0.05),_inset_-4px_-4px_8px_rgba(255,255,255,0.8)]">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" class="text-indigo-200" stroke="currentColor"
            stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
    </div>
    <h4 class="font-brand text-2xl font-bold text-slate-400 mb-2">No Tickets Yet</h4>
    <p class="text-sm text-slate-400 max-w-sm">Your feedback queue is empty. Relax! ðŸŒ¸</p>
</div>
`;
                    return;
                }

                list.innerHTML = data.map((c, index) => {
                    let imgs = [];
                    try { imgs = JSON.parse(c.image_url || '[]'); } catch (e) { }
                    if (!Array.isArray(imgs)) imgs = [c.image_url];

                    const isResolved = c.status === 'Resolved';
                    // Clay Colors
                    const statusClass = isResolved
                        ? 'bg-emerald-100 text-emerald-600'
                        : 'bg-amber-100 text-amber-600';

                    return `
<div onclick="viewComplaint(${index})"
    class="clay-card p-6 hover:-translate-y-1 transition-all duration-300 group flex flex-col relative overflow-hidden cursor-pointer h-full">

    <!-- Actions (Top Right) -->
    <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition-all duration-300 z-20">
        <button onclick="editComplaint(${index}); event.stopPropagation();"
            class="w-8 h-8 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-500 hover:bg-indigo-500 hover:text-white transition-all shadow-sm"
            title="Edit">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        </button>
        <button onclick="deleteComplaint(${c.id}); event.stopPropagation();"
            class="w-8 h-8 rounded-full bg-rose-50 flex items-center justify-center text-rose-500 hover:bg-rose-500 hover:text-white transition-all shadow-sm"
            title="Delete">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
        </button>
    </div>

    <!-- Header -->
    <div class="flex items-center gap-4 mb-4">
        <div
            class="w-12 h-12 rounded-2xl bg-indigo-50 flex items-center justify-center text-indigo-600 font-brand font-bold text-xl shrink-0">
            ${c.student_name ? c.student_name.charAt(0) : '?'}
        </div>
        <div>
            <h4 class="font-brand text-lg font-bold text-slate-700 leading-tight">${c.student_name || 'Unknown'}</h4>
            <p class="text-xs text-slate-400 font-bold mt-1">ID #${c.id}</p>
        </div>
    </div>

    <!-- Content -->
    <div class="space-y-3 mb-4 flex-1">
        ${c.pattern_name ? `
        <div>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Item</p>
            <p class="text-sm font-bold text-slate-600 line-clamp-1">${c.pattern_name}</p>
        </div>
        ` : ''}

        <div>
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-0.5">Issue</p>
            <p class="text-sm font-bold text-rose-500 line-clamp-2">${c.issue_type || 'Unspecified Issue'}</p>
        </div>
    </div>

    <!-- Footer -->
    <div class="pt-3 border-t border-slate-50 flex justify-between items-center mt-auto">
        <span class="px-3 py-1 rounded-lg text-[10px] font-extrabold uppercase tracking-wide ${statusClass}">
            ${isResolved ? 'Resolved' : 'Open'}
        </span>

        ${c.reply ? `
        <div class="text-[10px] font-bold text-indigo-400 uppercase tracking-wide flex items-center gap-1">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 21a8 8 0 0 1 13.292-6" />
                <circle cx="10" cy="8" r="5" />
                <path d="M19 16v6" />
                <path d="M22 19h-6" />
            </svg>
            Responded
        </div>
        ` : `<span class="text-[10px] text-slate-300 font-bold">${new Date(c.created_at).toLocaleDateString()}</span>`}
    </div>
</div>
`}).join('');

            } catch (e) {
                console.error(e);
                list.innerHTML = `
<div class="text-center p-8 text-rose-500 bg-rose-50 rounded-xl border border-rose-100 opacity-90">
    <svg class="w-10 h-10 mx-auto mb-2 text-rose-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    <p class="font-bold mb-1 font-ink">Connection Error</p>
    <p class="text-[10px] opacity-70 mb-3">${e.message || "Failed to load data"}</p>
    <button onclick="fetchMyComplaints()"
        class="px-4 py-2 bg-white border border-rose-200 rounded-full text-xs font-bold hover:bg-rose-100 transition-colors">Retry</button>
</div>
`;
            }
        }

        function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }

        // Start - Handled at bottom of file
        init();
    </script>

    <!-- COMPLAINT DETAIL MODAL (Manual Overlay) -->
    <div id="complaintDetailModal"
        class="hidden fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-white/20 relative opacity-100 scale-100">
            <div
                class="sticky top-0 bg-white/95 backdrop-blur-md z-10 px-6 py-4 border-b border-stone-100 flex justify-between items-center">
                <h3 class="font-ink text-lg text-stone-800">Application Full View</h3>
                <button onclick="document.getElementById('complaintDetailModal').classList.add('hidden')"
                    class="p-2 hover:bg-stone-100 rounded-full transition-colors"><svg width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg></button>
            </div>
            <div id="detailModalContent" class="p-6"></div>
        </div>
    </div>
    <!-- IMPORT MODAL -->
    <div id="importModal"
        class="hidden fixed inset-0 z-[100] bg-black/40 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col border border-white/20 animate-in zoom-in-95 duration-200">
            <!-- Header -->
            <div
                class="p-6 border-b border-stone-100 flex justify-between items-center bg-white/95 backdrop-blur-md rounded-t-2xl z-10">
                <div>
                    <h3 class="font-ink text-xl text-stone-800">Bulk Import Students</h3>
                    <p class="text-xs text-stone-400 font-bold uppercase tracking-wider mt-1">Excel â€¢ CSV â€¢ Manual Entry
                    </p>
                </div>
                <button onclick="document.getElementById('importModal').classList.add('hidden')"
                    class="w-8 h-8 rounded-full bg-stone-100 hover:bg-stone-200 flex items-center justify-center transition-colors">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-hidden flex flex-col p-6 bg-stone-50/50 relative">

                <!-- VIEW 1: LIST & UPLOAD -->
                <div id="importListView" class="flex flex-col h-full">
                    <!-- File Upload Area -->
                    <div class="mb-6 shrink-0">
                        <div class="border-2 border-dashed border-indigo-200 rounded-2xl p-6 text-center hover:bg-indigo-50/50 transition-colors cursor-pointer bg-white"
                            onclick="document.getElementById('multiFileImport').click()" ondrop="handleDrop(event)"
                            ondragover="event.preventDefault()">
                            <input type="file" id="multiFileImport" multiple accept=".xlsx, .xls, .csv" class="hidden"
                                onchange="handleFileSelection(event)">
                            <div class="flex items-center justify-center gap-4">
                                <div
                                    class="w-10 h-10 bg-indigo-100 text-indigo-500 rounded-xl flex items-center justify-center">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                                <div class="text-left">
                                    <h4 class="font-bold text-stone-700 text-sm">Upload Excel Files</h4>
                                    <p class="text-stone-400 text-xs">Drag & Drop or Click to Browse</p>
                                </div>
                            </div>
                        </div>
                        <!-- Selected Files List -->
                        <div id="importFileList" class="flex flex-wrap gap-2 mt-3"></div>
                    </div>

                    <!-- Actions -->
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-3 shrink-0">
                        <div class="flex items-center gap-3">
                            <h4 class="font-bold text-stone-700">Data Preview</h4>
                            <span id="previewCount"
                                class="px-2 py-1 rounded-md bg-stone-100 text-xs font-bold text-stone-500">0
                                Records</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showManualEntryForm()"
                                class="px-4 py-2 bg-white border border-stone-200 rounded-lg text-sm font-bold text-stone-600 hover:bg-stone-50 hover:text-indigo-600 transition-colors shadow-sm flex items-center gap-2">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Manually
                            </button>
                            <button onclick="clearImportdata()"
                                class="px-4 py-2 bg-white border border-rose-200 rounded-lg text-sm font-bold text-rose-500 hover:bg-rose-50 transition-colors shadow-sm">
                                Clear All
                            </button>
                        </div>
                    </div>

                    <!-- Preview Table (Expanded Height) -->
                    <div
                        class="flex-1 overflow-auto bg-white rounded-xl border border-stone-200 shadow-sm relative custom-scrollbar min-h-[300px]">
                        <table class="w-full text-left border-collapse text-sm">
                            <thead class="bg-stone-50 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Roll No
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Name
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Gender
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Class
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Section
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">House
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap">Adm No
                                    </th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs whitespace-nowrap w-24">
                                        Status</th>
                                    <th class="p-3 font-bold text-stone-500 uppercase text-xs w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="importPreviewBody" class="divide-y divide-stone-100">
                                <!-- Rows -->
                                <tr id="emptyPreviewState">
                                    <td colspan="9" class="p-20 text-center">
                                        <div class="flex flex-col items-center opacity-50">
                                            <div
                                                class="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mb-4 text-stone-400">
                                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="1.5">
                                                    <path
                                                        d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z">
                                                    </path>
                                                    <polyline points="14 2 14 8 20 8"></polyline>
                                                    <line x1="12" y1="18" x2="12" y2="12"></line>
                                                    <line x1="9" y1="15" x2="15" y1="15"></line>
                                                </svg>
                                            </div>
                                            <p class="font-bold text-stone-400 text-lg">Empty List</p>
                                            <p class="text-stone-400 text-sm">Upload a file or add students manually</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            ```
                        </table>
                    </div>
                </div>

                <!-- VIEW 2: MANUAL ENTRY FORM -->
                <div id="manualEntryForm" class="hidden h-full flex flex-col min-h-0">
                    <div class="flex items-center justify-between mb-6 shrink-0">
                        <h4 class="font-bold text-xl text-stone-800">Add New Student</h4>
                        <button onclick="hideManualEntryForm()"
                            class="text-stone-400 hover:text-stone-600 font-bold text-sm">Back to List</button>
                    </div>

                    <div
                        class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start flex-1 overflow-y-auto pr-2 pb-32 min-h-0 custom-scrollbar">
                        <!-- Name -->
                        <div class="col-span-1 lg:col-span-2 space-y-2">
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Student Name
                                <span class="text-rose-500">*</span></label>
                            <input type="text" id="m_name"
                                class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all placeholder:font-normal"
                                placeholder="e.g. Aditi Sharma">
                        </div>

                        <!-- Basic Details -->
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Roll
                                Number</label>
                            <input type="text" id="m_roll"
                                class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                                placeholder="e.g. 24">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Admission
                                No.</label>
                            <input type="text" id="m_adm"
                                class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                                placeholder="e.g. R-2024-001">
                        </div>

                        <!-- Class & Section (Side-by-side) -->
                        <div class="col-span-1 lg:col-span-2 grid grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Class</label>
                                <input type="text" id="m_class"
                                    class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                                    placeholder="e.g. X">
                            </div>
                            <div class="space-y-2">
                                <label
                                    class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Section</label>
                                <input type="text" id="m_sec"
                                    class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                                    placeholder="e.g. A">
                            </div>
                        </div>

                        <!-- Extras -->
                        <div class="space-y-2">
                            <label
                                class="block text-xs font-bold text-stone-400 uppercase tracking-wider">Gender</label>
                            <select id="m_gender"
                                class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 cursor-pointer">
                                <option value="-">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-stone-400 uppercase tracking-wider">House</label>
                            <input type="text" id="m_house"
                                class="w-full bg-white border-2 border-stone-200 rounded-xl px-4 py-3 font-bold text-stone-700 outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all"
                                placeholder="e.g. Blue House">
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-stone-200 flex justify-end gap-3">
                        <button onclick="hideManualEntryForm()"
                            class="px-6 py-3 rounded-xl font-bold text-stone-500 hover:bg-stone-100 transition-colors">Cancel</button>
                        <button onclick="saveManualEntry()"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-400 transition-all flex items-center gap-2">
                            <span>Add Student</span>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M5 12h14M12 5v14" />
                            </svg>
                        </button>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div id="importModalFooter"
                class="p-6 border-t border-stone-100 bg-white rounded-b-2xl flex justify-end gap-3 z-10">
                <button onclick="document.getElementById('importModal').classList.add('hidden')"
                    class="px-6 py-2.5 rounded-xl font-bold text-stone-500 hover:bg-stone-100 transition-colors">Cancel</button>
                <button onclick="processUpload()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:shadow-indigo-400 transition-all flex items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <span>Import Students</span>
                </button>
            </div>
        </div>
    </div>
    <!-- EDIT STUDENT MODAL -->
    <dialog id="editStudentModal" class="bg-transparent">
        <div class="fixed inset-0 flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm z-50">
            <div
                class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden animate-in zoom-in-95 duration-200">
                <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-indigo-50/30">
                    <h3 class="font-brand text-lg font-bold text-slate-800">Edit Student</h3>
                    <button onclick="document.getElementById('editStudentModal').close()"
                        class="w-8 h-8 rounded-full bg-white hover:bg-slate-100 text-slate-400 hover:text-rose-500 flex items-center justify-center transition-colors shadow-sm">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" />
                        </svg>
                    </button>
                </div>
                <div class="p-8 space-y-6">
                    <input type="hidden" id="edit_original_adm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Name</label>
                            <input type="text" id="edit_name"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Admission
                                No</label>
                            <input type="text" id="edit_adm"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Roll
                                No</label>
                            <input type="text" id="edit_roll"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Gender</label>
                            <select id="edit_gender"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Class</label>
                            <input type="text" id="edit_class"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">Section</label>
                            <input type="text" id="edit_sec"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-extrabold text-slate-400 uppercase tracking-wider mb-2">House</label>
                            <input type="text" id="edit_house"
                                class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-end gap-3">
                    <button onclick="document.getElementById('editStudentModal').close()"
                        class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-white transition-all">Cancel</button>
                    <button onclick="saveStudentEdit()"
                        class="px-6 py-2.5 rounded-xl bg-indigo-500 hover:bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 transition-all transform active:scale-95">Save
                        Changes</button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- ID CARD MODAL -->
    <dialog id="idCardModal" class="bg-transparent">
        <div class="fixed inset-0 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm z-50">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-sm max-h-[90vh] overflow-y-auto overflow-x-hidden animate-in zoom-in-95 duration-200 border-4 border-white">
                <!-- ID Card Content -->
                <div id="printableIdCard" class="bg-slate-50 relative overflow-hidden">
                    <!-- Background blobs -->
                    <div
                        class="absolute top-[-50px] right-[-50px] w-32 h-32 bg-indigo-200 rounded-full mix-blend-multiply filter blur-xl opacity-70">
                    </div>
                    <div
                        class="absolute bottom-[-50px] left-[-50px] w-32 h-32 bg-pink-200 rounded-full mix-blend-multiply filter blur-xl opacity-70">
                    </div>

                    <div class="p-6 flex flex-col items-center relative z-10">
                        <!-- School Header -->
                        <div class="text-center mb-6">
                            <h2 class="text-xl font-brand font-black text-slate-800 uppercase tracking-tight"
                                id="idSchoolName">School Name</h2>
                            <p class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">Student Identity
                                Card</p>
                        </div>

                        <!-- Photo Placeholder -->
                        <div
                            class="w-24 h-24 rounded-full bg-gradient-to-br from-indigo-100 to-white shadow-inner flex items-center justify-center mb-4 ring-4 ring-white">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#6366f1"
                                stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>

                        <!-- Student Details -->
                        <div class="text-center space-y-1 mb-6">
                            <h3 class="text-2xl font-black text-slate-800" id="idName">Student Name</h3>
                            <p class="text-sm font-bold text-slate-500" id="idClass">Class X - A</p>
                            <p class="text-xs font-mono text-slate-400" id="idRoll">Roll: 123</p>
                        </div>

                        <!-- Info Grid -->
                        <div class="w-full grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-white p-3 rounded-xl shadow-sm text-center">
                                <p class="text-[10px] text-slate-400 font-bold uppercase">Admission No</p>
                                <p class="font-mono font-bold text-slate-700 text-sm" id="idAdm">0000</p>
                            </div>
                            <div class="bg-white p-3 rounded-xl shadow-sm text-center">
                                <p class="text-[10px] text-slate-400 font-bold uppercase">House</p>
                                <p class="font-bold text-slate-700 text-sm" id="idHouse">-</p>
                            </div>
                        </div>

                        <!-- Extra Details: Status & Measurements -->
                        <div class="w-full bg-white p-3 rounded-xl shadow-sm mb-6 border border-slate-50">
                            <div class="flex justify-between items-center mb-3 border-b border-indigo-50 pb-2">
                                <span
                                    class="text-[10px] text-indigo-300 font-bold uppercase tracking-wider">Status</span>
                                <span id="idStatus"
                                    class="px-2 py-0.5 rounded-md text-[10px] font-bold bg-slate-100 text-slate-500 uppercase tracking-wide">Pending</span>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] text-indigo-300 font-bold uppercase tracking-wider mb-2">
                                    Measurements
                                </p>
                                <div class="space-y-1 text-center font-mono text-xs font-bold text-slate-600 min-h-[40px]"
                                    id="idMeasurements">
                                    <!-- Dynamic Dress Details -->
                                </div>
                            </div>
                        </div>

                        <!-- QR Code (Client Side Optimised) -->
                        <div class="bg-white p-2 rounded-xl shadow-sm flex justify-center items-center min-h-[120px]">
                            <div id="idQrCodeContainer"></div>
                        </div>
                        <p class="text-[9px] text-slate-300 mt-2 font-mono">Scan to view full details</p>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div class="p-4 border-t border-slate-100 flex justify-between bg-white">
                    <button onclick="document.getElementById('idCardModal').close()"
                        class="text-slate-400 hover:text-slate-600 font-bold text-sm px-4">Close</button>
                    <button onclick="downloadIdCard()" title="Download Card"
                        class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold text-sm shadow-lg shadow-indigo-200 hover:shadow-indigo-400 transition-all flex items-center gap-2">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download PDF
                    </button>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Undo Toast -->
    <div id="undoToast"
        class="fixed bottom-6 right-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div class="bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4">
            <span id="undoMsg" class="font-medium">Items deleted</span>
            <button onclick="undoDelete()"
                class="px-3 py-1 bg-white/10 hover:bg-white/20 rounded-lg text-sm font-bold text-indigo-300 hover:text-indigo-200 transition-colors pointer-events-auto">UNDO</button>
            <button onclick="dismissUndo()" class="text-slate-400 hover:text-white pointer-events-auto">&times;</button>
        </div>
    </div>

    <!-- Batch QR Modal -->
    <dialog id="batchQrModal" class="bg-transparent">
        <div class="fixed inset-0 flex items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm z-50">
            <div
                class="bg-white rounded-3xl shadow-2xl w-full max-w-sm max-h-[85vh] overflow-y-auto animate-in zoom-in-95 duration-200 border-4 border-white p-6 text-center">
                <h3 class="text-xl font-black text-slate-800 uppercase tracking-tight mb-2">Filtered View QR</h3>
                <p class="text-xs text-slate-500 mb-6">Scan to open this filtered list on mobile</p>

                <!-- PIN Input Moved to Settings -->
                <p class="text-xs text-slate-400 mb-4 italic" id="activePinDisplay">Using Default PIN</p>

                <div
                    class="bg-white p-3 rounded-xl shadow-inner border border-slate-100 inline-block mb-4 flex justify-center">
                    <div id="batchQrContainer"></div>
                </div>

                <div id="batchQrInfo" class="text-xs font-mono text-slate-400 mb-6 space-y-1"></div>

                <div class="flex gap-3">
                    <button onclick="document.getElementById('batchQrModal').close()"
                        class="flex-1 py-3 rounded-xl bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold transition-all">Close</button>
                    <button onclick="downloadBatchQr()"
                        class="flex-1 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-bold shadow-lg shadow-indigo-200 transition-all">Download</button>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        function generateBatchQr() {
            // Get current filter values safely
            const clsSelect = document.getElementById('filter_class');
            const secSelect = document.getElementById('filter_section');
            const houseSelect = document.getElementById('filter_house');

            const cls = clsSelect ? clsSelect.value : '';
            const sec = secSelect ? secSelect.value : '';
            const house = houseSelect ? houseSelect.value : '';
            const school = sessionStorage.getItem('schoolName') || 'Unknown School';

            // Setup Payload for QR
            const payload = {
                s: school,
                f: { c: cls, sec: sec, h: house },
                t: Date.now()
            };

            // Encode JSON
            const json = JSON.stringify(payload);
            // using api.qrserver.com
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(json)}`;

            document.getElementById('batchQrImg').src = url;
            document.getElementById('batchQrInfo').innerHTML = `
                <p class="font-bold text-slate-600">School: ${school}</p>
                <div class="border-t border-slate-100 my-2 pt-2">
                    <p>Class: <span class="text-slate-600 font-bold">${cls || 'All'}</span></p>
                    <p>Section: <span class="text-slate-600 font-bold">${sec || 'All'}</span></p>
                    <p>House: <span class="text-slate-600 font-bold">${house || 'All'}</span></p>
                </div>
            `;

            document.getElementById('batchQrModal').showModal();
        }

        async function downloadBatchQr() {
            const imgParams = document.getElementById('batchQrImg').src;
            if (!imgParams) return;

            try {
                // Fetch image as blob to allow download with custom filename
                const response = await fetch(imgParams);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;

                // Construct Filename
                const cls = document.getElementById('filter_class').value || 'All';
                const sec = document.getElementById('filter_section').value || 'All';
                link.download = `QR_Class-${cls}_Sec-${sec}_${Date.now()}.png`;

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);
            } catch (err) {
                console.error("Download failed", err);
                alert("Could not download image. Try right-click > Save Image As.");
            }
        }
    </script>
    <script>
        // == OVERRIDE FUNCTIONS FOR CLIENT-SIDE QR & PDF (Unique Item List) ==
        // This script block redefines the functions to ensure latest logic is used.

        // Global QR Object
        window.qrCodeObj = null;

        // 1. INJECT SETTINGS MODAL - REMOVED (Replaced by Page Settings)

        // 3. QR GENERATION
        window.generateBatchQr = function () {
            const clsSelect = document.getElementById('filter_class');
            const secSelect = document.getElementById('filter_section');
            const houseSelect = document.getElementById('filter_house');

            const cls = clsSelect ? clsSelect.value : '';
            const sec = secSelect ? secSelect.value : '';
            const house = houseSelect ? houseSelect.value : '';
            const school = sessionStorage.getItem('schoolName') || 'Unknown School';

            // Use Stored PIN
            const userPin = localStorage.getItem('default_qr_pin') || '1234';

            const payload = {
                s: school,
                f: { c: cls, sec: sec, h: house },
                p: userPin,
                t: Date.now()
            };

            const json = JSON.stringify(payload);

            // Update UI to show active PIN
            const pinDisplay = document.getElementById('activePinDisplay');
            if (pinDisplay) pinDisplay.innerText = `Active Access PIN: ${userPin}`;

            // Robust Container Finding
            let container = document.getElementById('batchQrContainer');
            if (!container) {
                const img = document.getElementById('batchQrImg');
                if (img) {
                    container = img.parentNode;
                    container.id = 'batchQrContainer';
                    container.innerHTML = '';
                }
            }

            if (!container) {
                console.error("QR Container missing");
                return;
            }

            container.innerHTML = ''; // Clear

            try {
                window.qrCodeObj = new QRCode(container, {
                    text: json,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                container.style.display = 'flex';
                container.style.justifyContent = 'center';

            } catch (e) {
                console.error("QRCode Lib Error", e);
                container.innerText = "Error loading QR Lib";
            }

            document.getElementById('batchQrInfo').innerHTML = `
            <p class="font-bold text-slate-600">School: ${school}</p>
            <div class="border-t border-slate-100 my-2 pt-2">
                <p>Class: <span class="text-slate-600 font-bold">${cls || 'All'}</span></p>
                <p>Section: <span class="text-slate-600 font-bold">${sec || 'All'}</span></p>
                <div class="mt-2 text-xs text-slate-400">
                     Generated: ${new Date().toLocaleDateString()}
                </div>
            </div>
        `;

            document.getElementById('batchQrModal').showModal();
        };

        window.downloadBatchQr = function () {
            if (!window.jspdf) {
                alert("PDF Library loading... Try again in a second.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const school = sessionStorage.getItem('schoolName') || 'Unknown School';
            const cls = document.getElementById('filter_class').value || '';
            const sec = document.getElementById('filter_section').value || '';
            const house = document.getElementById('filter_house').value || '';
            const date = new Date().toLocaleDateString();

            // --- CALCULATE SUMMARY DATA ---
            // Filter students to get accurate count and items
            // Filter students to get accurate count and items (Loose Matching)
            const filteredStudents = allStudents.filter(s => {
                const matchClass = cls === '' || (String(s.class || '').trim() == cls);
                const matchSec = sec === '' || (String(s.section || '').trim() == sec);
                const matchHouse = house === '' || s.house === house;
                return matchClass && matchSec && matchHouse;
            });

            // DEBUGGING: Warn if Logic Fails
            if (filteredStudents.length === 0) {
                alert(`DEBUG: No Students Found!\nFilter Class: "${cls}"\nFilter Section: "${sec}"\nTotal in DB: ${allStudents.length}\nSample Student Class: "${allStudents[0]?.class || 'N/A'}"`);
                // Don't return, let it generate empty PDF so user sees the "0"
            }

            // Extract unique measurement items (Dress Names)
            const uniqueItems = new Set();
            filteredStudents.forEach(s => {
                if (s.measurements && Array.isArray(s.measurements)) {
                    s.measurements.forEach(m => {
                        if (m.name) uniqueItems.add(m.name);
                    });
                }
            });
            const itemsList = Array.from(uniqueItems).join(', ');

            // --- GENERATE PDF ---
            // Header
            doc.setFontSize(18);
            doc.setFont("helvetica", "bold");
            doc.text(school, 105, 20, { align: "center" });

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text("Filtered Student List QR", 105, 28, { align: "center" });

            // Filter Box
            doc.setDrawColor(200);
            doc.setFillColor(245, 247, 250);
            doc.rect(20, 35, 170, 50, 'FD'); // Expanded box

            doc.setTextColor(60);
            doc.setFontSize(11);
            doc.text("View Context:", 30, 45);

            doc.setFont("helvetica", "bold");
            doc.text(`Date: ${date}`, 140, 45);

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.text(`â€¢ Class: ${cls || 'All'}`, 30, 55);
            doc.text(`â€¢ Section: ${sec || 'All'}`, 30, 62);
            doc.text(`â€¢ House: ${house || 'All'}`, 30, 69);

            doc.setFont("helvetica", "bold");
            doc.text(`Total Students: ${filteredStudents.length}`, 100, 55);

            // Uniform Items Section
            if (itemsList) {
                doc.setFont("helvetica", "bold");
                doc.text("Uniform Items:", 100, 62);
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                // Split long text
                const splitProps = doc.splitTextToSize(itemsList, 80);
                doc.text(splitProps, 100, 67);
            }

            // QR Image Extraction
            const container = document.getElementById('batchQrContainer');
            let imgData = null;
            if (container) {
                // Try canvas first (QRCode.js default)
                const canvas = container.querySelectorAll('canvas')[0];
                const img = container.querySelectorAll('img')[0];

                if (canvas) {
                    try {
                        imgData = canvas.toDataURL("image/png");
                    } catch (e) { console.warn("Canvas Taint", e); }
                }
                else if (img && img.src.startsWith('data:')) {
                    imgData = img.src;
                }
                else if (img && img.src) {
                    // If it's an external URL (unlikely with qrcode.js but possible fallback)
                    // We can't draw raw URL to PDF easily without proxy. 
                    // But we are using client-side lib now.
                    imgData = img.src;
                }
            }

            if (imgData) {
                try {
                    doc.addImage(imgData, 'PNG', 75, 100, 60, 60);
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    doc.text("Scan to open filtered list.", 105, 170, { align: "center" });

                    // Footer 
                    doc.setFontSize(8);
                    doc.text("Generated via School Dashboard", 105, 280, { align: "center" });

                    // Save
                    doc.save(`Filter_QR_${cls}_${sec}_${Date.now()}.pdf`);
                } catch (pdfErr) {
                    console.error("PDF generation error", pdfErr);
                    alert("Error adding QR to PDF.");
                }
            } else {
                alert("QR Code image not found!");
            }
        };
    </script>

</body>

</html>