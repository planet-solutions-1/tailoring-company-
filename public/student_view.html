<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Access | School Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- SECURITY GATE MODAL -->
    <dialog id="securityModal" class="bg-transparent backdrop:bg-slate-900/90" open>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center animate-in zoom-in-95">
                <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold mb-2">Secure Access Required</h2>
                <p class="text-slate-500 text-sm mb-6">Enter the School Access Code to view this list.</p>

                <input type="password" id="accessPinInput" placeholder="Enter PIN"
                    class="w-full text-center text-2xl tracking-[0.5em] font-bold p-3 border rounded-xl mb-4 focus:ring-2 focus:ring-slate-400 outline-none">

                <button onclick="verifyPin()"
                    class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 transition">Unlock
                    View</button>
                <p id="pinError" class="text-rose-500 text-xs font-bold mt-3 hidden">Incorrect Access Code</p>
            </div>
        </div>
    </dialog>

    <!-- CONTENT (Hidden by default) -->
    <div id="mainContent" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-lg font-bold text-slate-800">Student List View</h1>
                <p class="text-xs text-slate-500" id="filterContext">Loading context...</p>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadPdf()"
                    class="px-4 py-2 bg-rose-50 text-rose-600 rounded-lg text-sm font-bold hover:bg-rose-100 transition">PDF</button>
                <button onclick="window.close()"
                    class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-bold hover:bg-slate-200 transition">Close</button>
            </div>
        </div>

        <!-- Data Display -->
        <div class="flex-1 p-4 overflow-auto">
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Class</th>
                            <th class="px-4 py-3">Section</th>
                            <th class="px-4 py-3 text-right">View</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="divide-y divide-slate-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // === SECURITY LOGIC ===
        let CORRECT_PIN = "1234"; // Default fallback
        let filters = {};

        // 1. DATA PRE-LOAD & PIN EXTRACTION
        try {
            const params = new URLSearchParams(window.location.search);
            const filterStr = params.get('filters');
            if (filterStr) {
                filters = JSON.parse(decodeURIComponent(filterStr));

                // Serverless Dynamic PIN from QR Payload
                if (filters.p && filters.p.toString().trim() !== "") {
                    CORRECT_PIN = filters.p.toString().trim();
                    console.log("Using custom QR PIN");
                }
            }
        } catch (e) { console.error("URL Params Parse Error", e); }

        function verifyPin() {
            const input = document.getElementById('accessPinInput').value;
            if (input.trim() === CORRECT_PIN) {
                document.getElementById('securityModal').close();
                document.getElementById('securityModal').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
            } else {
                document.getElementById('pinError').classList.remove('hidden');
                document.getElementById('accessPinInput').value = '';
                document.getElementById('accessPinInput').focus();
            }
        }

        // === DATA LOGIC ===
        async function loadData() {
            // Check for Individual Student Context first
            const params = new URLSearchParams(window.location.search);
            const studentStr = params.get('student');

            if (studentStr) {
                try {
                    const studentObj = JSON.parse(decodeURIComponent(studentStr));
                    renderStudentCard(studentObj);
                    return; // Stop table loading
                } catch (e) { console.error("Student parse error", e); }
            }

            // Normal List Context (Mobile Scan View)
            document.getElementById('filterContext').innerText = `Class: ${filters.c || 'All'} â€¢ Section: ${filters.sec || 'All'}`;

            // FETCH REAL DATA
            const query = new URLSearchParams({
                class: filters.c || '',
                section: filters.sec || '',
                // house: filters.h // Optional
            }).toString();

            try {
                const res = await fetch(`/api/public/students?${query}`);
                if (!res.ok) throw new Error("Server Error");
                const students = await res.json();

                if (students.length > 0) {
                    renderTable(students);
                } else {
                    document.getElementById('studentTableBody').innerHTML = `
                        <tr><td colspan="4" class="p-8 text-center text-slate-400">
                            No students found for this class/section.<br>
                            <span class="text-xs">Ensure data is synced from Dashboard.</span>
                        </td></tr>`;
                }
            } catch (e) {
                console.warn("Fetch Error, falling back to Demo if Local", e);
                // Fallback for Local/Demo Mode
                const mockStudents = [
                    { name: "Demo Student 1", class: filters.c || "10", section: filters.sec || "A" },
                    { name: "Demo Student 2", class: filters.c || "10", section: filters.sec || "A" }
                ];
                renderTable(mockStudents);
                document.getElementById('filterContext').innerHTML += ` <span class="text-rose-400 font-bold">(Demo Data - Server Unreachable)</span>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('studentTableBody');
            tbody.innerHTML = data.map(s => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="px-4 py-3 font-medium text-slate-800">${s.name}</td>
                    <td class="px-4 py-3 text-slate-500">${s.class}</td>
                    <td class="px-4 py-3 text-slate-500">${s.section}</td>
                    <td class="px-4 py-3 text-right">
                        <button class="text-indigo-600 font-bold hover:underline">Details</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderStudentCard(s) {
            const container = document.getElementById('studentTableBody').parentElement;
            // Clear table and show card
            container.innerHTML = `
                <div class="p-8 flex flex-col items-center text-center">
                    <div class="w-24 h-24 bg-indigo-100 rounded-full flex items-center justify-center mb-4 text-3xl">ðŸŽ“</div>
                    <h2 class="text-2xl font-black text-slate-800 mb-1">${s.n || 'Unknown'}</h2>
                    <p class="text-lg font-bold text-slate-500 mb-4">${s.c || '-'} ${s.s ? '(' + s.s + ')' : ''}</p>
                    
                    <div class="grid grid-cols-2 gap-4 w-full max-w-xs mb-6">
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="text-xs uppercase font-bold text-slate-400">ADM NO</p>
                            <p class="font-mono font-bold text-slate-700">${s.id || '--'}</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <p class="text-xs uppercase font-bold text-slate-400">STATUS</p>
                            <p class="font-bold text-indigo-600">${s.st || 'Unknown'}</p>
                        </div>
                    </div>

                    <div class="w-full max-w-xs space-y-3">
                         <div class="p-3 bg-amber-50 text-amber-700 text-xs rounded-lg">
                            Measurements not stored in QR. <br>Login to view full details.
                         </div>
                         <button onclick="window.location.href='index.html'" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800">
                            Admin Login (Update)
                         </button>
                    </div>
                </div>
            `;
            document.getElementById('filterContext').innerText = "Individual Student View";
        }

        async function downloadPdf() {
            const content = document.getElementById('mainContent');
            const btn = document.querySelector('button[onclick="downloadPdf()"]');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";

            try {
                // Ensure everything rendered
                await new Promise(r => setTimeout(r, 500));

                const canvas = await html2canvas(content, {
                    scale: 2,
                    useCORS: true,
                    ignoreElements: (el) => el.tagName === 'BUTTON' || el.id === 'securityModal' // Hide buttons in PDF
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;

                // Fit to A4 Height or Width logic
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();

                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save("Student_View_Export.pdf");
            } catch (err) {
                console.error(err);
                alert("PDF Error: " + err.message);
            } finally {
                btn.innerText = originalText;
            }
        }

        // Auto-Focus Pin
        document.getElementById('accessPinInput').focus();
    </script>
</body>

</html>