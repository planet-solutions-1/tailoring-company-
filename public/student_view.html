<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Access | School Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    boxShadow: {
                        'clay': '8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff',
                        'clay-sm': '4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff',
                        'clay-inset': 'inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff'
                    },
                    colors: {
                        surface: '#eef2f6'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #eef2f6;
        }

        /* Clay Base Color */
        .clay-card {
            background: #eef2f6;
            border-radius: 24px;
            box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
        }

        .clay-btn {
            background: #eef2f6;
            border-radius: 12px;
            box-shadow: 5px 5px 10px #d1d9e6, -5px -5px 10px #ffffff;
            transition: all 0.2s ease;
        }

        .clay-btn:active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            transform: scale(0.98);
        }
    </style>
</head>

<body class="text-slate-700">

    <!-- SECURITY GATE MODAL -->
    <dialog id="securityModal" class="bg-transparent backdrop:bg-slate-900/80" open>
        <div class="fixed inset-0 flex items-center justify-center p-4">
            <div class="clay-card p-8 text-center animate-in zoom-in-95 w-full max-w-sm">
                <div
                    class="w-16 h-16 rounded-full clay-btn flex items-center justify-center mx-auto mb-6 text-slate-500">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold mb-2 text-slate-800">Secure Access</h2>
                <p class="text-slate-500 text-sm mb-6">Enter School PIN</p>

                <input type="password" id="accessPinInput" placeholder="PIN"
                    class="w-full text-center text-2xl tracking-[0.5em] font-bold p-4 rounded-xl mb-6 outline-none shadow-clay-inset bg-surface text-slate-700 placeholder-slate-300">

                <button onclick="verifyPin()"
                    class="w-full clay-btn py-4 font-bold text-indigo-600 hover:text-indigo-700">Unlock View</button>

                <p id="pinError" class="text-rose-500 text-xs font-bold mt-4 hidden">Incorrect PIN</p>
            </div>
        </div>
    </dialog>

    <!-- CONTENT (Hidden by default) -->
    <!-- CONTENT -->
    <div id="mainContent" class="hidden min-h-screen flex flex-col p-4 md:p-6 gap-6 max-w-5xl mx-auto w-full">
        <!-- Header -->
        <div class="clay-card px-6 py-5 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-4 z-10">
            <div class="text-center md:text-left">
                <h1 class="text-xl font-extrabold text-slate-800 tracking-tight">Student Data</h1>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mt-1" id="filterContext">Loading...
                </p>
            </div>
            <div class="flex gap-3">
                <button onclick="downloadPdf()"
                    class="clay-btn px-4 py-2 text-rose-500 font-bold text-sm flex items-center gap-2">
                    <span>PDF</span>
                </button>
                <button onclick="downloadExcel()"
                    class="clay-btn px-4 py-2 text-emerald-600 font-bold text-sm flex items-center gap-2">
                    <span>Excel</span>
                </button>
                <button onclick="window.close()" class="clay-btn px-4 py-2 text-slate-500 font-bold text-sm">
                    Close
                </button>
            </div>
        </div>

        <!-- LIST VIEW -->
        <div id="listView" class="flex-1 clay-card p-4 overflow-hidden flex flex-col">
            <div class="overflow-auto rounded-xl">
                <table class="w-full text-sm text-left">
                    <thead
                        class="text-slate-400 font-bold uppercase text-[10px] tracking-wider border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3">Name</th>
                            <th class="px-4 py-3">Class</th>
                            <th class="px-4 py-3 text-right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="divide-y divide-slate-100">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DETAIL VIEW (Hidden by Default) -->
        <div id="detailView"
            class="hidden flex-1 clay-card p-6 md:p-10 flex flex-col items-center text-center animate-in slide-in-from-right-8">
            <!-- Content Injected Here -->
        </div>
    </div>

    <script>
        // === SECURITY LOGIC ===
        let CORRECT_PIN = "1234"; // Default fallback
        let filters = {};

        // 1. DATA PRE-LOAD & PIN EXTRACTION
        try {
            const params = new URLSearchParams(window.location.search);
            const filterStr = params.get('filters');

            // Allow PIN override via URL param 'p' (for Individual QR)
            const paramPin = params.get('p');
            if (paramPin) {
                CORRECT_PIN = paramPin;
            }

            if (filterStr) {
                filters = JSON.parse(decodeURIComponent(filterStr));

                // Serverless Dynamic PIN from QR Payload (Batch QR)
                if (filters.p && String(filters.p).trim() !== "") {
                    CORRECT_PIN = String(filters.p).trim();
                }
            }
        } catch (e) { console.error("URL Error", e); }

        function verifyPin() {
            const input = document.getElementById('accessPinInput').value;
            if (input.trim() === CORRECT_PIN) {
                document.getElementById('securityModal').close();
                document.getElementById('securityModal').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
            } else {
                document.getElementById('pinError').classList.remove('hidden');
                document.getElementById('accessPinInput').value = '';
                document.getElementById('accessPinInput').focus();
            }
        }

        // === DATA LOGIC ===
        async function loadData() {
            const params = new URLSearchParams(window.location.search);

            // 1. Direct Student Object (Legacy/Backup)
            const studentStr = params.get('student');
            if (studentStr) {
                try {
                    const studentObj = JSON.parse(decodeURIComponent(studentStr));
                    renderStudentCard(studentObj);
                    return;
                } catch (e) { console.error("Student parse error", e); }
            }

            // 2. Extract Direct Parameters (New Dynamic QR)
            const adm = params.get('adm');
            const sid = params.get('sid');
            const sName = params.get('s');

            // Merge into filters if present
            if (sid) filters.sid = sid;
            if (sName) filters.s = decodeURIComponent(sName);

            // Context Display
            const schoolName = filters.s || 'School Data';

            if (adm) {
                document.getElementById('filterContext').innerText = `${schoolName} ‚Ä¢ Ref: ${adm}`;
            } else {
                const contextText = `${schoolName} ‚Ä¢ Class: ${filters.c || 'All'} ‚Ä¢ Sec: ${filters.sec || 'All'}`;
                document.getElementById('filterContext').innerText = contextText;
            }

            // FETCH REAL DATA
            // If we have an ID, we still fetch by School ID (and maybe class if we had it, but for single lookup we likely just have ID)
            // Best approach: Fetch all for school (filtered by class if available in filters, otherwise all)
            // Note: If fetching ALL students is heavy, we should optimize API to support ?adm=...
            // For now, we assume standard fetch.

            const query = new URLSearchParams({
                class: filters.c || '',
                section: filters.sec || '',
                house: filters.h || '',
                sid: filters.sid || ''
            }).toString();

            try {
                const res = await fetch(`/api/public/students?${query}`);
                if (!res.ok) throw new Error("Load Failed");
                let students = await res.json();
                window.fetchedStudents = students;

                // 2.1 Filter by Admission Number if provided
                if (adm) {
                    const target = students.find(s => String(s.admission_no) === String(adm) || String(s.temp_id) === String(adm) || String(s.id) === String(adm));

                    if (target) {
                        // Directly Show Details
                        renderStudentCard(target);
                        return;
                    } else {
                        // Not found
                        alert("Student not found in this list. Please check the school/class selection.");
                        // Fallback to table view or empty state
                    }
                }

                // Standard List Render
                if (students.length > 0) {
                    renderTable(students);
                } else {
                    document.getElementById('studentTableBody').innerHTML = `
                        <tr><td colspan="3" class="p-8 text-center text-slate-400">
                            No students found.<br>
                            <span class="text-xs">Ensure data is synced.</span>
                        </td></tr>`;
                }
            } catch (e) {
                console.warn("Demo Fallback", e);
                // Fallback for Local/Demo Mode
                if (adm) {
                    // Mock Single
                    const mock = { name: "Demo Student", class: "10", section: "A", admission_no: adm, id: adm };
                    renderStudentCard(mock);
                } else {
                    const mockStudents = Array(5).fill(0).map((_, i) => ({
                        name: `Demo Student ${i + 1}`, class: filters.c || "10", section: filters.sec || "A",
                        measurements: [{ Item: "Shirt", Size: "32" }, { Item: "Pant", Size: 30 }]
                    }));
                    window.fetchedStudents = mockStudents;
                    renderTable(mockStudents);
                }
                document.getElementById('filterContext').innerHTML += ` <span class="text-rose-500 font-bold block mt-1">(Error: ${e.message})</span>`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('studentTableBody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-400">No students found</td></tr>`;
                return;
            }
            tbody.innerHTML = data.map((s, index) => `
                <tr class="hover:bg-indigo-50/50 transition border-b border-indigo-50/30 last:border-none">
                    <td class="px-4 py-4 font-bold text-slate-700">${s.name}</td>
                    <td class="px-4 py-4 text-slate-500 font-mono text-xs">${s.class} - ${s.section}</td>
                    <td class="px-4 py-4 text-right">
                        <button onclick="showDetails(${index})" class="clay-btn px-3 py-1 text-xs font-bold text-indigo-500">View</button>
                    </td>
                </tr>
            `).join('');
        }

        // SHOW DETAILS MODAL
        function showDetails(index) {
            const s = window.fetchedStudents[index];
            if (!s) return;

            // Simple Alert or Custom Modal? Let's re-use Security Modal but change content,
            // or just render the Card View overlay. Let's render Card View overlay for simplicity.

            // Re-render as card overlay
            renderStudentCard(s);
        }

        function renderStudentCard(s) {
            const listEl = document.getElementById('listView');
            const detailEl = document.getElementById('detailView');

            // Hide List, Show Detail
            listEl.classList.add('hidden');
            detailEl.classList.remove('hidden');

            // Build Measurements HTML
            const measHtml = (s.measurements && s.measurements.length)
                ? `<div class="w-full max-w-sm grid gap-3 mt-6">
                    ${s.measurements.map(m => `
                        <div class="clay-btn p-4 flex justify-between items-center bg-white/50">
                            <div><p class="font-bold text-indigo-900">${m.Item}</p><p class="text-[10px] text-indigo-400">${m.Pattern || ''}</p></div>
                            <div class="font-mono font-black text-xl text-slate-700">${m.Size}</div>
                        </div>`).join('')}
                   </div>`
                : `<div class="clay-btn p-4 w-full max-w-sm mt-6 text-center text-slate-400 text-sm">No measurements logged</div>`;

            detailEl.innerHTML = `
                <button onclick="closeDetails()" class="self-start mb-6 clay-btn px-4 py-2 text-slate-500 hover:text-slate-800 text-xs font-bold">‚Üê Back</button>
                
                <div class="w-24 h-24 rounded-full clay-btn flex items-center justify-center mb-4 text-4xl text-indigo-500">üéì</div>
                <h2 class="text-2xl font-black text-slate-800">${s.name}</h2>
                <p class="text-sm font-bold text-slate-400 uppercase tracking-widest mt-1 mb-6">${s.class} ${s.section}</p>
                
                <div class="flex gap-4 w-full max-w-sm">
                    <div class="flex-1 clay-btn p-3 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">ADM NO</p>
                        <p class="font-mono font-bold text-slate-600">${s.id || s.admission_no || '--'}</p>
                    </div>
                    <div class="flex-1 clay-btn p-3 text-center">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">HOUSE</p>
                        <p class="font-bold text-slate-600">${s.house || '-'}</p>
                    </div>
                </div>

                ${measHtml}
            `;
            document.getElementById('filterContext').innerText = "Student Profile";
        }

        function closeDetails() {
            document.getElementById('listView').classList.remove('hidden');
            document.getElementById('detailView').classList.add('hidden');
            // Restore Context
            const params = new URLSearchParams(window.location.search);
            const sName = params.get('s') || (filters.s || 'School Data');
            document.getElementById('filterContext').innerText = `${sName} ‚Ä¢ Class: ${filters.c || 'All'} ‚Ä¢ Sec: ${filters.sec || 'All'}`;
        }

        // === NEW PDF LOGIC (AUTO TABLE) ===
        function downloadPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            const schoolName = filters.s || 'School Data';
            doc.setFontSize(18);
            doc.text(schoolName, 14, 20);

            doc.setFontSize(10);
            doc.setTextColor(100);
            const dateStr = new Date().toLocaleDateString();
            doc.text(`Student Measurement Report | ${dateStr}`, 14, 26);
            doc.text(`Filter: Class ${filters.c || 'All'} - Section ${filters.sec || 'All'}`, 14, 32);

            // Prepare Data
            const students = window.fetchedStudents || [];
            const tableBody = students.map(s => {
                // Flatten Measurements
                const measStr = (s.measurements || []).map(m => `${m.Item}: ${m.Size}`).join(', ');
                return [s.name, `${s.class} ${s.section}`, s.admission_no || s.id, measStr || '-'];
            });

            // AutoTable
            doc.autoTable({
                startY: 40,
                head: [['Name', 'Class', 'Adm No', 'Measurements']],
                body: tableBody,
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }, // Indigo
                styles: { fontSize: 9, cellPadding: 3 },
                columnStyles: {
                    3: { cellWidth: 'auto' } // Allow measurements to expand
                }
            });

            doc.save(`Student_Report_${dateStr}.pdf`);
        }

        // EXCEL EXPORT
        function downloadExcel() {
            /* Excel Logic (Simplified for brevity as already implemented) */
            const students = window.fetchedStudents || [];
            if (!students.length) return alert("No Data");
            const ws = XLSX.utils.json_to_sheet(students.map(s => ({
                Name: s.name, Class: s.class, Section: s.section,
                Measurements: (s.measurements || []).map(m => `${m.Item}:${m.Size}`).join(', ')
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            XLSX.writeFile(wb, "Student_List.xlsx");
        }

        // Auto-Focus Pin
        document.getElementById('accessPinInput').focus();
    </script>
</body>

</html>