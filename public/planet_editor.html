<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Editor - Rapid Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>window.jsPDF = window.jspdf.jsPDF;</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9F9F7;
            /* Washi Paper White */
            color: #2C3E50;
            /* Ink Blue */
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Noto Serif JP', serif;
        }

        .cell-input {
            transition: all 0.2s;
        }

        .cell-input:focus {
            outline: none;
            background-color: #FFFFFF;
            box-shadow: inset 0 0 0 1px #4A5568;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: #FFFFFF;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        /* Custom Select Style */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234A5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        .btn-action {
            background-color: #4A5568;
            color: white;
            transition: all 0.2s;
        }

        .btn-action:hover {
            background-color: #2D3748;
        }

        .btn-outline {
            background-color: #FFFFFF;
            border: 1px solid #E2E8F0;
            color: #4A5568;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            background-color: #F7FAFC;
            border-color: #CBD5E0;
        }

        /* Japanese Art Watermark - Refined */
        .watermark {
            position: absolute;
            bottom: -50px;
            right: -50px;
            opacity: 0.15;
            pointer-events: none;
            z-index: 0;
            width: 400px;
            height: 400px;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden relative">

    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" class="fixed inset-0 z-[100] bg-[#F9F9F7] flex items-center justify-center">
        <div
            class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full border border-indigo-50 relative overflow-hidden">
            <!-- Decorative Header -->
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 to-indigo-300"></div>

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    üîê
                </div>
                <h2 class="text-2xl font-serif font-bold text-slate-800">Planet Editor</h2>
                <p class="text-slate-400 text-sm mt-1 uppercase tracking-wider">Authentication Required</p>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-indigo-100 mb-6">
                <button onclick="switchAuthTab('tailor')" id="tabTailor"
                    class="flex-1 pb-2 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 transition-colors">Tailor
                    Login</button>
                <button onclick="switchAuthTab('code')" id="tabCode"
                    class="flex-1 pb-2 text-sm font-bold text-slate-400 border-b-2 border-transparent hover:text-indigo-400 transition-colors">Access
                    Code</button>
            </div>

            <!-- Tailor Form -->
            <form id="formTailor" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input type="text" id="loginUser"
                        class="w-full border border-indigo-100 rounded p-3 outline-none focus:border-indigo-400 bg-indigo-50/30"
                        placeholder="Enter username" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="loginPass"
                        class="w-full border border-indigo-100 rounded p-3 outline-none focus:border-indigo-400 bg-indigo-50/30"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-transform active:scale-95">
                    Secure Login
                </button>
            </form>

            <!-- Access Code Form -->
            <form id="formCode" onsubmit="handleAccessCode(event)" class="space-y-4 hidden">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">6-Digit Access Code</label>
                    <input type="text" id="accessCode"
                        class="w-full border border-indigo-100 rounded p-3 outline-none focus:border-indigo-400 bg-indigo-50/30 font-mono text-center text-2xl tracking-widest uppercase"
                        placeholder="XXXXXX" maxlength="6" required>
                </div>
                <button type="submit"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-transform active:scale-95">
                    Unlock Editor
                </button>
            </form>

            <p id="authError" class="text-rose-500 text-xs text-center mt-4 font-bold min-h-[1.5em]"></p>
        </div>
    </div>

    <!-- PATTERN MODAL -->
    <div id="patternModal"
        class="fixed inset-0 z-50 hidden bg-black/30 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg relative border border-slate-100">
            <button onclick="document.getElementById('patternModal').classList.add('hidden')"
                class="absolute top-4 right-4 text-slate-400 hover:text-slate-600">
                <svg width="20" height="20" viewbox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
            </button>

            <h3 class="text-xl font-serif font-bold text-slate-800 mb-1">Create Pattern</h3>
            <p class="text-xs text-slate-400 uppercase tracking-widest mb-6">Store Configuration</p>

            <form onsubmit="handleCreatePattern(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Pattern Name</label>
                    <input type="text" id="patName"
                        class="w-full border border-slate-200 rounded p-2 text-sm focus:border-indigo-400 outline-none"
                        placeholder="e.g. Boys Full Kit Class 1-5" required>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Consumption (M)</label>
                        <input type="number" step="0.01" id="patCons"
                            class="w-full border border-slate-200 rounded p-2 text-sm focus:border-indigo-400 outline-none"
                            placeholder="0.00">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cloth Details</label>
                    <textarea id="patCloth"
                        class="w-full border border-slate-200 rounded p-2 text-sm focus:border-indigo-400 outline-none h-20"
                        placeholder="Fabric type, shade, etc."></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Special Requirements</label>
                    <input type="text" id="patReq"
                        class="w-full border border-slate-200 rounded p-2 text-sm focus:border-indigo-400 outline-none"
                        placeholder="Optional notes">
                </div>

                <div class="mb-4 bg-yellow-50 p-3 rounded border border-yellow-200">
                    <label class="block text-xs font-bold text-yellow-800 uppercase mb-2">Item Quantities
                        (Default)</label>
                    <div id="pattern-qty-grid"
                        class="grid grid-cols-2 gap-2 text-xs max-h-40 overflow-y-auto custom-scrollbar">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <div class="bg-indigo-50 p-3 rounded border border-indigo-100 text-xs text-indigo-800">
                    <strong>Note:</strong> This pattern will be assigned to
                    <span id="patCount" class="font-bold underline">0</span>
                    currently filtered students.
                </div>

                <button type="submit"
                    class="w-full bg-rose-600 text-white py-3 rounded-lg font-bold shadow-lg shadow-rose-200 hover:bg-rose-700 transition-transform active:scale-95 flex justify-center items-center gap-2">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    Upload Measurement Data
                </button>
            </form>
        </div>
    </div>

    <!-- Japanese Art Watermark - Refined Design -->
    <svg class="watermark" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <filter id="ink-blur" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="0.5" />
            </filter>
        </defs>

        <!-- Red Sun -->
        <circle cx="220" cy="60" r="35" fill="#C0392B" opacity="0.8" style="mix-blend-mode: multiply;" />

        <!-- Bamboo Stalks -->
        <g stroke="#2C3E50" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0.9">
            <path d="M260 300 Q270 200 240 100" stroke-width="4" />
            <path d="M260 300 M262 250 M265 200 M255 150 M245 100" stroke-width="0" />
            <path d="M290 300 Q280 220 295 140" stroke-width="3" />
            <path d="M220 300 Q230 250 210 180" stroke-width="2.5" />
        </g>

        <!-- Bamboo Leaves -->
        <g fill="#2C3E50" opacity="0.9">
            <path d="M240 100 Q220 90 200 105 Q220 100 240 100 Z" />
            <path d="M240 100 Q250 80 230 60 Q245 80 240 100 Z" />
            <path d="M240 150 Q220 145 205 155 Q225 150 240 150 Z" />
            <path d="M295 140 Q275 130 260 135 Q280 135 295 140 Z" />
            <path d="M210 180 Q190 170 175 180 Q195 175 210 180 Z" />
        </g>

        <!-- Pagoda Silhouette -->
        <g stroke="#2C3E50" stroke-width="1.5" fill="none" opacity="0.7" transform="translate(20, 20)">
            <path d="M280 280 L220 280" />
            <path d="M270 260 L230 260" />
            <path d="M260 240 L240 240" />
            <path d="M285 280 L220 280 L215 275" />
            <path d="M275 260 L230 260 L225 255" />
            <path d="M265 240 L240 240 L235 235" />
        </g>
    </svg>

    <!-- Undo/Redo is dynamically added to Header -->

    <!-- Advanced Export Modal -->
    <div id="exportModal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div
            class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-[#E2E8F0] bg-[#F9F9F7] flex justify-between items-center shrink-0">
                <h3 class="font-bold text-[#2C3E50] text-lg">Upload / Export Data</h3>
                <button onclick="closeExportModal()" class="text-[#7F8C8D] hover:text-[#2C3E50]">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="p-6 space-y-4 overflow-y-auto custom-scrollbar">
                <!-- Metadata Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-semibold text-[#7F8C8D] uppercase tracking-wider mb-1">School
                            Name</label>
                        <input type="text" id="metaSchool"
                            class="w-full text-sm border border-[#E2E8F0] rounded p-2 outline-none focus:border-[#4A5568]"
                            placeholder="e.g. Greenwood High">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-[#7F8C8D] uppercase tracking-wider mb-1">Pattern
                            Code</label>
                        <input type="text" id="metaPattern"
                            class="w-full text-sm border border-[#E2E8F0] rounded p-2 outline-none focus:border-[#4A5568]"
                            placeholder="e.g. P-101">
                    </div>

                </div>
                <div>
                    <label
                        class="block text-xs font-semibold text-[#7F8C8D] uppercase tracking-wider mb-1">Description</label>
                    <textarea id="metaDesc" rows="2"
                        class="w-full text-sm border border-[#E2E8F0] rounded p-2 outline-none focus:border-[#4A5568]"
                        placeholder="Optional description..."></textarea>
                </div>

                <hr class="border-[#E2E8F0]">

                <!-- Calculation Section -->
                <div class="bg-[#F0F4F8] p-4 rounded-md border border-[#CBD5E0]">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2 mb-2">
                        <label class="block text-xs font-bold text-[#2D3748] uppercase">Cloth Consumption
                            (Meters/Student)</label>
                        <input type="number" id="metaConsumption" step="0.01"
                            class="w-full sm:w-32 text-sm border border-[#A0AEC0] rounded p-1 outline-none text-right font-mono text-[#2D3748]"
                            placeholder="0.00" oninput="updateExportTotal()">
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs font-bold text-[#2D3748] uppercase mb-1">Cloth Details</label>
                        <textarea id="metaClothDetails" rows="2"
                            class="w-full text-sm border border-[#A0AEC0] rounded p-2 outline-none text-[#2D3748] placeholder-gray-400"
                            placeholder="E.g. Cotton 100%, Blue Shade..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs font-bold text-[#2D3748] uppercase mb-1">Special
                            Requirements</label>
                        <textarea id="metaSpecialReq" rows="2"
                            class="w-full text-sm border border-[#A0AEC0] rounded p-2 outline-none text-[#2D3748] placeholder-gray-400"
                            placeholder="Any special instructions..."></textarea>
                    </div>
                    <div class="flex justify-between text-xs text-[#7F8C8D] mb-1">
                        <span>Filtered Students:</span>
                        <span id="exportCount" class="font-mono">0</span>
                    </div>
                    <div
                        class="bg-gray-50 p-2 rounded border border-gray-200 text-xs text-[#7F8C8D] flex justify-between items-center">
                        <div>
                            <strong class="block text-gray-700">Total Items:</strong>
                            <span id="exportTotalQty" class="font-mono text-lg font-bold text-indigo-600">0</span>
                        </div>
                        <div class="w-px h-8 bg-gray-300 mx-2"></div>
                        <div>
                            <strong class="block text-gray-700">Total Cloth:</strong>
                            <span id="exportTotalCloth" class="font-mono text-lg font-bold text-gray-600">0.00 M</span>
                        </div>
                    </div>

                    <!-- Active Filters Readout -->
                    <div class="text-xs text-[#7F8C8D] mt-2">
                        <strong class="block mb-1">Active Filters:</strong>
                        <p id="exportFilters" class="italic overflow-hidden text-ellipsis">None</p>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-[#E2E8F0] bg-[#F9F9F7] flex justify-end gap-3">
                <button onclick="closeExportModal()"
                    class="btn-outline px-4 py-2 rounded text-sm font-medium">Cancel</button>
                <div class="flex gap-2">
                    <!-- Upload Data Button (New) -->
                    <button onclick="handleDataUpload()"
                        class="px-5 py-2 rounded text-sm font-bold shadow-md bg-indigo-600 text-white hover:bg-indigo-700 flex items-center gap-2">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="17 8 12 3 7 8" />
                            <line x1="12" y1="3" x2="12" y2="15" />
                        </svg>
                        Upload Data
                    </button>
                    <div class="w-px bg-gray-300 mx-1"></div>
                    <button onclick="confirmExportPDF()"
                        class="btn-outline px-5 py-2 rounded text-sm font-medium shadow-sm hover:bg-gray-50 text-[#C0392B] border-[#C0392B]/30">Export
                        PDF</button>
                    <button onclick="confirmExport()"
                        class="btn-action px-6 py-2 rounded text-sm font-medium shadow-md">Export Excel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Metadata Modal -->
    <div id="metadataModal"
        class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="px-6 py-4 border-b border-[#E2E8F0] bg-[#F9F9F7] flex justify-between items-center">
                <h3 class="font-bold text-[#2C3E50] text-lg">Imported Metadata</h3>
                <button onclick="document.getElementById('metadataModal').classList.add('hidden')"
                    class="text-[#7F8C8D] hover:text-[#2C3E50]">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="p-6 max-h-[60vh] overflow-auto">
                <div id="metadataContent" class="text-sm text-[#4A5568] space-y-2 font-mono">
                    <p class="italic text-gray-400">No metadata found.</p>
                </div>
            </div>
            <div class="px-6 py-3 border-t border-[#E2E8F0] bg-[#F9F9F7] flex justify-end">
                <button onclick="document.getElementById('metadataModal').classList.add('hidden')"
                    class="btn-outline px-4 py-2 rounded text-sm font-medium">Close</button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header
        class="bg-white border-b border-[#E2E8F0] px-6 py-4 flex flex-col md:flex-row justify-between items-center shadow-sm z-30 relative gap-4">
        <div class="flex items-center gap-4">
            <button onclick="logout()"
                class="text-xs text-rose-500 border border-rose-200 px-2 py-1 rounded hover:bg-rose-50 font-bold"
                title="Sign Out">
                Logout
            </button>
            <div class="bg-[#4A5568] text-white p-2 rounded-md shadow-sm">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-serif text-[#2D3748] tracking-tight">Planet Editor <span
                        class="text-xs font-sans text-[#CBD5E0] font-normal"
                        style="font-family: 'Inter', sans-serif;">v2.1</span></h1>
                <p class="text-xs text-[#7F8C8D] tracking-wide">RAPID DATA ENTRY SYSTEM</p>
            </div>
        </div>
        <!-- Hidden File Input -->
        <input type="file" id="fileInput" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(event)" />
        <div id="headerActions" class="grid grid-cols-2 w-full md:w-auto md:flex gap-2 md:gap-3 items-center">
            <!-- Navigation Button -->
            <!-- School Name Display -->
            <div class="hidden md:block text-right">
                <h2 id="schoolNameDisplay" class="text-sm font-bold text-slate-700"></h2>
                <span class="text-[10px] text-slate-400 uppercase tracking-widest">Target School</span>
            </div>

            <div class="h-8 w-px bg-[#E2E8F0] hidden md:block"></div>

            <!-- Create Pattern Button -->
            <button onclick="openPatternModal()"
                class="bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 px-4 py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition-colors">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"></path>
                </svg>
                <span class="inline">Create Pattern</span>
            </button>

            <button onclick="openExportModal()"
                class="btn-action px-4 py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2 shadow-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span class="inline">Export</span>
            </button>



            <button onclick="showMetadata()" title="Info"
                class="btn-outline px-3 py-2 rounded-md text-sm font-medium text-[#7F8C8D] hover:text-[#4A5568] flex items-center justify-center">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                <span class="md:hidden ml-2">Info</span>
            </button>

            <!-- SYNC BUTTON -->
            <div class="h-8 w-px bg-[#E2E8F0] hidden md:block"></div>
            <div class="flex items-center gap-2">
                <span id="syncStatus"
                    class="text-[10px] font-bold text-slate-400 uppercase tracking-wider hidden md:block">Offline</span>
                <button onclick="syncToCloud()" id="btnSync"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-bold hover:bg-indigo-700 shadow-md shadow-indigo-200 flex items-center gap-2 transition-all active:scale-95">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 2v6h-6"></path>
                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                        <path d="M3 22v-6h6"></path>
                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                    </svg>
                    Sync
                </button>
            </div>

        </div>
    </header>

    <!-- Toolbar -->
    <div
        class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-4 overflow-x-auto no-scrollbar z-20 relative">
        <div class="flex items-center gap-1 bg-[#F7FAFC] p-1 rounded-lg shrink-0 border border-[#EDF2F7]">
            <button onclick="setView('table')" id="btn-table"
                class="px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]">Table</button>
            <button onclick="setView('card')" id="btn-card"
                class="px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all">Cards</button>
        </div>

        <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

        <!-- Search & Filters -->
        <div class="flex items-center gap-3 w-full sm:w-auto overflow-x-auto">
            <div class="relative">
                <svg class="absolute left-3 top-2 text-[#A0AEC0]" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search..."
                    class="pl-9 pr-3 py-1.5 text-sm border border-[#E2E8F0] rounded-md focus:border-[#4A5568] outline-none w-32 sm:w-48 bg-[#F9F9F7] focus:bg-white transition-colors">
            </div>

            <select id="filterClass" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Classes</option>
            </select>

            <select id="filterSection" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Sections</option>
            </select>

            <select id="filterHouse" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Houses</option>
            </select>

            <select id="filterGender" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Genders</option>
            </select>

            <select id="filterAttendance" onchange="handleFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                <option value="">All Attendance</option>
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
            </select>

            <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block mx-2"></div>

            <select id="filterItem" onchange="handleItemFilter()"
                class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[180px] font-medium">
                <option value="">Filter by Item</option>
            </select>

            <!-- Dynamic Component Filters Container -->
            <div id="dynamicFilters" class="flex flex-wrap items-center gap-2">
                <!-- Dropdowns will be injected here -->
            </div>
        </div>

        <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

        <div class="text-sm text-[#7F8C8D] whitespace-nowrap font-light flex items-center gap-2">
            <span id="rowCount" class="font-bold text-[#2C3E50]">0</span> <span class="hidden sm:inline">filtered</span>
            <span class="text-[#CBD5E0]">|</span>
            <span class="text-[#7F8C8D]">Total: <span id="totalCount" class="font-bold text-[#4A5568]">0</span></span>
        </div>

        <div class="flex items-center gap-2 ml-auto">
            <input type="checkbox" id="showCalculated" checked onchange="renderTable(); renderCards();"
                class="rounded text-[#4A5568] focus:ring-[#4A5568] border-[#CBD5E0]">
            <label for="showCalculated"
                class="text-sm text-[#4A5568] select-none cursor-pointer whitespace-nowrap font-medium">Show
                Calculated</label>
        </div>

        <button onclick="addNewRow()"
            class="text-[#4A5568] hover:bg-[#EDF2F7] px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1 whitespace-nowrap ml-2 transition-colors">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add
        </button>
    </div>

    <!-- Sheet Tabs (Dynamic) -->
    <div id="sheetTabs"
        class="flex gap-2 px-6 py-2 bg-[#F1F5F9] border-b border-[#E2E8F0] overflow-x-auto hidden items-center whitespace-nowrap min-h-[42px]">
        <!-- Sheet buttons will be injected here -->
    </div>



    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative bg-[#F9F9F7]/90 z-10 flex flex-col">

        <!-- Table View -->
        <div id="tableView" class="flex-1 overflow-auto">
            <table class="w-full border-collapse text-sm">
                <thead id="tableHead"
                    class="bg-[#FFFFFF] text-[#7F8C8D] font-medium text-xs uppercase sticky-header shadow-sm tracking-wider">
                    <!-- Headers injected by JS -->
                </thead>
                <tbody id="tableBody" class="bg-white/80 backdrop-blur-sm">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Card View (Mobile) -->
        <div id="cardView" class="hidden flex-1 overflow-auto p-6 space-y-4 pb-24">
            <!-- Cards will be inserted here -->
        </div>

        <!-- Pagination Controls -->
        <div class="bg-white border-t border-[#E2E8F0] px-6 py-3 flex items-center justify-between z-20">
            <div class="flex items-center gap-2">
                <span class="text-xs text-[#7F8C8D]">Rows per page:</span>
                <select id="rowsPerPage" onchange="changeRowsPerPage()"
                    class="text-xs border border-[#E2E8F0] rounded px-2 py-1 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="25">25</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                </select>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-xs text-[#7F8C8D]" id="pageInfo">Page 1 of 1</span>
                <div class="flex gap-1">
                    <button onclick="prevPage()"
                        class="p-1 rounded hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-50" id="btnPrev">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <button onclick="nextPage()"
                        class="p-1 rounded hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-50" id="btnNext">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        let data = [];
        let currentWorkbook = null;
        let currentSheetName = "";
        let currentMetadata = [];

        // Undo/Redo State
        const history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        let filters = {
            search: '',
            class: '',
            section: '',
            house: '',
            gender: '',
            attendance: '',
            item: '',
            components: {}
        };

        // Pagination State
        let currentPage = 1;
        let rowsPerPage = 50;
        let searchTimeout = null;

        const infoCols = ["S.No", "Roll No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
        const measureCols = ["U1", "U2", "U3", "U4", "U5", "U6", "U7", "U8", "L1", "L2", "L3", "L4", "L5", "L6", "L7", "L8"];

        // Item Definitions
        const boysItems = [
            { name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" },
        ];

        const girlsItems = [
            { name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" },
            { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" },
            { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" },
            { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" },
        ];

        const allItems = [...boysItems, ...girlsItems];

        // Global Listener Removed (Handled in init)

        // Initialize

        // COMPLAINTS LOGIC
        function openComplaintModal() {
            document.getElementById('complaintModal').classList.remove('hidden');
            fetchMyComplaints();
        }

        /* Old Submit Replaced */ async function old_submitComplaint(e) {
            e.preventDefault();
            const rating = document.getElementById('compRating').value;
            const comment = document.getElementById('compComment').value;
            const image = document.getElementById('compImage').value;
            const token = sessionStorage.getItem('token');
            const params = new URLSearchParams(window.location.search);
            // School ID might be in Session or URL
            const schoolId = params.get('schoolId') || sessionStorage.getItem('schoolId');

            if (!token) return alert("Please login first.");

            try {
                const res = await fetch('/api/data/complaints', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ school_id: schoolId, rating, comment, image_url: image })
                });

                if (res.ok) {
                    alert("Complaint Submitted!");
                    e.target.reset();
                    fetchMyComplaints();
                } else {
                    alert("Submission Failed");
                }
            } catch (err) { console.error(err); alert("Error submitting"); }
        }

        /* Old Fetch Replaced */ async function old_fetchMyComplaints() {
            const token = sessionStorage.getItem('token');
            const container = document.getElementById('complaintHistory');

            try {
                // Modified Endpoint: GET /api/data/my_complaints (Need to add this to backend)
                const res = await fetch('/api/data/my_complaints', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 404) {
                    container.innerHTML = '<p class="text-xs text-center text-gray-400">History feature pending backend update.</p>';
                    return;
                }

                const data = await res.json();
                if (!Array.isArray(data) || data.length === 0) {
                    container.innerHTML = '<p class="text-xs text-center text-gray-400">No previous reports.</p>';
                    return;
                }

                if (Array.isArray(data)) {
                    container.innerHTML = data.map(c => `
                        <div class="border rounded p-3 bg-white text-xs">
                            <div class="flex justify-between font-bold text-[#2C3E50] mb-1">
                                <span>${'‚òÖ'.repeat(c.rating || 0)}</span>
                                <span class="${c.status === 'Resolved' ? 'text-green-600' : 'text-rose-500'}">${c.status}</span>
                            </div>
                            <p class="text-gray-600 mb-2">"${c.comment}"</p>
                            ${c.reply ? `
                                <div class="bg-blue-50 p-2 rounded border border-blue-100 mt-2">
                                    <strong class="block text-blue-800 text-[10px] uppercase">Admin Reply:</strong>
                                    <p class="text-blue-900">${c.reply}</p>
                                </div>
                            ` : ''}
                            <div class="text-[10px] text-gray-400 text-right mt-1">${new Date(c.created_at).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                }


            } catch (e) {
                console.error(e);
                container.innerHTML = '<p class="text-xs text-center text-red-400">Failed to load history.</p>';
            }
        }





        // --- AUTH LOGIC ---
        function switchAuthTab(type) {
            const tailorBtn = document.getElementById('tabTailor');
            const codeBtn = document.getElementById('tabCode');
            const tailorForm = document.getElementById('formTailor');
            const codeForm = document.getElementById('formCode');

            if (type === 'tailor') {
                tailorBtn.classList.replace('text-slate-400', 'text-indigo-600');
                tailorBtn.classList.replace('border-transparent', 'border-indigo-600');
                codeBtn.classList.replace('text-indigo-600', 'text-slate-400');
                codeBtn.classList.replace('border-indigo-600', 'border-transparent');
                tailorForm.classList.remove('hidden');
                codeForm.classList.add('hidden');
            } else {
                codeBtn.classList.replace('text-slate-400', 'text-indigo-600');
                codeBtn.classList.replace('border-transparent', 'border-indigo-600');
                tailorBtn.classList.replace('text-indigo-600', 'text-slate-400');
                tailorBtn.classList.replace('border-indigo-600', 'border-transparent');
                codeForm.classList.remove('hidden');
                tailorForm.classList.add('hidden');
            }
            document.getElementById('authError').innerText = "";
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            const errorEl = document.getElementById('authError');

            errorEl.innerText = "Authenticating...";

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || "Login Failed");

                // Check Role
                if (data.role !== 'tailor' && data.role !== 'admin' && data.role !== 'company') {
                    throw new Error("Unauthorized Role for Editor");
                }

                saveSession({ ...data, type: 'credentials' });
            } catch (err) {
                errorEl.innerText = err.message;
            }
        }

        async function handleAccessCode(e) {
            e.preventDefault();
            const code = document.getElementById('accessCode').value.toUpperCase();
            const errorEl = document.getElementById('authError');
            errorEl.innerText = "Verifying...";

            try {
                const res = await fetch('/api/auth/access-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || "Invalid Code");

                // Only allow Access Code type 'editor' (mapped to role 'tailor' by backend)
                if (data.role !== 'editor' && data.role !== 'tailor') {
                    // Note: Backend map 'editor' -> 'tailor' role in JWT, but returns original type sometimes.
                    // The auth endpoint returns { accessToken, role: type, ... } where type is 'editor' or 'packing'
                    if (data.role !== 'editor') throw new Error("This code is for Packing DB, not Editor.");
                }

                saveSession({ ...data, type: 'code' });
            } catch (err) {
                errorEl.innerText = err.message;
            }
        }

        function saveSession(sessionData) {
            sessionStorage.setItem('token', sessionData.accessToken);
            sessionStorage.setItem('schoolId', sessionData.schoolId);
            sessionStorage.setItem('role', sessionData.role);

            // Unlock
            document.getElementById('loginOverlay').classList.add('hidden');

            // Trigger Cloud Fetch
            fetchCloudData();
        }

        function checkSession() {
            const token = sessionStorage.getItem('token');
            if (!token) {
                // Show Login
                document.getElementById('loginOverlay').classList.remove('hidden');
            } else {
                // Valid (Client-side assumption, API will reject real calls if expired)
                document.getElementById('loginOverlay').classList.add('hidden');
                fetchCloudData(); // Load data from cloud, fallback to local if fail
            }
        }


        function logout() {
            sessionStorage.clear();
            window.location.reload();
        }

        // --- INITIALIZATION ---
        // Removed default auto-init, now called by checkSession
        // function init() { ... } 

        // Start Here
        document.addEventListener('DOMContentLoaded', checkSession);

        function init() {
            const saved = localStorage.getItem('planetEditorData');
            if (saved) {
                try {
                    data = JSON.parse(saved);
                } catch (e) {
                    console.error("Local data corrupt", e);
                    for (let i = 0; i < 5; i++) addNewRow(false);
                }
            } else {
                for (let i = 0; i < 5; i++) addNewRow(false);
            }

            // Ensure consistent S.No
            if (data.length > 0) {
                data.forEach((r, i) => {
                    r["S.No"] = i + 1;
                    // DEFENSIVE FIX: Sanitize Quantity Fields
                    allItems.forEach(item => {
                        const qtyKey = `Qty_${item.name}`;
                        // If it's a string with commas, it's corrupt.
                        if (r[qtyKey] && typeof r[qtyKey] === 'string' && r[qtyKey].includes(',')) {
                            r[qtyKey] = "";
                        }
                    });
                });
            }

            updateCount();

            populateFilters();
            populateItemFilter();
            renderTable();
            renderCards();

            // Initial History State
            if (data.length > 0) {
                addToHistory();
                updateUndoRedoUI();
            }

            // Enter Key Navigation
            document.addEventListener('keydown', function (e) {
                // Support both Enter keys
                if ((e.key === 'Enter' || e.keyCode === 13)) {
                    // Check if target is a relevant input
                    if (e.target.classList.contains('cell-input')) {
                        e.preventDefault();

                        // Scope to current container (Table Body or Card View)
                        const container = e.target.closest('tbody') || e.target.closest('#cardView');
                        if (!container) return; // Should not happen if class match passed

                        // Get all ENABLED inputs
                        const inputs = Array.from(container.querySelectorAll('.cell-input:not([disabled])'));
                        const index = inputs.indexOf(e.target);

                        if (index > -1 && index < inputs.length - 1) {
                            const nextInput = inputs[index + 1];
                            nextInput.focus();
                            if (nextInput.tagName === 'INPUT' && (nextInput.type === 'text' || nextInput.type === 'number')) {
                                nextInput.select();
                            }
                        }
                    }
                }
            });
        }

        // --- DATA SYNC LOGIC ---

        async function fetchCloudData() {
            const token = sessionStorage.getItem('token');
            const schoolId = sessionStorage.getItem('schoolId');
            const statusEl = document.getElementById('syncStatus');

            if (!token || !schoolId) return init(); // Fallback to local if no auth

            statusEl.innerText = "Fetching...";
            statusEl.className = "text-[10px] font-bold text-blue-500 uppercase tracking-wider hidden md:block animate-pulse";

            try {
                // Use the route I verified in data.js: router.get('/students/:schoolId')
                const res = await fetch(`/api/data/students/${schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("Fetch Failed");

                const cloudData = await res.json();

                if (Array.isArray(cloudData) && cloudData.length > 0) {
                    console.log("Cloud Data Loaded:", cloudData.length);
                    // Map DB fields to Editor keys if needed, OR just ensure init handles DB format
                    // DB: name, admission_no, role_no, class, section, house, gender
                    // Editor: "Student Name", "Admission No", "Roll No", "Class", "Section", "House", "Gender"

                    data = cloudData.map(d => ({
                        "id": d.id, // Keep ID for updates
                        "Student Name": d.name,
                        "Admission No": d.admission_no,
                        "Roll No": d.roll_no,
                        "Class": d.class,
                        "Section": d.section,
                        "House": d.house,
                        "Gender": d.gender,
                        "Absent/Present": d.is_active ? "Present" : "Absent", // Basic map
                        "pattern_id": d.pattern_id,
                        ...d.measurements, // Spread measurements (U1, U2 etc) if stored in JSON column

                        // Hydrate Production Data (Quantities)
                        ...(() => {
                            const qtyMap = {};
                            if (d.production_data) {
                                // If production_data exists (Snapshot), use it to restore Qty fields
                                Object.keys(d.production_data).forEach(k => {
                                    // Ignore metadata keys
                                    if (k === 'Calculated' || k === 'Timestamp') return;

                                    // Map "Item Name" -> "Qty_ItemName"
                                    qtyMap[`Qty_${k}`] = d.production_data[k];
                                });
                            }
                            return qtyMap;
                        })()
                    }));

                    statusEl.innerText = "Cloud Synced";
                    statusEl.className = "text-[10px] font-bold text-green-500 uppercase tracking-wider hidden md:block";

                    // Fetch School Info Wrapper
                    fetchSchoolDetails(schoolId);

                    // Save to local as backup
                    localStorage.setItem('planetEditorData', JSON.stringify(data));
                } else {
                    // No cloud data? Keep local or empty?
                    // Let's rely on init() logic but maybe show "No Cloud Data"
                    console.log("No cloud data found, using local/empty.");
                }

                init(); // Re-render

            } catch (e) {
                console.error("Cloud Fetch Error:", e);
                statusEl.innerText = "Sync Error";
                statusEl.className = "text-[10px] font-bold text-rose-500 uppercase tracking-wider hidden md:block";
                init(); // Load local anyway
            }
        }

        async function syncToCloud() {
            const token = sessionStorage.getItem('token');
            const schoolId = sessionStorage.getItem('schoolId');
            const btn = document.getElementById('btnSync');
            const statusEl = document.getElementById('syncStatus');

            if (!token) return alert("You are offline. Login to sync.");

            const originalText = btn.innerHTML;
            btn.innerHTML = `Saving...`;
            btn.disabled = true;
            statusEl.innerText = "Syncing...";

            try {
                // Prepare Payload with corrected Measurements Structure
                const payload = data.map(d => {
                    const measurements = {};
                    measureCols.forEach(k => {
                        if (d[k] !== undefined) measurements[k] = d[k];
                    });

                    return {
                        id: d.id,
                        admission_no: d["Admission No"],
                        roll: d["Roll No"],
                        name: d["Student Name"],
                        class: d["Class"],
                        section: d["Section"],
                        house: d["House"],
                        gender: d["Gender"],
                        pattern_id: d.pattern_id, // Persist pattern link
                        measurements: measurements, // Key Fix: Send measurements object
                        production_data: (() => {
                            // Snapshot Calculated Production Data
                            const snapshot = {};
                            const gender = (d["Gender"] || "").toUpperCase();

                            // 1. Snapshot Item Output (e.g. "Boys Shirt": "2")
                            allItems.forEach(item => {
                                // Skip if gender mismatch (optimization)
                                const iType = item.type.toUpperCase();
                                if (iType === "MALE" && gender !== "MALE") return;
                                if (iType === "FEMALE" && gender !== "FEMALE") return;

                                const val = calculateItemValue(d, item);
                                if (val && val !== "" && val !== "0" && val !== "00") {
                                    snapshot[item.name] = val;
                                }
                            });

                            // 2. Snapshot Raw Measurements (U1, L2 etc) flattened ?
                            // User asked for "full measurement datas". The raw measurements are in `measurements` col.
                            // The calculated item outputs are in `snapshot`.
                            // Storing both covers all bases.
                            return snapshot;
                        })()
                    };
                });

                const res = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ students: payload })
                });


                if (!res.ok) throw new Error("Sync Failed");

                const result = await res.json();
                console.log("Sync Result:", result);

                statusEl.innerText = "Saved";
                statusEl.className = "text-[10px] font-bold text-green-600 uppercase tracking-wider hidden md:block";
                setTimeout(() => statusEl.innerText = "Cloud Synced", 2000);

                alert(`Sync Successful!\nUpdated/Inserted: ${result.count}`);

            } catch (e) {
                console.error(e);
                alert("Sync Failed. Check console.");
                statusEl.innerText = "Error";
                statusEl.className = "text-[10px] font-bold text-rose-600 uppercase tracking-wider hidden md:block";
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function fetchSchoolDetails(id) {
            const token = sessionStorage.getItem('token');
            try {
                // Endpoint might not exist directly returning one school, use list?
                // Or we can infer name from something else.
                // Actually, let's use /api/data/schools if role is appropriate, OR add a tiny endpoint.
                // User can just see local storage name if we saved it? No.
                // Minimal: Update UI with School ID at least.
                document.getElementById('schoolNameDisplay').innerText = "School #" + id;
            } catch (e) { }
        }

        // --- PATTERN LOGIC ---
        // --- PATTERN LOGIC ---
        function openPatternModal() {
            const filtered = getFilteredData();
            document.getElementById('patCount').innerText = filtered.length;

            // Populate Quantities Grid
            const grid = document.getElementById('pattern-qty-grid');
            if (grid) {
                grid.innerHTML = '';
                allItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-white border border-gray-200 p-2 rounded";
                    div.innerHTML = `<span class="text-[10px] font-mono font-bold text-gray-600 truncate mr-2" title="${item.name}">${item.name}</span>
                    <input type="number" min="0" value="0" data-item="${item.name}" class="w-12 text-center border border-gray-300 rounded px-1 py-0.5 text-xs font-bold text-blue-600 outline-none focus:border-blue-500">`;
                    grid.appendChild(div);
                });
            }

            document.getElementById('patternModal').classList.remove('hidden');
        }

        async function handleCreatePattern(e) {
            e.preventDefault();
            const token = sessionStorage.getItem('token');
            const schoolId = sessionStorage.getItem('schoolId');

            const name = document.getElementById('patName').value;
            const consumption = document.getElementById('patCons').value;
            const cloth = document.getElementById('patCloth').value;
            const req = document.getElementById('patReq').value;

            if (!name) return alert("Pattern Name Required");
            if (!token) return alert("Offline!");

            // Gather Quantities
            const quantities = {};
            const grid = document.getElementById('pattern-qty-grid');
            if (grid) {
                grid.querySelectorAll('input').forEach(inp => {
                    const val = parseInt(inp.value);
                    if (val > 0) quantities[inp.getAttribute('data-item')] = val;
                });
            }

            try {
                // 1. Create Pattern (Upload Data)
                const res = await fetch('/api/data/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        school_id: schoolId,
                        name: name,
                        consumption: parseFloat(consumption),
                        cloth_details: cloth,
                        special_req: req,
                        quantities: quantities
                    })
                });

                if (!res.ok) throw new Error("Failed to create pattern");
                const resData = await res.json();
                const patternId = resData.id;

                // 2. Assign to Filtered Students
                const filtered = getFilteredData();
                const ids = filtered.map(d => d.id);

                data.forEach(d => {
                    if (ids.includes(d.id)) {
                        d.pattern_id = patternId;
                    }
                });

                document.getElementById('patternModal').classList.add('hidden');
                e.target.reset(); // Reset form

                alert(`‚úÖ Upload Successful! Pattern "${name}" Saved.\nLinked to ${filtered.length} students.`);

                // 3. Sync
                syncToCloud();

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
            }
        }







        function populateFilters() {
            const classes = [...new Set(data.map(r => r.Class).filter(v => v != null && v !== ""))].sort();
            const sections = [...new Set(data.map(r => r.Section).filter(v => v != null && v !== ""))].sort();
            const houses = [...new Set(data.map(r => r.House).filter(v => v != null && v !== ""))].sort();
            const genders = [...new Set(data.map(r => r.Gender).filter(v => v != null && v !== ""))].sort();

            // Advanced Filtering UI: Convert Selects to Inputs with Datalists
            const classContainer = document.getElementById('filterClass').parentElement;
            const sectionContainer = document.getElementById('filterSection').parentElement;

            // Helper to Setup Input+Datalist (Only run once or if structure missing)
            if (document.getElementById('filterClass').tagName === 'SELECT') {
                const setupInput = (id, placeholder, values) => {
                    const input = document.createElement('input');
                    input.id = id;
                    input.setAttribute('list', `list-${id}`);
                    input.className = "text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]";
                    input.placeholder = placeholder;
                    input.onchange = handleFilter;

                    const dl = document.createElement('datalist');
                    dl.id = `list-${id}`;
                    dl.innerHTML = values.map(v => `<option value="${v}">`).join('');

                    const oldInfo = document.getElementById(id);
                    oldInfo.replaceWith(input);
                    input.after(dl);
                    // restore value
                    input.value = oldInfo.value;
                };

                setupInput('filterClass', 'All Classes', classes);
                setupInput('filterSection', 'All Sections', sections);
                setupInput('filterHouse', 'All Houses', houses);
            } else {
                // Just update datalists
                document.getElementById('list-filterClass').innerHTML = classes.map(c => `<option value="${c}">`).join('');
                document.getElementById('list-filterSection').innerHTML = sections.map(s => `<option value="${s}">`).join('');
                document.getElementById('list-filterHouse').innerHTML = houses.map(h => `<option value="${h}">`).join('');
            }

            // House is now an Input, exclude from Select logic below
            const genderSelect = document.getElementById('filterGender');

            const currentGender = genderSelect.value;
            genderSelect.innerHTML = '<option value="">All Genders</option>' + genders.map(g => `<option value="${g}">${g}</option>`).join('');
            if (genders.includes(currentGender)) genderSelect.value = currentGender;
        }

        function populateItemFilter() {
            const itemSelect = document.getElementById('filterItem');
            itemSelect.innerHTML = '<option value="">Filter by Item</option>' + allItems.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
        }

        function handleSearch() {
            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filters.search = document.getElementById('searchInput').value.toLowerCase();
                currentPage = 1; // Reset to first page on search
                renderTable();
                renderCards();
                updateCount();
            }, 300);
        }

        function handleFilter() {
            filters.class = document.getElementById('filterClass').value;
            filters.section = document.getElementById('filterSection').value;
            filters.house = document.getElementById('filterHouse').value;
            filters.house = document.getElementById('filterHouse').value;
            filters.gender = document.getElementById('filterGender').value;
            filters.attendance = document.getElementById('filterAttendance').value;
            currentPage = 1; // Reset to first page on filter
            renderTable();
            renderCards();
            updateCount();
        }

        function handleItemFilter() {
            const itemName = document.getElementById('filterItem').value;
            filters.item = itemName;
            filters.components = {};

            const container = document.getElementById('dynamicFilters');
            container.innerHTML = '';

            if (itemName) {
                const item = allItems.find(i => i.name === itemName);
                if (item) {
                    item.cols.forEach(col => {
                        const values = [...new Set(data.map(r => r[col]).filter(v => v && v !== "00"))].sort();

                        // Use Input + Datalist for flexible entry (Exact or Range)
                        const wrapper = document.createElement('div');
                        wrapper.className = "relative inline-block";

                        const input = document.createElement('input');
                        input.setAttribute('list', `list-${col}`);
                        input.type = "text";
                        input.placeholder = col;
                        input.className = "text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 outline-none focus:border-[#4A5568] bg-white w-24 text-[#4A5568] placeholder-gray-400";

                        // Restore previous value if exists
                        if (filters.components[col]) {
                            input.value = filters.components[col];
                        }

                        const datalist = document.createElement('datalist');
                        datalist.id = `list-${col}`;
                        datalist.innerHTML = values.map(v => `<option value="${v}">`).join('');

                        input.onchange = (e) => {
                            if (e.target.value) {
                                filters.components[col] = e.target.value;
                            } else {
                                delete filters.components[col];
                            }
                            currentPage = 1;
                            renderTable();
                            renderCards();
                            updateCount();
                        };

                        wrapper.appendChild(input);
                        wrapper.appendChild(datalist);
                        container.appendChild(wrapper);
                    });
                }
            }

            currentPage = 1;
            renderTable();
            renderCards();
            updateCount();
        }

        function getFilteredData() {
            return data.filter(row => {
                const matchesSearch = !filters.search ||
                    (row["Student Name"] || "").toLowerCase().includes(filters.search) ||
                    (String(row["Admission No"]) || "").toLowerCase().includes(filters.search) ||
                    (String(row["Roll No"]) || "").toLowerCase().includes(filters.search);

                // Advanced Filtering Logic
                const advancedMatch = (rowVal, filterVal) => {
                    if (!filterVal) return true;
                    if (rowVal == null || rowVal === "") return false;
                    const rVal = String(rowVal).trim().toUpperCase();
                    const fVal = filterVal.toUpperCase();

                    // Comma List (e.g. "1,4,7" or "A,C")
                    if (fVal.includes(',')) {
                        const parts = fVal.split(',').map(p => p.trim());
                        return parts.includes(rVal);
                    }

                    // Range (e.g. "7-10" or "A-C")
                    if (fVal.includes('-')) {
                        const [min, max] = fVal.split('-').map(p => p.trim());
                        // Numeric Range
                        if (!isNaN(min) && !isNaN(max)) {
                            const numVal = parseFloat(rowVal);
                            return !isNaN(numVal) && numVal >= parseFloat(min) && numVal <= parseFloat(max);
                        }
                        // Char Range (Single Character)
                        if (min.length === 1 && max.length === 1 && rVal.length === 1) {
                            return rVal >= min && rVal <= max;
                        }
                    }

                    // Exact Filter
                    return rVal === fVal;
                };

                const matchesClass = advancedMatch(row.Class, filters.class);
                const matchesSection = advancedMatch(row.Section, filters.section);
                const matchesHouse = advancedMatch(row.House, filters.house);
                const matchesGender = !filters.gender || row.Gender === filters.gender;

                let matchesAttendance = true;
                if (filters.attendance) {
                    const status = (row["Absent/Present"] || "").toString().toLowerCase();
                    if (filters.attendance === "Absent") {
                        matchesAttendance = status.includes("absent");
                    } else if (filters.attendance === "Present") {
                        matchesAttendance = status === "" || !status.includes("absent") || status.includes("present");
                    }
                }

                let matchesComponents = true;
                if (filters.item) {
                    const item = allItems.find(i => i.name === filters.item);
                    if (item) {
                        const gender = (row["Gender"] || "").toUpperCase();
                        const itemType = item.type.toUpperCase();
                        if (itemType === "MALE" && gender !== "MALE") matchesComponents = false;
                        if (itemType === "FEMALE" && gender !== "FEMALE") matchesComponents = false;
                    }

                    Object.keys(filters.components).forEach(col => {
                        const filterVal = filters.components[col];
                        const rowVal = row[col];

                        // Range Logic (e.g., "30-35")
                        if (filterVal.includes('-')) {
                            const [min, max] = filterVal.split('-').map(Number);
                            if (!isNaN(min) && !isNaN(max)) {
                                const valNum = parseFloat(rowVal);
                                if (isNaN(valNum) || valNum < min || valNum > max) {
                                    matchesComponents = false;
                                }
                            } else {
                                // Fallback to exact string match if split fails (e.g. "A-B")
                                if (String(rowVal) !== filterVal) matchesComponents = false;
                            }
                        } else {
                            // Exact Match (String Comparison for robustness)
                            if (String(rowVal) !== filterVal) {
                                matchesComponents = false;
                            }
                        }
                    });
                }

                return matchesSearch && matchesClass && matchesSection && matchesHouse && matchesGender && matchesComponents && matchesAttendance;
            });
        }

        function addNewRow(render = true) {
            // Optimistic UI Update
            const newRow = {};
            [...infoCols, ...measureCols].forEach(col => newRow[col] = "");
            newRow["Absent/Present"] = "Present";
            measureCols.forEach(col => newRow[col] = "00");
            newRow["S.No"] = data.length + 1;

            // Generate Temp ID for tracking
            newRow._tempId = Date.now();

            data.push(newRow);
            if (render) {
                addToHistory();
                const totalFiltered = getFilteredData().length;
                currentPage = Math.ceil(totalFiltered / rowsPerPage);
                populateFilters();
                renderTable();
                renderCards();
                updateCount();
                updateUndoRedoUI();

                // Sync New Row
                syncRow(data.length - 1);

                setTimeout(() => {
                    const tableContainer = document.getElementById('tableView');
                    tableContainer.scrollTop = tableContainer.scrollHeight;
                }, 50);
            }
        }

        function updateCell(index, field, value) {
            const oldVal = data[index][field];
            if (oldVal !== value) {
                data[index][field] = value;

                // Define needsRerender based on field type
                const needsRerender = ['Class', 'Section', 'House', 'Gender', 'Absent/Present'].includes(field) ||
                    (filters.item && measureCols.includes(field));

                if (needsRerender) {
                    if (['Class', 'Section', 'House', 'Gender', 'Absent/Present'].includes(field)) {
                        populateFilters();
                    }

                    if (filters.item && measureCols.includes(field)) {
                        const currentSelections = { ...filters.components };
                        handleItemFilter(); // This rebuilds dropdowns
                        // With Input+Datalist structure, restore values
                        const container = document.getElementById('dynamicFilters');
                        Array.from(container.children).forEach(wrapper => {
                            const input = wrapper.querySelector('input');
                            if (input && currentSelections[input.placeholder]) {
                                input.value = currentSelections[input.placeholder];
                                filters.components[input.placeholder] = input.value;
                            }
                        });
                    }
                    renderTable();
                    renderCards();
                    updateCount();
                    updateUndoRedoUI();
                } else {
                    updateRowCalculations(index);
                    updateUndoRedoUI();
                }

                addToHistory();
                debouncedSave();
            }
        }

        function deleteRow(index) {
            if (confirm('Delete this record?')) {
                data.splice(index, 1);
                data.forEach((row, i) => row["S.No"] = i + 1);

                addToHistory(); // Snapshot AFTER delete

                populateFilters();
                renderTable();
                renderCards();
                updateCount();
                saveData();
                updateUndoRedoUI();
            }
        }

        function calculateItemValue(row, item) {
            const gender = (row["Gender"] || "").toUpperCase();
            const itemType = item.type.toUpperCase();

            // Strict Gender Check: If item is Male, Row MUST be Male
            // Exception: If gender is not set yet, we usually want to hide? 
            // Existing logic:
            if (itemType === "MALE" && gender !== "MALE") return "";
            if (itemType === "FEMALE" && gender !== "FEMALE") return "";

            const parts = item.cols.map(col => {
                const val = row[col];
                if (col === "Quantity" || col.toLowerCase() === "qty") {
                    // Look for SPECIFIC item quantity first
                    const specificQty = row[`Qty_${item.name}`];
                    // Default to 1 if missing/empty
                    return (specificQty === undefined || specificQty === null || specificQty === "") ? "1" : specificQty;
                }
                // Default Measurements to 00
                return val || "00";
            });
            return parts.join(",");
        }

        // Pagination Logic
        function changeRowsPerPage() {
            rowsPerPage = parseInt(document.getElementById('rowsPerPage').value);
            currentPage = 1;
            renderTable();
            renderCards();
            updateCount();
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
                renderCards();
                updateCount();
            }
        }

        function nextPage() {
            const filteredData = getFilteredData();
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
                renderCards();
                updateCount();
            }
        }

        function renderTable() {
            const filteredData = getFilteredData();
            const showCalculated = document.getElementById('showCalculated').checked;
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');



            // Pagination Slice
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            // Render Header
            // Render Header
            let headerHTML = `
                <tr class="bg-[#F7FAFC]">
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[50px] text-center font-bold text-[#4A5568]">#</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[60px] text-center font-bold text-[#4A5568]">Roll No</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] sticky-col bg-[#F7FAFC] z-20 min-w-[200px] text-left font-bold text-[#4A5568]" style="left: 0px;">Student Name</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[100px] text-left">Gender</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">Class</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">Section</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[80px] text-left">House</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[100px] text-left">Adm No</th>
                    <th class="p-3 border-b border-r border-[#E2E8F0] min-w-[120px] text-left">Absent/Present</th>
            `;

            measureCols.forEach(col => {
                const colorClass = col.startsWith('U') ? 'bg-[#EBF8FF] text-[#3182CE]' : 'bg-[#F0FFF4] text-[#38A169]';
                headerHTML += `<th class="p-3 border-b border-r border-[#E2E8F0] ${colorClass} min-w-[60px] text-center font-semibold">${col}</th>`;
            });

            let visibleItems = allItems;
            if (filters.item) {
                visibleItems = allItems.filter(i => i.name === filters.item);
            }

            if (showCalculated) {
                visibleItems.forEach(item => {
                    headerHTML += `<th class="p-3 border-b border-r border-[#E2E8F0] bg-[#FAF5FF] text-[#805AD5] min-w-[150px] text-left whitespace-nowrap text-[10px] font-medium tracking-wide">${item.name.replace('BOYS - ', 'B: ').replace('GIRLS - ', 'G: ')}</th>`;
                    headerHTML += `<th class="p-3 border-b border-r border-[#E2E8F0] bg-[#F0FFF4] text-[#2F855A] min-w-[60px] text-center font-bold text-[10px] tracking-wide">QUANTITY</th>`;
                });
            }

            headerHTML += `<th class="p-3 border-b border-[#E2E8F0] min-w-[50px]"></th></tr>`;
            thead.innerHTML = headerHTML;

            // Render Body
            tbody.innerHTML = pageData.map((row) => {
                const i = data.indexOf(row); // Get original index

                const attendanceStatus = (row["Absent/Present"] || "").toString().toLowerCase();
                const isAbsent = attendanceStatus.includes("absent");
                const rowBg = isAbsent ? "bg-red-50 hover:bg-red-100" : "hover:bg-[#F7FAFC]";
                const stickyBg = isAbsent ? "bg-red-50 group-hover:bg-red-100" : "bg-white group-hover:bg-[#F7FAFC]";

                let rowHTML = `
                <tr class="${rowBg} group border-b border-[#EDF2F7] transition-colors">
                    <td class="p-0 border-r border-[#EDF2F7] text-center text-[#CBD5E0] text-xs font-mono min-w-[50px]">${row["S.No"]}</td>
                    <td class="p-0 border-r border-[#EDF2F7] min-w-[60px]">
                        <input type="text" value="${row["Roll No"] || ''}" onchange="updateCell(${i}, 'Roll No', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-[#2C3E50] text-center font-mono" placeholder="-">
                    </td>
                    <td class="p-0 border-r border-[#EDF2F7] sticky-col ${stickyBg} min-w-[200px] shadow-[4px_0_8px_-2px_rgba(0,0,0,0.05)]" style="left: 0px;">
                        <input type="text" value="${row["Student Name"] || ''}" onchange="updateCell(${i}, 'Student Name', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-[#2C3E50] font-medium" placeholder="Name">
                    </td>
                    <td class="p-0 border-r border-[#EDF2F7]">
                        <input type="text" value="${row["Gender"] || ''}" onchange="updateCell(${i}, 'Gender', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-sm text-[#4A5568]" placeholder="-">
                    </td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Class"] || ''}" onchange="updateCell(${i}, 'Class', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Section"] || ''}" onchange="updateCell(${i}, 'Section', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["House"] || ''}" onchange="updateCell(${i}, 'House', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]"><input type="text" value="${row["Admission No"] || ''}" onchange="updateCell(${i}, 'Admission No', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center text-[#4A5568]"></td>
                    <td class="p-0 border-r border-[#EDF2F7]">
                        <select onchange="updateCell(${i}, 'Absent/Present', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-sm text-[#4A5568]">
                            <option value="Present" ${(!row["Absent/Present"] || row["Absent/Present"] === 'Present') ? 'selected' : ''}>Present</option>
                            <option value="Absent" ${row["Absent/Present"] === 'Absent' ? 'selected' : ''}>Absent</option>
                            <option value="Leave" ${row["Absent/Present"] === 'Leave' ? 'selected' : ''}>Leave</option>
                            <option value="OD" ${row["Absent/Present"] === 'OD' ? 'selected' : ''}>OD</option>
                        </select>
                    </td>
                `;

                measureCols.forEach(col => {
                    const bgClass = col.startsWith('U') ? 'bg-[#EBF8FF]/30' : 'bg-[#F0FFF4]/30';
                    // Aggressive Zero Hiding
                    let rVal = row[col];
                    if (rVal === '00' || rVal === '0' || rVal === 0) rVal = '';

                    rowHTML += `
                        <td class="p-0 border-r border-[#EDF2F7] ${bgClass}">
                            <input type="text" value="${rVal || ''}" onfocus="if(this.value==='') this.value=''" onchange="updateCell(${i}, '${col}', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center font-mono text-[#4A5568] focus:bg-white cursor-pointer" placeholder="-">
                        </td>
                    `;
                });

                if (showCalculated) {
                    visibleItems.forEach(item => {
                        const val = calculateItemValue(row, item);
                        const qtyKey = `Qty_${item.name}`;
                        let qtyValue = row[qtyKey] || '';

                        // JIT SANITIZATION: If Value is Corrupt (String with Comma), Clean it
                        if (typeof qtyValue === 'string' && qtyValue.includes(',')) {
                            qtyValue = "";
                            row[qtyKey] = ""; // Heal data
                        }

                        rowHTML += `<td class="p-2 border-r border-[#EDF2F7] bg-[#FAF5FF]/30 text-[10px] text-[#805AD5] font-mono whitespace-nowrap overflow-hidden text-ellipsis">${val}</td>`;
                        rowHTML += `
                            <td class="p-0 border-r border-[#EDF2F7] bg-[#F0FFF4]/30">
                                <input type="number" value="${qtyValue}" onfocus="if(this.value==='0' || this.value==='1') this.select()" onchange="updateCell(${i}, '${qtyKey}', this.value)" class="cell-input w-full h-full p-2 bg-transparent border-none text-center font-mono text-[#2F855A] focus:bg-white cursor-pointer" placeholder="-">
                            </td>
                        `;
                    });
                }

                rowHTML += `
                    <td class="p-1 text-center">
                        <button onclick="deleteRow(${i})" class="text-[#CBD5E0] hover:text-red-500 transition-colors">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </td>
                </tr>`;

                return rowHTML;
            }).join('');
        }

        function renderCards() {
            const filteredData = getFilteredData();
            const showCalculated = document.getElementById('showCalculated').checked;

            // Calculate unique genders for dynamic dropdown
            const uniqueGenders = [...new Set(data.map(r => r.Gender).filter(v => v && v !== ""))].sort();

            // Pagination Slice for Cards too
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            const container = document.getElementById('cardView');
            container.innerHTML = pageData.map((row) => {
                const i = data.indexOf(row);
                return `
                <div class="bg-white rounded-lg shadow-sm border border-[#E2E8F0] p-5 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-[#F7FAFC] text-[#A0AEC0] font-bold w-8 h-8 rounded-full flex items-center justify-center text-xs border border-[#EDF2F7]">
                                ${row["S.No"]}
                            </div>
                            <div>
                                <input type="text" value="${row["Student Name"] || ''}" onchange="updateCell(${i}, 'Student Name', this.value)" class="cell-input font-bold text-[#2C3E50] border-b border-transparent focus:border-[#4A5568] outline-none bg-transparent w-full text-lg" placeholder="Student Name">
                                <div class="flex gap-2 mt-2">
                                    <input type="text" value="${row["Gender"] || ''}" onchange="updateCell(${i}, 'Gender', this.value)" class="cell-input text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] text-[#4A5568] w-20" placeholder="Gender">
                                    <input type="text" value="${row["Class"] || ''}" onchange="updateCell(${i}, 'Class', this.value)" class="cell-input text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-14 text-center text-[#4A5568]" placeholder="Class">
                                    <input type="text" value="${row["Section"] || ''}" onchange="updateCell(${i}, 'Section', this.value)" class="cell-input text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-14 text-center text-[#4A5568]" placeholder="Sec">
                                    <input type="text" value="${row["House"] || ''}" onchange="updateCell(${i}, 'House', this.value)" class="cell-input text-xs bg-[#F7FAFC] rounded px-2 py-1 border border-[#EDF2F7] w-20 text-center text-[#4A5568]" placeholder="House">
                                </div>
                            </div>
                        </div>
                        <button onclick="deleteRow(${i})" class="text-[#CBD5E0] hover:text-red-500">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-4 gap-3 mb-2">
                        ${measureCols.map(col => {
                    let rVal = row[col];
                    if (rVal === '00' || rVal === '0' || rVal === 0) rVal = '';
                    return `
                            <div class="relative">
                                <label class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold ${col.startsWith('U') ? 'text-[#3182CE]' : 'text-[#38A169]'} tracking-wider">${col}</label>
                                <input type="number" value="${rVal || ''}" onfocus="if(this.value==='') this.value=''" onchange="updateCell(${i}, '${col}', this.value)" class="cell-input w-full border border-[#E2E8F0] rounded-md p-2 text-center font-mono text-sm focus:border-[#4A5568] focus:ring-1 focus:ring-[#4A5568] outline-none text-[#2C3E50]" placeholder="-">
                            </div>
                        `;
                }).join('')}
                    </div>

                    <!-- Calculated Items Section -->
                    ${showCalculated ? `
                    <div class="space-y-3 mt-4 border-t border-[#EDF2F7] pt-4">
                        ${(() => {
                            let visibleCardItems = allItems;
                            if (filters.item) {
                                visibleCardItems = allItems.filter(i => i.name === filters.item);
                            }
                            return visibleCardItems.map(item => {
                                const val = calculateItemValue(row, item);
                                const qtyKey = `Qty_${item.name}`;
                                return `
                                    <div class="flex items-center gap-2 bg-[#F7FAFC] p-2 rounded-md justify-between">
                                        <div class="flex flex-col min-w-0 flex-1">
                                            <label class="text-[10px] font-bold text-[#805AD5] uppercase tracking-wide truncate" title="${item.name}">${item.name.replace('BOYS - ', 'B: ').replace('GIRLS - ', 'G: ')}</label>
                                            <span class="font-mono text-xs text-[#4A5568] truncate" title="${val}">${val}</span>
                                        </div>
                                        <div class="flex flex-col items-center w-20 shrink-0">
                                             <label class="text-[9px] font-bold text-[#2F855A] uppercase tracking-wide">Qty</label>
                                             <input type="number" value="${row[qtyKey] || ''}" onfocus="if(this.value==='0' || this.value==='1') this.select()" onchange="updateCell(${i}, '${qtyKey}', this.value)" class="cell-input w-full border border-[#E2E8F0] rounded p-1 text-center font-mono text-sm text-[#2F855A] bg-white">
                                        </div>
                                    </div>
                                `;
                            }).join('');
                        })()}
                    </div>
                    ` : ''}
                </div>
            `}).join('');
        }

        function setView(view) {
            document.getElementById('tableView').classList.toggle('hidden', view !== 'table');
            document.getElementById('cardView').classList.toggle('hidden', view !== 'card');

            document.getElementById('btn-table').className = view === 'table' ? 'px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]' : 'px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all';
            document.getElementById('btn-card').className = view === 'card' ? 'px-4 py-1.5 rounded-md text-sm font-medium bg-white text-[#4A5568] shadow-sm transition-all border border-[#E2E8F0]' : 'px-4 py-1.5 rounded-md text-sm font-medium text-[#A0AEC0] hover:text-[#4A5568] transition-all';
        }

        function updateCount() {
            const filtered = getFilteredData().length;
            const total = data.length;
            const totalPages = Math.ceil(filtered / rowsPerPage);

            document.getElementById('rowCount').textContent = filtered;
            if (document.getElementById('totalCount')) {
                document.getElementById('totalCount').textContent = total;
            } else {
                // Fallback if HTML update failed
                document.getElementById('rowCount').textContent = `${filtered} / ${total}`;
            }

            document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;

            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages || totalPages === 0;
        }

        function showMetadata() {
            const container = document.getElementById('metadataContent');
            if (currentMetadata && currentMetadata.length > 0) {
                container.innerHTML = currentMetadata.map(row => {
                    const line = row.filter(c => c).join(' | ');
                    return `<div class="p-2 bg-[#F7FAFC] border border-[#EDF2F7] rounded break-words font-mono text-xs">${line || '<em class="text-gray-300">Empty Row</em>'}</div>`;
                }).join('');
            } else {
                container.innerHTML = '<p class="italic text-gray-400">No metadata found.</p>';
            }
            document.getElementById('metadataModal').classList.remove('hidden');
        }

        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const debouncedSave = debounce(saveData, 1000);

        function saveData() {
            localStorage.setItem('planetEditorData', JSON.stringify(data));
        }

        function updateRowCalculations(index) {
            if (!document.getElementById('showCalculated').checked) return;

            // Calculate the actual row index in the current page view
            // The tableBody has the filtered, paged rows.
            // We need to find the DOM row corresponding to 'index' (which is the index in the full 'data' array)
            // However, it's easier to just find the row by its S.No or careful mapping.
            // But wait, 'renderTable' renders `pageData`.
            // Let's interact with the DOM row if it exists in the current view.

            const filteredData = getFilteredData();
            // Check if this data index is in current filtered view
            if (!filteredData.includes(data[index])) return;

            const pageIndex = filteredData.indexOf(data[index]);
            // Check if on current page
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;

            if (pageIndex >= startIndex && pageIndex < endIndex) {
                // It is visible
                const domRowIndex = pageIndex - startIndex;
                const tbody = document.getElementById('tableBody');
                const row = tbody.children[domRowIndex];
                if (!row) return;

                // Calculated columns are at the end.
                // We know how many info + measure columns there are.
                // The infoCols array has 9 items now (S.No to Absent/Present)
                // So, 9 fixed columns (S.No to Absent/Present) + 16 Measure Columns = 25 columns.
                // Calculated columns start at index 25 (0-based)
                const calcStartIndex = infoCols.length + measureCols.length;
                const dataRow = data[index];

                let visibleItems = allItems;
                if (filters.item) {
                    visibleItems = allItems.filter(i => i.name === filters.item);
                }

                visibleItems.forEach((item, idx) => {
                    // There are 2 columns per item (Calculated Value + Quantity Input)
                    // We only want to update the Calculated Value column.
                    const cellIndex = calcStartIndex + (idx * 2);
                    const cell = row.children[cellIndex];
                    if (cell) {
                        cell.textContent = calculateItemValue(dataRow, item);
                    }
                });
            }
        }

        async function handleFileUpload(e) {
            console.log("üìÇ File input changed! Selected:", e.target.files[0]);
            try {
                const file = e.target.files[0];
                if (!file) {
                    console.warn("‚ö†Ô∏è No file selected.");
                    return;
                }

                console.log("‚è≥ Reading file...");
                const ab = await file.arrayBuffer();

                if (typeof XLSX === 'undefined') {
                    console.error("‚ùå SheetJS (XLSX) is NOT loaded globally!");
                    alert("Error: SheetJS library not loaded. Check internet connection.");
                    return;
                }

                console.log("üìñ Parsing workbook with SheetJS...");
                currentWorkbook = XLSX.read(ab);
                console.log("‚úÖ Workbook parsed. Sheets:", currentWorkbook.SheetNames);

                const sheetNames = currentWorkbook.SheetNames;
                renderSheetTabs(sheetNames);
                loadSheet(sheetNames[0]);
            } catch (error) {
                console.error("‚ùå Critical error in handleFileUpload:", error);
                alert("Import failed: " + error.message);
            }
        }

        function renderSheetTabs(sheetNames) {
            const container = document.getElementById('sheetTabs');
            if (sheetNames.length <= 1) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');

            container.innerHTML = `<span class="text-xs font-bold text-[#7F8C8D] uppercase tracking-wider mr-2">Sheets:</span>` +
                sheetNames.map(name => {
                    return `<button onclick="loadSheet('${name}')" data-sheet="${name}" class="sheet-tab px-3 py-1.5 rounded-t-md text-sm font-medium transition-all border-b-2 border-transparent hover:bg-white hover:text-[#2C3E50] text-[#7F8C8D]">${name}</button>`;
                }).join('');
        }

        function loadSheet(sheetName) {
            currentSheetName = sheetName;

            // Update Active Tab UI
            document.querySelectorAll('.sheet-tab').forEach(btn => {
                if (btn.dataset.sheet === sheetName) {
                    btn.classList.add('bg-white', 'text-[#2C3E50]', 'border-[#4A5568]', 'shadow-sm');
                    btn.classList.remove('text-[#7F8C8D]', 'border-transparent');
                } else {
                    btn.classList.remove('bg-white', 'text-[#2C3E50]', 'border-[#4A5568]', 'shadow-sm');
                    btn.classList.add('text-[#7F8C8D]', 'border-transparent');
                }
            });

            const ws = currentWorkbook.Sheets[sheetName];

            // Smart Header Detection (Upgraded from index.html)
            const headerRowIndex = detectHeaderRow(ws);
            console.log("Detected Header Row at Index:", headerRowIndex);

            // Capture Metadata Rows (Rows before the header)
            if (headerRowIndex > 0) {
                const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
                currentMetadata = rawRows.slice(0, headerRowIndex);
                // Ensure empty array if undefined/null
            } else {
                currentMetadata = [];
            }

            const jsonData = XLSX.utils.sheet_to_json(ws, { range: headerRowIndex, defval: "" });

            data = jsonData.map((row, i) => {
                const newRow = {};
                // Normalize keys from import
                const rowKeys = Object.keys(row);

                infoCols.forEach(col => {
                    // Try exact match
                    if (row[col] !== undefined) {
                        newRow[col] = row[col];
                    } else {
                        // Try case-insensitive match
                        const match = rowKeys.find(k => k.trim().toLowerCase() === col.toLowerCase());
                        newRow[col] = match ? row[match] : "";
                    }
                });

                if (!newRow["Absent/Present"]) newRow["Absent/Present"] = "Present";

                // Measure Columns Matching
                // Row keys might be "U1 (Shirt Length)" or just "U1"
                rowKeys.forEach(key => {
                    const cleanKey = key.trim();
                    measureCols.forEach(m => {
                        // Match "U1", "U1 ", "U1 ("
                        if (cleanKey === m || cleanKey.startsWith(m + " ") || cleanKey.startsWith(m + "(")) {
                            newRow[m] = row[key];
                        }
                    });
                });

                measureCols.forEach(m => {
                    if (!newRow[m]) newRow[m] = "00";
                });
                newRow["S.No"] = i + 1;
                return newRow;
            });

            populateFilters();
            populateItemFilter();
            renderTable();
            renderCards();
            updateCount();
            saveData();
        }

        function detectHeaderRow(ws) {
            const keyTerms = [
                "student", "name", "class", "section", "admission", "adm",
                "gender", "house", "u1", "s.no", "sl.no", "std", "div", "sec",
                "roll", "id", "no"
            ];

            const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
            let bestIndex = 0;
            let maxMatches = 0;

            // Scan first 20 rows
            for (let i = 0; i < Math.min(rawRows.length, 20); i++) {
                const row = rawRows[i];
                let matches = 0;
                if (Array.isArray(row)) {
                    row.forEach(cell => {
                        if (typeof cell === 'string') {
                            const cellLower = cell.trim().toLowerCase();
                            if (keyTerms.some(term => cellLower.includes(term))) {
                                matches++;
                            }
                        }
                    });
                }
                if (matches > maxMatches) {
                    maxMatches = matches;
                    bestIndex = i;
                }
            }
            return bestIndex;
        }

        // Advanced Export Modal Logic
        function openExportModal() {
            const modal = document.getElementById('exportModal');
            const filtered = getFilteredData();
            const count = filtered.length;

            document.getElementById('exportCount').textContent = count;

            // Auto-Fill School Name (Best Effort)
            const schoolNameInput = document.getElementById('metaSchool');
            if (schoolNameInput && !schoolNameInput.value) {
                // Try to get from session or school display
                const storedName = sessionStorage.getItem('schoolName'); // If we stored it
                if (storedName) schoolNameInput.value = storedName;
                else {
                    // Fallback: Use ID
                    const sid = sessionStorage.getItem('schoolId');
                    if (sid) schoolNameInput.value = "School #" + sid;
                }
            }

            // Calculate Totals
            const totalQty = calculateTotalQty(filtered);
            document.getElementById('exportTotalQty').innerText = totalQty;

            // Generate Filter Summary
            const activeFilters = [];
            if (filters.class) activeFilters.push(`Class: ${filters.class}`);
            if (filters.section) activeFilters.push(`Section: ${filters.section}`);
            if (filters.house) activeFilters.push(`House: ${filters.house}`);
            if (filters.gender) activeFilters.push(`Gender: ${filters.gender}`);
            if (filters.item) activeFilters.push(`Item: ${filters.item}`);
            Object.keys(filters.components).forEach(k => {
                activeFilters.push(`${k}: ${filters.components[k]}`);
            });

            document.getElementById('exportFilters').textContent = activeFilters.length ? activeFilters.join(' | ') : "All Data";

            updateExportTotal(); // Reset calc
            modal.classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
        }

        function calculateTotalQty(dataset) {
            let total = 0;
            dataset.forEach(row => {
                // Sum specific item quantities
                allItems.forEach(item => {
                    const qtyKey = `Qty_${item.name}`;
                    let rawQ = row[qtyKey];

                    // Validation: If it's a string with comma, it's corrupt data (the leak bug). Ignore it.
                    if (typeof rawQ === 'string' && rawQ.includes(',')) {
                        rawQ = NaN;
                    }

                    const q = parseFloat(rawQ);
                    // Only add if explicitly set and numeric. 
                    // If empty, do we assume 1 IF the item has data? 
                    // The user previously wanted "1" default for Export.
                    // For "Total Cloth", if they haven't entered a quantity, should we count it?
                    // Safe approach: Sum explicit quantities. If 0/empty, ignore (or assume 0).
                    // BUT for Export, we defaulted to "1".
                    // Let's align: If item string is valid (has measurements), assume default 1 if qty empty.

                    // New Check: calculateItemValue no longer has quantity
                    const valStr = calculateItemValue(row, item);
                    const hasMeasurements = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                    if (!isNaN(q)) {
                        total += q;
                    } else if (hasMeasurements) {
                        // If item has measurements but no explicit qty, count as 1
                        total += 1;
                    }
                });
            });
            return total;
        }

        function calculateTotalBreakdown(dataset) {
            const breakdown = {};
            dataset.forEach(row => {
                allItems.forEach(item => {
                    const qtyKey = `Qty_${item.name}`;
                    let rawQ = row[qtyKey];
                    if (typeof rawQ === 'string' && rawQ.includes(',')) rawQ = NaN;
                    let q = parseFloat(rawQ);

                    // Logic matches calculateTotalQty:
                    // 1. Explicit Quantity?
                    if (!isNaN(q)) {
                        breakdown[item.name] = (breakdown[item.name] || 0) + q;
                    } else {
                        // 2. Calculated Value?
                        const valStr = calculateItemValue(row, item);
                        const hasMeasurements = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (hasMeasurements) {
                            breakdown[item.name] = (breakdown[item.name] || 0) + 1;
                        }
                    }
                });
            });
            return breakdown;
        }

        function updateExportTotal() {
            const consumption = parseFloat(document.getElementById('metaConsumption').value) || 0;
            const filteredData = getFilteredData();
            const totalQty = calculateTotalQty(filteredData);
            const total = (totalQty * consumption).toFixed(2);
            document.getElementById('exportTotalCloth').textContent = `${total} M`;
        }

        function confirmExport() {
            closeExportModal();

            const exportData = getFilteredData();
            const schoolName = document.getElementById('metaSchool').value;
            const patternCode = document.getElementById('metaPattern').value;
            const description = document.getElementById('metaDesc').value;
            // Quantity removed from global metadata
            const consumption = document.getElementById('metaConsumption').value;
            const clothDetails = document.getElementById('metaClothDetails').value;
            const specialReq = document.getElementById('metaSpecialReq').value;
            const totalCloth = document.getElementById('exportTotalCloth').textContent;
            const filterSummary = document.getElementById('exportFilters').textContent;

            const infoHeaders = ["S.No", "Roll No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
            const measureHeaders = [
                "U1 (SHIRT LENGTH)", "U2 (CHEST)", "U3 (STOMACH)", "U4 (SHOULDER)",
                "U5 (FULL SLEEVE)", "U6 (HALF SLEEVE)", "U7 (KURTHA/SPECIAL FROCK LENGTH)", "U8 (EXTRA CELL)",
                "L1 (PANT LENGTH)", "L2 (WAIST)", "L3 (SHORTS LENGTH)", "L4 (PINOFORE LENGTH)",
                "L5 (SKIRT LENGTH)", "L6 (HIP)", "L7 (THIGH)", "L8 (EXTRA CELL)"
            ];

            // 1. Filter Items based on User Selection (Dropdown) OR Gender
            const selectedItemFilter = document.getElementById('filterItem') ? document.getElementById('filterItem').value : "";
            let visibleItems = allItems;

            if (selectedItemFilter && selectedItemFilter !== "All Items" && selectedItemFilter !== "") {
                // Exact Match Filter
                visibleItems = allItems.filter(i => i.name === selectedItemFilter);
            } else {
                // Fallback to Gender Logic
                const visibleGenders = new Set(exportData.map(r => (r.Gender || "").toUpperCase()));
                const hasMale = visibleGenders.has("MALE");
                const hasFemale = visibleGenders.has("FEMALE");

                if (hasMale && !hasFemale) {
                    visibleItems = allItems.filter(i => i.type.toUpperCase() !== "FEMALE");
                } else if (hasFemale && !hasMale) {
                    visibleItems = allItems.filter(i => i.type.toUpperCase() !== "MALE");
                }
            }

            const itemHeaders = visibleItems.map(i => i.name);
            // Add Pattern Column to Headers
            const headers = [...infoHeaders, ...measureHeaders, ...itemHeaders, "Pattern Code"];

            // Construct Metadata Rows
            let sheetData = [];

            // Add existing metadata (from import) + New Metadata
            sheetData.push(["METADATA:"]);
            if (schoolName) sheetData.push(["School Name", schoolName]);
            if (patternCode) sheetData.push(["Pattern Code", patternCode]);
            if (description) sheetData.push(["Description", description]);
            // if (quantity) sheetData.push(["Quantity", quantity]); // Removed
            if (clothDetails) sheetData.push(["Cloth Details", clothDetails]);
            if (specialReq) sheetData.push(["Special Requirements", specialReq]);
            sheetData.push(["Total Students", exportData.length]);
            if (consumption) {
                const totalQty = calculateTotalQty(exportData);
                const calcTotal = (totalQty * parseFloat(consumption)).toFixed(2);
                sheetData.push(["Cloth/Student", consumption + " M", "Total Cloth", calcTotal]);
            }
            sheetData.push(["Filters Applied", filterSummary]);
            if (selectedItemFilter && selectedItemFilter !== "All Items") {
                sheetData.push(["Item Filter", selectedItemFilter]);
            }
            sheetData.push(["Export Date", new Date().toLocaleString()]);
            sheetData.push([]); // Spacer

            // Excel Header: interleaved Item + Quantity
            const headerRow = [];
            infoHeaders.forEach(col => headerRow.push(col));
            measureHeaders.forEach(col => headerRow.push(col)); // Add measure headers
            visibleItems.forEach(item => {
                headerRow.push(item.name);
                headerRow.push("Quantity");
            });
            headerRow.push("Pattern Code");
            sheetData.push(headerRow); // Add the constructed header row to sheetData

            // Excel Data
            exportData.forEach(row => {
                const rowArray = [];
                infoHeaders.forEach(col => rowArray.push(row[col] || ""));
                measureHeaders.forEach((_, i) => {
                    const key = measureCols[i];
                    rowArray.push(row[key] || "00");
                }); // Add measure data

                visibleItems.forEach(item => {
                    // Calculated Item String
                    rowArray.push(calculateItemValue(row, item));

                    // Explicit Quantity
                    let q = row[`Qty_${item.name}`];
                    if (typeof q === 'string' && q.includes(',')) q = ""; // Sanitize
                    // Default to 1 if no qty but item exists?
                    // calculateItemValue defaults qty to 1 inside the STRING.
                    // Here we want the explicit quantity column.
                    // If empty, let's show empty or                        // Only if calculateItemValue returned a valid pattern (not empty).
                    const val = calculateItemValue(row, item);
                    const hasData = val.replace(/,00/g, '').replace(/,/g, '').length > 0;
                    if (!q && hasData) q = 1;

                    rowArray.push(q || "");
                });

                rowArray.push(patternCode || "");
                sheetData.push(rowArray);
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(sheetData);

            const startMeasureCol = infoHeaders.length;
            const uMap = {};
            for (let i = 1; i <= 8; i++) uMap[`U${i}`] = startMeasureCol + i - 1;
            const lMap = {};
            for (let i = 1; i <= 8; i++) lMap[`L${i}`] = startMeasureCol + 8 + i - 1;

            // Correctly start just after info + measures
            const startItemCol = infoHeaders.length + measureHeaders.length;

            // Dynamically calculate Header Row Index
            // It's the last row in sheetData BEFORE data starts.
            // sheetData length = Metadata + 1 (Header) + DataRows
            // Header is at index: sheetData.length - exportData.length - 1
            const headerRowIndex = sheetData.length - exportData.length - 1;

            for (let r = 0; r < exportData.length; r++) {
                // Excel Row Calculation (1-based index)
                const rowNum = headerRowIndex + r + 2;
                const genderCell = `H${rowNum}`; // Gender is now at column H (0-indexed G)

                // Only iterate over VISIBLE items
                visibleItems.forEach((item, idx) => {
                    const colIndex = startItemCol + (idx * 2); // Items are interleaved with Quantity
                    const cellRef = XLSX.utils.encode_cell({ r: rowNum - 1, c: colIndex });

                    const parts = item.cols.map(comp => {
                        let colIdx = -1;
                        if (uMap[comp] !== undefined) colIdx = uMap[comp];
                        else if (lMap[comp] !== undefined) colIdx = lMap[comp];

                        if (colIdx !== -1) {
                            return `${XLSX.utils.encode_col(colIdx)}${rowNum}`;
                        }
                        return null;
                    }).filter(p => p);

                    const concatFormula = parts.join(' & "," & ');
                    let finalFormula = "";

                    if (item.type === "Male") {
                        finalFormula = `IF(UPPER(${genderCell})="MALE", ${concatFormula}, "")`;
                    } else if (item.type === "Female") {
                        finalFormula = `IF(UPPER(${genderCell})="FEMALE", ${concatFormula}, "")`;
                    } else {
                        finalFormula = concatFormula;
                    }

                    const calculatedValue = calculateItemValue(exportData[r], item);

                    if (!ws[cellRef]) ws[cellRef] = { t: 's', v: '' };
                    ws[cellRef].f = finalFormula;
                    ws[cellRef].v = calculatedValue;
                });
            }

            const wscols = headers.map(h => ({ wch: h.length + 5 }));
            ws['!cols'] = wscols;

            XLSX.utils.book_append_sheet(wb, ws, "Measurements");
            XLSX.writeFile(wb, `Planet_Data_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }


        async function confirmExportPDF() {
            try {
                console.log("Starting PDF Export...");
                closeExportModal();

                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error("jsPDF library not found. Please refresh the page.");
                }

                const { jsPDF } = window.jspdf;
                // A4 Landscape - Standard & Clean
                const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });

                const exportData = getFilteredData();
                const schoolName = document.getElementById('metaSchool').value;
                const patternCode = document.getElementById('metaPattern').value;
                const description = document.getElementById('metaDesc').value;
                // const quantity = document.getElementById('metaQuantity').value;
                const consumption = document.getElementById('metaConsumption').value;
                const clothDetails = document.getElementById('metaClothDetails').value;
                const specialReq = document.getElementById('metaSpecialReq').value;
                const filterSummary = document.getElementById('exportFilters').textContent;

                // Get Specific Item Filter
                const selectedItemFilter = document.getElementById('filterItem') ? document.getElementById('filterItem').value : "";

                // Japanese Design Palette
                const colorDark = [44, 62, 80]; // Dark Indigo/Gunmetal
                const colorLight = [245, 247, 250]; // Very Light Gray (Clouds)

                let y = 15;
                const metaLeft = 14;

                // Title - Minimalist & Bold
                doc.setFont("helvetica", "bold");
                doc.setFontSize(18);
                doc.setTextColor(...colorDark);
                doc.text("Planet Data Export", metaLeft, y);
                y += 10;

                // Metadata Section - Clean Typography
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);

                const addMetaLine = (label, value) => {
                    if (value) {
                        doc.setFont("helvetica", "bold");
                        doc.text(`${label}:`, metaLeft, y);
                        doc.setFont("helvetica", "normal");
                        doc.text(value, metaLeft + 35, y);
                        y += 6;
                    }
                };

                addMetaLine("School", schoolName);
                addMetaLine("Pattern", patternCode);
                addMetaLine("Description", description);
                // addMetaLine("Quantity", quantity); // Removed

                if (clothDetails) {
                    doc.setFont("helvetica", "bold");
                    doc.text("Cloth Details:", metaLeft, y);
                    doc.setFont("helvetica", "normal");
                    const splitCloth = doc.splitTextToSize(clothDetails, 200);
                    doc.text(splitCloth, metaLeft + 35, y);
                    y += (splitCloth.length * 5) + 2;
                }

                if (specialReq) {
                    doc.setFont("helvetica", "bold");
                    doc.text("Special Req:", metaLeft, y);
                    doc.setFont("helvetica", "normal");
                    const splitReq = doc.splitTextToSize(specialReq, 200);
                    doc.text(splitReq, metaLeft + 35, y);
                    y += (splitReq.length * 5) + 2;
                }

                addMetaLine("Total Students", `${exportData.length}`);

                if (consumption) {
                    const totalQty = calculateTotalQty(exportData);
                    const totalCloth = (totalQty * parseFloat(consumption)).toFixed(2);
                    addMetaLine("Cloth/Student", `${consumption} M`);
                    addMetaLine("Total Cloth", `${totalCloth} M`);
                }

                addMetaLine("Filters", filterSummary);
                if (selectedItemFilter && selectedItemFilter !== "All Items") {
                    addMetaLine("Item Filter", selectedItemFilter);
                }

                y += 5;

                // Table Logic
                // 1. Filter Items based on User Selection (Dropdown) OR Gender
                let visibleItems = allItems;

                if (selectedItemFilter && selectedItemFilter !== "All Items" && selectedItemFilter !== "") {
                    // Exact Match Filter (User requested "only show that item")
                    visibleItems = allItems.filter(i => i.name === selectedItemFilter);
                } else {
                    // Fallback to Gender Logic if no specific item selected
                    const visibleGenders = new Set(exportData.map(r => (r.Gender || "").toUpperCase()));
                    const hasMale = visibleGenders.has("MALE");
                    const hasFemale = visibleGenders.has("FEMALE");

                    if (hasMale && !hasFemale) {
                        visibleItems = allItems.filter(i => i.type.toUpperCase() !== "FEMALE");
                    } else if (hasFemale && !hasMale) {
                        visibleItems = allItems.filter(i => i.type.toUpperCase() !== "MALE");
                    }
                }

                const itemHeaders = [];
                visibleItems.forEach(item => {
                    itemHeaders.push(item.name.replace('BOYS - ', 'B: ').replace('GIRLS - ', 'G: '));
                    itemHeaders.push("Qty");
                });
                const tableHeaders = [[...infoCols, ...itemHeaders, "Pattern"]];

                const tableRows = exportData.map(row => {
                    const infoValues = infoCols.map(col => row[col] || "");
                    const itemValues = [];

                    visibleItems.forEach(item => {
                        itemValues.push(calculateItemValue(row, item));
                        let q = row[`Qty_${item.name}`];
                        if (typeof q === 'string' && q.includes(',')) q = ""; // Sanitize

                        const val = calculateItemValue(row, item);
                        const hasData = val.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (!q && hasData) q = 1;

                        itemValues.push(q || "");
                    });

                    return [...infoValues, ...itemValues, patternCode || ""];
                });

                // AutoTable - Japanese Minimalist
                doc.autoTable({
                    head: tableHeaders,
                    body: tableRows,
                    startY: y,
                    theme: 'grid', // Clean grid
                    headStyles: {
                        fillColor: colorDark,
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold',
                        halign: 'center',
                        valign: 'middle',
                        cellPadding: 3,
                        lineWidth: 0 // No border on header for cleaner look
                    },
                    bodyStyles: {
                        fontSize: 9,
                        textColor: 50,
                        valign: 'middle',
                        cellPadding: 3,
                        lineColor: [230, 230, 230] // Very subtle borders
                    },
                    alternateRowStyles: {
                        fillColor: colorLight // Subtle striping
                    },
                    styles: {
                        overflow: 'linebreak',
                        halign: 'left',
                        font: 'helvetica'
                    },
                    // Clean, standard proportions for A4 Landscape
                    columnStyles: {
                        0: { cellWidth: 12 },  // S.No
                        1: { cellWidth: 15 },  // Roll No
                        2: { cellWidth: 20 },  // Adm No
                        3: { cellWidth: 40 },  // Name
                        4: { cellWidth: 15 },  // Class
                        5: { cellWidth: 15 },  // Section
                        6: { cellWidth: 20 },  // House
                        7: { cellWidth: 20 },  // Gender
                        8: { cellWidth: 30 },  // Absent/Present
                        // Dynamic styling for item info columns
                        // If only 1 item selected, give it plenty of space
                        ...(visibleItems.length === 1 ? { 9: { cellWidth: 'auto' } } : {}),
                        // Pattern Column Style (Last Column)
                        [tableHeaders[0].length - 1]: { cellWidth: 25, halign: 'center' }
                    }
                });

                doc.save(`PlanetData_PDF_${new Date().toISOString().slice(0, 10)}.pdf`);

            } catch (error) {
                console.error("PDF Export Error:", error);
                alert("Failed to export PDF: " + error.message);
            }
        }

        function addToHistory() {

            // Deep copy of data
            history.push(JSON.stringify(data));
            if (history.length > MAX_HISTORY) {
                history.shift();
            } else {
                historyIndex++;
            }
            updateUndoRedoUI();
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                data = JSON.parse(history[historyIndex]);
                postRestoreState();
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                data = JSON.parse(history[historyIndex]);
                postRestoreState();
            }
        }

        function postRestoreState() {
            populateFilters();
            renderTable();
            renderCards();
            updateCount();
            saveData(); // Save to local storage without adding to history again
            updateUndoRedoUI();
        }

        function updateUndoRedoUI() {
            let btnContainer = document.getElementById('undoRedoContainer');
            if (!btnContainer) {
                // Find the actions container (Export/Import buttons)
                // Find the actions container (Export/Import buttons)
                const actionsContainer = document.getElementById('headerActions');
                if (actionsContainer) {
                    btnContainer = document.createElement('div');
                    btnContainer.id = 'undoRedoContainer';
                    btnContainer.className = 'flex gap-1 mr-2';
                    btnContainer.innerHTML = `
                        <button onclick="undo()" id="btnUndo" class="p-2 rounded-md hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-30 disabled:cursor-not-allowed border border-[#E2E8F0] bg-white transition-all shadow-sm" title="Undo">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"></path><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path></svg>
                        </button>
                        <button onclick="redo()" id="btnRedo" class="p-2 rounded-md hover:bg-[#F7FAFC] text-[#4A5568] disabled:opacity-30 disabled:cursor-not-allowed border border-[#E2E8F0] bg-white transition-all shadow-sm" title="Redo">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"></path><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3L21 13"></path></svg>
                        </button>
                    `;
                    actionsContainer.insertBefore(btnContainer, actionsContainer.firstChild);
                }
            }

            if (btnContainer) {
                document.getElementById('btnUndo').disabled = historyIndex <= 0;
                document.getElementById('btnRedo').disabled = historyIndex >= history.length - 1;
            }
        }




        async function handleDataUpload() {
            const c = confirm("Are you sure you want to UPLOAD this data?\nThis will create a Pattern/Order record and save student quantities.");
            if (!c) return;

            const token = sessionStorage.getItem('token');
            const schoolId = sessionStorage.getItem('schoolId');

            // Metadata from Modal
            const meta = {
                school_id: schoolId,
                name: document.getElementById('metaPattern').value || "Upload_" + new Date().toISOString().slice(0, 10),
                consumption: parseFloat(document.getElementById('metaConsumption').value) || 0,
                cloth_details: document.getElementById('metaClothDetails').value,
                special_req: document.getElementById('metaSpecialReq').value,
                // Store Individual Item Breakdown
                quantities: calculateTotalBreakdown(getFilteredData())
            };

            try {
                // 1. Create Pattern/Order Record
                // Use existing /api/data/patterns endpoint (it accepts name, consumption, etc.)
                const res = await fetch('/api/data/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(meta)
                });

                if (!res.ok) throw new Error("Failed to create Order Record");
                const resData = await res.json();
                const patternId = resData.id;

                // 2. Link Filtered Students to this Pattern
                const filtered = getFilteredData();
                const ids = filtered.map(d => d.id);
                data.forEach(d => {
                    if (ids.includes(d.id)) {
                        d.pattern_id = patternId;
                    }
                });

                // 3. Sync Students (Production Data Snapshot)
                await syncToCloud();

                alert(`‚úÖ Upload Successful!\nOrder Record Created (ID: ${patternId}).\n${filtered.length} Students Updated.\n\nRedirecting to Pattern Dashboard...`);
                // Redirect immediately to the new Pattern View Dashboard
                window.location.href = `pattern_view.html?id=${patternId}`;

            } catch (e) {
                alert("Upload Failed: " + e.message);
            }
        }

        init();
    </script>



</body>


</html>