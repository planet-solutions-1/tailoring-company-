<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern View | Planet Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #1c1917;
            --rice-paper: #fafaf9;
            --seal-red: #be123c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--rice-paper);
            color: #44403c;
        }

        .font-ink {
            font-family: 'Noto Serif JP', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="planet_editor.html"
                    class="text-stone-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-wider">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Editor
                </a>
                <div class="h-6 w-px bg-stone-700"></div>
                <h1 class="font-ink text-xl flex items-center gap-2"><span class="text-rose-600 text-2xl">●</span>
                    <span id="pageTitle">Pattern Details View</span>
                </h1>
            </div>

            <!-- Default Actions (View Mode) -->
            <div id="viewActions" class="flex gap-3">
                <button onclick="downloadPDF()"
                    class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download PDF
                </button>
                <button onclick="downloadExcel()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download Excel
                </button>
            </div>

            <!-- Create Actions (Create Mode) -->
            <div id="createActions" class="hidden flex gap-3">
                <button onclick="savePattern()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow-lg text-sm font-bold uppercase flex items-center gap-2 transition-transform active:scale-95 ring-2 ring-indigo-400">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save & Create Pattern
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 max-w-[1920px] mx-auto w-full space-y-4">

        <!-- Creation Panel (Only Visible in Create Mode) -->
        <div id="creationPanel" class="hidden glass-panel p-6 rounded-xl border-l-4 border-indigo-500 shadow-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Metadata Inputs -->
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Pattern Details</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">School Name</label>
                            <input type="text" id="metaSchool" readonly
                                class="w-full text-sm border border-gray-300 rounded p-2 bg-gray-100 text-gray-600 font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Pattern Code</label>
                            <input type="text" id="metaPattern"
                                class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200"
                                placeholder="e.g. P-101">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Description</label>
                        <textarea id="metaDesc" rows="2"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500"
                            placeholder="Optional description..."></textarea>
                    </div>
                </div>

                <!-- Specs Inputs -->
                <div class="space-y-4 bg-stone-50 p-4 rounded-lg border border-stone-200">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Specifications</h3>

                    <div class="flex items-center justify-between">
                        <label class="block text-xs font-bold text-stone-600 uppercase">Cloth Consumption
                            (Mtrs/Student)</label>
                        <input type="number" id="metaConsumption" step="0.01"
                            class="w-32 text-sm border border-gray-300 rounded p-1 text-right font-mono font-bold text-indigo-700"
                            placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Cloth Details</label>
                        <input type="text" id="metaClothDetails"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Special
                            Requirements</label>
                        <input type="text" id="metaSpecialReq"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                </div>
            </div>
        </div>


        <!-- Advanced Toolbar (Ported from Editor) -->
        <div id="filterPanel"
            class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-4 overflow-x-auto no-scrollbar z-20 relative sticky top-0">

            <!-- Search & Filters -->
            <div class="flex items-center gap-3 w-full sm:w-auto overflow-x-auto">
                <div class="relative">
                    <svg class="absolute left-3 top-2 text-[#A0AEC0]" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search..."
                        class="pl-9 pr-3 py-1.5 text-sm border border-[#E2E8F0] rounded-md focus:border-[#4A5568] outline-none w-32 sm:w-48 bg-[#F9F9F7] focus:bg-white transition-colors">
                </div>

                <select id="filterClass" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Classes</option>
                </select>

                <select id="filterSection" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Sections</option>
                </select>

                <select id="filterHouse" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Houses</option>
                </select>

                <select id="filterGender" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Genders</option>
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                </select>

                <select id="filterAttendance" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Attendance</option>
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                </select>

                <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block mx-2"></div>

                <select id="filterItem" onchange="handleItemFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[200px] font-medium">
                    <option value="">All Measurements (U1-L8)</option>
                </select>

                <div class="flex items-center gap-2 pl-2 border-l border-[#E2E8F0] ml-2">
                    <input type="checkbox" id="filterHasData" onchange="handleFilter()" checked
                        class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                    <label for="filterHasData"
                        class="text-sm text-[#4A5568] font-medium whitespace-nowrap select-none cursor-pointer">With
                        Data Only</label>
                </div>

                <!-- School/Pattern Hidden Selects for View Mode Compatibility -->
                <!-- School/Pattern Filters (Unhidden for Pattern Management) -->
                <select id="f-school" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[150px]">
                    <option value="all">All Schools</option>
                </select>
                <select id="f-pattern" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[150px]">
                    <option value="all">All Patterns</option>
                </select>
                <!-- Legacy IDs Mapped -->
                <input type="hidden" id="f-class" value="">
                <input type="hidden" id="f-gender" value="all">
                <input type="hidden" id="f-packed" value="all">
                <input type="hidden" id="f-item" value="all">

                <!-- Dynamic Component Filters Container -->
                <div id="dynamicFilters" class="flex flex-wrap items-center gap-2">
                    <!-- Dropdowns will be injected here -->
                </div>
            </div>

            <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

            <div class="flex items-center gap-2 ml-auto">
                <!-- Export Buttons from Header -->
                <div id="viewActions" class="flex gap-2">
                    <button id="btnToggleView" onclick="togglePatternView()"
                        class="bg-stone-700 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-stone-800 shadow-sm flex items-center gap-1 transition-colors">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span id="txtToggleView">View Groups</span>
                    </button>
                    <button onclick="openRenameModal()" id="btnRenamePattern"
                        class="hidden bg-stone-100 text-stone-700 border border-stone-200 px-3 py-1.5 rounded text-xs font-bold hover:bg-stone-200 shadow-sm">
                        Rename
                    </button>
                    <button onclick="downloadPDF()"
                        class="btn-outline px-3 py-1.5 rounded text-xs font-bold text-rose-600 border-rose-200 hover:bg-rose-50">PDF</button>
                    <button onclick="downloadExcel()"
                        class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm">Excel</button>
                    <button id="btnDeletePattern" onclick="deletePattern()"
                        class="hidden bg-red-100 text-red-700 border border-red-200 px-3 py-1.5 rounded text-xs font-bold hover:bg-red-200 shadow-sm flex items-center gap-1">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                        Delete
                    </button>
                </div>
                <div id="createActions" class="hidden flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-purple-50 px-3 py-1 rounded border border-purple-200">
                        <label class="text-[10px] font-bold text-purple-700 uppercase">Material Calc</label>
                        <input type="number" id="metaConsumption" placeholder="Unit (m)" step="0.1"
                            oninput="calculateMaterial()"
                            class="w-16 border border-purple-300 rounded px-2 py-1 text-xs outline-none focus:border-purple-500 font-bold text-purple-700 bg-white">
                        <span class="text-xs text-purple-400">x Qty =</span>
                        <span id="calcTotalMaterial" class="text-sm font-bold text-purple-800">0m</span>
                    </div>

                    <button onclick="savePattern()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center gap-2 transition-transform active:scale-95">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save & Create Pattern
                    </button>
                </div>
            </div>
        </div>

        <!-- Pattern Groups View (New Window/Section) -->
        <div id="groupsView"
            class="hidden flex-1 glass-panel rounded-xl p-6 shadow-xl border border-stone-200 overflow-auto">
            <h2 class="text-xl font-ink font-bold text-stone-800 mb-6 flex items-center gap-2">
                <span class="text-indigo-600 text-2xl">❖</span> Pattern Groups
            </h2>
            <div id="patternGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Grid Items -->
            </div>
        </div>

        <!-- Data Table View -->
        <div id="tableView"
            class="hidden glass-panel rounded-xl overflow-hidden shadow-xl border border-stone-200 flex-1 min-h-[500px] flex flex-col">
            <div class="overflow-auto flex-1 h-full">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-stone-50 text-stone-500 uppercase text-xs sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="p-3 font-bold border-b border-r bg-stone-50 sticky left-0 z-30 w-16">No.</th>
                            <th class="p-3 font-bold border-b">School</th>
                            <th class="p-3 font-bold border-b">Student</th>
                            <th class="p-3 font-bold border-b">Class</th>
                            <th class="p-3 font-bold border-b">Pattern</th>
                            <!-- Dynamic Measurement Headers -->
                            <th class="p-3 font-bold border-b bg-amber-50 text-amber-700 text-center"
                                id="meas-header-group" colspan="1">Measurements</th>
                            <th class="p-3 font-bold border-b text-center">Status</th>
                        </tr>
                        <tr id="sub-header-row" class="bg-stone-100 text-[10px] font-mono text-stone-600 hidden">
                            <!-- Will be populated by JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-stone-100 bg-white text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t bg-stone-50 text-right text-xs text-stone-500 font-mono" id="row-count">Loading...
            </div>
        </div>

    </main>

    <script>
        const API_BASE = '/api';
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'planet_editor.html';

        // --- URL PARAMS ---
        const urlParams = new URLSearchParams(window.location.search);
        const TARGET_PATTERN_ID = urlParams.get('id');
        const MODE = urlParams.get('mode'); // 'create' or null

        // --- DATA ---
        let allStudents = [];
        let patterns = [];
        let schools = [];
        let filteredStudents = []; // Active dataset
        let draftMetadata = null;

        // --- CONFIG ---
        // --- CONFIG ---
        const infoCols = ["S.No", "Roll No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
        const measureCols = ["U1", "U2", "U3", "U4", "U5", "U6", "U7", "U8", "L1", "L2", "L3", "L4", "L5", "L6", "L7", "L8"];

        const boysItems = [
            { name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" },
        ];

        const girlsItems = [
            { name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" },
            { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" },
            { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" },
            { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" },
        ];
        const allItems = [...boysItems, ...girlsItems];

        let filters = {
            search: '',
            class: '',
            section: '',
            house: '',
            gender: '',
            attendance: '',
            item: '',
            hasData: true, // Default Checked
            components: {}
        };
        let searchTimeout = null;

        // --- INIT ---
        async function init() {
            // Populate Items (handled by populateFilters and static options)
            // But we need to load initial items into Item Select
            const itemSel = document.getElementById('f-item'); // Note: ID changed to filterItem in new HTML but kept aliases
            // Wait, I replaced the HTML. The new ID is `filterItem`. The old one `f-item` is hidden.
            // I should update this to populate `filterItem`.
            const newItemSel = document.getElementById('filterItem');
            if (newItemSel) {
                newItemSel.innerHTML = '<option value="">All Measurements (U1-L8)</option>' + allItems.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
            }

            if (MODE === 'create') {
                setupCreateMode();
            } else {
                setupViewMode();
            }
        }
        init();

        // --- FILTERING LOGIC ---
        function populateFilters() {
            const classes = new Set();
            const sections = new Set();
            const houses = new Set();

            allStudents.forEach(s => {
                const c = getStudentProp(s, 'class');
                const sec = getStudentProp(s, 'section');
                const h = getStudentProp(s, 'house'); // Assuming 'house' prop handled in getStudentProp
                if (c) classes.add(c);
                if (sec) sections.add(sec);
                if (h) houses.add(h);
            });

            const fillParam = (id, set) => {
                const el = document.getElementById(id);
                if (!el) return;
                const current = el.value;
                el.innerHTML = `<option value="">All ${id.replace('filter', '')}s</option>` +
                    [...set].sort().map(v => `<option value="${v}">${v}</option>`).join('');
                el.value = current;
            };

            fillParam('filterClass', classes);
            fillParam('filterSection', sections);
            fillParam('filterHouse', houses);
        }

        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filters.search = document.getElementById('searchInput').value.toLowerCase();
                renderTable();
            }, 300);
        }

        function handleFilter() {
            filters.class = document.getElementById('filterClass').value;
            filters.section = document.getElementById('filterSection').value;
            filters.house = document.getElementById('filterHouse').value;
            filters.gender = document.getElementById('filterGender').value;
            filters.attendance = document.getElementById('filterAttendance').value;
            filters.hasData = document.getElementById('filterHasData').checked;

            // Show/Hide Delete Button based on Pattern Selection
            const fPattern = document.getElementById('f-pattern').value;
            const btnDel = document.getElementById('btnDeletePattern');
            if (fPattern && fPattern !== 'all') {
                btnDel.classList.remove('hidden');
                document.getElementById('btnRenamePattern').classList.remove('hidden');
            } else {
                btnDel.classList.add('hidden');
                document.getElementById('btnRenamePattern').classList.add('hidden');
            }

            renderTable();
        }

        function handleItemFilter() {
            const itemName = document.getElementById('filterItem').value;
            filters.item = itemName;
            filters.components = {};

            const container = document.getElementById('dynamicFilters');
            container.innerHTML = '';

            if (itemName) {
                const item = allItems.find(i => i.name === itemName);
                if (item) {
                    item.cols.forEach(col => {
                        // Extract unique values for this col from data
                        // Need to use getMeasurementsSafe and handle flat/nested
                        const values = new Set();
                        allStudents.forEach(s => {
                            const m = getMeasurementsSafe(s);
                            // Robust access: U1 or u1
                            const val = m[col] || m[col.toLowerCase()];
                            if (val && val !== "00") values.add(val);
                        });
                        const sortedValues = [...values].sort();

                        const wrapper = document.createElement('div');
                        wrapper.className = "relative inline-block";

                        const input = document.createElement('input');
                        input.setAttribute('list', `list-${col}`);
                        input.type = "text";
                        input.placeholder = col;
                        input.className = "text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 outline-none focus:border-[#4A5568] bg-white w-24 text-[#4A5568] placeholder-gray-400";

                        input.onchange = (e) => {
                            if (e.target.value) filters.components[col] = e.target.value;
                            else delete filters.components[col];
                            renderTable();
                        };

                        const datalist = document.createElement('datalist');
                        datalist.id = `list-${col}`;
                        datalist.innerHTML = sortedValues.map(v => `<option value="${v}">`).join('');

                        wrapper.appendChild(input);
                        wrapper.appendChild(datalist);
                        container.appendChild(wrapper);
                    });
                }
            }
            renderTable();
        }

        // Advanced Matching Helper
        function advancedMatch(rowVal, filterVal) {
            if (!filterVal) return true;
            if (rowVal == null || rowVal === "") return false;
            const rVal = String(rowVal).trim().toUpperCase();
            const fVal = filterVal.toUpperCase();

            // Comma List
            if (fVal.includes(',')) {
                return fVal.split(',').map(p => p.trim()).includes(rVal);
            }
            // Range
            if (fVal.includes('-')) {
                const [min, max] = fVal.split('-').map(p => p.trim());
                if (!isNaN(min) && !isNaN(max)) {
                    const numVal = parseFloat(rowVal);
                    return !isNaN(numVal) && numVal >= parseFloat(min) && numVal <= parseFloat(max);
                }
                if (min.length === 1 && max.length === 1 && rVal.length === 1) {
                    return rVal >= min && rVal <= max;
                }
            }
            return rVal === fVal;
        }

        function setupCreateMode() {
            document.getElementById('pageTitle').innerText = "Create New Pattern";
            document.getElementById('viewActions').classList.add('hidden');
            document.getElementById('createActions').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            document.getElementById('tableView').classList.remove('hidden'); // Fix: Ensure Table is Visible
            // document.getElementById('filterPanel').classList.add('hidden'); // UNHIDDEN per user request

            // Load Draft Data
            try {
                const draft = JSON.parse(sessionStorage.getItem('draftPatternData'));
                if (draft && draft.students) {
                    allStudents = draft.students; // Flat objects from Editor
                    draftMetadata = draft;
                    document.getElementById('metaSchool').value = draft.schoolName || 'Unknown';
                    populateFilters(); // Populate dropdowns from Loaded Data
                    renderTable();
                } else {
                    alert("No data passed for creation. Returning to Editor.");
                    window.location.href = 'planet_editor.html';
                }
            } catch (e) { console.error(e); }
        }

        async function setupViewMode() {
            await Promise.all([
                fetchData(),
                fetchPatterns(),
                fetchSchools()
            ]);

            if (TARGET_PATTERN_ID) {
                const patSel = document.getElementById('f-pattern');
                const schSel = document.getElementById('f-school');
                patSel.value = TARGET_PATTERN_ID;
                const targetPattern = patterns.find(p => p.id == TARGET_PATTERN_ID);
                if (targetPattern) schSel.value = targetPattern.school_id;
            }
            renderTable();
        }

        async function fetchData() {
            try {
                const res = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } });
                allStudents = await res.json();
            } catch (e) { console.error(e); }
        }

        async function fetchPatterns() {
            try {
                const res = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                patterns = await res.json();
                const sel = document.getElementById('f-pattern');
                sel.innerHTML = '<option value="all">All Patterns</option>';
                patterns.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.name} (${p.school_name})`;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchSchools() {
            try {
                const res = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                schools = await res.json();
                const sel = document.getElementById('f-school');
                sel.innerHTML = '<option value="all">All Schools</option>';
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        // --- HELPER: NORMALIZE DATA ACCESS ---
        function getStudentProp(s, prop) {
            // 1. Try Direct Property (DB style)
            if (s[prop] !== undefined) return s[prop];

            // 2. Try Editor CSV/Excel Mapping
            if (prop === 'name') return s["Student Name"] || s["Student"] || s["Name"];
            if (prop === 'class') return s["Class"];
            if (prop === 'section') return s["Section"];
            if (prop === 'roll') return s["Roll No"] || s["Admission No"];
            if (prop === 'gender') return s["Gender"];
            if (prop === 'school_name') return draftMetadata ? draftMetadata.schoolName : '';
            if (prop === 'pattern_name') return '';
            if (prop === 'is_packed') return false;

            if (prop === 'attendance') return s["Absent/Present"] || s["attendance"] || "Present";
            if (prop === 'school_id') return s.school_id;
            return '';
        }

        // --- RENDER ---
        function renderTable() {
            // 1. FILTERING
            let data = allStudents.filter(s => {
                // Search
                if (filters.search) {
                    const name = (getStudentProp(s, 'name') || '').toLowerCase();
                    const roll = String(getStudentProp(s, 'roll') || '').toLowerCase();
                    if (!name.includes(filters.search) && !roll.includes(filters.search)) return false;
                }

                // View Mode Specific Filters (Legacy preservation)
                if (MODE !== 'create') {
                    const fSchool = document.getElementById('f-school').value;
                    const fPattern = document.getElementById('f-pattern').value;
                    /* Legacy Packed Filter check - hidden in UI now but logic remains valid if used */
                    // if (fPattern !== 'all' && s.pattern_id != fPattern) return false;
                }

                // ADVANCED FILTERS
                if (!advancedMatch(getStudentProp(s, 'class'), filters.class)) return false;
                if (!advancedMatch(getStudentProp(s, 'section'), filters.section)) return false;
                if (!advancedMatch(getStudentProp(s, 'house'), filters.house)) return false;

                if (filters.gender) {
                    const g = getStudentProp(s, 'gender');
                    if (filters.gender === 'M' && g !== 'Male' && g !== 'M') return false;
                    if (filters.gender === 'F' && g !== 'Female' && g !== 'F') return false;
                    if (filters.gender !== 'M' && filters.gender !== 'F' && g !== filters.gender) return false;
                }

                if (filters.attendance) {
                    const status = (getStudentProp(s, 'attendance') || '').toLowerCase();
                    if (filters.attendance === 'Absent' && !status.includes('absent')) return false;
                    if (filters.attendance === 'Present' && status.includes('absent')) return false;
                }

                // Item & Dynamic Filters
                if (filters.item) {
                    const def = allItems.find(x => x.name === filters.item);
                    const sGen = getStudentProp(s, 'gender');
                    // Gender Check for Item
                    if (def && sGen && def.type) {
                        const normGen = (sGen === 'Male' || sGen === 'M') ? 'Male' : (sGen === 'Female' || sGen === 'F') ? 'Female' : '';
                        if (normGen && normGen !== def.type) return false;
                    }

                    // Dynamic Components (Range Filters)
                    if (filters.components && Object.keys(filters.components).length > 0) {
                        const m = getMeasurementsSafe(s);
                        for (const [col, fVal] of Object.entries(filters.components)) {
                            const mVal = m[col] || m[col.toLowerCase()] || "";
                            if (!advancedMatch(mVal, fVal)) return false;
                        }
                    }
                }

                // HAS DATA FILTER
                if (filters.hasData) {
                    const m = getMeasurementsSafe(s);
                    // Check if ANY measurement column has a value != "00"/"0"/""
                    // We check against ALL measureCols
                    const hasAny = measureCols.some(k => {
                        const val = m[k] || m[k.toLowerCase()];
                        return val && val !== "00" && val !== "0";
                    });
                    if (!hasAny) return false;
                }

                return true;
            });

            const fItem = filters.item; // Use state
            const measHeader = document.getElementById('meas-header-group');
            let subRow = document.getElementById('sub-header-row');
            let showCols = [];

            if (fItem) { // Check state instead of DOM value
                const def = allItems.find(x => x.name === fItem);
                if (def) showCols = def.cols;
                measHeader.innerText = fItem;
                measHeader.colSpan = showCols.length;
            } else {
                // SHOW ALL
                showCols = measureCols;
                measHeader.innerText = "All Measurements";
                measHeader.colSpan = showCols.length;
            }

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.map((s, idx) => {
                const m = getMeasurementsSafe(s);
                let measCells = '';

                if (showCols.length > 0) {
                    measCells = showCols.map(k => {
                        // Access: Try "U1" (exact) then "u1" (lowercase) - robust access
                        let val = m[k] || m[k.toLowerCase()] || '-';
                        return `<td class="p-3 text-center font-mono font-bold bg-amber-50/30 text-stone-700 border-b border-stone-100">${val}</td>`;
                    }).join('');
                } else {
                    measCells = `<td class="p-3 text-xs text-stone-400 italic border-b border-stone-100">Select Item Type...</td>`;
                }

                const dName = getStudentProp(s, 'name');
                const dRoll = getStudentProp(s, 'roll');
                const dClass = getStudentProp(s, 'class');
                const dSection = getStudentProp(s, 'section');
                const dGender = getStudentProp(s, 'gender');
                const dSchool = getStudentProp(s, 'school_name');
                const dPattern = getStudentProp(s, 'pattern_name');
                const dPacked = getStudentProp(s, 'is_packed');

                return `<tr class="hover:bg-blue-50 transition-colors">
                    <td class="p-3 border-b border-r bg-stone-50/50 sticky left-0 font-mono text-xs text-stone-400 font-bold">${idx + 1}</td>
                    <td class="p-3 border-b border-stone-100 font-bold text-stone-700">${dSchool}</td>
                    <td class="p-3 border-b border-stone-100">
                        <div class="font-bold text-stone-800">${dName || '<span class="text-red-400">?</span>'}</div>
                        <div class="text-[10px] text-stone-500 font-mono">Roll: ${dRoll || '-'}</div>
                    </td>
                    <td class="p-3 border-b border-stone-100 text-sm">${dClass} ${dSection || ''} <span class="text-xs text-stone-400">(${dGender?.[0] || '?'})</span></td>
                    <td class="p-3 border-b border-stone-100">
                        ${dPattern ? `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-bold ring-1 ring-indigo-200">${dPattern}</span>` : '<span class="text-stone-300">-</span>'}
                    </td>
                    ${measCells}
                    <td class="p-3 border-b border-stone-100 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${dPacked ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${dPacked ? 'Packed' : 'Pending'}</span>
                    </td>
                </tr>`;
            }).join('');

            if (showCols.length > 0) {
                subRow.classList.remove('hidden');
                subRow.innerHTML = `
                    <th colspan="5"></th>
                    ${showCols.map(c => `<th class="p-2 text-center bg-amber-100 text-amber-800 border-x border-amber-200">${c}</th>`).join('')}
                    <th></th>
                `;
            } else {
                subRow.classList.add('hidden');
            }

            document.getElementById('row-count').innerText = `Showing ${data.length} Records`;
            window.filteredData = data;
            window.currentCols = showCols;
        }

        function getMeasurementsSafe(s) {
            // DB: nested Object string or object
            if (s.measurements) {
                if (typeof s.measurements === 'string') { try { return JSON.parse(s.measurements); } catch (e) { return {}; } }
                return s.measurements;
            }
            // Editor: Flat Object, return s itself
            return s;
        }

        // --- CREATE/SAVE LOGIC ---
        // Duplicate Logic from Planet Editor but adapted for this view
        function calculateItemValue(row, itemInfo) {
            const m = getMeasurementsSafe(row);
            // Reconstruct Logic from Editor if needed
            // For now assuming 'm' has keys "u1", "l1" etc.
            // itemInfo.cols = ["U1", "U2"]
            const vals = itemInfo.cols.map(c => m[c.toLowerCase()] || "00");
            // Filter logic? 
            if (itemInfo.type && row.gender && row.gender.toUpperCase() !== itemInfo.type.toUpperCase()) return "";

            // Check if all empty?
            const allEmpty = vals.every(v => v === "00" || v === "" || v === "0");
            if (allEmpty) return "00,00"; // Or whatever format
            return vals.join(",");
        }

        function calculateTotalBreakdown(dataset) {
            const breakdown = {};
            dataset.forEach(row => {
                allItems.forEach(item => {
                    // We don't have explicit Qty columns here unless we pulled them.
                    // Editor filtered data SHOULD include all columns from the table.
                    // Check if 'Qty_Item' exists in `row`.
                    // The `allStudents` here comes from `filtered` in Editor which is `data.filter(...)`.
                    // `data` in Editor has everything. So yes.

                    const qtyKey = `Qty_${item.name}`;
                    let rawQ = row[qtyKey];
                    if (typeof rawQ === 'string' && rawQ.includes(',')) rawQ = NaN;
                    let q = parseFloat(rawQ);

                    if (!isNaN(q)) {
                        breakdown[item.name] = (breakdown[item.name] || 0) + q;
                    } else {
                        // Calculated
                        const valStr = calculateItemValue(row, item);
                        const hasMeasurements = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (hasMeasurements) {
                            breakdown[item.name] = (breakdown[item.name] || 0) + 1;
                        }
                    }
                });
            });
            return breakdown;
        }

        async function savePattern() {
            if (!draftMetadata) return alert("Missing Session Data");

            // USE FILTERED DATA (User Intent: "These filtered data are used")
            const targetData = window.filteredData && window.filteredData.length > 0 ? window.filteredData : allStudents;
            const currentItem = filters.item ? allItems.find(i => i.name === filters.item) : null;

            if (targetData.length === 0) return alert("No students selected for this pattern.");

            const name = document.getElementById('metaPattern').value;
            const description = document.getElementById('metaDesc').value;
            const consumption = document.getElementById('metaConsumption').value;
            const cloth = document.getElementById('metaClothDetails').value;
            const req = document.getElementById('metaSpecialReq').value;

            if (!name) return alert("Pattern Code is Required");

            // Calculate Breakdown based on TARGET DATA
            const quantities = calculateTotalBreakdown(targetData);

            if (Object.keys(quantities).length === 0) {
                if (!confirm("Warning: No quantities calculated. Provide quantities or check if measurements exist. Continue?")) return;
            }

            try {
                // 1. Create Pattern Group
                const res = await fetch('/api/data/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        school_id: draftMetadata.schoolId,
                        name: name,
                        description: description,
                        consumption: parseFloat(consumption) || 0,
                        cloth_details: cloth,
                        special_req: req,
                        quantities: quantities
                    })
                });

                if (!res.ok) throw new Error("Failed to create pattern");
                const resData = await res.json();
                const patternId = resData.id;

                // 2. Link Students & Store Production Data
                const syncPayload = targetData.map(s => {
                    const prodData = {};

                    // Logic: If Item Filter active, store ONLY that item.
                    // If NO Item Filter, store ALL items? (Likely not intended for a specific pattern, but safer to store what's calculated)

                    const itemsToStore = currentItem ? [currentItem] : allItems;

                    itemsToStore.forEach(item => {
                        // Calculate Qty for this item for this student
                        // Check calculated first
                        const valStr = calculateItemValue(s, item);
                        const hasMeas = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (hasMeas) {
                            prodData[item.name] = "1"; // Default 1 if measured
                        }
                        // Check explicit Qty override (if we had it in data) - logic from breakdown
                        const qtyKey = `Qty_${item.name}`;
                        if (s[qtyKey] && !isNaN(parseFloat(s[qtyKey]))) {
                            prodData[item.name] = String(s[qtyKey]);
                        }
                    });

                    return {
                        id: s.id, // ID must exist if we are syncing. In Create Mode, these are from DB or drafts?
                        // Drafts from Editor have IDs if they came from DB. New rows have _tempId?
                        // If they are new rows, they might not have IDs yet? 
                        // Wait, Editor loads data from DB. New rows in Editor have _tempId.
                        // If we sync _tempId, backend won't match. 
                        // BUT the user says "store the datas". Backend handles INSERT if no ID match but match Admission No.
                        // Create Mode data implies we are creating pattern for EXISTING students usually?
                        // Ensure we pass necessary identifying info.
                        admission_no: s.admission_no || s["Admission No"], // Fallback for safety
                        roll_no: s.roll_no || s["Roll No"],
                        name: s.name || s["Student Name"],
                        school_id: draftMetadata.schoolId, // Ensure Context

                        pattern_id: patternId,
                        production_data: prodData
                    };
                });

                const syncRes = await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ students: syncPayload })
                });

                if (!syncRes.ok) throw new Error("Failed to link students.");

                alert(`✅ Pattern '${name}' Created!\\nLinked ${targetData.length} Students.`);
                window.location.href = `pattern_view.html?id=${patternId}`;

            } catch (e) {
                alert("Error: " + e.message);
                console.error(e);
            }
        }



        // --- MATERIAL CALCULATOR ---
        function calculateMaterial() {
            const unit = parseFloat(document.getElementById('metaConsumption').value) || 0;
            // Get current filtered student count
            const count = window.filteredData ? window.filteredData.length : (allStudents ? allStudents.length : 0);

            // Or should it be based on "Quantities" of items?
            // "quantity is given... metirial type quantity it automatically add calculate user input"
            // Usually Material is per garment.
            // Let's assume Unit * Count of Students (Garments)

            const total = (unit * count).toFixed(2);
            document.getElementById('calcTotalMaterial').innerText = `${total}m`;
        }


        // --- DELETE WITH UNDO ---
        let undoTimeout = null;
        let deleteToast = null;

        async function deletePattern() {
            const patId = document.getElementById('f-pattern').value;
            if (!patId || patId === 'all') return;

            if (!confirm("Are you sure you want to DELETE this pattern?")) return;

            // OPTIMISTIC UNDO UI
            const btn = document.getElementById('btnDeletePattern');
            const originalText = btn.innerHTML;

            // Show Undo Toast
            showUndoToast(patId);

            // Hide pattern locally immediately? Or just wait?
            // User requirement: "undo it 20 seconds".
            // So we delay the actual call.
        }

        function showUndoToast(patId) {
            // Create Toast
            if (deleteToast) deleteToast.remove();

            deleteToast = document.createElement('div');
            deleteToast.className = "fixed bottom-10 right-10 bg-stone-900 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-4 z-50 animate-bounce";
            deleteToast.innerHTML = `
                <div>
                    <div class="font-bold text-sm">Pattern Deletion Pending...</div>
                    <div class="text-xs text-stone-400">Executing in <span id="undo-timer">20</span>s</div>
                </div>
                <button onclick="cancelDelete()" class="bg-stone-700 hover:bg-stone-600 px-3 py-1 rounded text-xs font-bold uppercase">Undo</button>
            `;
            document.body.appendChild(deleteToast);

            let timeLeft = 20;
            const timerSpan = document.getElementById('undo-timer');

            undoTimeout = setInterval(async () => {
                timeLeft--;
                if (timerSpan) timerSpan.innerText = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(undoTimeout);
                    deleteToast.remove();
                    await executeDelete(patId);
                }
            }, 1000);
        }

        function cancelDelete() {
            clearInterval(undoTimeout);
            if (deleteToast) deleteToast.remove();
            alert("Deletion Cancelled.");
        }

        async function executeDelete(patId) {
            try {
                const res = await fetch(`/api/data/patterns/${patId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) throw new Error("Delete failed");

                alert("Pattern Deleted Permanently.");
                window.location.href = 'pattern_view.html';
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // --- EXPORT ---
        // --- EXPORT ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];

            // Meta Info
            const patternName = MODE === 'create' ? document.getElementById('metaPattern').value : (data[0]?.pattern_name || "Custom View");
            const consumption = document.getElementById('metaConsumption') ? document.getElementById('metaConsumption').value : (data[0]?.pattern_consumption || 0);
            const totalMaterial = document.getElementById('calcTotalMaterial') ? document.getElementById('calcTotalMaterial').innerText : "0m";

            // Header (Pattern Name Centered)
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text(patternName.toUpperCase(), 148.5, 15, { align: "center" });

            // Sub-Header Details
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const details = `Item: ${document.getElementById('f-item').value} | Material/Unit: ${consumption}m | Total: ${totalMaterial}`;
            doc.text(details, 148.5, 22, { align: "center" });

            // Description
            const description = MODE === 'create' ? document.getElementById('metaDesc').value : (data[0]?.pattern_description || "");

            if (description) {
                doc.setFont("helvetica", "italic");
                doc.text(`"${description}"`, 148.5, 27, { align: "center" });
            }

            // Table

            // Table
            let headers = [['School', 'Name', 'Class', 'Admsn No', ...cols, 'Status']];
            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name || "N/A",
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.admission_no || s["Admission No"] || "-",
                ];

                cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                row.push(s.is_packed ? 'Packed' : 'Pending');
                return row;
            });

            doc.autoTable({
                head: headers,
                body: body,
                startY: 30,
                theme: 'grid',
                headStyles: { fillColor: [40, 40, 40], textColor: 255, halign: 'center' },
                styles: { fontSize: 9, cellPadding: 3, halign: 'center' },
                columnStyles: { 0: { halign: 'left' }, 1: { halign: 'left' } } // Name/School left align
            });

            // Footer / End of Data Summary
            // "pattern name under its datas also adde messurments..."
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.setFont("helvetica", "bold");
            doc.text(`End of List: ${patternName}`, 14, finalY);

            doc.save(`Pattern_${patternName.replace(/\s+/g, '_')}.pdf`);
        }

        function downloadExcel() {
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];

            const exportData = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = {
                    "School": s.school_name || (draftMetadata ? draftMetadata.schoolName : '-'),
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Pattern": s.pattern_name,
                    "Status": s.is_packed ? "Packed" : "Pending"
                };

                if (cols.length > 0) {
                    cols.forEach(k => row[k] = m[k.toLowerCase()] || '');
                } else {
                    row["Measurements"] = "Select Item to View";
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PatternData");
            XLSX.writeFile(wb, `Pattern_Data_${TARGET_PATTERN_ID || 'View'}.xlsx`);
        }

    </script>
    <!-- MODALS -->
    <!-- Pattern Manager Modal REMOVED - Converted to Main View -->

    <!-- Rename Modal -->
    <div id="renameModal"
        class="hidden fixed inset-0 bg-black/50 z-[70] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6">
            <h3 class="font-bold text-lg mb-4 text-stone-800">Rename Pattern</h3>
            <input type="hidden" id="renameId">
            <div class="space-y-3">
                <div>
                    <label class="text-xs font-bold text-stone-500 uppercase">Pattern Name</label>
                    <input type="text" id="renameName" class="w-full border p-2 rounded text-sm font-bold">
                </div>
                <div>
                    <label class="text-xs font-bold text-stone-500 uppercase">Description</label>
                    <textarea id="renameDesc" class="w-full border p-2 rounded text-sm" rows="3"></textarea>
                </div>
                <div class="flex gap-2 justify-end pt-2">
                    <button onclick="document.getElementById('renameModal').classList.add('hidden')"
                        class="px-3 py-1.5 text-stone-500 text-sm font-bold hover:bg-stone-100 rounded">Cancel</button>
                    <button onclick="executeRename()"
                        class="px-3 py-1.5 bg-indigo-600 text-white text-sm font-bold hover:bg-indigo-700 rounded shadow">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ... (Existing Script) ...

        // --- VIEW SWITCHING LOGIC ---
        let currentView = 'table'; // table | groups

        async function togglePatternView(forceView) {
            const target = forceView || (currentView === 'table' ? 'groups' : 'table');
            const btnTxt = document.getElementById('txtToggleView');
            const dataView = document.getElementById('tableView');
            const groupsView = document.getElementById('groupsView');
            const filterPanel = document.getElementById('filterPanel');

            if (target === 'groups') {
                await fetchPatterns();
                renderGroupGrid();
                dataView.classList.add('hidden');
                groupsView.classList.remove('hidden');
                filterPanel.classList.add('opacity-50', 'pointer-events-none'); // Disable filters in group view
                btnTxt.innerText = "Back to Data";
                currentView = 'groups';
            } else {
                dataView.classList.remove('hidden');
                groupsView.classList.add('hidden');
                filterPanel.classList.remove('opacity-50', 'pointer-events-none');
                btnTxt.innerText = "All Patterns";
                currentView = 'table';
            }
        }

        // Initialize based on ID
        if (!TARGET_PATTERN_ID && MODE !== 'create') {
            // If no ID, show groups by default
            setTimeout(() => togglePatternView('groups'), 100);
        } else {
            document.getElementById('tableView').classList.remove('hidden');
        }

        function renderGroupGrid() {
            const grid = document.getElementById('patternGrid');
            if (patterns.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-stone-400 italic py-10">No patterns created yet.</div>';
                return;
            }
            grid.innerHTML = patterns.map(p => `
                <div onclick="selectPattern('${p.id}')" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 cursor-pointer hover:border-indigo-500 hover:shadow-lg hover:-translate-y-1 transition-all group relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="font-ink font-bold text-stone-800 text-xl group-hover:text-indigo-600">${p.name}</div>
                         <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] font-mono bg-stone-100 px-2 py-0.5 rounded text-stone-500">
                            ${new Date(p.created_at).toLocaleDateString()}
                            </span>
                            <span class="text-[10px] font-bold uppercase text-indigo-400">#${p.id}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-2 py-1 rounded bg-amber-50 text-amber-700 text-xs font-bold border border-amber-100">${p.school_name}</span>
                    </div>

                    <div class="bg-stone-50 p-3 rounded-lg border border-stone-100 mb-4 h-20 overflow-hidden relative">
                         <div class="text-xs text-stone-400 uppercase font-bold mb-1">Description</div>
                        <div class="text-xs text-stone-600 italic leading-relaxed line-clamp-3">${p.description || "No description provided."}</div>
                        <div class="absolute bottom-0 left-0 right-0 h-6 bg-gradient-to-t from-stone-50 to-transparent"></div>
                    </div>
                    
                    <div class="flex justify-between items-center pt-2 border-t border-stone-100 mt-auto">
                         <span class="text-xs font-bold text-stone-400 uppercase tracking-widest group-hover:text-indigo-500 transition-colors">Open Group &rarr;</span>
                         ${p.consumption ? `<span class="text-xs font-bold text-stone-500 bg-stone-100 px-2 py-1 rounded">${p.consumption}m / unit</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function openPatternManager() { togglePatternView('groups'); } // Alias for safety

        function selectPattern(id) {
            // Update URL logic to avoid full reload? 
            // Better to reload to ensure Clean State for Table View or just re-init?
            // User requested "window", so reload is cleaner for "Entering" a pattern.
            window.location.href = `pattern_view.html?id=${id}`;
        }

        // --- RENAME LOGIC ---
        function openRenameModal() {
            const id = document.getElementById('f-pattern').value;
            if (!id || id === 'all') return;
            const p = patterns.find(pat => pat.id == id);
            if (!p) return;

            document.getElementById('renameId').value = id;
            document.getElementById('renameName').value = p.name;
            document.getElementById('renameDesc').value = p.description || "";
            document.getElementById('renameModal').classList.remove('hidden');
        }

        async function executeRename() {
            const id = document.getElementById('renameId').value;
            const name = document.getElementById('renameName').value;
            const desc = document.getElementById('renameDesc').value;

            try {
                const res = await fetch(`${API_BASE}/data/patterns/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name, description: desc })
                });

                if (!res.ok) throw new Error("Update failed");
                alert("Pattern Updated!");
                location.reload();
            } catch (e) {
                alert(e.message);
            }
        }
    </script>
</body>

</html>