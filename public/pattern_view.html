<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern View | Planet Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #1c1917;
            --rice-paper: #fafaf9;
            --seal-red: #be123c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--rice-paper);
            color: #44403c;
        }

        .font-ink {
            font-family: 'Noto Serif JP', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="planet_editor.html"
                    class="text-stone-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-wider">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Editor
                </a>
                <div class="h-6 w-px bg-stone-700"></div>
                <h1 class="font-ink text-xl flex items-center gap-2"><span class="text-rose-600 text-2xl">●</span>
                    <span id="pageTitle">Pattern Details View</span>
                </h1>
            </div>

            <!-- Default Actions (View Mode) -->
            <div id="viewActions" class="flex gap-3">
                <button onclick="downloadPDF()"
                    class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download PDF
                </button>
                <button onclick="downloadExcel()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download Excel
                </button>
            </div>

            <!-- Create Actions (Create Mode) -->
            <div id="createActions" class="hidden flex gap-3">
                <button onclick="savePattern()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow-lg text-sm font-bold uppercase flex items-center gap-2 transition-transform active:scale-95 ring-2 ring-indigo-400">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save & Create Pattern
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 max-w-[1920px] mx-auto w-full space-y-4">

        <!-- Creation Panel (Only Visible in Create Mode) -->
        <div id="creationPanel" class="hidden glass-panel p-6 rounded-xl border-l-4 border-indigo-500 shadow-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Metadata Inputs -->
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Pattern Details</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">School Name</label>
                            <input type="text" id="metaSchool" readonly
                                class="w-full text-sm border border-gray-300 rounded p-2 bg-gray-100 text-gray-600 font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Pattern Code</label>
                            <input type="text" id="metaPattern"
                                class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200"
                                placeholder="e.g. P-101">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Description</label>
                        <textarea id="metaDesc" rows="2"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500"
                            placeholder="Optional description..."></textarea>
                    </div>
                </div>

                <!-- Specs Inputs -->
                <div class="space-y-4 bg-stone-50 p-4 rounded-lg border border-stone-200">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Specifications</h3>

                    <div class="flex items-center justify-between">
                        <label class="block text-xs font-bold text-stone-600 uppercase">Cloth Consumption
                            (Mtrs/Student)</label>
                        <input type="number" id="metaConsumption" step="0.01"
                            class="w-32 text-sm border border-gray-300 rounded p-1 text-right font-mono font-bold text-indigo-700"
                            placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Cloth Details</label>
                        <input type="text" id="metaClothDetails"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Special
                            Requirements</label>
                        <input type="text" id="metaSpecialReq"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                </div>
            </div>
        </div>


        <!-- Filters (Hidden in Create Mode) -->
        <div id="filterPanel" class="glass-panel p-4 rounded-xl flex flex-wrap gap-4 items-end sticky top-20 z-40">
            <!-- School -->
            <div class="w-full sm:w-auto">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">School</label>
                <select id="f-school" onchange="renderTable()"
                    class="w-full sm:w-48 border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm bg-gray-50 pointer-events-none opacity-80"
                    tabindex="-1">
                    <option value="all">Loading...</option>
                </select>
            </div>

            <!-- Pattern -->
            <div class="w-full sm:w-auto">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Pattern</label>
                <select id="f-pattern" onchange="renderTable()"
                    class="w-full sm:w-48 border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm bg-gray-50 pointer-events-none opacity-80"
                    tabindex="-1">
                    <option value="all">Loading...</option>
                </select>
            </div>

            <!-- Item Type (CRITICAL) -->
            <div class="w-full sm:w-auto flex-1">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Measurement Type (Item)</label>
                <select id="f-item" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-rose-500 shadow-sm font-medium text-stone-700 bg-amber-50/50">
                    <option value="all">-- Select Item to View Measurements --</option>
                </select>
            </div>

            <!-- Meta Filters -->
            <div class="w-[30%] sm:w-24">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Class</label>
                <input type="text" id="f-class" onkeyup="renderTable()" placeholder="All"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
            </div>
            <div class="w-[30%] sm:w-24">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Gender</label>
                <select id="f-gender" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
                    <option value="all">All</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="w-[30%] sm:w-32">
                <label class="block text-[10px] font-bold text-stone-500 uppercase mb-1">Status</label>
                <select id="f-packed" onchange="renderTable()"
                    class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none shadow-sm">
                    <option value="all">All</option>
                    <option value="pending">Pending</option>
                    <option value="packed">Packed</option>
                </select>
            </div>
        </div>

        <!-- Data Table -->
        <div
            class="glass-panel rounded-xl overflow-hidden shadow-xl border border-stone-200 flex-1 min-h-[500px] flex flex-col">
            <div class="overflow-auto flex-1 h-full">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-stone-50 text-stone-500 uppercase text-xs sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="p-3 font-bold border-b border-r bg-stone-50 sticky left-0 z-30 w-16">No.</th>
                            <th class="p-3 font-bold border-b">School</th>
                            <th class="p-3 font-bold border-b">Student</th>
                            <th class="p-3 font-bold border-b">Class</th>
                            <th class="p-3 font-bold border-b">Pattern</th>
                            <!-- Dynamic Measurement Headers -->
                            <th class="p-3 font-bold border-b bg-amber-50 text-amber-700 text-center"
                                id="meas-header-group" colspan="1">Measurements</th>
                            <th class="p-3 font-bold border-b text-center">Status</th>
                        </tr>
                        <tr id="sub-header-row" class="bg-stone-100 text-[10px] font-mono text-stone-600 hidden">
                            <!-- Will be populated by JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-stone-100 bg-white text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t bg-stone-50 text-right text-xs text-stone-500 font-mono" id="row-count">Loading...
            </div>
        </div>

    </main>

    <script>
        const API_BASE = '/api';
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'planet_editor.html';

        // --- URL PARAMS ---
        const urlParams = new URLSearchParams(window.location.search);
        const TARGET_PATTERN_ID = urlParams.get('id');
        const MODE = urlParams.get('mode'); // 'create' or null

        // --- DATA ---
        let allStudents = [];
        let patterns = [];
        let schools = [];
        let filteredStudents = []; // Active dataset
        let draftMetadata = null;

        // --- CONFIG ---
        const boysItems = [{ name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" }];
        const girlsItems = [{ name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" }, { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" }, { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" }, { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }];
        const allItems = [...boysItems, ...girlsItems];

        // --- INIT ---
        async function init() {
            // Populate Items
            const itemSel = document.getElementById('f-item');
            allItems.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.name;
                opt.text = i.name;
                itemSel.appendChild(opt);
            });

            if (MODE === 'create') {
                setupCreateMode();
            } else {
                setupViewMode();
            }
        }
        init();

        function setupCreateMode() {
            document.getElementById('pageTitle').innerText = "Create New Pattern";
            document.getElementById('viewActions').classList.add('hidden');
            document.getElementById('createActions').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            // document.getElementById('filterPanel').classList.add('hidden'); // UNHIDDEN per user request

            // Load Draft Data
            try {
                const draft = JSON.parse(sessionStorage.getItem('draftPatternData'));
                if (draft && draft.students) {
                    allStudents = draft.students; // Flat objects from Editor
                    draftMetadata = draft;
                    document.getElementById('metaSchool').value = draft.schoolName || 'Unknown';
                    renderTable();
                } else {
                    alert("No data passed for creation. Returning to Editor.");
                    window.location.href = 'planet_editor.html';
                }
            } catch (e) { console.error(e); }
        }

        async function setupViewMode() {
            await Promise.all([
                fetchData(),
                fetchPatterns(),
                fetchSchools()
            ]);

            if (TARGET_PATTERN_ID) {
                const patSel = document.getElementById('f-pattern');
                const schSel = document.getElementById('f-school');
                patSel.value = TARGET_PATTERN_ID;
                const targetPattern = patterns.find(p => p.id == TARGET_PATTERN_ID);
                if (targetPattern) schSel.value = targetPattern.school_id;
            }
            renderTable();
        }

        async function fetchData() {
            try {
                const res = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } });
                allStudents = await res.json();
            } catch (e) { console.error(e); }
        }

        async function fetchPatterns() {
            try {
                const res = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                patterns = await res.json();
                const sel = document.getElementById('f-pattern');
                sel.innerHTML = '<option value="all">All Patterns</option>';
                patterns.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.name} (${p.school_name})`;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchSchools() {
            try {
                const res = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                schools = await res.json();
                const sel = document.getElementById('f-school');
                sel.innerHTML = '<option value="all">All Schools</option>';
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        // --- HELPER: NORMALIZE DATA ACCESS ---
        function getStudentProp(s, prop) {
            // 1. Try Direct Property (DB style)
            if (s[prop] !== undefined) return s[prop];

            // 2. Try Editor CSV/Excel Mapping
            if (prop === 'name') return s["Student Name"] || s["Student"] || s["Name"];
            if (prop === 'class') return s["Class"];
            if (prop === 'section') return s["Section"];
            if (prop === 'roll') return s["Roll No"] || s["Admission No"];
            if (prop === 'gender') return s["Gender"];
            if (prop === 'school_name') return draftMetadata ? draftMetadata.schoolName : '';
            if (prop === 'pattern_name') return '';
            if (prop === 'is_packed') return false;

            return '';
        }

        // --- RENDER ---
        function renderTable() {
            // Use different filtering based on Mode
            let data = [];

            if (MODE === 'create') {
                // In create mode, we show ALL students passed in draft, filtered only by Item/Class if needed
                // But typically we want to show exactly what was passed.
                // Let's rely on item filter though.
                const fItem = document.getElementById('f-item').value;
                data = allStudents.filter(s => {
                    // Still allow Item Filter to see columns
                    if (fItem !== 'all') {
                        const def = allItems.find(x => x.name === fItem);
                        if (def && s.gender && def.type && s.gender !== def.type) return false;
                    }
                    return true;
                });
            } else {
                // View Mode Filtering
                const fSchool = document.getElementById('f-school').value;
                const fPattern = document.getElementById('f-pattern').value;
                const fItem = document.getElementById('f-item').value;
                const fClass = document.getElementById('f-class').value.toLowerCase();
                const fGender = document.getElementById('f-gender').value;
                const fPacked = document.getElementById('f-packed').value;

                data = allStudents.filter(s => {
                    if (fSchool !== 'all' && s.school_id != fSchool) return false;
                    if (fPattern !== 'all' && s.pattern_id != fPattern) return false;
                    if (fGender !== 'all' && s.gender !== fGender) return false;
                    if (fPacked === 'packed' && !s.is_packed) return false;
                    if (fPacked === 'pending' && s.is_packed) return false;
                    if (fClass && !(s.class || '').toLowerCase().includes(fClass)) return false;

                    if (fItem !== 'all') {
                        const def = allItems.find(x => x.name === fItem);
                        if (def && s.gender && def.type && s.gender !== def.type) return false;
                    }
                    return true;
                });
            }

            const fItem = document.getElementById('f-item').value;
            const measHeader = document.getElementById('meas-header-group');
            let subRow = document.getElementById('sub-header-row');
            let showCols = [];

            if (fItem !== 'all') {
                const def = allItems.find(x => x.name === fItem);
                if (def) showCols = def.cols;
                measHeader.innerText = fItem;
                measHeader.colSpan = showCols.length;
            } else {
                showCols = [];
                measHeader.innerText = "Measurements (Select Item)";
                measHeader.colSpan = 1;
            }

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.map((s, idx) => {
                const m = getMeasurementsSafe(s);
                let measCells = '';

                if (showCols.length > 0) {
                    measCells = showCols.map(k => {
                        // Access: Try "U1" (exact) then "u1" (lowercase) - robust access
                        let val = m[k] || m[k.toLowerCase()] || '-';
                        return `<td class="p-3 text-center font-mono font-bold bg-amber-50/30 text-stone-700 border-b border-stone-100">${val}</td>`;
                    }).join('');
                } else {
                    measCells = `<td class="p-3 text-xs text-stone-400 italic border-b border-stone-100">Select Item Type...</td>`;
                }

                const dName = getStudentProp(s, 'name');
                const dRoll = getStudentProp(s, 'roll');
                const dClass = getStudentProp(s, 'class');
                const dSection = getStudentProp(s, 'section');
                const dGender = getStudentProp(s, 'gender');
                const dSchool = getStudentProp(s, 'school_name');
                const dPattern = getStudentProp(s, 'pattern_name');
                const dPacked = getStudentProp(s, 'is_packed');

                return `<tr class="hover:bg-blue-50 transition-colors">
                    <td class="p-3 border-b border-r bg-stone-50/50 sticky left-0 font-mono text-xs text-stone-400 font-bold">${idx + 1}</td>
                    <td class="p-3 border-b border-stone-100 font-bold text-stone-700">${dSchool}</td>
                    <td class="p-3 border-b border-stone-100">
                        <div class="font-bold text-stone-800">${dName || '<span class="text-red-400">?</span>'}</div>
                        <div class="text-[10px] text-stone-500 font-mono">Roll: ${dRoll || '-'}</div>
                    </td>
                    <td class="p-3 border-b border-stone-100 text-sm">${dClass} ${dSection || ''} <span class="text-xs text-stone-400">(${dGender?.[0] || '?'})</span></td>
                    <td class="p-3 border-b border-stone-100">
                        ${dPattern ? `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-bold ring-1 ring-indigo-200">${dPattern}</span>` : '<span class="text-stone-300">-</span>'}
                    </td>
                    ${measCells}
                    <td class="p-3 border-b border-stone-100 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${dPacked ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${dPacked ? 'Packed' : 'Pending'}</span>
                    </td>
                </tr>`;
            }).join('');

            if (showCols.length > 0) {
                subRow.classList.remove('hidden');
                subRow.innerHTML = `
                    <th colspan="5"></th>
                    ${showCols.map(c => `<th class="p-2 text-center bg-amber-100 text-amber-800 border-x border-amber-200">${c}</th>`).join('')}
                    <th></th>
                `;
            } else {
                subRow.classList.add('hidden');
            }

            document.getElementById('row-count').innerText = `Showing ${data.length} Records`;
            window.filteredData = data;
            window.currentCols = showCols;
        }

        function getMeasurementsSafe(s) {
            // DB: nested Object string or object
            if (s.measurements) {
                if (typeof s.measurements === 'string') { try { return JSON.parse(s.measurements); } catch (e) { return {}; } }
                return s.measurements;
            }
            // Editor: Flat Object, return s itself
            return s;
        }

        // --- CREATE/SAVE LOGIC ---
        // Duplicate Logic from Planet Editor but adapted for this view
        function calculateItemValue(row, itemInfo) {
            const m = getMeasurementsSafe(row);
            // Reconstruct Logic from Editor if needed
            // For now assuming 'm' has keys "u1", "l1" etc.
            // itemInfo.cols = ["U1", "U2"]
            const vals = itemInfo.cols.map(c => m[c.toLowerCase()] || "00");
            // Filter logic? 
            if (itemInfo.type && row.gender && row.gender.toUpperCase() !== itemInfo.type.toUpperCase()) return "";

            // Check if all empty?
            const allEmpty = vals.every(v => v === "00" || v === "" || v === "0");
            if (allEmpty) return "00,00"; // Or whatever format
            return vals.join(",");
        }

        function calculateTotalBreakdown(dataset) {
            const breakdown = {};
            dataset.forEach(row => {
                allItems.forEach(item => {
                    // We don't have explicit Qty columns here unless we pulled them.
                    // Editor filtered data SHOULD include all columns from the table.
                    // Check if 'Qty_Item' exists in `row`.
                    // The `allStudents` here comes from `filtered` in Editor which is `data.filter(...)`.
                    // `data` in Editor has everything. So yes.

                    const qtyKey = `Qty_${item.name}`;
                    let rawQ = row[qtyKey];
                    if (typeof rawQ === 'string' && rawQ.includes(',')) rawQ = NaN;
                    let q = parseFloat(rawQ);

                    if (!isNaN(q)) {
                        breakdown[item.name] = (breakdown[item.name] || 0) + q;
                    } else {
                        // Calculated
                        const valStr = calculateItemValue(row, item);
                        const hasMeasurements = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (hasMeasurements) {
                            breakdown[item.name] = (breakdown[item.name] || 0) + 1;
                        }
                    }
                });
            });
            return breakdown;
        }

        async function savePattern() {
            if (!draftMetadata) return alert("Missing Session Data");

            const name = document.getElementById('metaPattern').value;
            const consumption = document.getElementById('metaConsumption').value;
            const cloth = document.getElementById('metaClothDetails').value;
            const req = document.getElementById('metaSpecialReq').value;

            if (!name) return alert("Pattern Code is Required");

            const quantities = calculateTotalBreakdown(allStudents);

            try {
                // 1. Create Pattern
                const res = await fetch('/api/data/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        school_id: draftMetadata.schoolId,
                        name: name,
                        consumption: parseFloat(consumption),
                        cloth_details: cloth,
                        special_req: req,
                        quantities: quantities
                    })
                });

                if (!res.ok) throw new Error("Failed to create pattern");
                const resData = await res.json();
                const patternId = resData.id;

                // 2. Link Students (Sync logic needs to happen on SERVER or we must push updates?)
                // WE NEED TO UPDATE THE STUDENTS IN DB TO LINK TO THIS PATTERN.
                // In Editor, we called `syncToCloud`. Here we don't have the full Sync logic.
                // We should make a dedicated API call to "Link Students to Pattern".
                // Since we have the IDs.

                // Let's reuse `/api/sync` but we need to construct the payload.
                // The payload expected by `/api/sync` is array of students.
                // We only need to update `pattern_id`.
                // Efficient way: POST /api/data/link_pattern  { pattern_id: X, student_ids: [...] }
                // But that endpoint doesn't exist.
                // Reuse Sync: Construct minimal payload { id: X, pattern_id: Y } for all students.

                const syncPayload = allStudents.map(s => ({
                    id: s.id,
                    pattern_id: patternId,
                    // We must also send production_data if we want to ensure it's saved? 
                    // Editor logic sent it. If we don't send, it stays as is?
                    // Sync logic performs UPDATE. if we send `pattern_id`, it updates it.
                    // Be careful not to wipe other fields.
                    // Let's send `production_data` too just in case it wasn't there?
                    // Actually, if we just came from Editor, the data might not be in Cloud yet?
                    // Wait, Editor `filtered` data is LOCAL.
                    // If the user made changes in Editor and clicked "Create Pattern", those changes are in `draftPatternData`.
                    // But they are NOT in the database yet if they didn't click "Sync".
                    // The user flow implies "Save & Create".
                    // So we MUST sync everything: Measurements, everything.
                    // This is heavy.

                    // Simple solution: We pass the FULL student object.
                    // But we need to calculate `production_data` string for each item.
                    // This logic is duplicated.

                    ...s, // Spread existing props (name, class etc)
                    pattern_id: patternId,
                    production_data: produceProductionData(s)
                }));

                await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ data: syncPayload, school_id: draftMetadata.schoolId })
                });

                alert("✅ Pattern Created & Data Linked Successfully!");

                // Switch to View Mode
                window.location.href = `pattern_view.html?id=${patternId}`;

            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function produceProductionData(row) {
            const snapshot = {};
            allItems.forEach(item => {
                const val = calculateItemValue(row, item);
                // Only save if meaningful?
                // Editor logic: if (val && val !== ... ) snapshot[item.name] = val;
                if (val && val.replace(/,/g, '').replace(/0/g, '').length > 0) {
                    snapshot[item.name] = val;
                }
            });
            return JSON.stringify(snapshot); // API expects string or object? 
            // Server code: `const prodData = ... JSON.stringify(row.production_data)`
            // Actually server expects Object in JSON body, and it stringifies it?
            // No, let's look at server logic if needed.
            // safe bet: send Object.
            return snapshot;
        }


        // --- EXPORT ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];
            const item = document.getElementById('f-item').value;
            const patternName = MODE === 'create' ? document.getElementById('metaPattern').value : document.getElementById('f-pattern').options[document.getElementById('f-pattern').selectedIndex].text;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Pattern Details Report", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()} | Pattern: ${patternName} | Item: ${item}`, 14, 22);

            let headers = ['School', 'Name', 'Class', 'Pattern'];
            if (cols.length > 0) headers.push(...cols);
            else headers.push("Measurements");
            headers.push("Status");

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name || (draftMetadata ? draftMetadata.schoolName : '-'),
                    s.name,
                    `${s.class || ''} (${s.gender?.[0] || '?'})`,
                    s.pattern_name || '-'
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push('Select Item...');
                }

                row.push(s.is_packed ? 'Packed' : 'Pending');
                return row;
            });

            doc.autoTable({
                head: [headers],
                body: body,
                startY: 28,
                theme: 'grid',
                headStyles: { fillColor: [40, 40, 40], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 }
            });

            doc.save(`Pattern_Data_${TARGET_PATTERN_ID || 'View'}.pdf`);
        }

        function downloadExcel() {
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];

            const exportData = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = {
                    "School": s.school_name || (draftMetadata ? draftMetadata.schoolName : '-'),
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Pattern": s.pattern_name,
                    "Status": s.is_packed ? "Packed" : "Pending"
                };

                if (cols.length > 0) {
                    cols.forEach(k => row[k] = m[k.toLowerCase()] || '');
                } else {
                    row["Measurements"] = "Select Item to View";
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PatternData");
            XLSX.writeFile(wb, `Pattern_Data_${TARGET_PATTERN_ID || 'View'}.xlsx`);
        }

    </script>
</body>

</html>