<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattern View | Planet Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #1c1917;
            --rice-paper: #fafaf9;
            --seal-red: #be123c;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--rice-paper);
            color: #44403c;
        }

        .font-ink {
            font-family: 'Noto Serif JP', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-stone-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="planet_editor.html"
                    class="text-stone-400 hover:text-white transition-colors flex items-center gap-2 text-sm font-bold uppercase tracking-wider">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back to Editor
                </a>
                <div class="h-6 w-px bg-stone-700"></div>
                <h1 class="font-ink text-xl flex items-center gap-2"><span class="text-rose-600 text-2xl">●</span>
                    <span id="pageTitle">Pattern Details View</span>
                </h1>
            </div>

            <!-- Default Actions (View Mode) -->
            <div id="viewActions" class="flex gap-3">
                <button onclick="downloadPDF()"
                    class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download PDF
                </button>
                <button onclick="downloadExcel()"
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                    Download Excel
                </button>
            </div>

            <!-- Create Actions (Create Mode) -->
            <div id="createActions" class="hidden flex gap-3">
                <button onclick="savePattern()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow-lg text-sm font-bold uppercase flex items-center gap-2 transition-transform active:scale-95 ring-2 ring-indigo-400">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save & Create Pattern
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-4 md:p-6 max-w-[1920px] mx-auto w-full space-y-4">

        <!-- Creation Panel (Only Visible in Create Mode) -->
        <div id="creationPanel" class="hidden glass-panel p-6 rounded-xl border-l-4 border-indigo-500 shadow-lg mb-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Metadata Inputs -->
                <div class="space-y-4">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Pattern Details</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">School Name</label>
                            <input type="text" id="metaSchool" readonly
                                class="w-full text-sm border border-gray-300 rounded p-2 bg-gray-100 text-gray-600 font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Pattern Code</label>
                            <input type="text" id="metaPattern"
                                class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-200"
                                placeholder="e.g. P-101">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-1">Description</label>
                        <textarea id="metaDesc" rows="2"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none focus:border-indigo-500"
                            placeholder="Optional description..."></textarea>
                    </div>
                </div>

                <!-- Specs Inputs -->
                <div class="space-y-4 bg-stone-50 p-4 rounded-lg border border-stone-200">
                    <h3 class="text-lg font-bold text-stone-800 border-b border-stone-200 pb-2">Specifications</h3>

                    <div class="flex items-center justify-between">
                        <label class="block text-xs font-bold text-stone-600 uppercase">Cloth Consumption
                            (Mtrs/Student)</label>
                        <input type="number" id="metaConsumption" step="0.01"
                            class="w-32 text-sm border border-gray-300 rounded p-1 text-right font-mono font-bold text-indigo-700"
                            placeholder="0.00">
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Cloth Details</label>
                        <input type="text" id="metaClothDetails"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-stone-600 uppercase mb-1">Special
                            Requirements</label>
                        <input type="text" id="metaSpecialReq"
                            class="w-full text-sm border border-gray-300 rounded p-2 outline-none"
                            placeholder="Type...">
                    </div>
                </div>
            </div>
        </div>


        <!-- Advanced Toolbar (Ported from Editor) -->
        <div id="filterPanel"
            class="bg-white border-b border-[#E2E8F0] px-6 py-3 flex flex-col sm:flex-row items-start sm:items-center gap-4 overflow-x-auto no-scrollbar z-20 relative sticky top-0">

            <!-- Search & Filters -->
            <div class="flex items-center gap-3 w-full sm:w-auto overflow-x-auto">
                <div class="relative">
                    <svg class="absolute left-3 top-2 text-[#A0AEC0]" width="16" height="16" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="searchInput" oninput="handleSearch()" placeholder="Search..."
                        class="pl-9 pr-3 py-1.5 text-sm border border-[#E2E8F0] rounded-md focus:border-[#4A5568] outline-none w-32 sm:w-48 bg-[#F9F9F7] focus:bg-white transition-colors">
                </div>

                <select id="filterClass" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Classes</option>
                </select>

                <select id="filterSection" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Sections</option>
                </select>

                <select id="filterHouse" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Houses</option>
                </select>

                <select id="filterGender" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Genders</option>
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                </select>

                <select id="filterAttendance" onchange="handleFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568]">
                    <option value="">All Attendance</option>
                    <option value="Present">Present</option>
                    <option value="Absent">Absent</option>
                </select>

                <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block mx-2"></div>

                <select id="filterItem" onchange="handleItemFilter()"
                    class="text-sm border border-[#E2E8F0] rounded-md px-3 py-1.5 outline-none focus:border-[#4A5568] bg-white text-[#4A5568] max-w-[180px] font-medium">
                    <option value="">Filter by Item</option>
                </select>

                <!-- School/Pattern Hidden Selects for View Mode Compatibility -->
                <select id="f-school" class="hidden">
                    <option value="all">All</option>
                </select>
                <select id="f-pattern" class="hidden">
                    <option value="all">All</option>
                </select>
                <!-- Legacy IDs Mapped -->
                <input type="hidden" id="f-class" value="">
                <input type="hidden" id="f-gender" value="all">
                <input type="hidden" id="f-packed" value="all">
                <input type="hidden" id="f-item" value="all">

                <!-- Dynamic Component Filters Container -->
                <div id="dynamicFilters" class="flex flex-wrap items-center gap-2">
                    <!-- Dropdowns will be injected here -->
                </div>
            </div>

            <div class="h-8 w-px bg-[#E2E8F0] hidden sm:block"></div>

            <div class="flex items-center gap-2 ml-auto">
                <!-- Export Buttons from Header -->
                <div id="viewActions" class="flex gap-2">
                    <button onclick="downloadPDF()"
                        class="btn-outline px-3 py-1.5 rounded text-xs font-bold text-rose-600 border-rose-200 hover:bg-rose-50">PDF</button>
                    <button onclick="downloadExcel()"
                        class="bg-indigo-600 text-white px-3 py-1.5 rounded text-xs font-bold hover:bg-indigo-700 shadow-sm">Excel</button>
                </div>
                <div id="createActions" class="hidden">
                    <button onclick="savePattern()"
                        class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 flex items-center gap-2 transition-transform active:scale-95">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save & Create Pattern
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div
            class="glass-panel rounded-xl overflow-hidden shadow-xl border border-stone-200 flex-1 min-h-[500px] flex flex-col">
            <div class="overflow-auto flex-1 h-full">
                <table class="w-full text-left border-collapse whitespace-nowrap">
                    <thead class="bg-stone-50 text-stone-500 uppercase text-xs sticky top-0 z-20 shadow-sm">
                        <tr>
                            <th class="p-3 font-bold border-b border-r bg-stone-50 sticky left-0 z-30 w-16">No.</th>
                            <th class="p-3 font-bold border-b">School</th>
                            <th class="p-3 font-bold border-b">Student</th>
                            <th class="p-3 font-bold border-b">Class</th>
                            <th class="p-3 font-bold border-b">Pattern</th>
                            <!-- Dynamic Measurement Headers -->
                            <th class="p-3 font-bold border-b bg-amber-50 text-amber-700 text-center"
                                id="meas-header-group" colspan="1">Measurements</th>
                            <th class="p-3 font-bold border-b text-center">Status</th>
                        </tr>
                        <tr id="sub-header-row" class="bg-stone-100 text-[10px] font-mono text-stone-600 hidden">
                            <!-- Will be populated by JS -->
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-stone-100 bg-white text-sm">
                        <!-- Rows -->
                    </tbody>
                </table>
            </div>
            <div class="p-2 border-t bg-stone-50 text-right text-xs text-stone-500 font-mono" id="row-count">Loading...
            </div>
        </div>

    </main>

    <script>
        const API_BASE = '/api';
        const token = sessionStorage.getItem('token');
        if (!token) window.location.href = 'planet_editor.html';

        // --- URL PARAMS ---
        const urlParams = new URLSearchParams(window.location.search);
        const TARGET_PATTERN_ID = urlParams.get('id');
        const MODE = urlParams.get('mode'); // 'create' or null

        // --- DATA ---
        let allStudents = [];
        let patterns = [];
        let schools = [];
        let filteredStudents = []; // Active dataset
        let draftMetadata = null;

        // --- CONFIG ---
        // --- CONFIG ---
        const infoCols = ["S.No", "Roll No", "Admission No", "Student Name", "Class", "Section", "House", "Gender", "Absent/Present"];
        const measureCols = ["U1", "U2", "U3", "U4", "U5", "U6", "U7", "U8", "L1", "L2", "L3", "L4", "L5", "L6", "L7", "L8"];

        const boysItems = [
            { name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" },
        ];

        const girlsItems = [
            { name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" },
            { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" },
            { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" },
            { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" },
        ];
        const allItems = [...boysItems, ...girlsItems];

        let filters = {
            search: '',
            class: '',
            section: '',
            house: '',
            gender: '',
            attendance: '',
            item: '',
            components: {}
        };
        let searchTimeout = null;

        // --- INIT ---
        async function init() {
            // Populate Items (handled by populateFilters and static options)
            // But we need to load initial items into Item Select
            const itemSel = document.getElementById('f-item'); // Note: ID changed to filterItem in new HTML but kept aliases
            // Wait, I replaced the HTML. The new ID is `filterItem`. The old one `f-item` is hidden.
            // I should update this to populate `filterItem`.
            const newItemSel = document.getElementById('filterItem');
            if (newItemSel) {
                newItemSel.innerHTML = '<option value="">Filter by Item</option>' + allItems.map(i => `<option value="${i.name}">${i.name}</option>`).join('');
            }

            if (MODE === 'create') {
                setupCreateMode();
            } else {
                setupViewMode();
            }
        }
        init();

        // --- FILTERING LOGIC ---
        function populateFilters() {
            const classes = new Set();
            const sections = new Set();
            const houses = new Set();

            allStudents.forEach(s => {
                const c = getStudentProp(s, 'class');
                const sec = getStudentProp(s, 'section');
                const h = getStudentProp(s, 'house'); // Assuming 'house' prop handled in getStudentProp
                if (c) classes.add(c);
                if (sec) sections.add(sec);
                if (h) houses.add(h);
            });

            const fillParam = (id, set) => {
                const el = document.getElementById(id);
                if (!el) return;
                const current = el.value;
                el.innerHTML = `<option value="">All ${id.replace('filter', '')}s</option>` +
                    [...set].sort().map(v => `<option value="${v}">${v}</option>`).join('');
                el.value = current;
            };

            fillParam('filterClass', classes);
            fillParam('filterSection', sections);
            fillParam('filterHouse', houses);
        }

        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filters.search = document.getElementById('searchInput').value.toLowerCase();
                renderTable();
            }, 300);
        }

        function handleFilter() {
            filters.class = document.getElementById('filterClass').value;
            filters.section = document.getElementById('filterSection').value;
            filters.house = document.getElementById('filterHouse').value;
            filters.gender = document.getElementById('filterGender').value;
            filters.attendance = document.getElementById('filterAttendance').value;
            renderTable();
        }

        function handleItemFilter() {
            const itemName = document.getElementById('filterItem').value;
            filters.item = itemName;
            filters.components = {};

            const container = document.getElementById('dynamicFilters');
            container.innerHTML = '';

            if (itemName) {
                const item = allItems.find(i => i.name === itemName);
                if (item) {
                    item.cols.forEach(col => {
                        // Extract unique values for this col from data
                        // Need to use getMeasurementsSafe and handle flat/nested
                        const values = new Set();
                        allStudents.forEach(s => {
                            const m = getMeasurementsSafe(s);
                            // Robust access: U1 or u1
                            const val = m[col] || m[col.toLowerCase()];
                            if (val && val !== "00") values.add(val);
                        });
                        const sortedValues = [...values].sort();

                        const wrapper = document.createElement('div');
                        wrapper.className = "relative inline-block";

                        const input = document.createElement('input');
                        input.setAttribute('list', `list-${col}`);
                        input.type = "text";
                        input.placeholder = col;
                        input.className = "text-sm border border-[#E2E8F0] rounded-md px-2 py-1.5 outline-none focus:border-[#4A5568] bg-white w-24 text-[#4A5568] placeholder-gray-400";

                        input.onchange = (e) => {
                            if (e.target.value) filters.components[col] = e.target.value;
                            else delete filters.components[col];
                            renderTable();
                        };

                        const datalist = document.createElement('datalist');
                        datalist.id = `list-${col}`;
                        datalist.innerHTML = sortedValues.map(v => `<option value="${v}">`).join('');

                        wrapper.appendChild(input);
                        wrapper.appendChild(datalist);
                        container.appendChild(wrapper);
                    });
                }
            }
            renderTable();
        }

        // Advanced Matching Helper
        function advancedMatch(rowVal, filterVal) {
            if (!filterVal) return true;
            if (rowVal == null || rowVal === "") return false;
            const rVal = String(rowVal).trim().toUpperCase();
            const fVal = filterVal.toUpperCase();

            // Comma List
            if (fVal.includes(',')) {
                return fVal.split(',').map(p => p.trim()).includes(rVal);
            }
            // Range
            if (fVal.includes('-')) {
                const [min, max] = fVal.split('-').map(p => p.trim());
                if (!isNaN(min) && !isNaN(max)) {
                    const numVal = parseFloat(rowVal);
                    return !isNaN(numVal) && numVal >= parseFloat(min) && numVal <= parseFloat(max);
                }
                if (min.length === 1 && max.length === 1 && rVal.length === 1) {
                    return rVal >= min && rVal <= max;
                }
            }
            return rVal === fVal;
        }

        function setupCreateMode() {
            document.getElementById('pageTitle').innerText = "Create New Pattern";
            document.getElementById('viewActions').classList.add('hidden');
            document.getElementById('createActions').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            document.getElementById('creationPanel').classList.remove('hidden');
            // document.getElementById('filterPanel').classList.add('hidden'); // UNHIDDEN per user request

            // Load Draft Data
            try {
                const draft = JSON.parse(sessionStorage.getItem('draftPatternData'));
                if (draft && draft.students) {
                    allStudents = draft.students; // Flat objects from Editor
                    draftMetadata = draft;
                    document.getElementById('metaSchool').value = draft.schoolName || 'Unknown';
                    populateFilters(); // Populate dropdowns from Loaded Data
                    renderTable();
                } else {
                    alert("No data passed for creation. Returning to Editor.");
                    window.location.href = 'planet_editor.html';
                }
            } catch (e) { console.error(e); }
        }

        async function setupViewMode() {
            await Promise.all([
                fetchData(),
                fetchPatterns(),
                fetchSchools()
            ]);

            if (TARGET_PATTERN_ID) {
                const patSel = document.getElementById('f-pattern');
                const schSel = document.getElementById('f-school');
                patSel.value = TARGET_PATTERN_ID;
                const targetPattern = patterns.find(p => p.id == TARGET_PATTERN_ID);
                if (targetPattern) schSel.value = targetPattern.school_id;
            }
            renderTable();
        }

        async function fetchData() {
            try {
                const res = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } });
                allStudents = await res.json();
            } catch (e) { console.error(e); }
        }

        async function fetchPatterns() {
            try {
                const res = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                patterns = await res.json();
                const sel = document.getElementById('f-pattern');
                sel.innerHTML = '<option value="all">All Patterns</option>';
                patterns.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.text = `${p.name} (${p.school_name})`;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchSchools() {
            try {
                const res = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                schools = await res.json();
                const sel = document.getElementById('f-school');
                sel.innerHTML = '<option value="all">All Schools</option>';
                schools.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.text = s.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        // --- HELPER: NORMALIZE DATA ACCESS ---
        function getStudentProp(s, prop) {
            // 1. Try Direct Property (DB style)
            if (s[prop] !== undefined) return s[prop];

            // 2. Try Editor CSV/Excel Mapping
            if (prop === 'name') return s["Student Name"] || s["Student"] || s["Name"];
            if (prop === 'class') return s["Class"];
            if (prop === 'section') return s["Section"];
            if (prop === 'roll') return s["Roll No"] || s["Admission No"];
            if (prop === 'gender') return s["Gender"];
            if (prop === 'school_name') return draftMetadata ? draftMetadata.schoolName : '';
            if (prop === 'pattern_name') return '';
            if (prop === 'is_packed') return false;

            if (prop === 'attendance') return s["Absent/Present"] || s["attendance"] || "Present";
            if (prop === 'school_id') return s.school_id;
            return '';
        }

        // --- RENDER ---
        function renderTable() {
            // 1. FILTERING
            let data = allStudents.filter(s => {
                // Search
                if (filters.search) {
                    const name = (getStudentProp(s, 'name') || '').toLowerCase();
                    const roll = String(getStudentProp(s, 'roll') || '').toLowerCase();
                    if (!name.includes(filters.search) && !roll.includes(filters.search)) return false;
                }

                // View Mode Specific Filters (Legacy preservation)
                if (MODE !== 'create') {
                    const fSchool = document.getElementById('f-school').value;
                    const fPattern = document.getElementById('f-pattern').value;
                    /* Legacy Packed Filter check - hidden in UI now but logic remains valid if used */
                    // if (fPattern !== 'all' && s.pattern_id != fPattern) return false;
                }

                // ADVANCED FILTERS
                if (!advancedMatch(getStudentProp(s, 'class'), filters.class)) return false;
                if (!advancedMatch(getStudentProp(s, 'section'), filters.section)) return false;
                if (!advancedMatch(getStudentProp(s, 'house'), filters.house)) return false;

                if (filters.gender) {
                    const g = getStudentProp(s, 'gender');
                    if (filters.gender === 'M' && g !== 'Male' && g !== 'M') return false;
                    if (filters.gender === 'F' && g !== 'Female' && g !== 'F') return false;
                    if (filters.gender !== 'M' && filters.gender !== 'F' && g !== filters.gender) return false;
                }

                if (filters.attendance) {
                    const status = (getStudentProp(s, 'attendance') || '').toLowerCase();
                    if (filters.attendance === 'Absent' && !status.includes('absent')) return false;
                    if (filters.attendance === 'Present' && status.includes('absent')) return false;
                }

                // Item & Dynamic Filters
                if (filters.item) {
                    const def = allItems.find(x => x.name === filters.item);
                    const sGen = getStudentProp(s, 'gender');
                    // Gender Check for Item
                    if (def && sGen && def.type) {
                        const normGen = (sGen === 'Male' || sGen === 'M') ? 'Male' : (sGen === 'Female' || sGen === 'F') ? 'Female' : '';
                        if (normGen && normGen !== def.type) return false;
                    }

                    // Dynamic Components (Range Filters)
                    if (filters.components && Object.keys(filters.components).length > 0) {
                        const m = getMeasurementsSafe(s);
                        for (const [col, fVal] of Object.entries(filters.components)) {
                            const mVal = m[col] || m[col.toLowerCase()] || "";
                            if (!advancedMatch(mVal, fVal)) return false;
                        }
                    }
                }

                return true;
            });

            const fItem = filters.item; // Use state
            const measHeader = document.getElementById('meas-header-group');
            let subRow = document.getElementById('sub-header-row');
            let showCols = [];

            if (fItem) { // Check state instead of DOM value
                const def = allItems.find(x => x.name === fItem);
                if (def) showCols = def.cols;
                measHeader.innerText = fItem;
                measHeader.colSpan = showCols.length;
            } else {
                showCols = [];
                measHeader.innerText = "Measurements (Select Item)";
                measHeader.colSpan = 1;
            }

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = data.map((s, idx) => {
                const m = getMeasurementsSafe(s);
                let measCells = '';

                if (showCols.length > 0) {
                    measCells = showCols.map(k => {
                        // Access: Try "U1" (exact) then "u1" (lowercase) - robust access
                        let val = m[k] || m[k.toLowerCase()] || '-';
                        return `<td class="p-3 text-center font-mono font-bold bg-amber-50/30 text-stone-700 border-b border-stone-100">${val}</td>`;
                    }).join('');
                } else {
                    measCells = `<td class="p-3 text-xs text-stone-400 italic border-b border-stone-100">Select Item Type...</td>`;
                }

                const dName = getStudentProp(s, 'name');
                const dRoll = getStudentProp(s, 'roll');
                const dClass = getStudentProp(s, 'class');
                const dSection = getStudentProp(s, 'section');
                const dGender = getStudentProp(s, 'gender');
                const dSchool = getStudentProp(s, 'school_name');
                const dPattern = getStudentProp(s, 'pattern_name');
                const dPacked = getStudentProp(s, 'is_packed');

                return `<tr class="hover:bg-blue-50 transition-colors">
                    <td class="p-3 border-b border-r bg-stone-50/50 sticky left-0 font-mono text-xs text-stone-400 font-bold">${idx + 1}</td>
                    <td class="p-3 border-b border-stone-100 font-bold text-stone-700">${dSchool}</td>
                    <td class="p-3 border-b border-stone-100">
                        <div class="font-bold text-stone-800">${dName || '<span class="text-red-400">?</span>'}</div>
                        <div class="text-[10px] text-stone-500 font-mono">Roll: ${dRoll || '-'}</div>
                    </td>
                    <td class="p-3 border-b border-stone-100 text-sm">${dClass} ${dSection || ''} <span class="text-xs text-stone-400">(${dGender?.[0] || '?'})</span></td>
                    <td class="p-3 border-b border-stone-100">
                        ${dPattern ? `<span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-xs font-bold ring-1 ring-indigo-200">${dPattern}</span>` : '<span class="text-stone-300">-</span>'}
                    </td>
                    ${measCells}
                    <td class="p-3 border-b border-stone-100 text-center">
                        <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase ${dPacked ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${dPacked ? 'Packed' : 'Pending'}</span>
                    </td>
                </tr>`;
            }).join('');

            if (showCols.length > 0) {
                subRow.classList.remove('hidden');
                subRow.innerHTML = `
                    <th colspan="5"></th>
                    ${showCols.map(c => `<th class="p-2 text-center bg-amber-100 text-amber-800 border-x border-amber-200">${c}</th>`).join('')}
                    <th></th>
                `;
            } else {
                subRow.classList.add('hidden');
            }

            document.getElementById('row-count').innerText = `Showing ${data.length} Records`;
            window.filteredData = data;
            window.currentCols = showCols;
        }

        function getMeasurementsSafe(s) {
            // DB: nested Object string or object
            if (s.measurements) {
                if (typeof s.measurements === 'string') { try { return JSON.parse(s.measurements); } catch (e) { return {}; } }
                return s.measurements;
            }
            // Editor: Flat Object, return s itself
            return s;
        }

        // --- CREATE/SAVE LOGIC ---
        // Duplicate Logic from Planet Editor but adapted for this view
        function calculateItemValue(row, itemInfo) {
            const m = getMeasurementsSafe(row);
            // Reconstruct Logic from Editor if needed
            // For now assuming 'm' has keys "u1", "l1" etc.
            // itemInfo.cols = ["U1", "U2"]
            const vals = itemInfo.cols.map(c => m[c.toLowerCase()] || "00");
            // Filter logic? 
            if (itemInfo.type && row.gender && row.gender.toUpperCase() !== itemInfo.type.toUpperCase()) return "";

            // Check if all empty?
            const allEmpty = vals.every(v => v === "00" || v === "" || v === "0");
            if (allEmpty) return "00,00"; // Or whatever format
            return vals.join(",");
        }

        function calculateTotalBreakdown(dataset) {
            const breakdown = {};
            dataset.forEach(row => {
                allItems.forEach(item => {
                    // We don't have explicit Qty columns here unless we pulled them.
                    // Editor filtered data SHOULD include all columns from the table.
                    // Check if 'Qty_Item' exists in `row`.
                    // The `allStudents` here comes from `filtered` in Editor which is `data.filter(...)`.
                    // `data` in Editor has everything. So yes.

                    const qtyKey = `Qty_${item.name}`;
                    let rawQ = row[qtyKey];
                    if (typeof rawQ === 'string' && rawQ.includes(',')) rawQ = NaN;
                    let q = parseFloat(rawQ);

                    if (!isNaN(q)) {
                        breakdown[item.name] = (breakdown[item.name] || 0) + q;
                    } else {
                        // Calculated
                        const valStr = calculateItemValue(row, item);
                        const hasMeasurements = valStr.replace(/00/g, '').replace(/,/g, '').length > 0;
                        if (hasMeasurements) {
                            breakdown[item.name] = (breakdown[item.name] || 0) + 1;
                        }
                    }
                });
            });
            return breakdown;
        }

        async function savePattern() {
            if (!draftMetadata) return alert("Missing Session Data");

            const name = document.getElementById('metaPattern').value;
            const consumption = document.getElementById('metaConsumption').value;
            const cloth = document.getElementById('metaClothDetails').value;
            const req = document.getElementById('metaSpecialReq').value;

            if (!name) return alert("Pattern Code is Required");

            const quantities = calculateTotalBreakdown(allStudents);

            try {
                // 1. Create Pattern
                const res = await fetch('/api/data/patterns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({
                        school_id: draftMetadata.schoolId,
                        name: name,
                        consumption: parseFloat(consumption),
                        cloth_details: cloth,
                        special_req: req,
                        quantities: quantities
                    })
                });

                if (!res.ok) throw new Error("Failed to create pattern");
                const resData = await res.json();
                const patternId = resData.id;

                // 2. Link Students (Sync logic needs to happen on SERVER or we must push updates?)
                // WE NEED TO UPDATE THE STUDENTS IN DB TO LINK TO THIS PATTERN.
                // In Editor, we called `syncToCloud`. Here we don't have the full Sync logic.
                // We should make a dedicated API call to "Link Students to Pattern".
                // Since we have the IDs.

                // Let's reuse `/api/sync` but we need to construct the payload.
                // The payload expected by `/api/sync` is array of students.
                // We only need to update `pattern_id`.
                // Efficient way: POST /api/data/link_pattern  { pattern_id: X, student_ids: [...] }
                // But that endpoint doesn't exist.
                // Reuse Sync: Construct minimal payload { id: X, pattern_id: Y } for all students.

                const syncPayload = allStudents.map(s => ({
                    id: s.id,
                    pattern_id: patternId,
                    // We must also send production_data if we want to ensure it's saved? 
                    // Editor logic sent it. If we don't send, it stays as is?
                    // Sync logic performs UPDATE. if we send `pattern_id`, it updates it.
                    // Be careful not to wipe other fields.
                    // Let's send `production_data` too just in case it wasn't there?
                    // Actually, if we just came from Editor, the data might not be in Cloud yet?
                    // Wait, Editor `filtered` data is LOCAL.
                    // If the user made changes in Editor and clicked "Create Pattern", those changes are in `draftPatternData`.
                    // But they are NOT in the database yet if they didn't click "Sync".
                    // The user flow implies "Save & Create".
                    // So we MUST sync everything: Measurements, everything.
                    // This is heavy.

                    // Simple solution: We pass the FULL student object.
                    // But we need to calculate `production_data` string for each item.
                    // This logic is duplicated.

                    ...s, // Spread existing props (name, class etc)
                    pattern_id: patternId,
                    production_data: produceProductionData(s)
                }));

                await fetch('/api/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ data: syncPayload, school_id: draftMetadata.schoolId })
                });

                alert("✅ Pattern Created & Data Linked Successfully!");

                // Switch to View Mode
                window.location.href = `pattern_view.html?id=${patternId}`;

            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function produceProductionData(row) {
            const snapshot = {};
            allItems.forEach(item => {
                const val = calculateItemValue(row, item);
                // Only save if meaningful?
                // Editor logic: if (val && val !== ... ) snapshot[item.name] = val;
                if (val && val.replace(/,/g, '').replace(/0/g, '').length > 0) {
                    snapshot[item.name] = val;
                }
            });
            return JSON.stringify(snapshot); // API expects string or object? 
            // Server code: `const prodData = ... JSON.stringify(row.production_data)`
            // Actually server expects Object in JSON body, and it stringifies it?
            // No, let's look at server logic if needed.
            // safe bet: send Object.
            return snapshot;
        }


        // --- EXPORT ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];
            const item = document.getElementById('f-item').value;
            const patternName = MODE === 'create' ? document.getElementById('metaPattern').value : document.getElementById('f-pattern').options[document.getElementById('f-pattern').selectedIndex].text;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("Pattern Details Report", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()} | Pattern: ${patternName} | Item: ${item}`, 14, 22);

            let headers = ['School', 'Name', 'Class', 'Pattern'];
            if (cols.length > 0) headers.push(...cols);
            else headers.push("Measurements");
            headers.push("Status");

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name || (draftMetadata ? draftMetadata.schoolName : '-'),
                    s.name,
                    `${s.class || ''} (${s.gender?.[0] || '?'})`,
                    s.pattern_name || '-'
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push('Select Item...');
                }

                row.push(s.is_packed ? 'Packed' : 'Pending');
                return row;
            });

            doc.autoTable({
                head: [headers],
                body: body,
                startY: 28,
                theme: 'grid',
                headStyles: { fillColor: [40, 40, 40], textColor: 255 },
                styles: { fontSize: 8, cellPadding: 2 }
            });

            doc.save(`Pattern_Data_${TARGET_PATTERN_ID || 'View'}.pdf`);
        }

        function downloadExcel() {
            const data = window.filteredData || allStudents;
            const cols = window.currentCols || [];

            const exportData = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = {
                    "School": s.school_name || (draftMetadata ? draftMetadata.schoolName : '-'),
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Pattern": s.pattern_name,
                    "Status": s.is_packed ? "Packed" : "Pending"
                };

                if (cols.length > 0) {
                    cols.forEach(k => row[k] = m[k.toLowerCase()] || '');
                } else {
                    row["Measurements"] = "Select Item to View";
                }
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "PatternData");
            XLSX.writeFile(wb, `Pattern_Data_${TARGET_PATTERN_ID || 'View'}.xlsx`);
        }

    </script>
</body>

</html>