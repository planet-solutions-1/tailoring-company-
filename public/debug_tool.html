<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnosis Tool</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #f0f0f0;
        }

        .box {
            background: white;
            padding: 20px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .pass {
            color: green;
            font-weight: bold;
        }

        .fail {
            color: red;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #0056b3;
        }

        pre {
            background: #eee;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>ðŸ©º System Diagnosis (Medical Test)</h1>
    <p>Use this tool to find out why the errors are happening.</p>

    <div class="box">
        <h3>1. Token Check</h3>
        <p>Checking if you are logged in...</p>
        <div id="tokenStatus">Waiting...</div>
        <pre id="tokenDetails">...</pre>
    </div>

    <div class="box">
        <h3>2. Server Connection Test</h3>
        <p>Trying to reach the server...</p>
        <button onclick="runNetworkTest()">Run Test</button>
        <div id="networkStatus" style="margin-top:10px;"></div>
        <pre id="networkResponse">...</pre>
    </div>

    <div class="box">
        <h3>3. Delete Permission Test</h3>
        <p>Checking if you are allowed to delete...</p>
        <input type="text" id="testId" placeholder="Enter Admission No (e.g. P19017)" value="P19017">
        <button onclick="runDeleteTest()">Test Delete Permission</button>
        <div id="deleteStatus" style="margin-top:10px;"></div>
    </div>

    <script>
        // Get params from URL (injected by Dashboard) OR fallback to Session
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token') || sessionStorage.getItem('token');
        const schoolId = params.get('sid') || sessionStorage.getItem('schoolId');

        // 1. Token Check
        const tokenStatus = document.getElementById('tokenStatus');
        const tokenDetails = document.getElementById('tokenDetails');

        if (!token) {
            tokenStatus.innerHTML = "<span class='fail'>CRITICAL: No Token Found! You are not logged in.</span>";
            tokenDetails.innerText = "Please Log In again.";
        } else {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                const parsed = JSON.parse(jsonPayload);

                const now = Math.floor(Date.now() / 1000);
                const isExpired = parsed.exp < now;

                if (isExpired) {
                    tokenStatus.innerHTML = "<span class='fail'>FAIL: Token is EXPIRED. Log out and Log in.</span>";
                } else {
                    tokenStatus.innerHTML = "<span class='pass'>PASS: Token is Valid and Active.</span>";
                }

                tokenDetails.innerText = JSON.stringify(parsed, null, 2);
            } catch (e) {
                tokenStatus.innerHTML = "<span class='fail'>FAIL: Token is corrupt.</span>";
                tokenDetails.innerText = e.message;
            }
        }

        // 2. Network Test
        async function runNetworkTest() {
            const netStatus = document.getElementById('networkStatus');
            const netResp = document.getElementById('networkResponse');

            netStatus.innerHTML = "Testing...";
            try {
                // Try School Details
                const res = await fetch(`/api/schools/${schoolId || 5}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const text = await res.text();

                if (res.ok) {
                    netStatus.innerHTML = "<span class='pass'>PASS: Connected to Server (200 OK)</span>";
                } else {
                    netStatus.innerHTML = `<span class='fail'>FAIL: Server Error (${res.status})</span>`;
                }
                netResp.innerText = text.substring(0, 500); // Show preview
            } catch (e) {
                netStatus.innerHTML = "<span class='fail'>FAIL: Network unreachable.</span>";
                netResp.innerText = e.message;
            }
        }

        // 3. Delete Test
        async function runDeleteTest() {
            const id = document.getElementById('testId').value;
            const delStatus = document.getElementById('deleteStatus');

            delStatus.innerHTML = "Testing Permission (This attempts a real delete)...";
            try {
                const res = await fetch(`/api/data/students/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 401) {
                    const errText = await res.text();
                    delStatus.innerHTML = `<span class='fail'>FAIL: 401 Unauthorized. The Server rejected your Token.</span><br>Server Said: ${errText}`;
                } else if (res.status === 403) {
                    delStatus.innerHTML = "<span class='fail'>FAIL: 403 Forbidden. You don't have permission for this School ID.</span>";
                } else if (res.status === 404) {
                    delStatus.innerHTML = "<span class='pass'>PARTIAL PASS: 404 Not Found (Server replied, but student missing).</span>";
                } else if (res.ok) {
                    delStatus.innerHTML = "<span class='pass'>SUCCESS: 200 OK. Deleted successfully.</span>";
                } else {
                    const errText = await res.text();
                    delStatus.innerHTML = `<span class='fail'>FAIL: Error ${res.status}</span><br><pre>${errText}</pre>`;
                }
            } catch (e) {
                delStatus.innerHTML = "<span class='fail'>FAIL: Network Error.</span>";
            }
        }
    </script>
</body>

</html>