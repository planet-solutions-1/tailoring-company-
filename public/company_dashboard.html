<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Admin | Clay Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            /* Snow White & Pastels */
            --clay-bg: #f2fcf0;
            --clay-surface: #ffffff;

            /* Shadows for White-on-Green (Sage Tinted) */
            --shadow-light: 10px 10px 30px rgba(160, 175, 165, 0.4),
                -10px -10px 30px rgba(255, 255, 255, 0.8);
            --shadow-pressed: inset 6px 6px 10px rgba(160, 175, 165, 0.2),
                inset -6px -6px 10px rgba(255, 255, 255, 1);

            /* Pastel Accents */
            --accent-blue: #A0C4FF;
            /* Soft Blue */
            --accent-pink: #FFADAD;
            /* Soft Pink */
            --accent-peach: #FFD6A5;
            /* Peach */
            --accent-mint: #CAFFBF;
            /* Mint */
            --accent-purple: #BDB2FF;
            /* Keep for legacy or replace */

            /* Text */
            --text-main: #4A5568;
            --text-light: #A0AEC0;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--clay-bg);
            color: var(--text-main);
        }

        /* --- CLAY COMPONENTS --- */

        /* 1. Cards: Inflated, floating */
        .clay-card {
            background-color: var(--clay-surface);
            border-radius: 30px;
            /* Super rounded */
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: transform 0.3s ease;
        }

        /* 2. Buttons: Pressable 3D Objects */
        .clay-btn {
            background-color: var(--clay-surface);
            border-radius: 20px;
            padding: 12px 24px;
            font-weight: 800;
            /* Chunky text */
            color: var(--text-main);
            border: none;
            outline: none;
            cursor: pointer;
            box-shadow: var(--shadow-light);
            transition: all 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Press Animation */
        .clay-btn:active,
        .clay-btn.active {
            box-shadow: var(--shadow-pressed);
            transform: scale(0.95);
            color: var(--accent-purple);
        }

        /* Primary Button (Colored Clay) */
        .clay-primary {
            background: var(--clay-surface);
            /* Keep surface to show inset shadow well, or use gradient? */
            color: var(--accent-purple);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .clay-primary:hover {
            color: #8854d0;
        }

        /* 3. Inputs: Deeply Pressed */
        .clay-input {
            width: 100%;
            background-color: var(--clay-surface);
            border: none;
            border-radius: 15px;
            padding: 16px 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            color: var(--text-main);
            box-shadow: var(--shadow-pressed);
            /* Permanent pressed look */
            outline: none;
            transition: all 0.2s;
        }

        .clay-inner {
            box-shadow: var(--shadow-pressed);
        }

        .clay-input:focus {
            box-shadow: inset 4px 4px 8px rgba(166, 180, 200, 0.5),
                inset -4px -4px 8px rgba(255, 255, 255, 0.9),
                0 0 0 3px rgba(165, 94, 234, 0.3);
            /* Focus ring */
        }

        /* 4. Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--clay-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
            border: 3px solid var(--clay-bg);
        }

        /* Animations */
        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .fade-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col md:flex-row selection:bg-purple-200 selection:text-purple-900">

    <!-- Mobile Header -->
    <div class="md:hidden p-4 flex justify-between items-center z-50 sticky top-0 bg-opacity-80 backdrop-blur-md"
        style="background-color: var(--clay-bg);">
        <h1 class="text-xl font-extrabold flex items-center gap-2 text-gray-700">
            <span
                class="w-10 h-10 rounded-xl clay-primary flex items-center justify-center font-bold text-xl shadow-inner text-white"
                style="background: var(--accent-purple);">P</span>
            Planet Admin
        </h1>
        <button onclick="toggleSidebar()" class="clay-btn p-2 rounded-xl text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>

    <!-- Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-gray-900/10 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300 md:hidden">
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 w-72 md:w-72 md:m-6 md:rounded-3xl clay-card transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col scale-95 md:scale-100 origin-left border-none">

        <!-- Brand -->
        <div class="p-8 flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl clay-primary flex items-center justify-center text-2xl font-bold shadow-inner text-white"
                style="background: var(--accent-blue);">
                P
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-gray-700 tracking-tight">Planet</h1>
                <p
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest bg-blue-50 px-2 py-0.5 rounded-full inline-block mt-1">
                    Clay Command</p>
            </div>
        </div>

        <!-- User Profile Mini -->
        <div class="mx-6 p-4 clay-input !w-auto flex items-center gap-3 mb-6 shadow-inner">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-400 to-blue-500 text-white flex items-center justify-center font-bold text-lg shadow-lg">
                A
            </div>
            <div>
                <p class="text-sm font-bold text-gray-700">Admin User</p>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(74,222,128,0.8)]"></span>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Online</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 space-y-3 overflow-y-auto py-2">
            <button onclick="switchTab('overview')" id="nav-overview"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Overview
            </button>
            <button onclick="switchTab('data')" id="nav-data"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Tailoring Data
            </button>
            <button onclick="switchTab('users')" id="nav-users"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                User Management
            </button>
            <button onclick="switchTab('access')" id="nav-access"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Access Codes
            </button>
            <button onclick="switchTab('schools')" id="nav-schools"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18"></path>
                    <path d="M5 21V7l8-4 8 4v14"></path>
                    <path d="M17 21v-8.5"></path>
                </svg>
                Schools
            </button>
            <button onclick="switchTab('reports')" id="nav-reports"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Reports
            </button>
            <button onclick="switchTab('complaints')" id="nav-complaints"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 rounded-xl text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                    </path>
                </svg>
                Complaints
            </button>
            <button onclick="switchTab('settings')" id="nav-settings"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 rounded-xl text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                Settings
            </button>

            <div class="h-px bg-gray-300/50 mx-4 my-2"></div>

            <button onclick="window.open('pattern_view.html', '_blank')"
                class="clay-btn w-full flex items-center gap-4 px-6 py-3 text-sm text-blue-400">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Open Pattern Manager
            </button>
        </nav>
        <div class="p-6">
            <button onclick="logout()"
                class="w-full clay-btn py-3 text-xs font-extrabold text-gray-500 hover:text-red-500 uppercase tracking-wider">
                Sign Out
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col relative md:ml-96 transition-all duration-300 isolate">
        <!-- Background Decor (Watercolor Effect) -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none -z-10">
            <!-- Top Right Organic Blob -->
            <div
                class="absolute -top-[10%] -right-[5%] w-[700px] h-[700px] rounded-full bg-[#e2f7e7] blur-[100px] opacity-80 mix-blend-multiply">
            </div>
            <div
                class="absolute top-[5%] -right-[10%] w-[600px] h-[600px] rounded-full bg-[#dcfce7] blur-[80px] opacity-70 mix-blend-multiply">
            </div>

            <!-- Bottom Left Soft Wash -->
            <div
                class="absolute -bottom-[10%] -left-[10%] w-[800px] h-[800px] rounded-full bg-[#f0fdf4] blur-[120px] opacity-60">
            </div>
        </div>
        <!-- Header -->
        <div id="vertical-enforcer" class="flex flex-col w-full relative min-h-screen">
            <!-- Header -->
            <header class="px-8 py-6 flex justify-between items-center z-30 w-full gap-8">
                <div class="flex-1 min-w-0">
                    <h2 id="page-title"
                        class="text-2xl font-extrabold text-gray-700 tracking-tight whitespace-nowrap overflow-hidden text-overflow-ellipsis">
                        System Overview</h2>
                    <p id="page-subtitle" class="text-sm font-bold text-gray-400 mt-1 uppercase tracking-wide truncate">
                        Manage Planet
                        Solutions tailors & operations</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="if(confirm('Reset DB?')) resetDatabase()"
                        class="clay-btn px-6 py-3 text-gray-500 text-xs font-bold uppercase tracking-wider hover:text-red-500 rounded-xl whitespace-nowrap">
                        Reset DB
                    </button>
                    <button onclick="fixDatabase()"
                        class="clay-btn bg-indigo-50 text-indigo-600 px-6 py-3 text-xs font-bold uppercase tracking-wider rounded-xl shadow-lg hover:bg-indigo-100 transition-all active:scale-95 whitespace-nowrap">
                        Repair DB
                    </button>
                </div>
            </header>

            <!-- 3. USER MANAGEMENT (Relocated to Top) -->
            <div id="view-users" class="hidden fade-in space-y-8 w-full px-8 pb-8">

                <!-- A. REGISTRATION FORM (Always Visible) -->
                <div class="clay-card p-8 w-full">
                    <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-700">Account Registration</h3>
                            <p class="text-sm text-gray-400">Add new administrators or staff members.</p>
                        </div>
                        <button onclick="openSchoolModal()"
                            class="clay-btn clay-primary px-4 py-2 text-xs font-bold shadow-md hover:shadow-lg border-none transition-transform active:scale-95">
                            Register New School
                        </button>
                    </div>

                    <form onsubmit="createUser(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Username</label>
                                <input type="text" name="username" required class="clay-input w-full p-3 text-sm">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Password</label>
                                <input type="text" name="password" required class="clay-input w-full p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Role</label>
                                <select name="role" id="user-role" onchange="toggleSchoolSelect()"
                                    class="clay-input w-full p-3 text-sm">
                                    <option value="school">School Admin</option>
                                    <option value="tailor">Tailor</option>
                                    <option value="packing">Packing Unit</option>
                                    <option value="company">Company Admin</option>
                                </select>
                            </div>
                        </div>

                        <div id="school-select-wrapper" class="w-full">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Assign To
                                School</label>
                            <select name="school_id" id="school-select" class="clay-input w-full p-3 text-sm"></select>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="clay-btn clay-primary px-10 py-3 rounded-xl text-sm font-bold shadow-md transition-transform active:scale-95">
                                Create Account
                            </button>
                        </div>
                    </form>
                </div>

                <!-- B. EXISTING USERS TABLE -->
                <div class="clay-card p-8 w-full">
                    <h3 class="text-lg font-bold text-gray-600 mb-6">Existing Accounts</h3>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm min-w-[600px]">
                            <thead class="text-gray-400 uppercase text-xs font-bold bg-gray-50/50">
                                <tr>
                                    <th class="p-4 text-left rounded-l-xl">User</th>
                                    <th class="p-4 text-left">Role</th>
                                    <th class="p-4 text-left">School</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-right rounded-r-xl">Created</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 1. OVERVIEW -->
            <div id="view-overview" class="space-y-8 fade-in">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Stat Card 1: Total Students (Blue/Cyan Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#eff6ff] via-white to-[#eff6ff]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                            </div>
                            <span
                                class="bg-blue-400 text-white px-4 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wide shadow-md shadow-blue-200">+12%</span>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Total
                                Students</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-students">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-blue-100/40 rounded-full blur-2xl group-hover:bg-blue-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 2: Orders Pending (Amber/Cream Theme - REFERENCE MATCH) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#fffbeb] via-white to-[#fffbeb]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-amber-50 text-amber-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                                    <polyline points="12 6 12 12 16 14" stroke-width="2"></polyline>
                                </svg>
                            </div>
                            <span
                                class="bg-amber-400 text-white px-4 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wide shadow-md shadow-amber-200">Pending</span>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Orders
                                Pending</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-pending">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-amber-100/40 rounded-full blur-2xl group-hover:bg-amber-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 3: Completed (Emerald/Mint Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#ecfdf5] via-white to-[#ecfdf5]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <!-- Dynamic Badge for Completed (Hidden if 0 or styled differently) -->
                            <div
                                class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">
                                Completed
                            </p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-packed">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-emerald-100/40 rounded-full blur-2xl group-hover:bg-emerald-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 4: Total Schools (Rose/Pink Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#fff1f2] via-white to-[#fff1f2]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Total
                                Schools</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-schools">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-rose-100/40 rounded-full blur-2xl group-hover:bg-rose-200/40 transition-colors">
                        </div>
                    </div>




                </div>

                <!-- URGENT DEADLINES WIDGET -->
                <div class="mt-8 animate-in slide-in-from-bottom-4 duration-500 delay-150">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="text-2xl animate-pulse">⏳</span> Upcoming Deadlines & Priority
                    </h3>
                    <div id="urgent-deadlines-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="clay-card p-6 flex items-center justify-center text-gray-400 italic">
                            No upcoming deadlines set.
                        </div>
                    </div>
                </div>

                <!-- Charts Row (Restored) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-96">
                    <!-- Chart 1: Schools Distribution -->
                    <div class="clay-card p-6 flex flex-col justify-between lg:col-span-2 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10">
                            <div>
                                <h3 class="font-extrabold text-lg text-slate-700">School Distribution</h3>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                    Student
                                    Capacity &
                                    Enrollment</p>
                            </div>
                            <span class="p-2 rounded-xl bg-purple-50 text-purple-500 shadow-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                    </path>
                                </svg>
                            </span>
                        </div>
                        <div class="flex-1 w-full mt-4 relative">
                            <canvas id="chart-schools"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Packing Status -->
                    <div class="clay-card p-6 flex flex-col justify-between relative overflow-hidden">
                        <div class="flex justify-between items-start z-10">
                            <div>
                                <h3 class="font-extrabold text-lg text-slate-700">Order Status</h3>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                    Completion
                                    Rate
                                </p>
                            </div>
                            <div class="flex -space-x-2">
                                <!-- Decor -->
                            </div>
                        </div>
                        <div class="flex-1 w-full mt-4 relative flex items-center justify-center">
                            <canvas id="chart-packing"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Smart Insights Row (New) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <!-- 1. Performance Leaderboard -->
                    <div class="clay-card p-6 flex flex-col lg:col-span-1 h-[450px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="p-2 rounded-lg bg-yellow-100 text-yellow-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </span>
                                Leaderboard
                            </h3>
                            <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Top
                                Efficiency</span>
                        </div>

                        <div class="overflow-y-auto pr-2 custom-scrollbar flex-1 space-y-4" id="leaderboard-list">
                            <!-- Injected via JS -->
                            <div class="animate-pulse flex space-x-4">
                                <div class="rounded-full bg-gray-200 h-10 w-10"></div>
                                <div class="flex-1 space-y-2 py-1">
                                    <div class="h-2 bg-gray-200 rounded"></div>
                                    <div class="space-y-3">
                                        <div class="grid grid-cols-3 gap-4">
                                            <div class="h-2 bg-gray-200 rounded col-span-2"></div>
                                            <div class="h-2 bg-gray-200 rounded col-span-1"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Live Activity Feed -->
                    <div class="clay-card p-6 flex flex-col lg:col-span-2 h-[450px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="p-2 rounded-lg bg-blue-100 text-blue-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </span>
                                Live Activity
                            </h3>
                            <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Real-time
                                Updates</span>
                        </div>

                        <div class="overflow-y-auto pr-4 custom-scrollbar flex-1 relative" id="activity-feed">
                            <!-- Timeline Line -->
                            <div class="absolute left-6 top-4 bottom-4 w-0.5 bg-gray-100"></div>
                            <!-- Injected Items -->
                        </div>
                    </div>

                </div>
            </div>

            <!-- 2. TAILORING DATA (Restructured) -->
            <div id="view-data" class="hidden space-y-6 fade-in min-h-screen">

                <!-- LEVEL 1: SCHOOL SELECTION GRID -->
                <div id="td-level-1" class="animate-in slide-in-from-left-4 duration-300">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <div class="flex justify-between items-center mb-8">
                                <!-- Header Removed: Handled globally -->
                            </div>
                        </div>
                    </div>

                    <div id="td-school-grid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- School Cards Injected Here -->
                    </div>
                </div>

                <!-- LEVEL 2: SCHOOL DETAILS -->
                <div id="td-level-2" class="hidden animate-in slide-in-from-right-4 duration-300">
                    <!-- Header & Back -->
                    <div
                        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                        <div class="flex items-center gap-4">
                            <button onclick="closeSchoolDetails()"
                                class="w-10 h-10 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-600 flex items-center justify-center transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <div>
                                <h2 class="text-2xl font-extrabold text-gray-800 flex items-center gap-3">
                                    <span id="td-school-name">School Name</span>
                                    <span id="td-school-badge"
                                        class="px-3 py-1 rounded-full text-xs bg-blue-100 text-blue-600 font-bold uppercase tracking-wider">Loading</span>
                                </h2>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mt-1"
                                    id="td-school-meta">0
                                    Students • 0 Patterns</p>
                            </div>
                        </div>
                        <!-- Global Filters for this School View -->
                        <!-- Global Filters for this School View -->

                    </div>

                </div>

                <!-- LEVEL 2: CATEGORY GRID (Replaces Tabs) -->
                <div id="td-category-grid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Students Card -->
                    <div onclick="openLevel3('students')"
                        class="clay-card p-8 flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group">
                        <div>
                            <div
                                class="w-12 h-12 rounded-xl bg-blue-100 text-blue-600 flex items-center justify-center mb-4 text-2xl">
                                <i class="fas fa-users"></i> <!-- Using FontAwesome classes or SVG -->
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                    </path>
                                </svg>
                            </div>
                            <h3
                                class="text-xl font-extrabold text-gray-700 group-hover:text-blue-600 transition-colors">
                                Student Details</h3>
                            <p class="text-sm text-gray-400 font-bold mt-1" id="td-cat-students-count">Loading...
                            </p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-blue-600 group-hover:text-white transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </div>
                    </div>

                    <!-- Measurements Card -->
                    <div onclick="openLevel3('measurements')"
                        class="clay-card p-8 flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group">
                        <div>
                            <div
                                class="w-12 h-12 rounded-xl bg-purple-100 text-purple-600 flex items-center justify-center mb-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>
                            <h3
                                class="text-xl font-extrabold text-gray-700 group-hover:text-purple-600 transition-colors">
                                Measurements</h3>
                            <p class="text-sm text-gray-400 font-bold mt-1">Full Matrix View</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-purple-600 group-hover:text-white transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </div>
                    </div>

                    <!-- Pattern Boys Card -->
                    <div onclick="openLevel3('patterns-boys')"
                        class="clay-card p-8 flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group">
                        <div>
                            <div
                                class="w-12 h-12 rounded-xl bg-indigo-100 text-indigo-600 flex items-center justify-center mb-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                    </path>
                                </svg>
                            </div>
                            <h3
                                class="text-xl font-extrabold text-gray-700 group-hover:text-indigo-600 transition-colors">
                                Boys Patterns</h3>
                            <p class="text-sm text-gray-400 font-bold mt-1" id="td-cat-boys-count">Loading...</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-indigo-600 group-hover:text-white transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </div>
                    </div>

                    <!-- Pattern Girls Card -->
                    <div onclick="openLevel3('patterns-girls')"
                        class="clay-card p-8 flex items-center justify-between cursor-pointer hover:scale-[1.02] transition-transform group">
                        <div>
                            <div
                                class="w-12 h-12 rounded-xl bg-pink-100 text-pink-500 flex items-center justify-center mb-4">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                    </path>
                                </svg>
                            </div>
                            <h3
                                class="text-xl font-extrabold text-gray-700 group-hover:text-pink-500 transition-colors">
                                Girls Patterns</h3>
                            <p class="text-sm text-gray-400 font-bold mt-1" id="td-cat-girls-count">Loading...</p>
                        </div>
                        <div
                            class="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center text-gray-300 group-hover:bg-pink-500 group-hover:text-white transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7">
                                </path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- LEVEL 3: DATA VIEWS (Students, Measurements, Patterns Grid) -->
                <!-- Each View now has a Header with Back Button -->

                <!-- 1. STUDENTS LIST -->
                <div id="td-view-students" class="hidden space-y-6">
                    <div class="flex flex-col gap-6">
                        <div class="flex items-center gap-4">
                            <button onclick="closeLevel3()"
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <h3 class="text-xl font-extrabold text-gray-800">Student List</h3>
                        </div>

                        <!-- Filters Relocated Here -->
                        <!-- Filters Relocated Here -->
                        <!-- Filters Re-Built Layout -->
                        <div id="td-filters-container"
                            class="bg-gray-50/50 p-4 rounded-xl border border-gray-100 flex flex-col gap-4">
                            <!-- Top Row: Search & Desktop Actions -->
                            <div class="flex flex-col md:flex-row gap-4 items-center">
                                <!-- Search -->
                                <div class="relative w-full md:max-w-md">
                                    <span class="absolute left-3 top-3 text-gray-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </span>
                                    <input type="text" id="td-filter-search" oninput="renderTdCurrentTab()"
                                        placeholder="Search (1-5, A-C...)"
                                        class="clay-input h-10 pl-10 text-sm font-bold w-full bg-white transition-colors placeholder-gray-400">
                                </div>

                                <!-- Desktop Export Buttons -->
                                <div class="hidden md:flex items-center gap-3 ml-auto">
                                    <button onclick="downloadTdPDF()"
                                        class="clay-btn h-10 px-4 bg-red-50 text-red-600 font-bold uppercase text-xs hover:bg-red-100 flex items-center gap-2"
                                        title="Download PDF Report">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span>PDF</span>
                                    </button>
                                    <button onclick="exportTdCurrentData()"
                                        class="clay-btn h-10 px-4 bg-emerald-50 text-emerald-600 font-bold uppercase text-xs hover:bg-emerald-100 flex items-center gap-2"
                                        title="Download Excel">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                        <span>Excel</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Bottom Row: Filters Grid & Mobile Actions -->
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                <!-- Class -->
                                <div class="relative">
                                    <select id="td-filter-class" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Class</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Section -->
                                <div class="relative">
                                    <select id="td-filter-section" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Section</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Gender -->
                                <div class="relative">
                                    <select id="td-filter-gender" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>

                                <!-- Mobile Export Buttons (Visible only on small screens) -->
                                <div class="md:hidden col-span-2 flex items-center justify-end gap-2 mt-2">
                                    <button onclick="downloadTdPDF()"
                                        class="clay-btn h-10 w-10 flex items-center justify-center bg-red-50 text-red-600 hover:bg-red-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </button>
                                    <button onclick="exportTdCurrentData()"
                                        class="clay-btn h-10 w-10 flex items-center justify-center bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-lg">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-1 min-h-[500px] shadow-sm border border-gray-100">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100">
                                        <th class="p-4">Roll No</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4">Gender</th>
                                        <th class="p-4 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="td-list-students"
                                    class="text-sm font-medium text-gray-600 divide-y divide-gray-50">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. MEASUREMENTS -->
                <div id="td-view-measurements" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Full Measurements Matrix</h3>
                    </div>
                    <div class="bg-white rounded-2xl p-1 min-h-[500px] shadow-sm border border-gray-100">
                        <div class="overflow-x-auto custom-scrollbar pb-4">
                            <table class="w-full text-left whitespace-nowrap border-collapse">
                                <thead class="bg-gray-50/50 sticky top-0 z-10">
                                    <tr
                                        class="text-[10px] font-extrabold text-gray-400 uppercase tracking-wider border-b border-gray-200">
                                        <th
                                            class="p-3 sticky left-0 bg-white z-20 border-r border-gray-100 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                                            Student Identity</th>
                                        <!-- U1-U8 -->
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U1</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U2</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U3</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U4</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U5</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U6</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U7</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U8</th>
                                        <!-- L1-L8 -->
                                        <th
                                            class="p-2 text-center text-indigo-600 bg-indigo-50/30 border-l border-gray-100">
                                            L1</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L2</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L3</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L4</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L5</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L6</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L7</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L8</th>
                                        <th
                                            class="p-3 text-center bg-purple-50/30 text-purple-600 border-l border-gray-100">
                                            Qty</th>
                                        <th class="p-3 text-center">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="td-list-measurements"
                                    class="text-xs font-mono text-gray-600 divide-y divide-gray-50">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. PATTERN BOYS GRID (Level 3) -->
                <div id="td-view-patterns-boys" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Boys Pattern Groups</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="td-list-patterns-boys">
                    </div>
                </div>

                <!-- 4. PATTERN GIRLS GRID (Level 3) -->
                <div id="td-view-patterns-girls" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Girls Pattern Groups</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="td-list-patterns-girls">
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- 3. USER MANAGEMENT -->
    <div id="td-level-3-pattern" class="hidden space-y-6 fade-in p-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="closePatternDetails()"
                class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </button>
            <div class="bg-white px-6 py-3 rounded-2xl shadow-sm border border-gray-100 flex-1">
                <h2 class="text-xl font-extrabold text-gray-800 flex items-center gap-3" id="td-p3-title">
                    Pattern Name
                    <span class="text-xs px-2 py-1 rounded bg-blue-50 text-blue-600 font-bold uppercase tracking-wider"
                        id="td-p3-count">0 Students</span>
                </h2>
                <p class="text-gray-400 text-xs font-bold uppercase tracking-wider mt-1" id="td-p3-meta">Consumption
                    Details</p>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50/50">
                        <tr class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100">
                            <th class="p-4 pl-6">Student</th>
                            <th class="p-4">Class</th>
                            <th class="p-4">Measurements (U/L)</th>
                            <th class="p-4">Qty</th>
                            <th class="p-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="td-p3-list" class="text-sm font-medium text-gray-600 divide-y divide-gray-50">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- 3. USER MANAGEMENT -->


    <!-- 4. ACCESS CODES -->
    <div id="view-access" class="hidden fade-in space-y-8 w-full">
        <div class="clay-card p-8">
            <h3 class="text-xl font-bold text-gray-700 mb-6">Generate Secure Link</h3>
            <div class="flex flex-col md:flex-row gap-6 items-end">
                <div class="w-full md:flex-1">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Target School</label>
                    <select id="access-school-select" class="clay-input"></select>
                </div>
                <div class="w-full md:w-48">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Role Type</label>
                    <select id="access-type" class="clay-input">
                        <option value="tailor">Tailor (Measurements)</option>
                        <option value="packing">Packing (Status)</option>
                    </select>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Expires In</label>
                    <select id="access-expiry" class="clay-input">
                        <option value="24">24 Hours</option>
                        <option value="48">48 Hours</option>
                        <option value="168">7 Days</option>
                    </select>
                </div>
                <button onclick="generateCode()"
                    class="w-full md:w-auto clay-btn clay-primary px-8 py-3 rounded-xl font-bold uppercase text-sm shadow-xl transition-transform active:scale-95">
                    Generate
                </button>
            </div>
        </div>

        <div class="clay-card p-8">
            <h3 class="text-lg font-bold text-gray-600 mb-4">Active & Inactive Codes</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm min-w-[600px]">
                    <thead>
                        <tr class="border-b border-white/50 text-gray-400 font-bold uppercase text-xs">
                            <th class="text-left pb-3">School</th>
                            <th class="text-left pb-3">Code</th>
                            <th class="text-left pb-3">Type</th>
                            <th class="text-center pb-3">Status</th>
                            <th class="text-right pb-3">Action</th>
                        </tr>
                    </thead>
                    <tbody id="access-code-list" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. SCHOOLS -->
    <div id="view-schools" class="hidden fade-in space-y-8 w-full">
        <div class="clay-card p-8">
            <div class="flex items-center justify-between mb-6 border-b border-white/50 pb-4">
                <div>
                    <div>
                        <!-- Header Removed: Handled globally -->
                    </div>
                </div>
                <!-- Repair Button -->
                <button onclick="fixDatabase()"
                    class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold text-xs uppercase shadow-sm flex items-center gap-2 transition-colors border border-blue-200">
                    <span class="text-lg">🔧</span> Repair Database
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm min-w-[800px]">
                    <thead class="bg-gray-50/50 text-gray-500 uppercase text-xs font-bold rounded-lg">
                        <tr>
                            <th class="p-3 text-left">School Name</th>
                            <th class="p-3 text-left w-48">Priority</th>
                            <th class="p-3 text-left w-48">Status</th>
                            <th class="p-3 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="school-list-body" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>


    <!-- 5.5 SCHOOL DETAILS VIEW -->
    <div id="view-school-details" class="hidden fade-in max-w-7xl mx-auto space-y-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <button onclick="switchTab('schools')"
                    class="text-xs font-bold text-gray-400 hover:text-blue-500 uppercase flex items-center gap-1 mb-2 group">
                    <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>
                    Back to Schools List
                </button>
                <h3 class="text-3xl font-extrabold text-gray-700" id="sd-school-name">-</h3>
                <p class="text-sm text-gray-400 font-bold uppercase tracking-wider" id="sd-school-meta">School Data
                    Explorer</p>
            </div>
            <!-- Export for this school? -->
            <div class="flex gap-2">
                <button onclick="downloadPDF()"
                    class="clay-btn px-4 py-2 text-xs font-bold text-rose-500 uppercase flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Export PDF
                </button>
                <button onclick="downloadExcel()"
                    class="clay-btn px-4 py-2 text-xs font-bold text-emerald-500 uppercase flex items-center gap-2">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="8" x2="8" y2="8"></line>
                        <line x1="16" y1="16" x2="8" y2="16"></line>
                        <line x1="10" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Export Excel
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-4 border-b border-gray-200/50 pb-1 overflow-x-auto">
            <button onclick="switchSchoolTab('students')" id="tab-sd-students"
                class="clay-btn text-sm text-gray-500 hover:text-gray-700">Students List</button>
            <button onclick="switchSchoolTab('measurements')" id="tab-sd-measurements"
                class="clay-btn text-sm text-gray-500 hover:text-gray-700">Measurements Data</button>
            <button onclick="switchSchoolTab('patterns')" id="tab-sd-patterns"
                class="clay-btn text-sm active bg-blue-50 text-blue-600 border-blue-100">Patterns &
                Consumption</button>
        </div>

        <!-- Tab Content: Students -->
        <div id="sd-view-students" class="hidden fade-in">
            <div class="clay-card p-6">
                <div class="overflow-x-auto h-[650px] custom-scrollbar">
                    <table class="w-full text-sm text-left whitespace-nowrap">
                        <thead
                            class="sticky top-0 bg-white z-10 text-xs font-extrabold text-gray-400 uppercase tracking-wider shadow-sm">
                            <tr>
                                <th class="p-4 border-b">Roll No</th>
                                <th class="p-4 border-b">Student Name</th>
                                <th class="p-4 border-b">Class / Section</th>
                                <th class="p-4 border-b">Gender</th>
                                <th class="p-4 border-b">Pattern Assigned</th>
                                <th class="p-4 border-b text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="sd-list-students" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
                <p class="text-right text-xs text-gray-400 mt-4 px-2" id="sd-count-students">0 records</p>
            </div>
        </div>

        <!-- Tab Content: Measurements -->
        <div id="sd-view-measurements" class="hidden fade-in">
            <div class="clay-card p-6">
                <p
                    class="text-xs text-sky-500 font-bold mb-4 uppercase tracking-wider bg-sky-50 inline-block px-3 py-1 rounded-lg">
                    Showing All Measurement Data</p>
                <div class="overflow-x-auto h-[650px] custom-scrollbar">
                    <table class="w-full text-sm text-left whitespace-nowrap font-mono selection:bg-purple-100">
                        <thead
                            class="sticky top-0 bg-white z-10 text-xs font-extrabold text-gray-400 uppercase tracking-wider shadow-sm">
                            <tr>
                                <th class="p-3 border-b bg-gray-50/80 sticky left-0 z-20">Name</th>
                                <th class="p-3 border-b text-center">Pattern</th>
                                <!-- Standard Unified Columns -->
                                <th class="p-3 border-b text-center text-orange-400">U1</th>
                                <th class="p-3 border-b text-center text-orange-400">U2</th>
                                <th class="p-3 border-b text-center text-orange-400">U3</th>
                                <th class="p-3 border-b text-center text-orange-400">U4</th>
                                <th class="p-3 border-b text-center text-orange-400">U5</th>
                                <th class="p-3 border-b text-center text-orange-400">U6</th>
                                <th class="p-3 border-b text-center text-indigo-400">L1</th>
                                <th class="p-3 border-b text-center text-indigo-400">L2</th>
                                <th class="p-3 border-b text-center text-indigo-400">L3</th>
                                <th class="p-3 border-b text-center text-indigo-400">L4</th>
                                <th class="p-3 border-b text-center text-indigo-400">L5</th>
                                <th class="p-3 border-b text-center text-purple-600 bg-purple-50">Items Qty</th>
                                <th class="p-3 border-b pl-6">Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="sd-list-measurements" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Patterns -->
        <div id="sd-view-patterns" class="hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="sd-list-patterns">
                <!-- Cards Injected Here -->
            </div>
            <p id="sd-no-patterns" class="hidden text-center text-gray-400 py-12 italic">No patterns found for this
                school.</p>
        </div>
    </div>

    <!-- 6. REPORTS CENTER -->
    <div id="view-reports" class="hidden fade-in w-full space-y-10">

        <div class="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-gray-100 pb-4">
            <div>
                <div>
                    <!-- Header Removed: Handled globally -->
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="cleanupLogs()"
                    class="clay-btn px-4 py-2 text-xs font-bold text-red-400 hover:text-red-500">🗑️ Cleanup
                    Logs</button>
            </div>
        </div>

        <!-- SECTION 1: DATA EXPORTS -->
        <div class="space-y-4">
            <h4 class="font-bold text-gray-600 uppercase text-xs tracking-wider ml-1">Data Exports</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- 1. Registered Schools (Primary) -->
                <div
                    class="clay-card p-6 flex flex-col items-center text-center hover:scale-[1.01] transition-transform relative overflow-hidden">
                    <div
                        class="absolute top-0 right-0 p-4 opacity-5 text-9xl font-bold text-indigo-500 pointer-events-none">
                        🏫</div>
                    <div
                        class="w-16 h-16 rounded-2xl bg-indigo-100 flex items-center justify-center text-3xl mb-4 relative z-10">
                        🏫</div>
                    <h4 class="font-bold text-gray-700 text-lg relative z-10">Registered Schools</h4>
                    <p class="text-xs text-gray-400 mt-2 mb-6 relative z-10">Download complete registry of all
                        schools.
                    </p>
                    <div class="flex gap-2 w-full mt-auto relative z-10">
                        <button onclick="downloadReport('schools_list', 'xls')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-indigo-600 hover:bg-indigo-50">CSV</button>
                        <button onclick="downloadReport('schools_list', 'pdf')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-red-500 hover:bg-red-50">PDF</button>
                    </div>
                </div>

                <!-- 2. Student Data -->
                <div
                    class="clay-card p-6 flex flex-col items-center text-center hover:scale-[1.01] transition-transform">
                    <div class="w-16 h-16 rounded-2xl bg-emerald-100 flex items-center justify-center text-3xl mb-4">
                        🎓
                    </div>
                    <h4 class="font-bold text-gray-700 text-lg">Student Data</h4>
                    <p class="text-xs text-gray-400 mt-2 mb-4">Export students for a specific school.</p>
                    <select id="rp-export-school-select" class="clay-input w-full text-xs mb-4">
                        <option value="">-- Select School --</option>
                    </select>
                    <div class="flex gap-2 w-full mt-auto">
                        <button onclick="downloadReport('school', 'xls')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-emerald-600 hover:bg-emerald-50">Excel</button>
                        <button onclick="downloadReport('school', 'pdf')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-red-500 hover:bg-red-50">PDF</button>
                    </div>
                </div>

                <!-- 3. User Registry -->
                <div
                    class="clay-card p-6 flex flex-col items-center text-center hover:scale-[1.01] transition-transform">
                    <div class="w-16 h-16 rounded-2xl bg-purple-100 flex items-center justify-center text-3xl mb-4">
                        👥
                    </div>
                    <h4 class="font-bold text-gray-700 text-lg">User Registry</h4>
                    <p class="text-xs text-gray-400 mt-2 mb-6">List of all system users and roles.</p>
                    <div class="flex gap-2 w-full mt-auto">
                        <button onclick="downloadReport('users', 'xls')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-purple-600 hover:bg-purple-50">Excel</button>
                        <button onclick="downloadReport('users', 'pdf')"
                            class="flex-1 clay-btn py-3 text-sm font-bold text-red-500 hover:bg-red-50">PDF</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: SYSTEM LOGS -->
        <div class="space-y-4">
            <h4 class="font-bold text-gray-600 uppercase text-xs tracking-wider ml-1">System Activity Logs</h4>

            <!-- AI Highlights -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="ai-insights-grid">
                <!-- JS Injected -->
            </div>

            <!-- Log Filters & Visuals -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Filters & Volume -->
                <div class="clay-card p-6 space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Filter Logs</label>
                        <div class="space-y-3">
                            <select id="rp-school-select" onchange="fetchReportLogs('overview')"
                                class="clay-input w-full">
                                <option value="">All Schools</option>
                            </select>
                            <input type="text" id="rp-user-search" onkeyup="debounceLogFetch()"
                                placeholder="Search User..." class="clay-input w-full">
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-100">
                        <h5 class="font-bold text-gray-600 mb-4 text-xs">Activity Volume</h5>
                        <div class="h-32 relative"><canvas id="chart-logs-volume"></canvas></div>
                    </div>
                    <div class="pt-4 border-t border-gray-100">
                        <h5 class="font-bold text-gray-600 mb-4 text-xs">Role Distribution</h5>
                        <div class="h-32 relative"><canvas id="chart-logs-role"></canvas></div>
                    </div>
                </div>

                <!-- Log Table -->
                <div class="clay-card p-0 lg:col-span-2 overflow-hidden flex flex-col h-[500px]">
                    <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                        <span class="font-bold text-gray-500 text-xs">Recent Events</span>
                        <button onclick="downloadLogsXls()"
                            class="text-green-500 hover:text-green-600 text-xs font-bold">Download CSV</button>
                    </div>
                    <div class="flex-1 overflow-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-white text-gray-400 font-bold sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="p-4">Time</th>
                                    <th class="p-4">User</th>
                                    <th class="p-4">Action</th>
                                    <th class="p-4">Details</th>
                                </tr>
                            </thead>
                            <tbody id="rp-school-table" class="divide-y divide-gray-50 text-gray-600 font-medium">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- 7. COMPLAINTS OVERHAUL -->
    <div id="view-complaints" class="hidden fade-in w-full space-y-8">

        <!-- A. Analytics Header & Hotspots -->
        <div class="grid grid-cols-1 md:grid-cols-6 gap-6">
            <!-- Basic Counts -->
            <div class="md:col-span-2 grid grid-cols-3 gap-4">
                <div class="clay-card p-4 flex flex-col justify-center items-center text-center">
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Total</p>
                    <p class="text-3xl font-extrabold text-gray-700 mt-1" id="c-stat-total">0</p>
                </div>
                <div
                    class="clay-card p-4 flex flex-col justify-center items-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-orange-400"></div>
                    <p class="text-[10px] text-orange-500 font-bold uppercase tracking-widest">Open</p>
                    <p class="text-3xl font-extrabold text-gray-700 mt-1" id="c-stat-open">0</p>
                </div>
                <div
                    class="clay-card p-4 flex flex-col justify-center items-center text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-1 h-full bg-emerald-400"></div>
                    <p class="text-[10px] text-emerald-500 font-bold uppercase tracking-widest">Done</p>
                    <p class="text-3xl font-extrabold text-gray-700 mt-1" id="c-stat-resolved">0</p>
                </div>
            </div>

            <!-- Insight Cards -->
            <div class="clay-card p-4 col-span-2 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-rose-400"></div>
                <p class="text-[10px] text-rose-500 font-bold uppercase tracking-widest mb-2">Needs Attention (Top
                    Pattern)</p>
                <h4 class="font-bold text-gray-800 truncate text-lg" id="c-top-pattern">-</h4>
                <p class="text-xs text-gray-400 font-medium" id="c-top-pattern-count">0 complaints</p>
            </div>
            <div class="clay-card p-4 col-span-2 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-blue-400"></div>
                <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mb-2">Common Issue</p>
                <h4 class="font-bold text-gray-800 truncate text-lg" id="c-top-issue">-</h4>
                <p class="text-xs text-gray-400 font-medium" id="c-top-issue-count">0 occurrences</p>
            </div>
        </div>

        <!-- B. Charts & Trends -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-96">
            <div class="clay-card p-6 flex flex-col">
                <h3 class="font-bold text-lg text-gray-600 mb-4">Top Defective Patterns</h3>
                <div class="flex-1 relative"><canvas id="chart-patterns"></canvas></div>
            </div>
            <div class="clay-card p-6 flex flex-col">
                <h3 class="font-bold text-lg text-gray-600 mb-4">Common Defect Types</h3>
                <div class="flex-1 relative"><canvas id="chart-issues"></canvas></div>
            </div>
        </div>

        <!-- C. Filters & Controls -->
        <div class="clay-card p-6 flex flex-col md:flex-row gap-4 items-end">
            <div class="w-full md:w-auto flex-1">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-2">Search School</label>
                <input type="text" id="c-filter-school" onkeyup="renderComplaintDash()"
                    placeholder="Type school name..." class="clay-input">
            </div>
            <div class="w-full md:w-48">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-2">Filter Pattern</label>
                <select id="c-filter-pattern" onchange="renderComplaintDash()" class="clay-input">
                    <option value="all">All Patterns</option>
                    <!-- Populated JS -->
                </select>
            </div>
            <div class="w-full md:w-32">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-2">Gender</label>
                <select id="c-filter-gender" onchange="renderComplaintDash()" class="clay-input">
                    <option value="all">All</option>
                    <option value="Male">Boys</option>
                    <option value="Female">Girls</option>
                </select>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadComplaintsPDF()"
                    class="clay-btn px-4 py-3 text-xs font-bold uppercase text-rose-500 flex items-center gap-2">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    PDF
                </button>
                <button onclick="downloadComplaintsExcel()"
                    class="clay-btn px-4 py-3 text-xs font-bold uppercase text-emerald-500 flex items-center gap-2">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="8" x2="8" y2="8"></line>
                        <line x1="16" y1="16" x2="8" y2="16"></line>
                        <line x1="10" y1="12" x2="3" y2="12"></line>
                    </svg>
                    Excel
                </button>
            </div>
        </div>

        <!-- D. Schools Grid (Grouped) -->
        <div>
            <h3 class="font-bold text-2xl text-gray-700 mb-6 px-2">School Tickets</h3>
            <div id="school-complaints-grid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Dynamic School Cards -->
            </div>
            <p id="c-no-data" class="hidden text-center text-gray-400 py-12 italic font-medium">No complaints match
                your filters.</p>
        </div>

    </div>

    <!-- 8. SETTINGS -->
    <div id="view-settings" class="hidden fade-in w-full max-w-4xl mx-auto">
        <div class="clay-card p-8">
            <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-3">
                <span class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                        </path>
                    </svg>
                </span>
                Notification Preferences
            </h3>

            <div class="flex items-center justify-between p-4 bg-gray-50/50 rounded-xl border border-gray-100">
                <div>
                    <h4 class="font-bold text-gray-800">Urgent Deadline Alerts</h4>
                    <p class="text-sm text-gray-500">Show popup & browser notifications when schools have deadlines
                        < 3 days away.</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="setting-notify" onchange="toggleNotificationSetting(this.checked)"
                        class="sr-only peer">
                    <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                    </div>
                </label>
            </div>
        </div>
    </div>

    </div><!-- End Vertical Enforcer -->

    <!-- 8. TICKET DETAIL MODAL -->
    <dialog id="ticketModal" class="bg-transparent z-50">
        <div class="fixed inset-0 bg-gray-500/30 backdrop-blur-sm flex items-center justify-center p-4">
            <div
                class="clay-card w-full max-w-5xl h-[85vh] flex flex-col animate-in zoom-in-95 duration-200 outline-none">
                <!-- Header -->
                <div class="p-6 border-b border-white/50 flex justify-between items-center rounded-t-2xl">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="tm-school-name">School Name</h3>
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-bold mt-1" id="tm-school-stats">5
                            Open Tickets</p>
                    </div>
                    <button onclick="document.getElementById('ticketModal').close()"
                        class="w-10 h-10 rounded-full clay-btn flex items-center justify-center text-gray-500 hover:text-red-500">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 bg-transparent" id="tm-list">
                    <!-- Ticket Cards Injected -->

                </div>
            </div>
        </div>
    </dialog>

    </main>

    <!-- SCHOOL REGISTRATION MODAL -->
    <div id="school-modal"
        class="fixed inset-0 bg-gray-500/30 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="clay-card w-full max-w-md p-8 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-6 border-b border-white/50 pb-4 text-gray-700">Register New School</h3>
            <form onsubmit="registerSchool(event)" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">School Name</label>
                    <input type="text" name="name" required placeholder="e.g. Galaxy High School" class="clay-input">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Admin Username</label>
                    <input type="text" name="username" required placeholder="admin_galaxy" class="clay-input">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Password</label>
                    <input type="password" name="password" required class="clay-input">
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="document.getElementById('school-modal').classList.add('hidden')"
                        class="px-6 py-2 text-sm font-bold text-gray-500 hover:text-gray-700">CANCEL</button>
                    <button type="submit"
                        class="clay-btn clay-primary px-6 py-2 text-sm font-bold rounded-lg shadow-lg">REGISTER
                        SCHOOL</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const API_BASE = '/api'; const token = sessionStorage.getItem('token'); if (!token) window.location.href = 'login.html';
        let globalStudents = [], globalSchools = [], globalPatterns = [], dynamicFilters = {}, sidebarOpen = false;
        function toggleSidebar() { sidebarOpen = !sidebarOpen; const s = document.getElementById('sidebar'), b = document.getElementById('sidebar-backdrop'); if (sidebarOpen) { s.classList.remove('-translate-x-[120%]'); b.classList.remove('hidden'); setTimeout(() => b.classList.remove('opacity-0'), 10); } else { s.classList.add('-translate-x-[120%]'); b.classList.add('opacity-0'); setTimeout(() => b.classList.add('hidden'), 300); } }
        const boysItems = [{ name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" }];
        const girlsItems = [{ name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" }, { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" }, { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" }, { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }];
        // Consolidated Item Definitions for Lookup
        const itemDefinitions = [...boysItems, ...girlsItems];

        // Format time ago helper
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        // === HELPER FUNCTIONS (Missing Fix) ===
        function getStatusColor(status, isPacked) {
            if (status) {
                const s = status.toLowerCase();
                if (s === 'processing') return 'bg-yellow-100 text-yellow-600';
                if (s === 'production') return 'bg-blue-100 text-blue-600';
                if (s === 'dispatch') return 'bg-indigo-100 text-indigo-600';
                if (s === 'delivered') return 'bg-emerald-100 text-emerald-600';
            }
            if (isPacked) return 'bg-emerald-100 text-emerald-600';
            return 'bg-gray-100 text-gray-500';
        }

        function getMeasurementsSafe(s) {
            if (!s.measurements) return {};
            if (typeof s.measurements === 'string') {
                try { return JSON.parse(s.measurements); } catch (e) { return {}; }
            }
            return s.measurements || {};
        }

        function getItemQuantitiesSafe(s) {
            const m = getMeasurementsSafe(s);
            const quantities = {};
            // Basic logic to count items based on non-empty measurements might be needed, 
            // OR if you have a specific 'quantities' field. 
            // Assuming based on previous context we infer it or it's just a placeholder.
            // For now, let's map known items from column presence if needed.
            // Actually, let's look at the usage: it iterates keys.
            // If the student object has a 'quantities' field (parsed), use it? 
            // Let's implement a simple version that checks if the measurement for a standard item exists.

            // Re-using the itemDefinitions logic if possible, or simplified:
            itemDefinitions.forEach(def => {
                // Check if ANY of the required columns for this item have data
                // This is a heuristic.
                const hasData = def.cols.some(c => m[c.toLowerCase()] && m[c.toLowerCase()].trim() !== '');
                if (hasData) {
                    quantities[def.name] = 1; // Simple count
                }
            });
            return quantities;
        }

        async function init() {
            await Promise.all([fetchStats(), fetchAllStudents(), fetchSchoolsForSelect(), fetchGlobalPatterns()]);
            renderTailoringData();
            renderCharts();
            populateDynamicFilters();
            // Smart Insights
            // renderLeaderboard(); // Removed: Function definition missing
            fetchActivityLogs();
            if (window.renderUrgentDeadlines) renderUrgentDeadlines();
        }
        function switchTab(clickedId) {
            // Map Button IDs to View IDs (Corrected to match HTML)
            const map = {
                'overview': 'view-overview',
                'schools': 'view-schools',
                'data': 'view-data',
                'tailoring': 'view-data',
                'users': 'view-users',
                'access': 'view-access',
                'complaints': 'view-complaints',
                'reports': 'view-reports',
                'settings': 'view-settings'
            };

            // Allow calling with either short ID or full ID (fallback)
            const viewId = map[clickedId] || clickedId;

            // Hide all views (including School Details)
            const views = [
                'view-overview',
                'view-schools',
                'view-data',
                'view-users',
                'view-access',
                'view-complaints',
                'view-reports',
                'view-settings',
                'view-school-details' // Ensure this is hidden when switching main tabs
            ];

            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Show selected
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.remove('hidden');
            } else {
                console.warn(`View ID '${viewId}' not found in HTML.`);
            }

            const titles = {
                'view-overview': 'Overview',
                'view-schools': 'Schools',
                'view-data': 'Tailoring Data',
                'view-users': 'User Management',
                'view-access': 'Access Codes',
                'view-complaints': 'Complaints',
                'view-reports': 'Reports',
                'view-settings': 'Settings'
            };

            const subtitles = {
                'view-overview': 'Manage Planet Solutions tailors & operations',
                'view-schools': 'Manage priority and production status for each school',
                'view-data': 'Select a school to view details, measurements, and patterns',
                'view-users': 'Controls who can access the system and manage schools',
                'view-access': 'Generate and manage access codes for schools',
                'view-complaints': 'Track and resolve school complaints and issues',
                'view-reports': 'Download data and view system activity logs',
                'view-settings': 'Configure system preferences and notifications'
            };

            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.innerText = titles[viewId] || 'Overview';

            const subTitleEl = document.getElementById('page-subtitle');
            if (subTitleEl) subTitleEl.innerText = subtitles[viewId] || 'Manage Planet Solutions tailors & operations';

            if (sidebarOpen && window.innerWidth < 768) toggleSidebar();

            // Update Navigation Highlights
            // Update Navigation Highlights
            document.querySelectorAll('.nav-item').forEach(el => {
                // Remove all possible active variations to be safe
                el.classList.remove('!bg-blue-50', '!text-blue-600', '!border-r-4', '!border-blue-600', 'active', '!shadow-inner', 'bg-blue-50', 'text-blue-600', 'border-r-4', 'border-blue-600', 'shadow-inner');
                el.classList.add('text-gray-600');
            });

            // Map viewId back to navId or use clickedId logic
            let navSuffix = clickedId;
            if (viewId === 'view-data') navSuffix = 'data';
            if (viewId === 'view-schools') navSuffix = 'schools';
            if (viewId === 'view-users') navSuffix = 'users'; // Explicit check

            const navId = 'nav-' + navSuffix;
            const activeNav = document.getElementById(navId);
            if (activeNav) {
                activeNav.classList.remove('text-gray-600');
                // Force styles with !important equivalents (Tailwind) and add pressed shadow
                activeNav.classList.add('!bg-blue-50', '!text-blue-600', '!border-r-4', '!border-blue-600', '!shadow-inner');
            }

            // Scroll to Top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Auto-Fetch Logic
            if (viewId === 'view-schools') fetchSchoolsManage();
            if (viewId === 'view-users') { fetchSchoolsForSelect(); fetchUsers(); }
            if (viewId === 'view-access') fetchAccessCodes();
            if (viewId === 'view-complaints') fetchComplaints();
            if (viewId === 'view-reports') {
                fetchSchoolsManage().then(() => { if (window.initReports) initReports(); });
            }
        }
        function animateValue(obj, start, end, duration) { let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerText = Math.floor(progress * (end - start) + start); if (progress < 1) { window.requestAnimationFrame(step); } }; window.requestAnimationFrame(step); }
        async function fetchStats() { try { const r = await fetch(`${API_BASE}/data/stats`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); animateValue(document.getElementById('stat-students'), parseInt(document.getElementById('stat-students').innerText) || 0, d.students || 0, 1500); animateValue(document.getElementById('stat-schools'), parseInt(document.getElementById('stat-schools').innerText) || 0, d.schools || 0, 1500); animateValue(document.getElementById('stat-packed'), parseInt(document.getElementById('stat-packed').innerText) || 0, d.packed || 0, 1500); animateValue(document.getElementById('stat-pending'), parseInt(document.getElementById('stat-pending').innerText) || 0, d.pending || 0, 1500); } catch (e) { console.error("Stats Error", e) } }
        async function fetchAllStudents() {
            try {
                const r = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();

                // Deduplicate by ID
                const uniqueStudents = new Map();
                if (Array.isArray(d)) {
                    d.forEach(s => {
                        if (!uniqueStudents.has(s.id)) {
                            uniqueStudents.set(s.id, s);
                        } else {
                            // Optional: Merge data if needed, but for now take first
                        }
                    });
                    globalStudents = Array.from(uniqueStudents.values());
                } else {
                    globalStudents = [];
                }
            } catch (e) { console.error("Student Fetch Error", e); globalStudents = []; }
        }
        async function fetchGlobalPatterns() {
            try {
                const r = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();
                globalPatterns = Array.isArray(d) ? d : [];

                const filterEl = document.getElementById('filter-pattern');
                if (filterEl) {
                    filterEl.innerHTML = '<option value="all">All Patterns</option>' + globalPatterns.map(p => `<option value="${p.id}">${p.name} (${p.school_name})</option>`).join('');
                }
            } catch (e) { console.error("Patterns Error", e); globalPatterns = []; }
        }
        async function fetchSchoolsForSelect() { try { const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); globalSchools = Array.isArray(d) ? d : []; if (globalSchools.length > 0) { const o = globalSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); document.getElementById('school-select').innerHTML = o; document.getElementById('access-school-select').innerHTML = o; } } catch (e) { console.error("Schools Error", e); globalSchools = []; } }

        async function fetchUsers() { try { const r = await fetch(`${API_BASE}/data/users`, { headers: { 'Authorization': `Bearer ${token}` } }); const u = await r.json(); if (!Array.isArray(u)) return; document.getElementById('user-list-body').innerHTML = u.map(x => `<tr class="hover:bg-gray-50/50 group border-b border-gray-50"><td class="p-4 font-bold text-gray-700">${x.username}</td><td class="p-4"><span class="px-3 py-1 rounded-full text-xs bg-gray-100/80 uppercase font-bold text-gray-500 shadow-inner">${x.role}</span></td><td class="p-4 text-gray-500">${x.school_name || '-'}</td><td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold shadow-sm ${x.is_active !== false ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${x.is_active !== false ? 'Active' : 'Disabled'}</span></td><td class="p-4 text-right text-xs"><button onclick="toggleUserStatus(${x.id},${!(x.is_active !== false)},'${x.username}')" class="opacity-0 group-hover:opacity-100 transition-opacity px-4 py-2 rounded-lg font-bold shadow-sm ${x.is_active !== false ? 'text-red-500 bg-red-50 hover:bg-red-100' : 'text-green-500 bg-green-50 hover:bg-green-100'}">${x.is_active !== false ? 'Disable' : 'Enable'}</button></td></tr>`).join(''); } catch (e) { console.error(e) } }
        async function fetchAccessCodes() { try { const r = await fetch(`${API_BASE}/data/access_codes`, { headers: { 'Authorization': `Bearer ${token}` } }); const c = await r.json(); if (Array.isArray(c)) document.getElementById('access-code-list').innerHTML = c.map(x => `<tr class="border-b border-gray-50 ${x.is_active ? '' : 'opacity-40'}"><td class="py-4 font-bold text-gray-600">${x.school_name}</td><td class="py-4 font-mono text-rose-500 font-bold tracking-wider">${x.code}</td><td class="py-4 capitalize text-gray-500 font-medium">${x.type}</td><td class="py-4 text-center"><span class="${x.is_active ? 'text-green-500' : 'text-red-400 animate-pulse'} font-extrabold text-xs uppercase tracking-wider">${x.is_active ? 'Active' : 'Revoked'}</span></td><td class="py-4 text-right space-x-2">${x.is_active ? `<button onclick="toggleCode(${x.id},false)" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg text-xs font-bold transition-colors">REVOKE</button>` : `<button onclick="toggleCode(${x.id},true)" class="text-green-500 hover:bg-green-50 px-3 py-1 rounded-lg text-xs font-bold transition-colors">ACTIVATE</button>`}</td></tr>`).join(''); } catch (e) { console.error(e) } }
        async function fetchSchoolsManage() {
            try {
                const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();
                document.getElementById('school-list-body').innerHTML = Array.isArray(d) ? d.map(s => `
                    <tr class="hover:bg-gray-50/50 group border-b border-gray-50 ${s.priority === 'Urgent' ? 'bg-red-50/30' : ''}">
                        <td class="p-4 font-bold text-gray-700">
                             <div class="flex flex-col">
                                <span class="flex items-center gap-2">
                                    ${s.name}
                                    ${s.priority === 'Urgent' ? '<span class="animate-pulse text-xl" title="Urgent Production">🔥</span>' : ''}
                                    ${s.priority === 'High' ? '<span class="text-lg" title="High Priority">⚠️</span>' : ''}
                                </span>
                                <span class="text-[10px] text-gray-400 font-mono mt-1" id="timer-${s.id}">Calculate...</span>
                             </div>
                        </td>
                        <td class="p-4">
                             <div class="flex flex-col gap-2">
                                <select onchange="updateSchoolMeta(${s.id},'priority',this.value); if(this.value==='Urgent') alert('⚠️ Marked as URGENT! Production team will be notified.'); fetchSchoolsManage();" 
                                    class="clay-input h-8 py-1 px-2 text-xs font-bold uppercase ${s.priority === 'Urgent' ? 'text-red-600 bg-red-100 border-red-200' : (s.priority === 'High' ? 'text-orange-500' : 'text-gray-500')}">
                                    <option value="Normal" ${s.priority === 'Normal' ? 'selected' : ''}>Normal Priority</option>
                                    <option value="High" ${s.priority === 'High' ? 'selected' : ''}>High Priority</option>
                                    <option value="Urgent" ${s.priority === 'Urgent' ? 'selected' : ''}>Urgent (Rush)</option>
                                    <option value="Low" ${s.priority === 'Low' ? 'selected' : ''}>Low Priority</option>
                                </select>
                                <div class="flex gap-2 items-center">
                                    <div class="flex flex-col">
                                        <label class="text-[9px] uppercase font-bold text-gray-400">Start</label>
                                        <input type="date" value="${s.start_date ? s.start_date.split('T')[0] : ''}" onchange="updateSchoolMeta(${s.id}, 'start_date', this.value)" class="clay-input h-6 text-[10px] w-24">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[9px] uppercase font-bold text-gray-400">Deadline</label>
                                        <input type="date" value="${s.deadline ? s.deadline.split('T')[0] : ''}" onchange="updateSchoolMeta(${s.id}, 'deadline', this.value)" class="clay-input h-6 text-[10px] w-24">
                                    </div>
                                </div>
                             </div>
                        </td>
                        <td class="p-4 flex items-center gap-2">
                            <select id="status-select-${s.id}" class="clay-input h-8 py-1 px-2 text-xs font-bold uppercase w-full">
                                <option value="Measurements" ${s.status === 'Measurements' ? 'selected' : ''}>Measurements</option>
                                <option value="Processing" ${s.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                <option value="Production" ${s.status === 'Production' ? 'selected' : ''}>Production</option>
                                <option value="Dispatch" ${s.status === 'Dispatch' ? 'selected' : ''}>Dispatch</option>
                                <option value="Delivered" ${s.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                            <button onclick="updateSchoolStatusManual(${s.id})" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-lg shadow-sm transition-colors" title="Update Status">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </td>
                        <td class="p-4 text-right">
                             <div class="flex gap-2 justify-end">
                                <button onclick="viewSchoolData('${s.name}', ${s.id})" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">STUDENTS</button>
                                <button onclick="viewSchoolDetails('${s.name}', ${s.id})" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">DETAILS</button>
                                <button onclick="deleteSchool(${s.id}, '${s.name}')" class="text-xs bg-red-50 hover:bg-red-100 text-red-600 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm" title="Delete School">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                             </div>
                        </td>
                    </tr>`).join('') : '';

                // Trigger Countdowns
                if (Array.isArray(d)) {
                    d.forEach(s => updateTimerUI(s.id, s.deadline));
                    renderUrgentDeadlines(); // Update Main Dashboard Widget too
                }
            } catch (e) { console.error(e) }
        }

        function updateTimerUI(id, deadline) {
            const el = document.getElementById(`timer-${id}`);
            if (!el) return;
            if (!deadline) { el.innerText = "No deadline set"; return; }

            const diff = new Date(deadline) - new Date();
            if (diff < 0) {
                el.innerText = "⚠️ Overdue!";
                el.className = "text-[10px] text-red-600 font-bold mt-1 animate-pulse";
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            el.innerText = `⏳ ${days} ${days === 1 ? 'day' : 'days'} remaining`;
            if (days <= 3) el.className = "text-[10px] text-orange-600 font-bold mt-1";
            else el.className = "text-[10px] text-emerald-600 font-medium mt-1";
        }

        function renderUrgentDeadlines() {
            const grid = document.getElementById('urgent-deadlines-grid');
            if (!grid || !globalSchools) return;

            // Filter schools with deadlines
            const urgent = globalSchools
                .filter(s => s.deadline)
                .map(s => ({
                    ...s,
                    diff: new Date(s.deadline) - new Date(),
                    days: Math.floor((new Date(s.deadline) - new Date()) / (1000 * 60 * 60 * 24))
                }))
                .filter(s => s.diff > -86400000 * 30) // Only show recent overdue or future
                .sort((a, b) => a.diff - b.diff) // Most urgent first
                .slice(0, 3); // Top 3

            if (urgent.length === 0) {
                grid.innerHTML = `<div class="col-span-full clay-card p-6 flex items-center justify-center text-gray-400 italic">No upcoming deadlines found. Set a deadline in School Management.</div>`;
                return;
            }

            grid.innerHTML = urgent.map(s => {
                const isOverdue = s.diff < 0;
                const statusColor = isOverdue ? 'bg-red-50 text-red-600 border-red-200' : (s.days <= 7 ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-green-50 text-green-600 border-green-200');

                return `
                <div class="clay-card p-5 border ${isOverdue ? 'border-red-300 shadow-red-100' : 'border-white'} relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-gray-700 text-lg truncate">${s.name}</div>
                        ${s.priority === 'Urgent' ? '<span class="animate-pulse text-lg" title="Urgent">🔥</span>' : ''}
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Time Remaining</span>
                            <span class="text-xl font-black ${isOverdue ? 'text-red-500' : 'text-gray-700'}">
                                ${isOverdue ? 'OVERDUE' : s.days + ' Days'}
                            </span>
                        </div>
                         <div class="flex flex-col text-right">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Deadline</span>
                            <span class="text-sm font-bold text-gray-600">${new Date(s.deadline).toLocaleDateString()}</span>
                        </div>
                    </div>
                    
                     <!-- Progress Bar Visual -->
                     <div class="w-full h-1.5 bg-gray-100 rounded-full mt-4 overflow-hidden">
                        <div class="h-full ${isOverdue ? 'bg-red-500' : (s.days <= 7 ? 'bg-orange-400' : 'bg-emerald-400')}" style="width: ${Math.max(5, Math.min(100, 100 - (s.days * 2)))}%"></div>
                     </div>
                </div>
                `;
            }).join('');

            // Notification Logic (Simple Toast) for Urgent items
            const veryUrgent = urgent.filter(s => s.days <= 3 && s.days >= 0);
            if (veryUrgent.length > 0 && !window.hasNotifiedUrgent) {
                // Check setting: default to valid (true) if null
                const enabled = localStorage.getItem('notification_enabled') !== 'false';
                if (enabled) {
                    window.hasNotifiedUrgent = true;
                    const msg = `⚠️ Action Required: ${veryUrgent.length} school(s) have deadlines approaching in < 3 days.`;
                    showToast(msg, 'error');

                    // Native Browser Notification
                    if (Notification.permission === 'granted') {
                        new Notification("Planet Solutions Urgent", { body: `Action Required: ${veryUrgent.length} school(s) are near deadline!`, icon: 'https://cdn-icons-png.flaticon.com/512/564/564619.png' });
                    }
                }
            }
        }

        // Initialize Toggle
        document.addEventListener("DOMContentLoaded", () => {
            const setting = document.getElementById('setting-notify');
            if (setting) setting.checked = localStorage.getItem('notification_enabled') !== 'false';
        });

        function toggleNotificationSetting(val) {
            localStorage.setItem('notification_enabled', val);

            if (val && Notification.permission !== 'granted') {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') {
                        showToast("Browser Notifications Enabled!", 'success');
                        new Notification("Planet Solutions", { body: "Browser notifications are now active." });
                    } else {
                        showToast("Browser Notifications Blocked. Check site settings.", 'error');
                    }
                });
            } else {
                showToast(`Notifications ${val ? 'Enabled' : 'Disabled'}`, 'info');
            }
        }

        function showToast(msg, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = "fixed top-4 right-4 z-[9999] flex flex-col gap-3 pointer-events-none";
                document.body.appendChild(container); // Append to body, not inside a hidden view
            }

            const el = document.createElement('div');
            // Colors based on type
            const colors = type === 'error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-200';
            const icon = type === 'error' ? '🔥' : 'ℹ️';

            el.className = `clay-card p-4 rounded-xl shadow-2xl border ${colors} pointer-events-auto flex items-center gap-3 animate-in slide-in-from-right duration-300 max-w-sm`;
            el.innerHTML = `
                <span class="text-xl">${icon}</span>
                <p class="text-sm font-bold">${msg}</p>
                <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">✕</button>
            `;

            container.appendChild(el);
            // Auto remove after 6s
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => el.remove(), 500);
            }, 6000);
        }


        async function updateSchoolMeta(id, f, v) {
            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ [f]: v })
                });
                if (!r.ok) throw new Error("Update failed");
                if (typeof fetchSchoolsManage === 'function') fetchSchoolsManage();
            } catch (e) {
                console.error(e);
                alert("Failed to save changes. Please try again.");
            }
        }

        async function deleteSchool(id, name) {
            if (!confirm(`⚠️ DANGER ZONE ⚠️\n\nAre you sure you want to PERMANENTLY DELETE "${name}"?\n\nThis will remove:\n- The School Account\n- All ${name} Students\n- Measurements, Orders, Patterns\n\nThis action cannot be undone.`)) return;

            const verify = prompt(`To confirm deletion, type "DELETE" below:`);
            if (verify !== 'DELETE') return alert("Deletion Cancelled.");

            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const res = await r.json();
                if (r.ok) {
                    alert('✅ ' + res.message);
                    fetchSchoolsManage(); // Refresh List
                    fetchStats(); // Refresh Stats
                    fetchAllStudents(); // Refresh Data
                    // If current view is this school, go back
                    if (tdCurrentSchoolId === id) switchTab('schools');
                } else {
                    alert('❌ Failed: ' + (res.error || 'Unknown Error'));
                }
            } catch (e) { alert('Example Error: ' + e.message); }
        }

        async function updateSchoolStatusManual(id) {
            const val = document.getElementById(`status-select-${id}`).value;
            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status: val })
                });

                if (r.ok) {
                    const res = await r.json();
                    const debugInfo = res.debug ? `\n(Affected: ${res.debug.affected}, Changed: ${res.debug.changed})` : '';
                    alert("✅ Status Updated Successfully!" + debugInfo);
                } else {
                    const errText = await r.text();
                    try {
                        const errJson = JSON.parse(errText);
                        alert("❌ Update Failed: " + (errJson.error || errText));
                    } catch (e) {
                        alert("❌ Update Failed: " + errText);
                    }
                }
            } catch (e) { alert("Error: " + e.message); }
        }

        // SCHOOL DETAILS LOGIC
        let currentSchoolDetails = { id: null, name: null };

        // NEW: Link from Schools List to Data View
        async function viewSchoolData(schoolName, schoolId) {
            switchTab('data');
            // Ensure options populated
            populateDynamicFilters();

            // If ID provided, use new Detail View directly
            if (schoolId) {
                openSchoolDetails(schoolId);
            } else {
                // Fallback for name-only (Legacy support, try to find ID)
                const s = globalSchools.find(x => x.name === schoolName);
                if (s) openSchoolDetails(s.id);
                else {
                    const fs = document.getElementById('filter-school');
                    if (fs) fs.value = schoolName;
                    renderTailoringData();
                }
            }
        }

        // MODIFIED: School Details now focuses on Settings/Patterns
        async function viewSchoolDetails(schoolName, schoolId) {
            switchTab('school-details');
            currentSchoolDetails = { name: schoolName, id: schoolId };
            document.getElementById('sd-school-name').innerText = schoolName;

            // Ensure data is loaded
            if (globalStudents.length === 0) await fetchAllStudents();
            if (globalPatterns.length === 0) await fetchGlobalPatterns();

            // Default to students
            switchSchoolTab('students');
            renderSchoolDetails();
        }

        function switchSchoolTab(t) {
            const tabs = ['students', 'measurements', 'patterns'];
            tabs.forEach(tab => {
                const view = document.getElementById(`sd-view-${tab}`);
                const btn = document.getElementById(`tab-sd-${tab}`);
                if (view) view.classList.add('hidden');
                if (btn) btn.className = "clay-btn text-sm text-gray-500 hover:text-gray-700";
            });

            const v = document.getElementById(`sd-view-${t}`);
            const b = document.getElementById(`tab-sd-${t}`);
            if (v) v.classList.remove('hidden');
            if (b) b.className = "clay-btn text-sm active bg-blue-50 text-blue-600 border-blue-100";
        }

        function renderSchoolDetails() {
            const sName = currentSchoolDetails.name;
            const students = globalStudents.filter(s => s.school_name === sName);
            const patterns = globalPatterns.filter(p => p.school_name === sName);

            // 1. Render Students List
            document.getElementById('sd-count-students').innerText = `${students.length} records`;
            document.getElementById('sd-list-students').innerHTML = students.map(s => `
                    <tr class="hover:bg-gray-50 group transition-colors">
                        <td class="p-4 font-mono text-xs font-bold text-gray-500">${s.roll_no || '-'}</td>
                        <td class="p-4 font-bold text-gray-700">${s.name}</td>
                        <td class="p-4 text-xs font-bold text-gray-500">${s.class || ''} ${s.section || ''}</td>
                        <td class="p-4 text-xs font-bold text-gray-500 opacity-70">${s.gender || '-'}</td>
                         <td class="p-4 text-xs font-mono text-blue-500 font-bold">${s.pattern_name || '-'}</td>
                        <td class="p-4 text-center">
                             <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wide ${getStatusColor(s.order_status, s.is_packed)}">
                                ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                             </span>
                        </td>
                    </tr>
                `).join('');

            // 2. Render Measurements (Detailed)
            document.getElementById('sd-list-measurements').innerHTML = students.map(s => {
                const m = getMeasurementsSafe(s);
                const iq = getItemQuantitiesSafe(s);
                const qtyStr = Object.entries(iq).map(([k, v]) => `${k}: ${v}`).join(', ');

                return `
                    <tr class="hover:bg-gray-50 group border-b border-gray-50">
                        <td class="p-3 font-bold text-gray-700 bg-white sticky left-0 shadow-sm">${s.name}</td>
                        <td class="p-3 text-center text-xs text-blue-500 font-bold">${s.pattern_name || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u1 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u2 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u3 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u4 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u5 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u6 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l1 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l2 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l3 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l4 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l5 || '-'}</td>
                        <td class="p-3 text-xs text-purple-600 font-bold bg-purple-50/50 max-w-[200px] truncate" title="${qtyStr}">${qtyStr || '-'}</td>
                        <td class="p-3 text-xs text-gray-400 italic pl-6 max-w-[150px] truncate" title="${m.remarks || ''}">${m.remarks || '-'}</td>
                    </tr>`;
            }).join('');

            // 3. Render Patterns
            if (patterns.length === 0) {
                document.getElementById('sd-no-patterns').classList.remove('hidden');
                document.getElementById('sd-list-patterns').innerHTML = '';
            } else {
                document.getElementById('sd-no-patterns').classList.add('hidden');
                document.getElementById('sd-list-patterns').innerHTML = patterns.map(p => `
                        <div class="clay-card p-6 flex flex-col justify-between hover:scale-[1.02] transition-transform">
                            <div>
                                <h4 class="font-bold text-lg text-gray-700 mb-2">${p.name}</h4>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-4">Consumption: <span class="text-blue-500 text-lg">${p.consumption}m</span></p>
                                <div class="bg-gray-50 p-3 rounded-xl mb-4">
                                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Cloth Details</p>
                                    <p class="text-xs text-gray-600 font-medium line-clamp-2">${p.cloth_details || 'No details provided.'}</p>
                                </div>
                            </div>
                            <button onclick="window.open('pattern_view.html', '_blank')" class="text-xs font-bold text-center w-full py-3 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors uppercase tracking-wider">
                                Manage in Editor
                            </button>
                        </div>
                    `).join('');
            }
        }
        function populateDynamicFilters() {
            // Get unique values from Global Students
            const c = [...new Set(globalStudents.map(s => s.class).filter(Boolean))].sort();
            const se = [...new Set(globalStudents.map(s => s.section).filter(Boolean))].sort();

            // Populate Class Filter (New ID: td-filter-class)
            const classSelect = document.getElementById('td-filter-class');
            if (classSelect) {
                const current = classSelect.value;
                classSelect.innerHTML = '<option value="all">Class</option>' + c.map(x => `<option value="${x}">${x}</option>`).join('');
                if (c.includes(current)) classSelect.value = current;
            }

            // Populate Section Filter (New ID: td-filter-section)
            const sectionSelect = document.getElementById('td-filter-section');
            if (sectionSelect) {
                const current = sectionSelect.value;
                sectionSelect.innerHTML = '<option value="all">Section</option>' + se.map(x => `<option value="${x}">${x}</option>`).join('');
                if (se.includes(current)) sectionSelect.value = current;
            }

            // Populate School Filter (if exists in sidebar or elsewhere)
            const schoolSelect = document.getElementById('filter-school');
            if (schoolSelect) {
                const schools = globalSchools.length > 0 ? globalSchools.map(s => s.name).sort() : [...new Set(globalStudents.map(s => s.school_name).filter(Boolean))].sort();
                schoolSelect.innerHTML = '<option value="all">All Schools</option>' + schools.map(s => `<option value="${s.replace(/"/g, '&quot;')}">${s}</option>`).join('');
            }
        }
        // === NEW TAILORING DATA LOGIC (School-Centric) ===
        let tdCurrentSchoolId = null;
        let tdCurrentTab = 'students';

        // HELPER: Reset all visibility to prevent "leaking" views
        function resetTdViews() {
            const views = [
                'td-level-1',
                'td-level-2',
                'td-category-grid',
                'td-view-students',
                'td-view-measurements',
                'td-view-patterns-boys',
                'td-view-patterns-girls'
            ];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        function renderTailoringData() {
            resetTdViews();
            document.getElementById('td-level-1').classList.remove('hidden');

            const grid = document.getElementById('td-school-grid');
            grid.innerHTML = globalSchools.map(s => {
                // Calc stats - Use Name for safer matching if IDs are ambiguous
                const schoolStudents = globalStudents.filter(st => st.school_name === s.name);
                const count = schoolStudents.length;
                const takingMeas = schoolStudents.filter(st => st.measurements && Object.keys(st.measurements).length > 0).length; // Rough check

                return `
                     <div onclick="openSchoolDetails(${s.id})" class="clay-card p-6 flex flex-col cursor-pointer hover:scale-[1.03] transition-transform group">
                         <div class="flex justify-between items-start mb-6">
                              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-extrabold text-2xl shadow-lg shadow-blue-200">
                                  ${s.name.charAt(0)}
                              </div>
                              <span class="px-3 py-1 rounded-lg bg-gray-50 text-gray-400 text-[10px] font-bold uppercase tracking-wider group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">View Data</span>
                         </div>
                         <h3 class="text-xl font-bold text-gray-800 mb-1 line-clamp-1" title="${s.name}">${s.name}</h3>
                         <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">${s.priority} Priority</p>
                         
                         <div class="mt-auto grid grid-cols-2 gap-4">
                              <div class="bg-gray-50 rounded-xl p-3">
                                  <p class="text-[10px] text-gray-400 uppercase font-bold">Students</p>
                                  <p class="text-lg font-extrabold text-gray-700">${count}</p>
                              </div>
                              <div class="bg-gray-50 rounded-xl p-3">
                                  <p class="text-[10px] text-gray-400 uppercase font-bold">Meas. Taken</p>
                                  <p class="text-lg font-extrabold text-emerald-500">${takingMeas}</p>
                              </div>
                         </div>
                     </div>
                     `;
            }).join('');
        }

        async function openSchoolDetails(id) {
            if (globalStudents.length === 0) await fetchAllStudents();

            tdCurrentSchoolId = id;
            const s = globalSchools.find(x => x.id == id);
            if (!s) return;

            resetTdViews();
            document.getElementById('td-level-2').classList.remove('hidden');
            document.getElementById('td-category-grid').classList.remove('hidden');

            document.getElementById('td-school-name').innerText = s.name;
            document.getElementById('td-school-badge').innerText = s.status || 'Pending';
            document.getElementById('td-school-badge').className = `px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${getStatusColor(s.status, false)}`;

            // Reset Filters & Populate Counts - Use School Name match
            const schoolStudents = globalStudents.filter(st => st.school_name === s.name);
            document.getElementById('td-cat-students-count').innerText = `${schoolStudents.length} Students`;

            // Pattern Counts
            const boysPatterns = new Set(schoolStudents.filter(s => s.gender === 'Male').map(s => s.pattern_name || 'Unassigned')).size;
            const girlsPatterns = new Set(schoolStudents.filter(s => s.gender === 'Female').map(s => s.pattern_name || 'Unassigned')).size;

            document.getElementById('td-cat-boys-count').innerText = `${boysPatterns} Pattern Groups`;
            document.getElementById('td-cat-girls-count').innerText = `${girlsPatterns} Pattern Groups`;

            const classes = [...new Set(schoolStudents.map(st => st.class).filter(Boolean))].sort();
            const sections = [...new Set(schoolStudents.map(st => st.section).filter(Boolean))].sort();
            const genders = [...new Set(schoolStudents.map(st => st.gender).filter(Boolean))].sort();

            document.getElementById('td-filter-class').innerHTML = '<option value="all">Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('td-filter-section').innerHTML = '<option value="all">Section</option>' + sections.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function closeSchoolDetails() {
            tdCurrentSchoolId = null;
            renderTailoringData(); // Re-render grid to update stats if changed (though unlikely here)
        }

        // Level 2 -> Level 3 Transition
        function openLevel3(category) {
            resetTdViews();
            document.getElementById('td-level-2').classList.remove('hidden'); // Header remains visible
            const view = document.getElementById(`td-view-${category}`);
            if (view) {
                view.classList.remove('hidden');
                tdCurrentTab = category; // Maintain state for filters
                renderTdCurrentTab();
            }
        }

        function closeLevel3() {
            document.querySelectorAll('div[id^="td-view-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('td-category-grid').classList.remove('hidden');
            tdCurrentTab = null;
        }

        // Replaces switchTdTab for the new flow
        function switchTdTab(tab) {
            // Legacy support or direct link if needed, now directs to openLevel3
            openLevel3(tab);
        }
        // Helper to parse range queries (e.g. "1-5", "A-C")
        function parseRange(query) {
            query = query.toUpperCase().trim();
            if (!query) return null;

            // Numeric Range: "1-5"
            // Start of string, digit, dash, digit, end of string (simple)
            const numRange = query.match(/^(\d+)-(\d+)$/);
            if (numRange) {
                const start = parseInt(numRange[1]);
                const end = parseInt(numRange[2]);
                if (!isNaN(start) && !isNaN(end)) {
                    const res = [];
                    for (let i = Math.min(start, end); i <= Math.max(start, end); i++) res.push(String(i));
                    return res;
                }
            }

            // Alpha Range: "A-C"
            const charRange = query.match(/^([A-Z])-([A-Z])$/);
            if (charRange) {
                const start = charRange[1].charCodeAt(0);
                const end = charRange[2].charCodeAt(0);
                const res = [];
                for (let i = Math.min(start, end); i <= Math.max(start, end); i++) res.push(String.fromCharCode(i));
                return res;
            }

            return null; // Not a range
        }

        function renderTdCurrentTab() {
            if (!tdCurrentSchoolId) return;

            // 1. Get Base Data
            // 1. Get Base Data (Use Name for consistency with other fixes)
            const schoolName = document.getElementById('td-school-name').innerText;
            let data = globalStudents.filter(st => st.school_name === schoolName);

            // 2. Apply Filters
            const cls = document.getElementById('td-filter-class').value;
            const sec = document.getElementById('td-filter-section').value;
            const gender = document.getElementById('td-filter-gender').value;
            const search = document.getElementById('td-filter-search').value.trim();

            if (cls !== 'all') data = data.filter(st => st.class == cls);
            if (sec !== 'all') data = data.filter(st => st.section == sec);
            if (gender !== 'all') data = data.filter(st => st.gender && st.gender.toLowerCase() === gender.toLowerCase());

            // 3. Search Logic (Range + Keyword)
            if (search) {
                const rangeFilter = parseRange(search);
                if (rangeFilter) {
                    // Try to match Class OR Section
                    // If range is numeric [1,2,3], likely class.
                    // If range is alpha [A,B,C], likely section.
                    // But simpler: Check if Class OR Section is IN the range list.
                    data = data.filter(st =>
                        rangeFilter.includes(String(st.class).toUpperCase()) ||
                        rangeFilter.includes(String(st.section).toUpperCase())
                    );
                } else {
                    // Normal Text Search
                    const lowerQ = search.toLowerCase();
                    data = data.filter(st =>
                        st.name.toLowerCase().includes(lowerQ) ||
                        (st.roll_no && st.roll_no.toLowerCase().includes(lowerQ))
                    );
                }
            }

            // Store filtered data for Export
            window.filteredDataForExport = data;

            // 4. Render Specific Tab
            if (tdCurrentTab === 'students') renderTdStudents(data);
            if (tdCurrentTab === 'measurements') renderTdMeasurements(data);
            if (tdCurrentTab === 'patterns-boys') renderTdPatterns(data, 'Male');
            if (tdCurrentTab === 'patterns-girls') renderTdPatterns(data, 'Female');
        }

        // PDF Export Implementation
        function downloadTdPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const data = window.filteredDataForExport || globalStudents.filter(st => st.school_id == tdCurrentSchoolId);
            const schoolName = document.getElementById('td-school-name').innerText;

            doc.setFontSize(18);
            doc.text(`${schoolName} - Student Report`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()} • Records: ${data.length}`, 14, 28);

            // AutoTable - Simplified Columns
            const headers = [['Roll No', 'Name', 'Class', 'Gender', 'Status']];
            const rows = data.map(s => {
                return [
                    s.roll_no || '-',
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.gender,
                    s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')
                ];
            });

            doc.autoTable({
                head: headers,
                body: rows,
                startY: 35,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save(`${schoolName}_Student_List.pdf`);
        }

        function renderTdStudents(data) {
            document.getElementById('td-list-students').innerHTML = data.map(s => `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                        <td class="p-4 font-mono text-xs text-gray-500">${s.roll_no || '-'}</td>
                        <td class="p-4 text-gray-800">${s.name}</td>
                        <td class="p-4 text-xs font-bold text-gray-500">${s.class || ''} ${s.section || ''}</td>
                        <td class="p-4 text-xs">${s.gender || '-'}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wide ${getStatusColor(s.order_status, s.is_packed)}">
                                ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                            </span>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('td-school-meta').innerText = `${data.length} Students Shown`;
        }

        function renderTdMeasurements(data) {
            document.getElementById('td-list-measurements').innerHTML = data.map(s => {
                const m = getMeasurementsSafe(s);
                return `
                     <tr class="hover:bg-blue-50/30 transition-colors border-b border-gray-50">
                         <td class="p-3 bg-white sticky left-0 border-r border-gray-100 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                             <div class="font-bold text-gray-700 text-xs">${s.name}</div>
                             <div class="text-[9px] text-gray-400 font-mono">${s.roll_no || '-'}</div>
                         </td>
                         ${['u1', 'u2', 'u3', 'u4', 'u5', 'u6', 'u7', 'u8'].map(k => `<td class="p-2 text-center text-orange-600 bg-orange-50/10">${m[k] || '-'}</td>`).join('')}
                         ${['l1', 'l2', 'l3', 'l4', 'l5', 'l6', 'l7', 'l8'].map((k, i) => `<td class="p-2 text-center text-indigo-600 bg-indigo-50/10 ${i === 0 ? 'border-l border-gray-100' : ''}">${m[k] || '-'}</td>`).join('')}
                         <td class="p-3 text-xs bg-purple-50/30 text-purple-600 font-bold border-l border-gray-100 max-w-[120px] truncate" title="${Object.entries(getItemQuantitiesSafe(s)).map(([k, v]) => `${k}:${v}`).join(', ')}">
                             ${Object.entries(getItemQuantitiesSafe(s)).map(([k, v]) => `${k}:${v}`).join(', ')}
                         </td>
                         <td class="p-3 text-xs italic text-gray-400 truncate max-w-[150px]" title="${m.remarks || ''}">${m.remarks || '-'}</td>
                     </tr>
                     `;
            }).join('');
        }

        function renderTdPatterns(data, gender) {
            const genderData = data.filter(s => s.gender === gender);
            const groups = {};
            genderData.forEach(s => {
                const pname = s.pattern_name || 'Unassigned';
                if (!groups[pname]) groups[pname] = [];
                groups[pname].push(s);
            });

            const container = document.getElementById(gender === 'Male' ? 'td-list-patterns-boys' : 'td-list-patterns-girls');

            if (Object.keys(groups).length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-300 italic">No patterns found for ${gender} students.</div>`;
                return;
            }

            container.innerHTML = Object.entries(groups).sort().map(([name, students]) => {
                const meta = globalPatterns.find(p => p.name === name && p.school_id == tdCurrentSchoolId) || {};
                // Box Grid Layout (Click to Open Level 3)
                return `
                    <div onclick="openPatternDetails('${name}', '${gender}')" class="clay-card p-6 flex flex-col justify-between hover:scale-[1.02] transition-transform cursor-pointer group h-full">
                        <div>
                            <div class="flex justify-between items-start mb-4">
                                <h4 class="font-extrabold text-lg text-gray-700 line-clamp-2" title="${name}">${name}</h4>
                                <span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold shadow-sm group-hover:bg-blue-100 transition-colors">View</span>
                            </div>
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-4">Consumption: <span class="text-emerald-500 text-lg">${meta.consumption ? meta.consumption + 'm' : 'N/A'}</span></p>
                            <div class="bg-gray-50 p-3 rounded-xl mb-4 border border-gray-100">
                                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Cloth Details</p>
                                <p class="text-xs text-gray-600 font-medium line-clamp-2">${meta.cloth_details || 'No details provided.'}</p>
                            </div>
                        </div>
                        <div class="mt-auto pt-4 border-t border-gray-50 flex justify-between items-center text-xs font-bold text-gray-500">
                             <span>${students.length} Students</span>
                             <span class="text-indigo-400 group-hover:translate-x-1 transition-transform">Details &rarr;</span>
                        </div>
                    </div>
                    `;
            }).join('');
        }

        function openPatternDetails(patternName, gender) {
            // Find data
            // Need to re-filter because we passed string names. 
            // Context is tdCurrentSchoolId
            const schoolStudents = globalStudents.filter(st => st.school_id == tdCurrentSchoolId && st.gender === gender);
            const students = schoolStudents.filter(s => (s.pattern_name || 'Unassigned') === patternName);
            const meta = globalPatterns.find(p => p.name === patternName && p.school_id == tdCurrentSchoolId) || {};

            // UI
            // Hide Level 2 (which contains the L2 Grid AND L3 Views)
            // Actually, the Structure is:
            // Level 2 Container 
            //    -> Category Grid
            //    -> Level 3 Views (Students, Patterns Grid etc)

            // So we should HIDE Level 2 Container entirely to show Level 3 Pattern Detail?
            // Or Hide the specific Level 3 View?

            // Let's simply HIDE Level 2 Container and SHOW Level 3 Pattern Detail Container
            document.getElementById('td-level-2').classList.add('hidden');
            document.getElementById('td-level-3-pattern').classList.remove('hidden');

            document.getElementById('td-p3-title').innerText = patternName;
            document.getElementById('td-p3-title').setAttribute('data-gender', gender); // Store for back button
            document.getElementById('td-p3-count').innerText = `${students.length} Students`;
            document.getElementById('td-p3-meta').innerText = meta.consumption ? `Consumption: ${meta.consumption}m • ${meta.cloth_details || ''}` : 'No additional metadata';

            document.getElementById('td-p3-list').innerHTML = students.map(s => {
                const m = getMeasurementsSafe(s);
                const iq = getItemQuantitiesSafe(s);
                const qtyStr = Object.entries(iq).map(([k, v]) => `${k}:${v}`).join(', ');

                // Simplified Measurements string for list view
                const measStr = `U:[${m.u1 || '-'},${m.u2 || '-'},${m.u3 || '-'}] L:[${m.l1 || '-'},${m.l2 || '-'}]`;

                return `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                        <td class="p-4 pl-6 font-bold text-gray-700">${s.name} <span class="block text-xs font-mono text-gray-400 font-normal">${s.roll_no || '-'}</span></td>
                        <td class="p-4 text-xs font-bold text-gray-500">${s.class || ''} ${s.section || ''}</td>
                        <td class="p-4 text-xs">${s.gender || '-'}</td>
                        <td class="p-4 text-xs font-mono text-blue-500 bg-blue-50/30 rounded">${measStr}</td>
                        <td class="p-4 text-xs font-bold text-purple-600 bg-purple-50/30 rounded">${qtyStr}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wide ${getStatusColor(s.order_status, s.is_packed)}">
                                ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                            </span>
                        </td>
                    </tr>`;
            }).join('');
        }

        function closePatternDetails() {
            document.getElementById('td-level-3-pattern').classList.add('hidden');
            // Return to Level 3 (Pattern Grid) NOT Level 2 (Category Grid)
            const gender = document.getElementById('td-p3-title').getAttribute('data-gender');
            // We need to know which Level 3 view to show. 
            // Let's rely on hidden states. The Level 3 container (e.g. boys patterns) was NOT hidden when we opened L4?
            // Actually, best practice: Hide L3 when opening L4.

            // Let's fix openPatternDetails to hide L2/L3 correctly.
            document.getElementById('td-level-2').classList.remove('hidden'); // Ensure parent is visible

            // If we came from Boys Patterns
            // We need to restore the correct sub-view.
            // Simple hack: Re-open the last active tab (tdCurrentTab)
            if (tdCurrentTab) openLevel3(tdCurrentTab);
        }

        function exportTdCurrentData() {
            // Simple redirect to existing export logic but context sensitive?
            // Or re-implement for specific formatted export.
            // For now, let's reuse the global downloadExcel but filtered to current view data.
            window.filteredDataForExport = globalStudents.filter(st => st.school_id === tdCurrentSchoolId);
            // Apply filters
            const cls = document.getElementById('td-filter-class').value;
            const sec = document.getElementById('td-filter-section').value;
            if (cls !== 'all') window.filteredDataForExport = window.filteredDataForExport.filter(st => st.class == cls);
            if (sec !== 'all') window.filteredDataForExport = window.filteredDataForExport.filter(st => st.section == sec);

            downloadExcel(); // Reuses global function
        }


        async function fetchActivityLogs() {
            try {
                const r = await fetch(`${API_BASE}/data/logs`, { headers: { 'Authorization': `Bearer ${token}` } });
                const logs = await r.json();

                if (!Array.isArray(logs)) return;

                const iconMap = {
                    'CREATE': '<span class="bg-green-100 text-green-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></span>',
                    'UPDATE': '<span class="bg-blue-100 text-blue-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></span>',
                    'DELETE': '<span class="bg-red-100 text-red-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></span>',
                    'DEFAULT': '<span class="bg-gray-100 text-gray-500 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>'
                };

                document.getElementById('activity-feed').innerHTML = '<div class="absolute left-6 top-4 bottom-4 w-0.5 bg-gray-100"></div>' + logs.map(l => {
                    let type = 'DEFAULT';
                    if (l.action.includes('CREATE')) type = 'CREATE';
                    if (l.action.includes('UPDATE')) type = 'UPDATE';
                    if (l.action.includes('DELETE')) type = 'DELETE';

                    return `
                        <div class="relative pl-14 py-2 group">
                             <!-- Dot on Line -->
                             <div class="absolute left-[1.35rem] top-6 w-3 h-3 bg-white border-2 border-gray-300 rounded-full group-hover:border-blue-500 group-hover:scale-110 transition-all z-10"></div>
                             
                             <div class="flex items-start gap-4">
                                 <!-- Icon User -->
                                 ${iconMap[type]}
                                 <div>
                                     <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-0.5 flex items-center gap-2">
                                        ${l.username} 
                                        <span class="text-[10px] text-gray-300">• ${timeAgo(l.created_at)}</span>
                                     </p>
                                     <p class="text-sm font-bold text-gray-700">${l.details}</p>
                                 </div>
                             </div>
                        </div>`;
                }).join('');

            } catch (e) { console.error("Logs Error", e); }
        }

        // Removed dummy renderMeasurements Helper as it's now inline
        function dummy() { }

        function renderCharts() {
            const p = globalStudents.filter(s => s.is_packed).length, pe = globalStudents.length - p;
            // Destroy exists?
            new Chart(document.getElementById('chart-packing'), { type: 'doughnut', data: { labels: ['Packed', 'Pending'], datasets: [{ data: [p, pe], backgroundColor: ['#A8E6CF', '#FFD3B6'], borderWidth: 0 }] }, options: { maintainAspectRatio: false } });
            const sc = {}; globalStudents.forEach(s => { sc[s.school_name] = (sc[s.school_name] || 0) + 1 });
            new Chart(document.getElementById('chart-schools'), { type: 'bar', data: { labels: Object.keys(sc), datasets: [{ label: 'Student Count', data: Object.values(sc), backgroundColor: '#AA96DA', borderRadius: 4 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        async function createUser(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/users/create`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("User Created!"); e.target.reset(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function generateCode() { const sid = document.getElementById('access-school-select').value, type = document.getElementById('access-type').value, hrs = document.getElementById('access-expiry').value; try { const r = await fetch(`${API_BASE}/data/access_codes`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ school_id: sid, type, expires_in_hours: parseFloat(hrs) }) }); if (r.ok) { alert(`Code Created: ${(await r.json()).code}`); fetchAccessCodes(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function toggleCode(id, a) { if (!confirm(a ? "Activate?" : "Revoke?")) return; await fetch(`${API_BASE}/data/access_codes/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchAccessCodes(); }
        async function toggleUserStatus(id, a, n) { if (confirm(a ? "Enable?" : "Disable?")) await fetch(`${API_BASE}/data/users/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchUsers(); }
        async function registerSchool(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/schools`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("School Registered!"); document.getElementById('school-modal').classList.add('hidden'); e.target.reset(); fetchSchoolsForSelect(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert("Failed"); } }
        function openSchoolModal() { document.getElementById('school-modal').classList.remove('hidden'); }
        function toggleSchoolSelect() { const r = document.getElementById('user-role').value, s = document.getElementById('school-select-wrapper'); if (r === 'company') s.classList.add('hidden'); else s.classList.remove('hidden'); }
        async function fixDatabase() { if (confirm("Maintain DB?")) { await fetch(`${API_BASE}/data/migrate`, { method: 'POST' }); location.reload(); } }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // CLIENT SIDE EXPORTS (Filtered)
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Determine Data Source
            let data = window.filteredDataForExport || globalStudents;
            let title = "Tailoring Data Report";
            const isSchoolView = !document.getElementById('view-school-details').classList.contains('hidden');

            // Active Columns
            let cols = window.currentCols || [];
            if (isSchoolView && cols.length === 0) {
                // In school view, default to showing all raw measurements if no specific item filter active (which isn't in details view usually)
                cols = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'L1', 'L2', 'L3', 'L4', 'L5'];
            }

            if (isSchoolView && currentSchoolDetails.name) {
                data = globalStudents.filter(s => s.school_name === currentSchoolDetails.name);
                title = `${currentSchoolDetails.name} - Student Data`;
            }

            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            let head = [['School', 'Name', 'Class', 'Gender', 'Pattern']];

            if (cols.length > 0) head[0].push(...cols);
            else head[0].push("Measurements");

            head[0].push('Packed');

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name,
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.gender || '-',
                    s.pattern_name || '-'
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push("Select Item to View Details");
                }

                row.push(s.is_packed ? 'Yes' : 'No');
                return row;
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [244, 63, 94] }
            });

            doc.save("Global_Report.pdf");
        }

        function downloadExcel() {
            // Priority: Filtered Data -> School View Data -> Global Data
            let data = window.filteredDataForExport || globalStudents;
            let filename = "Tailoring_Data_Report";

            // Check if we are doing a Student Details Export (Special Case: Simplified)
            // If filteredDataForExport is present, it means we are likely in the Student Details view
            const isStudentDetailsExport = !!window.filteredDataForExport;

            // If we are in School Details View but filteredDataForExport is not set (legacy check)
            const isSchoolView = !document.getElementById('view-school-details').classList.contains('hidden');
            if (isSchoolView && !window.filteredDataForExport && currentSchoolDetails.name) {
                data = globalStudents.filter(s => s.school_name === currentSchoolDetails.name);
                filename = `${currentSchoolDetails.name}_Report`;
            } else if (window.filteredDataForExport) {
                // If filtered data exists, customize filename if possible
                if (tdCurrentSchoolId) {
                    const s = globalSchools.find(x => x.id == tdCurrentSchoolId);
                    if (s) filename = `${s.name}_Filtered_List`;
                }
            }

            // Active Columns
            let cols = window.currentCols || [];

            // Simplified Logic: If no specific measurement columns selected, and it's a filtered list, default to BASIC info only.
            // Unless the user explicitly asked for measurements (which they can't yet in this view).

            // The sheet name for Excel has a max of 31 characters.
            const sheetName = filename.substring(0, 30);

            const exportData = data.map(s => {
                const base = {
                    "Roll No": s.roll_no || '-',
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Status": s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')
                };

                // Add Measurements ONLY if NOT in simplified mode
                if (!isStudentDetailsExport) {
                    const m = getMeasurementsSafe(s);
                    base["Pattern"] = s.pattern_name || '-';
                    if (cols.length > 0) {
                        cols.forEach(c => base[c] = m[c.toLowerCase()] || '-');
                    } else {
                        // Default full measurements
                        base["U1"] = m.u1; base["U2"] = m.u2; base["U3"] = m.u3;
                        base["L1"] = m.l1; base["L2"] = m.l2; base["L3"] = m.l3;
                    }
                    base["Packed"] = s.is_packed ? 'Yes' : 'No';
                }

                return base;
            });

            // Generate Worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }


        // COMPLAINTS LOGIC
        let currentComplaintId = null;

        // COMPLAINTS ANALYTICS LOGIC
        let rawComplaints = [];
        let filteredComplaints = [];
        let chartIssues = null;
        let chartStatus = null;

        async function fetchComplaints() {
            try {
                const res = await fetch(`${API_BASE}/data/complaints`, { headers: { 'Authorization': `Bearer ${token}` } });
                rawComplaints = await res.json();
                if (!Array.isArray(rawComplaints)) rawComplaints = [];

                // Populate Filter Dropdowns (Patterns)
                const patterns = new Set();
                rawComplaints.forEach(c => {
                    if (c.pattern_name) {
                        c.pattern_name.split(',').forEach(p => patterns.add(p.trim()));
                    }
                });
                const sel = document.getElementById('c-filter-pattern');
                const currentVal = sel.value;
                sel.innerHTML = '<option value="all">All Patterns</option>' +
                    Array.from(patterns).sort().map(p => `<option value="${p}">${p}</option>`).join('');
                sel.value = currentVal;

                renderComplaintDash();
            } catch (e) { console.error("Complaints Error", e); }
        }

        function renderComplaintDash() {
            // 1. Filter Data
            const sFil = document.getElementById('c-filter-school').value.toLowerCase();
            const pFil = document.getElementById('c-filter-pattern').value;
            const gFil = document.getElementById('c-filter-gender').value;

            filteredComplaints = rawComplaints.filter(c => {
                if (sFil && !c.school_name.toLowerCase().includes(sFil)) return false;
                if (gFil !== 'all' && c.gender !== gFil) return false;
                if (pFil !== 'all' && (!c.pattern_name || !c.pattern_name.includes(pFil))) return false;
                return true;
            });

            // 2. Update Stats
            const total = filteredComplaints.length;
            const resolved = filteredComplaints.filter(c => c.status === 'Resolved').length;
            const open = total - resolved;

            document.getElementById('c-stat-total').innerText = total;
            document.getElementById('c-stat-open').innerText = open;
            document.getElementById('c-stat-resolved').innerText = resolved;

            // 3. Update Charts
            updateComplaintCharts(filteredComplaints);

            // 4. Render School Cards (Grouping)
            const grid = document.getElementById('school-complaints-grid');
            grid.innerHTML = '';

            if (total === 0) {
                document.getElementById('c-no-data').classList.remove('hidden');
                return;
            }
            document.getElementById('c-no-data').classList.add('hidden');

            // Group by School ID
            const schools = {};
            filteredComplaints.forEach(c => {
                if (!schools[c.school_id]) {
                    schools[c.school_id] = { name: c.school_name, count: 0, open: 0, resolved: 0, tickets: [] };
                }
                schools[c.school_id].count++;
                if (c.status === 'Resolved') schools[c.school_id].resolved++;
                else schools[c.school_id].open++;
                schools[c.school_id].tickets.push(c);
            });

            Object.values(schools).sort((a, b) => b.open - a.open).forEach(s => {
                const div = document.createElement('div');
                div.className = "clay-card p-6 rounded-xl hover:shadow-xl transition-all cursor-pointer border hover:border-rose-300 relative group overflow-hidden";
                div.onclick = () => openSchoolComplaints(s);

                div.innerHTML = `
                    <div class="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2 group-hover:bg-rose-100 transition-colors"></div>
                    <div class="relative z-10 flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-full bg-white shadow-inner flex items-center justify-center text-rose-500 font-bold text-xl">
                             ${s.name.charAt(0)}
                        </div>
                        ${s.open > 0 ? `<span class="bg-rose-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md shadow-rose-200">${s.open} Open</span>` : `<span class="bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm">All Good</span>`}
                    </div>
                    <h3 class="relative z-10 font-bold text-xl text-gray-700 mb-1 truncate">${s.name}</h3>
                    <p class="relative z-10 text-xs text-gray-400 uppercase font-bold tracking-wider">${s.count} Total Items</p>
                `;
                grid.appendChild(div);
            });
        }

        // === USER MANAGEMENT FUNCTIONS ===
        function toggleUserForm() {
            const container = document.getElementById('user-create-form-container');
            const chevron = document.getElementById('user-form-chevron');
            if (container.classList.contains('max-h-0')) {
                // Expand
                container.classList.remove('max-h-0');
                container.classList.add('max-h-[1000px]', 'mt-4');
                chevron.classList.add('rotate-180');
            } else {
                // Collapse
                container.classList.add('max-h-0');
                container.classList.remove('max-h-[1000px]', 'mt-4');
                chevron.classList.remove('rotate-180');
            }
        }

        function openSchoolModal() {
            document.getElementById('school-modal').classList.remove('hidden');
        }

        function toggleSchoolSelect() {
            const role = document.getElementById('user-role').value;
            const schoolSelect = document.getElementById('school-select-wrapper');
            if (role === 'company') {
                schoolSelect.classList.add('hidden');
            } else {
                schoolSelect.classList.remove('hidden');
            }
        }

        async function createUser(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                username: form.username.value,
                password: form.password.value,
                role: form.role.value,
                schoolId: (form.role.value !== 'company' && form.school_id) ? form.school_id.value : null
            };

            try {
                const r = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const d = await r.json();
                if (r.ok) {
                    alert('✅ User Created Successfully');
                    form.reset();
                    fetchUsers();
                } else {
                    alert('❌ ' + (d.error || 'Failed to create user'));
                }
            } catch (err) { console.error(err); alert('Error creating user'); }
        }

        async function registerSchool(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                name: form.name.value,
                username: form.username.value,
                password: form.password.value
            };

            try {
                // Server handles both School and Admin User creation in one transaction
                const r = await fetch(`${API_BASE}/data/schools`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const d = await r.json();

                if (r.ok) {
                    alert('✅ School & Admin Registered Successfully!');
                    document.getElementById('school-modal').classList.add('hidden');
                    form.reset();
                    fetchSchoolsForSelect(); // Refresh dropdowns
                    fetchSchoolsManage(); // Refresh list
                    fetchUsers(); // Refresh users
                } else {
                    alert('❌ Error: ' + (d.error || 'Failed to register school'));
                }
            } catch (err) {
                console.error(err);
                alert('❌ Network Error: ' + err.message);
            }
        }

        async function fetchUsers() {
            try {
                const r = await fetch(`${API_BASE}/data/users`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await r.json();
                const tbody = document.getElementById('user-list-body');
                tbody.innerHTML = '';

                if (Array.isArray(users)) {
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            <td class="p-3 font-bold text-gray-700">${u.username}</td>
                            <td class="p-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold uppercase">${u.role}</span></td>
                            <td class="p-3 text-gray-500">${u.school_name || (u.role === 'company' ? 'Planet Schools' : '-')}</td>
                            <td class="p-3 text-center">
                                <button onclick="toggleUserStatus(${u.id}, ${!u.is_active}, '${u.username}')" 
                                    class="${u.is_active ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} px-2 py-1 rounded-full text-xs font-bold shadow-sm hover:scale-105 transition-transform">
                                    ${u.is_active ? 'Active' : 'Disabled'}
                                </button>
                            </td>
                            <td class="p-3 text-right text-gray-400 font-mono text-xs">${new Date(u.created_at).toLocaleDateString()}</td>
                        </tr>
                    `).join('');
                }
            } catch (e) { console.error("Fetch Users Error", e); }
        }

        async function toggleUserStatus(id, active, username) {
            // Note: We need an endpoint to update user status. 
            // Assuming PUT /api/data/users/:id exists.
            if (!confirm(`Are you sure you want to ${active ? 'ENABLE' : 'DISABLE'} user ${username}?`)) return;
            try {
                const r = await fetch(`${API_BASE}/data/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ is_active: active })
                });
                const d = await r.json();
                if (r.ok) fetchUsers();
                else alert("❌ Update Failed: " + (d.error || "Unknown Error"));
            } catch (e) { console.error(e); alert("Client Error: " + e.message); }
        }

        async function fixDatabase() {
            if (!confirm("Attempt to fix database schema issues (missing columns)?")) return;
            try {
                const r = await fetch(`${API_BASE} / data / migrate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await r.json();
                alert(d.message || d.error);
            } catch (e) { alert("Migration Failed: " + e.message); }
        }

        function updateComplaintCharts(data) {
            // 1. Calculate Aggregates
            const patternCounts = {};
            const issueCounts = {};

            data.forEach(c => {
                // Patterns
                if (c.pattern_name) {
                    c.pattern_name.split(',').forEach(p => {
                        const cleanP = p.trim();
                        if (cleanP) patternCounts[cleanP] = (patternCounts[cleanP] || 0) + 1;
                    });
                }

                // Issues (Parse "Pattern (Issue)" format)
                if (c.issue_type) {
                    c.issue_type.split(',').forEach(i => {
                        let cleanI = i.trim();
                        if (cleanI.includes('(')) {
                            // Extract content between parenthesis e.g., "Size Mismatch" from "Shirt (Size Mismatch)"
                            const match = cleanI.match(/\(([^)]+)\)/);
                            if (match && match[1]) cleanI = match[1].trim();
                        }
                        if (cleanI) issueCounts[cleanI] = (issueCounts[cleanI] || 0) + 1;
                    });
                }
            });

            // 2. Identify Hotspots (Top 1)
            const topPattern = Object.entries(patternCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
            const topIssue = Object.entries(issueCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];

            document.getElementById('c-top-pattern').innerText = topPattern[0];
            document.getElementById('c-top-pattern-count').innerText = `${topPattern[1]} complaints`;

            document.getElementById('c-top-issue').innerText = topIssue[0];
            document.getElementById('c-top-issue-count').innerText = `${topIssue[1]} occurrences`;


            // 3. Render Chart 1: Top 10 Patterns (Horizontal Bar)
            const ctx1 = document.getElementById('chart-patterns');
            if (chartIssues) chartIssues.destroy(); // using same var name for convenience, represents "Patterns" now

            // Sort and Slice Top 10
            const sortedPatterns = Object.entries(patternCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            chartIssues = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedPatterns.map(x => x[0]),
                    datasets: [{
                        label: 'Complaints',
                        data: sortedPatterns.map(x => x[1]),
                        backgroundColor: '#f43f5e',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });

            // 4. Render Chart 2: Defect Types (Doughnut)
            const ctx2 = document.getElementById('chart-issues'); // using same ID in HTML, different concept
            if (chartStatus) chartStatus.destroy(); // represents "Issues" now

            const sortedIssues = Object.entries(issueCounts).sort((a, b) => b[1] - a[1]);

            chartStatus = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: sortedIssues.map(x => x[0]),
                    datasets: [{
                        data: sortedIssues.map(x => x[1]),
                        backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#6366f1', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function openSchoolComplaints(schoolData) {
            document.getElementById('tm-school-name').innerText = schoolData.name;
            document.getElementById('tm-school-stats').innerText = `${schoolData.open} Active • ${schoolData.resolved} Resolved`;

            const list = document.getElementById('tm-list');
            list.innerHTML = schoolData.tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(c => {
                const isResolved = c.status === 'Resolved';
                let images = [];
                try { images = JSON.parse(c.image_url || '[]'); } catch (e) { if (c.image_url) images = [c.image_url]; }

                return `
                < div class= "clay-card p-6 mb-4 animate-in slide-in-from-bottom-2 duration-300" >
                         <div class="flex justify-between items-start mb-4">
                             <div>
                                 <span class="text-[10px] bg-gray-100 text-gray-400 px-2 py-1 rounded uppercase font-bold tracking-wider">${new Date(c.created_at).toLocaleDateString()}</span>
                                 <div class="mt-2 text-sm text-gray-800 font-bold">${c.student_name || 'Generic Ticket'} <span class="text-gray-400 font-normal">(${c.student_reg_no || '-'})</span></div>
                                 <div class="text-xs text-gray-400 font-medium">${c.class || ''} ${c.section || ''} ${c.house ? '• ' + c.house : ''} ${c.gender ? '• ' + c.gender : ''}</div>
                             </div>
                             <div class="text-right">
                                 <select onchange="updateTicketStatus(${c.id}, this.value)" class="clay-input text-[10px] h-8 py-1 font-bold uppercase ${isResolved ? 'text-emerald-500' : 'text-rose-500'}">
                                     <option value="Open" ${!isResolved ? 'selected' : ''}>Open</option>
                                     <option value="Resolved" ${isResolved ? 'selected' : ''}>Resolved</option>
                                 </select>
                             </div>
                         </div>
                         
                         <!--Issue Specs-- >
                         <div class="bg-gray-50/50 p-4 rounded-xl border border-white/50 mb-4 text-xs">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div>
                                     <span class="block font-bold text-gray-400 uppercase text-[10px] mb-1">Patterns</span>
                                     <span class="text-gray-700 font-medium">${c.pattern_name || '-'}</span>
                                  </div>
                                  <div>
                                     <span class="block font-bold text-gray-400 uppercase text-[10px] mb-1">Issues</span>
                                     <span class="text-gray-700 font-medium">${c.issue_type || '-'}</span>
                                  </div>
                             </div>
                         </div>

                         <p class="text-gray-600 text-sm mb-4 leading-relaxed">"${c.comment}"</p>
                         
                         <!--Images -->
                ${images.length > 0 ? `<div class="flex gap-2 overflow-x-auto pb-2">${images.map(u => `<img src="${u}" onclick="window.open('${u}')" class="h-16 w-16 rounded-lg object-cover shadow-sm cursor-pointer hover:shadow-md transition-shadow">`).join('')}</div>` : ''}

                < !--Actions -->
                <div class="border-t border-white/50 pt-4 mt-2">
                    ${c.reply ? `<div class="p-3 bg-blue-50/50 rounded-lg border border-blue-100"><p class="text-xs text-blue-800 font-medium"><span class="font-bold uppercase text-[10px] mr-2">Admin Reply:</span> ${c.reply}</p></div>` : `<button onclick="openReplyModal(${c.id}, '${c.school_name}')" class="text-xs font-bold text-rose-500 hover:text-rose-600 uppercase tracking-wider flex items-center gap-1">Reply to School</button>`}

                </div>
                    </div >
                    `;
            }).join('');

            document.getElementById('ticketModal').showModal();
        }

        async function updateTicketStatus(id, newStatus) {
            // Optimistic Update? No, let's fetch.
            try {
                // Reuse reply endpoint or new status toggler? 
                // We don't have a status toggle route yet explicitly in previous summary, 
                // but 'PUT /api/data/complaints/:id' works for full updates. 
                // Let's assume we can enable a standard update.
                // Wait, the previous code for PUT used: db.run("UPDATE complaints SET rating = ?, comment = ?, image_url = ? ...")
                // It did NOT update status. 
                // Checking backend... we need to ensure backend supports status update!
                // If not, we fall back to just display for now, or use 'reply' to resolve. 
                // Let's assume simple reply for now is the main interaction, OR use the reply endpoint to also close it if needed. 
                // Actually, let's stick to just viewing for safety unless I patch the backend. 
                // User asked for "update complaint style". I will leave status changing as visual for now or patch backend if I can.
                // Let's create a quick patch in next step if broken.
                alert("Status update requires Backend Patch. Coming soon.");
            } catch (e) { }
        }

        function generateComplaintReport() {
            downloadComplaintsExcel();
        }

        function downloadComplaintsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            // Header
            doc.setFontSize(18);
            doc.text("Planetsolutions - Complaint Report", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()} `, 14, 26);

            // Stats
            const total = document.getElementById('c-stat-total')?.innerText || '0';
            const open = document.getElementById('c-stat-open')?.innerText || '0';
            doc.text(`Total: ${total} | Open: ${open} `, 14, 32);

            // Table Data
            const tableRows = filteredComplaints.map(c => [
                new Date(c.created_at).toLocaleDateString(),
                c.school_name,
                c.student_name + ` (${c.student_reg_no || '-'})`,
                c.gender,
                (c.pattern_name || '-').substring(0, 30),
                (c.issue_type || '-').substring(0, 30),
                c.status
            ]);

            doc.autoTable({
                startY: 36,
                head: [['Date', 'School', 'Student', 'Gender', 'Patterns', 'Issues', 'Status']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: [244, 63, 94] },
                styles: { fontSize: 8 },
            });

            doc.save(`complaints_report_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function downloadComplaintsExcel() {
            const wb = XLSX.utils.book_new();
            const excelData = filteredComplaints.map(c => ({
                "Date": new Date(c.created_at).toLocaleDateString(),
                "School": c.school_name,
                "Student": c.student_name,
                "Reg No": c.student_reg_no,
                "Class": c.class,
                "Section": c.section,
                "Gender": c.gender,
                "Status": c.status,
                "Patterns": c.pattern_name,
                "Issues": c.issue_type,
                "Comment": c.comment,
                "Reply": c.reply || ''
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wscols = Object.keys(excelData[0] || {}).map(k => ({ wch: 20 }));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Complaints");
            XLSX.writeFile(wb, `complaints_report_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function openReplyModal(id, schoolName) {
            currentComplaintId = id;
            document.getElementById('reply-school-name').innerText = `Replying to: ${schoolName} `;
            document.getElementById('reply-text').value = '';

            // Force close ticket modal to fix stacking
            const tm = document.getElementById('ticketModal');
            if (tm) tm.close();

            const rm = document.getElementById('reply-modal');
            rm.classList.remove('hidden');
            rm.style.zIndex = '9999';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden');
            currentComplaintId = null;
        }

        async function submitReply() {
            if (!currentComplaintId) return;
            const text = document.getElementById('reply-text').value;
            if (!text.trim()) return alert("Please write a reply.");

            try {
                const res = await fetch(`${API_BASE} /data/complaints / ${currentComplaintId}/reply`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ reply: text })
                });

                if (res.ok) {
                    alert("Reply Sent!");
                    closeReplyModal();
                    fetchComplaints();
                } else {
                    alert("Failed to send reply");
                }
            } catch (e) { alert(e.message); }
        }

        document.getElementById('nav-overview').classList.add('active'); init().then(() => {
            // Auto Refresh Pollers
            setInterval(() => { fetchStats(); }, 30000);
            setInterval(() => { if (!document.getElementById('view-complaints').classList.contains('hidden')) fetchComplaints(); }, 15000);
        });
    </script>

    <!-- REPLY MODAL -->
    <div id="reply-modal"
        class="fixed inset-0 bg-gray-500/30 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="premium-card w-full max-w-lg p-8">
            <h3 class="text-xl font-bold text-gray-700 mb-2">Reply to Complaint</h3>
            <p class="text-xs text-gray-400 mb-6 font-medium" id="reply-school-name">School Name</p>
            <textarea id="reply-text" rows="4" class="input-premium w-full p-4 text-sm"
                placeholder="Write your response here..."></textarea>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeReplyModal()"
                    class="px-4 py-2 text-xs font-bold text-gray-500 hover:text-gray-700 uppercase tracking-wider">CANCEL</button>
                <button onclick="submitReply()"
                    class="btn-primary px-6 py-3 text-xs font-bold rounded-lg shadow-lg uppercase tracking-wider">SEND
                    REPLY</button>
            </div>
        </div>
    </div>

    <script>
        async function resetDatabase() {
            if (!confirm("⚠️ DANGER: This will DELETE ALL PATTERNS, MEASUREMENTS and UNLINK STUDENTS from the database.\\n\\nThis action cannot be undone on Production.\\n\\nType 'RESET' to confirm:")) return;

            const conf = prompt("Type 'RESET' to confirm deletion:");
            if (conf !== 'RESET') return alert("Cancelled.");

            try {
                const res = await fetch(`${API_BASE}/data/reset_tables`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const d = await res.json();
                if (!res.ok) throw new Error(d.error || "Reset failed");
                alert("✅ " + d.message);
                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function fixDatabase() {
            if (!confirm("Attempt to repair database schema? (Adds missing tables/columns)")) return;
            try {
                const res = await fetch(`${API_BASE}/data/fix_db`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await res.json();
                alert(d.message);
            } catch (e) {
                alert("Repair Error: " + e.message);
            }
        }

        // === SMART REPORTS LOGIC ===
        let globalLogs = [];
        let charts = { vol: null, role: null };
        let debounceTimer;

        function initReports() {
            // Populate School Dropdowns (Both Filter & Export)
            const opts = globalSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            document.querySelectorAll('#rp-school-select, #rp-export-school-select').forEach(s => {
                s.innerHTML = `<option value="">-- All Schools --</option>` + opts;
            });

            // Initial Fetch (Load everything)
            fetchReportLogs('overview');
        }

        // Removed switchReportTab (No longer needed)

        function debounceLogFetch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => fetchReportLogs('overview'), 500); // Always update main view
        }

        async function fetchReportLogs(context) {
            const params = new URLSearchParams({ days: 7 }); // Default 7

            // APPLY ALL FILTERS ALWAYS (Single View)
            const sid = document.getElementById('rp-school-select') ? document.getElementById('rp-school-select').value : null;
            if (sid) params.append('school_id', sid);

            const uname = document.getElementById('rp-user-search') ? document.getElementById('rp-user-search').value : null;
            if (uname) params.append('username', uname);

            // Fetch
            try {
                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/logs?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await r.json();
                globalLogs = data.error ? [] : data;

                // RENDER EVERYTHING
                renderAnalytics();
                renderLogTable('rp-school-table', globalLogs);

            } catch (e) { console.error("Log Fetch Error", e); }
        }

        function renderAnalytics() {
            // 1. AI Insights
            const stats = {
                total: globalLogs.length,
                topAction: {},
                topUser: {},
                roles: {}
            };

            globalLogs.forEach(l => {
                stats.topAction[l.action] = (stats.topAction[l.action] || 0) + 1;
                stats.topUser[l.username] = (stats.topUser[l.username] || 0) + 1;
                stats.roles[l.role || 'unknown'] = (stats.roles[l.role || 'unknown'] || 0) + 1;
            });

            const topA = Object.entries(stats.topAction).sort((a, b) => b[1] - a[1])[0] || ['None', 0];
            const topU = Object.entries(stats.topUser).sort((a, b) => b[1] - a[1])[0] || ['None', 0];

            document.getElementById('ai-insights-grid').innerHTML = `
                <div class="flex items-center gap-4 bg-white p-4 rounded-xl border border-indigo-100 shadow-sm">
                    <div class="text-2xl">📈</div>
                    <div><p class="text-[10px] bg-gray-100 px-2 rounded-full font-bold uppercase text-gray-500 mb-1 w-fit">Total Events</p><p class="font-bold text-gray-700">${stats.total} <span class="text-xs font-normal text-gray-400">last 7 days</span></p></div>
                </div>
                <div class="flex items-center gap-4 bg-white p-4 rounded-xl border border-indigo-100 shadow-sm">
                    <div class="text-2xl">⚡</div>
                    <div><p class="text-[10px] bg-blue-100 px-2 rounded-full font-bold uppercase text-blue-500 mb-1 w-fit">Top Action</p><p class="font-bold text-gray-700 truncate w-32" title="${topA[0]}">${topA[0]}</p></div>
                </div>
                <div class="flex items-center gap-4 bg-white p-4 rounded-xl border border-indigo-100 shadow-sm">
                    <div class="text-2xl">👑</div>
                    <div><p class="text-[10px] bg-amber-100 px-2 rounded-full font-bold uppercase text-amber-600 mb-1 w-fit">Most Active User</p><p class="font-bold text-gray-700">${topU[0]}</p></div>
                </div>
            `;

            // 2. Volume Chart (Bar)
            const dates = {};
            globalLogs.forEach(l => {
                const d = new Date(l.created_at).toLocaleDateString();
                dates[d] = (dates[d] || 0) + 1;
            });

            if (charts.vol) charts.vol.destroy();
            charts.vol = new Chart(document.getElementById('chart-logs-volume'), {
                type: 'bar',
                data: {
                    labels: Object.keys(dates),
                    datasets: [{ label: 'Events', data: Object.values(dates), backgroundColor: '#818cf8', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
            });

            // 3. Role Chart (Pie)
            if (charts.role) charts.role.destroy();
            charts.role = new Chart(document.getElementById('chart-logs-role'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(stats.roles),
                    datasets: [{ data: Object.values(stats.roles), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function renderLogTable(id, logs) {
            const tbody = document.getElementById(id);
            if (logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">No logs found matching criteria.</td></tr>`;
                return;
            }
            tbody.innerHTML = logs.map(l => `
                <tr class="hover:bg-gray-50 border-b border-gray-50">
                    <td class="p-4 whitespace-nowrap text-gray-400 text-[10px] font-mono">${new Date(l.created_at).toLocaleString()}</td>
                    <td class="p-4 font-bold text-gray-700 text-xs">${l.username} <span class="text-[9px] text-gray-400 font-normal">(${l.role || '-'})</span></td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-100 text-gray-600 border border-gray-200">${l.action}</span></td>
                    <td class="p-4 text-xs text-gray-500 truncate max-w-xs" title="${l.details}">${l.details}</td>
                </tr>
            `).join('');
        }

        async function cleanupLogs() {
            if (!confirm("Are you sure? This will delete all logs older than 7 days.")) return;
            try {
                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/logs/cleanup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await r.json();
                showToast(d.message);
                fetchReportLogs('overview'); // Refresh
            } catch (e) { showToast("Cleanup failed", true); }
        }

        async function downloadReport(type, format) {
            const { jsPDF } = window.jspdf;

            // 1. SCHOOL SPECIFIC DATA
            if (type === 'school') {
                const schoolId = document.getElementById('rp-export-school-select').value;
                if (!schoolId) return alert("Please select a school first.");

                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/schools/${schoolId}/export`, { headers: { 'Authorization': `Bearer ${token}` } });
                const students = await r.json();
                if (students.length === 0) return alert("No data found for this school.");

                if (format === 'xls') {
                    // Simple CSV Export
                    let csv = "Admission No,Name,Class,Section,Gender,Measurements\n";
                    students.forEach(s => {
                        const m = s.measurements || {};
                        csv += `${s.admission_no},${s.name},${s.class},${s.section},${s.gender},"${JSON.stringify(m).replace(/"/g, '""')}"\n`;
                    });
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `School_Data_${schoolId}.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text(`Student Data: School ${schoolId}`, 14, 15);
                    const headers = [["Adm No", "Name", "Class", "Section", "Gender"]];
                    const data = students.map(s => [s.admission_no, s.name, s.class, s.section, s.gender]);

                    doc.autoTable({
                        head: headers,
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8 },
                        theme: 'grid'
                    });
                    doc.save(`School_Data_${schoolId}.pdf`);
                }
            }

            // 2. USER REGISTRY
            if (type === 'users') {
                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/users_report`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await r.json();

                if (format === 'xls') {
                    let csv = "ID,Username,Role,School,Created At\n";
                    users.forEach(u => csv += `${u.id},${u.username},${u.role},${u.school_name || 'N/A'},${u.created_at}\n`);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `User_Registry.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text("User Registry", 14, 15);
                    doc.autoTable({
                        head: [['ID', 'Username', 'Role', 'School', 'Created At']],
                        body: users.map(u => [u.id, u.username, u.role, u.school_name || 'N/A', new Date(u.created_at).toLocaleDateString()]),
                        startY: 20,
                        theme: 'striped'
                    });
                    doc.save('User_Registry.pdf');
                }
            }

            // 3. REGISTERED SCHOOLS LIST
            if (type === 'schools_list') {
                if (!globalSchools || globalSchools.length === 0) return alert("No school data loaded.");

                if (format === 'xls') {
                    let csv = "ID,School Name,Username,Priority,Status,Start Date,Deadline\n";
                    globalSchools.forEach(s => csv += `${s.id},${s.name},${s.username},${s.priority},${s.status},${s.start_date || ''},${s.deadline || ''}\n`);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Registered_Schools_Registry.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text("Registered Schools Registry", 14, 15);
                    const data = globalSchools.map(s => [s.name, s.username, s.status, s.start_date || '-', s.deadline || '-']);
                    doc.autoTable({
                        head: [['School Name', 'Admin', 'Status', 'Start', 'Deadline']],
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8 },
                        theme: 'grid',
                        columnStyles: { 0: { cellWidth: 50 } } // Wider column for name
                    });
                    doc.save('Registered_Schools.pdf');
                }
            }
        }

        function downloadLogsXls() {
            if (globalLogs.length === 0) return alert("No logs to download.");
            let csv = "Time,User,Role,School ID,Action,Details\n";
            globalLogs.forEach(l => {
                csv += `${l.created_at},${l.username},${l.role || ''},${l.school_id || ''},${l.action},"${l.details.replace(/"/g, '""')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `System_Logs.csv`;
            a.click();
        }
    </script>
</body>

</html>
```