<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Admin | Command Center v5.2 (Mobile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --ink-black: #1c1917;
            --rice-paper: #fafaf9;
            --seal-red: #be123c;
        }

        /* REPLY MODAL FIX: High z-index to overlay Ticket Modal */
        #replyModal {
            z-index: 60 !important;
        }

        #replyModal::backdrop {
            z-index: 59 !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--rice-paper);
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23e7e5e4' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .font-ink {
            font-family: 'Noto Serif JP', serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-item.active {
            background-color: var(--rice-paper);
            color: var(--ink-black);
            border-left: 4px solid var(--seal-red);
        }

        .ink-brush-title {
            position: relative;
            display: inline-block;
        }

        .ink-brush-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 40px;
            height: 3px;
            background-color: var(--seal-red);
            border-radius: 2px;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d6d3d1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a29e;
        }
    </style>
</head>

<body class="h-screen flex flex-col md:flex-row overflow-hidden text-stone-800">

    <!-- Mobile Header -->
    <div class="md:hidden bg-stone-900 text-white p-4 flex justify-between items-center z-50 shadow-md">
        <h1 class="font-ink text-lg flex items-center gap-2"><span class="text-rose-600 text-xl">●</span> Planet Admin
        </h1>
        <button onclick="toggleSidebar()" class="text-stone-300 focus:outline-none"><svg width="24" height="24"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg></button>
    </div>

    <!-- Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass-panel opacity-0 transition-opacity duration-300">
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-40 w-64 bg-stone-900 text-stone-400 flex flex-col shadow-2xl transition-transform duration-300 transform -translate-x-full md:translate-x-0 md:relative">
        <div class="p-6 border-b border-stone-800 hidden md:block">
            <h1 class="text-2xl font-ink text-stone-100 tracking-wide flex items-center gap-2"><span
                    class="text-rose-600 text-3xl">●</span> Planet</h1>
            <p class="text-xs text-stone-500 mt-1 tracking-widest uppercase">Admin Command v15.1</p>
        </div>
        <div class="p-6 border-b border-stone-800 md:hidden flex justify-between items-center"><span
                class="text-xl font-ink text-white">Menu</span><button onclick="toggleSidebar()"
                class="text-stone-500"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                    stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg></button></div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <button onclick="switchTab('overview')" id="nav-overview"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg> Overview</button>
            <button onclick="switchTab('data')" id="nav-data"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg> Tailoring Data</button>
            <button onclick="switchTab('users')" id="nav-users"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                </svg> User Management</button>
            <button onclick="switchTab('access')" id="nav-access"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                    <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                </svg> Access Codes</button>
            <button onclick="switchTab('reports')" id="nav-reports"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                    <polyline points="14 2 14 8 20 8" />
                    <line x1="16" y1="13" x2="8" y2="13" />
                    <line x1="16" y1="17" x2="8" y2="17" />
                    <polyline points="10 9 9 9 8 9" />
                </svg> Reports & Exports</button>
            <button onclick="switchTab('schools')" id="nav-schools"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-9a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v9" />
                </svg> Schools</button>
            <button onclick="switchTab('complaints')" id="nav-complaints"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-stone-200 transition-all text-sm font-medium"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
                </svg> Complaints</button>

            <!-- SHORTCUTS -->
            <div class="h-px bg-stone-800 mx-4 my-2"></div>

            <button onclick="window.open('planet_editor.html', '_blank')"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-rose-400 transition-all text-sm font-medium text-stone-400"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                </svg> Open School Editor</button>

            <button onclick="window.open('packing_dashboard.html', '_blank')"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-rose-400 transition-all text-sm font-medium text-stone-400"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg> Open Packing DB</button>

            <button onclick="window.open('pattern_view.html', '_blank')"
                class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-r-lg hover:bg-stone-800 hover:text-indigo-400 transition-all text-sm font-medium text-stone-400"><svg
                    width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg> Open Pattern Manager</button>
        </nav>
        <div class="p-4 border-t border-stone-800"><button onclick="logout()"
                class="w-full bg-rose-900/30 text-rose-400 hover:bg-rose-900/50 hover:text-rose-300 py-2 px-4 rounded transition-colors text-xs uppercase tracking-wider font-bold">Sign
                Out</button></div>
    </aside>

    <main class="flex-1 overflow-y-auto p-4 md:p-8 relative">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6 md:mb-8">
            <div>
                <h2 id="page-title" class="text-2xl md:text-3xl font-ink font-bold text-stone-800 ink-brush-title">
                    System Overview</h2>
                <p id="page-subtitle" class="text-stone-500 mt-2 text-sm">Real-time data from all schools & production
                    units.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="resetDatabase()"
                    class="bg-red-50 text-red-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-red-100 border border-red-200 shadow-sm transition-transform active:scale-95 whitespace-nowrap">Reset
                    DB</button>

                <button onclick="fixDatabase()"
                    class="bg-blue-50 text-blue-600 px-4 py-2 rounded-full text-xs font-bold hover:bg-blue-100 border border-blue-200 shadow-sm transition-transform active:scale-95 whitespace-nowrap">Repair
                    DB</button>
                <div
                    class="bg-white px-4 py-2 rounded-full shadow-sm border border-stone-200 text-xs font-mono text-stone-500 flex items-center gap-2 whitespace-nowrap">
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>Online
                </div>
            </div>
        </header>

        <!-- 1. OVERVIEW -->
        <div id="view-overview" class="space-y-6 fade-in">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                <div class="glass-panel p-6 rounded-xl">
                    <p class="text-xs text-stone-500 uppercase tracking-widest font-bold">Total Students</p>
                    <p class="text-4xl font-ink text-stone-800 mt-2" id="stat-students">0</p>
                </div>
                <div class="glass-panel p-6 rounded-xl">
                    <p class="text-xs text-stone-500 uppercase tracking-widest font-bold">Schools</p>
                    <p class="text-4xl font-ink text-stone-800 mt-2" id="stat-schools">0</p>
                </div>
                <div class="glass-panel p-6 rounded-xl border-l-4 border-emerald-500">
                    <p class="text-xs text-emerald-600 uppercase tracking-widest font-bold">Packed Units</p>
                    <p class="text-4xl font-ink text-stone-800 mt-2" id="stat-packed">0</p>
                </div>
                <div class="glass-panel p-6 rounded-xl border-l-4 border-amber-500">
                    <p class="text-xs text-amber-600 uppercase tracking-widest font-bold">Pending</p>
                    <p class="text-4xl font-ink text-stone-800 mt-2" id="stat-pending">0</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-auto md:h-80">
                <div class="glass-panel p-6 rounded-xl flex flex-col h-80 md:h-full">
                    <h3 class="font-ink text-lg mb-4">Packing Progress</h3>
                    <div class="flex-1 relative"><canvas id="chart-packing"></canvas></div>
                </div>
                <div class="glass-panel p-6 rounded-xl flex flex-col h-80 md:h-full">
                    <h3 class="font-ink text-lg mb-4">School Enrollment</h3>
                    <div class="flex-1 relative"><canvas id="chart-schools"></canvas></div>
                </div>
            </div>
        </div>

        <!-- 2. TAILORING DATA (Consolidated) -->
        <div id="view-data" class="hidden space-y-4 fade-in">
            <!-- Header with Exports -->
            <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                <div>
                    <h3 class="font-ink text-2xl">Tailoring Data</h3>
                    <p class="text-stone-500 text-sm">Filter by Item to see measurements.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadPDF()"
                        class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        Export PDF
                    </button>
                    <button onclick="downloadExcel()"
                        class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase flex items-center gap-2 transition-transform active:scale-95">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="8" x2="8" y2="8"></line>
                            <line x1="16" y1="16" x2="8" y2="16"></line>
                            <line x1="10" y1="12" x2="3" y2="12"></line>
                        </svg>
                        Export Excel
                    </button>
                </div>
            </div>

            <div
                class="glass-panel p-4 rounded-xl flex flex-wrap gap-3 md:gap-4 items-end sticky top-0 bg-white/95 z-20 shadow-sm border-b">
                <!-- Item Filter (Primary) -->
                <div class="w-full md:w-auto flex-1"><label class="text-[10px] font-bold text-stone-500 uppercase">Item
                        Type (Required for Measurements)</label><select id="filter-item" onchange="renderGlobalTable()"
                        class="block w-full mt-1 text-xs border-amber-300 bg-amber-50 rounded shadow-sm py-2 font-bold text-stone-700">
                        <option value="all">-- Select Item --</option>
                    </select></div>

                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Pattern</label><select
                        id="filter-pattern" onchange="renderGlobalTable()"
                        class="block w-full md:w-32 mt-1 text-xs border-gray-300 rounded shadow-sm">
                        <option value="all">All Patterns</option>
                    </select></div>

                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Class</label><input type="text"
                        id="filter-class" list="list-class" onchange="renderGlobalTable()"
                        class="block w-full md:w-20 mt-1 text-xs border-gray-300 rounded shadow-sm px-2 py-1.5"
                        placeholder="All"><datalist id="list-class"></datalist></div>
                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Section</label><input type="text"
                        id="filter-section" list="list-section" onchange="renderGlobalTable()"
                        class="block w-full md:w-20 mt-1 text-xs border-gray-300 rounded shadow-sm px-2 py-1.5"
                        placeholder="All"><datalist id="list-section"></datalist></div>
                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">House</label><input type="text"
                        id="filter-house" list="list-house" onchange="renderGlobalTable()"
                        class="block w-full md:w-24 mt-1 text-xs border-gray-300 rounded shadow-sm px-2 py-1.5"
                        placeholder="All"><datalist id="list-house"></datalist></div>
                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Gender</label><select id="filter-gender"
                        onchange="renderGlobalTable()"
                        class="block w-full md:w-24 mt-1 text-xs border-gray-300 rounded shadow-sm">
                        <option value="">All</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select></div>
                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Priority</label><select
                        id="filter-priority" onchange="renderGlobalTable()"
                        class="block w-full md:w-24 mt-1 text-xs border-gray-300 rounded shadow-sm">
                        <option value="all">All</option>
                        <option value="High">High</option>
                        <option value="Normal">Normal</option>
                        <option value="Low">Low</option>
                    </select></div>
                <div class="w-[47%] md:w-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Packing</label><select id="filter-packed"
                        onchange="renderGlobalTable()"
                        class="block w-full md:w-24 mt-1 text-xs border-gray-300 rounded shadow-sm">
                        <option value="all">All</option>
                        <option value="packed">Packed</option>
                        <option value="pending">Pending</option>
                    </select></div>
                <div class="w-full md:w-auto md:ml-auto"><label
                        class="text-[10px] font-bold text-stone-500 uppercase">Search</label><input type="text"
                        id="date-search" onkeyup="renderGlobalTable()" placeholder="Name / Roll No..."
                        class="block w-full md:w-32 mt-1 text-xs border-gray-300 rounded shadow-sm px-2 py-1.5"></div>
            </div>

            <!-- Removed dynamic-filters-container as we use Table Columns now -->

            <div class="glass-panel rounded-xl overflow-hidden shadow-lg border border-stone-200">
                <div class="overflow-x-auto h-[600px]">
                    <table class="w-full text-left border-collapse min-w-[1000px] whitespace-nowrap">
                        <thead
                            class="bg-stone-50 sticky top-0 z-10 shadow-sm text-xs font-bold text-stone-500 uppercase tracking-wider">
                            <tr>
                                <th class="p-4 bg-stone-50 sticky left-0 z-20">School</th>
                                <th class="p-4">Student</th>
                                <th class="p-4">Class</th>
                                <th class="p-4">Pattern</th>
                                <!-- Dynamic Header -->
                                <th class="p-4 text-center bg-amber-50 text-amber-700 border-x border-amber-100"
                                    id="th-measurements">Measurements</th>
                                <th class="p-4 text-center">Status</th>
                            </tr>
                            <tr id="th-sub-row" class="bg-stone-100 hidden">
                                <!-- Populated by JS -->
                            </tr>
                        </thead>
                        <tbody id="global-table-body" class="divide-y divide-stone-100 bg-white text-sm"></tbody>
                    </table>
                </div>
            </div>
            <p class="text-right text-xs text-stone-400 mt-2" id="record-count">Showing 0 records</p>
        </div>

        <!-- 3. USER MANAGEMENT -->
        <div id="view-users" class="hidden fade-in max-w-5xl mx-auto space-y-8">
            <div class="glass-panel p-6 md:p-8 rounded-xl relative">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="text-2xl font-ink">User Management</h3><button onclick="openSchoolModal()"
                        class="bg-stone-800 hover:bg-stone-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors shadow-lg">Register
                        New School</button>
                </div>
                <h4 class="text-sm font-bold text-stone-500 uppercase tracking-wider mb-4">Create New User Account</h4>
                <form onsubmit="createUser(event)" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm font-medium text-stone-700">Username</label><input type="text"
                                name="username" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-rose-500 focus:ring-rose-500 px-3 py-2 border">
                        </div>
                        <div><label class="block text-sm font-medium text-stone-700">Password</label><input type="text"
                                name="password" required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-rose-500 focus:ring-rose-500 px-3 py-2 border">
                        </div>
                    </div>
                    <div><label class="block text-sm font-medium text-stone-700">Role</label><select name="role"
                            id="user-role" onchange="toggleSchoolSelect()"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-rose-500 focus:ring-rose-500 px-3 py-2 border">
                            <option value="school">School Admin</option>
                            <option value="tailor">Tailor</option>
                            <option value="packing">Packing Unit</option>
                            <option value="company">Company Admin</option>
                        </select></div>
                    <div id="school-select-wrapper"><label class="block text-sm font-medium text-stone-700">Assign To
                            School</label><select name="school_id" id="school-select"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-rose-500 focus:ring-rose-500 px-3 py-2 border"></select>
                    </div>
                    <button type="submit"
                        class="w-full bg-stone-900 text-white py-3 rounded-lg hover:bg-stone-800 transition-colors font-medium text-lg shadow-lg">Create
                        Account</button>
                </form>
            </div>
            <div class="glass-panel p-6 md:p-8 rounded-xl">
                <h3 class="text-lg font-ink mb-4">Existing Accounts</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead class="bg-stone-50 text-stone-500 uppercase text-xs">
                            <tr>
                                <th class="p-3 text-left">User</th>
                                <th class="p-3 text-left">Role</th>
                                <th class="p-3 text-left">School</th>
                                <th class="p-3 text-right">Created</th>
                            </tr>
                        </thead>
                        <tbody id="user-list-body" class="divide-y divide-stone-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. ACCESS CODES -->
        <div id="view-access" class="hidden fade-in max-w-5xl mx-auto space-y-6">
            <div class="glass-panel p-6 md:p-8 rounded-xl">
                <h3 class="text-xl font-ink mb-4">Generate Secure Link</h3>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="w-full md:flex-1"><label
                            class="block text-xs font-bold text-stone-500 uppercase mb-1">Target School</label><select
                            id="access-school-select" class="w-full border rounded px-3 py-2"></select></div>
                    <div class="w-full md:w-48"><label
                            class="block text-xs font-bold text-stone-500 uppercase mb-1">Role Type</label><select
                            id="access-type" class="w-full border rounded px-3 py-2">
                            <option value="tailor">Tailor (Measurements)</option>
                            <option value="packing">Packing (Status)</option>
                        </select></div>
                    <div class="w-full md:w-32"><label
                            class="block text-xs font-bold text-stone-500 uppercase mb-1">Expires In</label><select
                            id="access-expiry" class="w-full border rounded px-3 py-2">
                            <option value="24">24 Hours</option>
                            <option value="48">48 Hours</option>
                            <option value="168">7 Days</option>
                        </select></div><button onclick="generateCode()"
                        class="w-full md:w-auto bg-rose-600 text-white px-6 py-2 rounded shadow hover:bg-rose-700 font-bold uppercase text-sm">Generate</button>
                </div>
            </div>
            <div class="glass-panel p-6 rounded-xl">
                <h3 class="text-lg font-ink mb-4">Active & Inactive Codes</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead>
                            <tr class="border-b text-stone-500">
                                <th class="text-left pb-2">School</th>
                                <th class="text-left pb-2">Code</th>
                                <th class="text-left pb-2">Type</th>
                                <th class="text-left pb-2">Status</th>
                                <th class="text-right pb-2">Action</th>
                            </tr>
                        </thead>
                        <tbody id="access-code-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 5. SCHOOLS -->
        <div id="view-schools" class="hidden fade-in max-w-5xl mx-auto space-y-8">
            <div class="glass-panel p-6 md:p-8 rounded-xl">
                <h3 class="text-2xl font-ink mb-6 border-b pb-4">School Metadata</h3>
                <p class="text-stone-500 text-sm mb-4">Manage priority and production status for each school.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm min-w-[800px]">
                        <thead class="bg-stone-50 text-stone-500 uppercase text-xs">
                            <tr>
                                <th class="p-3 text-left">School Name</th>
                                <th class="p-3 text-left w-48">Priority</th>
                                <th class="p-3 text-left w-48">Status</th>
                                <th class="p-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="school-list-body" class="divide-y divide-stone-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 6. REPORTS -->
        <div id="view-reports" class="hidden fade-in max-w-4xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-panel p-8 rounded-xl text-center hover:scale-105 transition-transform cursor-pointer"
                    onclick="downloadPDF()">
                    <div
                        class="w-16 h-16 bg-red-100 text-red-600 mx-auto rounded-full flex items-center justify-center mb-4">
                        PDF</div>
                    <h3 class="font-ink text-xl">Download PDF Report</h3>
                    <p class="text-sm text-stone-500 mt-2">Full system summary formatted for printing.</p>
                </div>
                <div class="glass-panel p-8 rounded-xl text-center hover:scale-105 transition-transform cursor-pointer"
                    onclick="downloadExcel()">
                    <div
                        class="w-16 h-16 bg-green-100 text-green-600 mx-auto rounded-full flex items-center justify-center mb-4">
                        XLS</div>
                    <h3 class="font-ink text-xl">Export Excel Data</h3>
                    <p class="text-sm text-stone-500 mt-2">Raw data export of all students and measurements.</p>
                </div>
            </div>
        </div>

        <!-- 7. COMPLAINTS -->
        <!-- 7. COMPLAINTS OVERHAUL -->
        <div id="view-complaints" class="hidden fade-in max-w-[1600px] mx-auto space-y-8">

            <!-- A. Analytics Header & Hotspots -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-6">
                <!-- Basic Counts -->
                <div class="md:col-span-2 grid grid-cols-3 gap-2">
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-stone-800 flex flex-col justify-center items-center text-center">
                        <p class="text-[10px] text-stone-400 font-bold uppercase tracking-widest">Total</p>
                        <p class="text-3xl font-ink text-stone-800 mt-1" id="c-stat-total">0</p>
                    </div>
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-amber-500 flex flex-col justify-center items-center text-center">
                        <p class="text-[10px] text-amber-600 font-bold uppercase tracking-widest">Open</p>
                        <p class="text-3xl font-ink text-stone-800 mt-1" id="c-stat-open">0</p>
                    </div>
                    <div
                        class="glass-panel p-4 rounded-xl border-l-4 border-emerald-500 flex flex-col justify-center items-center text-center">
                        <p class="text-[10px] text-emerald-600 font-bold uppercase tracking-widest">Done</p>
                        <p class="text-3xl font-ink text-stone-800 mt-1" id="c-stat-resolved">0</p>
                    </div>
                </div>

                <!-- Insight Cards -->
                <div class="glass-panel p-4 rounded-xl col-span-2 border-t-4 border-rose-500">
                    <p class="text-[10px] text-rose-500 font-bold uppercase tracking-widest mb-2">Needs Attention (Top
                        Pattern)</p>
                    <h4 class="font-bold text-stone-800 truncate" id="c-top-pattern">-</h4>
                    <p class="text-xs text-stone-500" id="c-top-pattern-count">0 complaints</p>
                </div>
                <div class="glass-panel p-4 rounded-xl col-span-2 border-t-4 border-indigo-500">
                    <p class="text-[10px] text-indigo-500 font-bold uppercase tracking-widest mb-2">Common Issue</p>
                    <h4 class="font-bold text-stone-800 truncate" id="c-top-issue">-</h4>
                    <p class="text-xs text-stone-500" id="c-top-issue-count">0 occurrences</p>
                </div>
            </div>

            <!-- B. Charts & Trends -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-96">
                <div class="glass-panel p-6 rounded-xl flex flex-col">
                    <h3 class="font-ink text-lg text-stone-700 mb-4">Top Defective Patterns</h3>
                    <div class="flex-1 relative"><canvas id="chart-patterns"></canvas></div>
                </div>
                <div class="glass-panel p-6 rounded-xl flex flex-col">
                    <h3 class="font-ink text-lg text-stone-700 mb-4">Common Defect Types</h3>
                    <div class="flex-1 relative"><canvas id="chart-issues"></canvas></div>
                </div>
            </div>

            <!-- C. Filters & Controls -->
            <div class="glass-panel p-4 rounded-xl flex flex-col md:flex-row gap-4 items-end bg-white/50">
                <div class="w-full md:w-auto flex-1">
                    <label class="block text-[10px] font-bold text-stone-400 uppercase mb-1">Search School</label>
                    <input type="text" id="c-filter-school" onkeyup="renderComplaintDash()"
                        placeholder="Type school name..."
                        class="w-full border border-stone-200 rounded px-3 py-2 text-xs outline-none focus:border-rose-500">
                </div>
                <div class="w-full md:w-48">
                    <label class="block text-[10px] font-bold text-stone-400 uppercase mb-1">Filter Pattern</label>
                    <select id="c-filter-pattern" onchange="renderComplaintDash()"
                        class="w-full border border-stone-200 rounded px-3 py-2 text-xs outline-none focus:border-rose-500">
                        <option value="all">All Patterns</option>
                        <!-- Populated JS -->
                    </select>
                </div>
                <div class="w-full md:w-32">
                    <label class="block text-[10px] font-bold text-stone-400 uppercase mb-1">Gender</label>
                    <select id="c-filter-gender" onchange="renderComplaintDash()"
                        class="w-full border border-stone-200 rounded px-3 py-2 text-xs outline-none focus:border-rose-500">
                        <option value="all">All</option>
                        <option value="Male">Boys</option>
                        <option value="Female">Girls</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadPDF()"
                        class="bg-rose-600 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase hover:bg-rose-700 transition-colors flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        PDF
                    </button>
                    <button onclick="downloadExcel()"
                        class="bg-emerald-600 text-white px-4 py-2 rounded shadow-lg text-xs font-bold uppercase hover:bg-emerald-700 transition-colors flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="8" x2="8" y2="8"></line>
                            <line x1="16" y1="16" x2="8" y2="16"></line>
                            <line x1="10" y1="12" x2="3" y2="12"></line>
                        </svg>
                        Excel
                    </button>
                </div>
            </div>

            <!-- D. Schools Grid (Grouped) -->
            <div>
                <h3 class="font-ink text-2xl text-stone-800 mb-4 px-2">School Tickets</h3>
                <div id="school-complaints-grid"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    <!-- Dynamic School Cards -->
                </div>
                <p id="c-no-data" class="hidden text-center text-stone-400 py-12 italic">No complaints match your
                    filters.</p>
            </div>

        </div>

        <!-- 8. TICKET DETAIL MODAL -->
        <dialog id="ticketModal" class="bg-transparent z-50">
            <div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div
                    class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col animate-in zoom-in-95 duration-200">
                    <!-- Header -->
                    <div
                        class="p-6 border-b border-stone-100 flex justify-between items-center bg-stone-50/50 rounded-t-2xl">
                        <div>
                            <h3 class="font-ink text-2xl font-bold text-stone-800" id="tm-school-name">School Name</h3>
                            <p class="text-xs text-stone-500 uppercase tracking-wider font-bold mt-1"
                                id="tm-school-stats">5 Open Tickets</p>
                        </div>
                        <button onclick="document.getElementById('ticketModal').close()"
                            class="w-8 h-8 rounded-full bg-stone-200 hover:bg-stone-300 flex items-center justify-center transition-colors">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 overflow-y-auto p-6 bg-stone-50" id="tm-list">
                        <!-- Ticket Cards Injected -->
                    </div>
                </div>
            </div>
        </dialog>

    </main>

    <!-- SCHOOL REGISTRATION MODAL -->
    <div id="school-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <h3 class="text-xl font-ink mb-4 border-b pb-2">Register New School</h3>
            <form onsubmit="registerSchool(event)" class="space-y-4">
                <div><label class="block text-xs font-bold text-stone-500 uppercase mb-1">School Name</label><input
                        type="text" name="name" required placeholder="e.g. Galaxy High School"
                        class="w-full border rounded px-3 py-2 text-sm focus:border-stone-800 outline-none"></div>
                <div><label class="block text-xs font-bold text-stone-500 uppercase mb-1">Admin Username</label><input
                        type="text" name="username" required placeholder="admin_galaxy"
                        class="w-full border rounded px-3 py-2 text-sm focus:border-stone-800 outline-none"></div>
                <div><label class="block text-xs font-bold text-stone-500 uppercase mb-1">Password</label><input
                        type="password" name="password" required
                        class="w-full border rounded px-3 py-2 text-sm focus:border-stone-800 outline-none"></div>
                <div class="flex justify-end gap-2 mt-6"><button type="button"
                        onclick="document.getElementById('school-modal').classList.add('hidden')"
                        class="px-4 py-2 text-sm font-bold text-stone-500 hover:bg-stone-100 rounded">CANCEL</button><button
                        type="submit"
                        class="px-4 py-2 text-sm font-bold bg-stone-900 text-white rounded hover:bg-stone-700">REGISTER
                        SCHOOL</button></div>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const API_BASE = '/api'; const token = sessionStorage.getItem('token'); if (!token) window.location.href = 'login.html';
        let globalStudents = [], globalSchools = [], globalPatterns = [], dynamicFilters = {}, sidebarOpen = false;
        function toggleSidebar() { sidebarOpen = !sidebarOpen; const s = document.getElementById('sidebar'), b = document.getElementById('sidebar-backdrop'); if (sidebarOpen) { s.classList.remove('-translate-x-full'); b.classList.remove('hidden'); setTimeout(() => b.classList.remove('opacity-0'), 10); } else { s.classList.add('-translate-x-full'); b.classList.add('opacity-0'); setTimeout(() => b.classList.add('hidden'), 300); } }
        const boysItems = [{ name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" }];
        const girlsItems = [{ name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" }, { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" }, { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" }, { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }];
        const allItems = [...boysItems, ...girlsItems];
        async function init() { await Promise.all([fetchStats(), fetchAllStudents(), fetchSchoolsForSelect(), fetchGlobalPatterns()]); renderGlobalTable(); renderCharts(); populateDynamicFilters(); }
        function switchTab(id) { document.querySelectorAll('main > div[id^="view-"]').forEach(d => d.classList.add('hidden')); document.getElementById(`view-${id}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); document.getElementById(`nav-${id}`).classList.add('active'); if (window.innerWidth < 768 && sidebarOpen) toggleSidebar(); if (id === 'access') fetchAccessCodes(); if (id === 'users') fetchUsers(); if (id === 'complaints') fetchComplaints(); if (id === 'schools') fetchSchoolsManage(); }
        async function fetchStats() { try { const r = await fetch(`${API_BASE}/data/stats`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); document.getElementById('stat-students').innerText = d.students || 0; document.getElementById('stat-schools').innerText = d.schools || 0; document.getElementById('stat-packed').innerText = d.packed || 0; document.getElementById('stat-pending').innerText = d.pending || 0; } catch (e) { console.error("Stats Error", e) } }
        async function fetchAllStudents() { try { const r = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); globalStudents = Array.isArray(d) ? d : []; } catch (e) { console.error("Student Fetch Error", e); globalStudents = []; } }
        async function fetchGlobalPatterns() { try { const r = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); globalPatterns = Array.isArray(d) ? d : []; document.getElementById('filter-pattern').innerHTML = '<option value="all">All Patterns</option>' + globalPatterns.map(p => `<option value="${p.id}">${p.name} (${p.school_name})</option>`).join(''); } catch (e) { console.error("Patterns Error", e); globalPatterns = []; } }
        async function fetchSchoolsForSelect() { try { const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); globalSchools = Array.isArray(d) ? d : []; if (globalSchools.length > 0) { const o = globalSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); document.getElementById('school-select').innerHTML = o; document.getElementById('access-school-select').innerHTML = o; } } catch (e) { console.error("Schools Error", e); globalSchools = []; } }

        async function fetchUsers() { try { const r = await fetch(`${API_BASE}/data/users`, { headers: { 'Authorization': `Bearer ${token}` } }); const u = await r.json(); if (!Array.isArray(u)) return; document.getElementById('user-list-body').innerHTML = u.map(x => `<tr class="hover:bg-stone-50 group"><td class="p-3 font-medium text-stone-900">${x.username}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs bg-gray-100 uppercase font-bold">${x.role}</span></td><td class="p-3 text-stone-500">${x.school_name || '-'}</td><td class="p-3 text-center"><span class="px-2 py-0.5 rounded text-xs font-medium ${x.is_active !== false ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${x.is_active !== false ? 'ACTIVE' : 'DISABLED'}</span></td><td class="p-3 text-right text-xs"><button onclick="toggleUserStatus(${x.id},${!(x.is_active !== false)},'${x.username}')" class="opacity-0 group-hover:opacity-100 transition-opacity px-2 py-1 rounded border ${x.is_active !== false ? 'text-red-600 border-red-200 hover:bg-red-50' : 'text-green-600 border-green-200 hover:bg-green-50'}">${x.is_active !== false ? 'DISABLE' : 'ENABLE'}</button></td></tr>`).join(''); } catch (e) { console.error(e) } }
        async function fetchAccessCodes() { try { const r = await fetch(`${API_BASE}/data/access_codes`, { headers: { 'Authorization': `Bearer ${token}` } }); const c = await r.json(); if (Array.isArray(c)) document.getElementById('access-code-list').innerHTML = c.map(x => `<tr class="border-b ${x.is_active ? '' : 'opacity-50'}"><td class="py-3 font-medium">${x.school_name}</td><td class="py-3 font-mono text-rose-600 font-bold tracking-wider">${x.code}</td><td class="py-3 capitalize">${x.type}</td><td class="py-3 text-center"><span class="${x.is_active ? 'text-green-600' : 'text-red-500 animate-pulse'} font-bold text-xs">${x.is_active ? 'ACTIVE' : 'REVOKED'}</span></td><td class="py-3 text-right space-x-2">${x.is_active ? `<button onclick="toggleCode(${x.id},false)" class="text-red-600 hover:underline text-xs font-bold border border-red-200 px-2 py-1 rounded hover:bg-red-50">REVOKE</button>` : `<button onclick="toggleCode(${x.id},true)" class="text-green-600 hover:underline text-xs font-bold border border-green-200 px-2 py-1 rounded hover:bg-green-50">ACTIVATE</button>`}</td></tr>`).join(''); } catch (e) { console.error(e) } }
        async function fetchSchoolsManage() { try { const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); document.getElementById('school-list-body').innerHTML = Array.isArray(d) ? d.map(s => `<tr class="hover:bg-stone-50 group"><td class="p-4 font-bold text-stone-900">${s.name}</td><td class="p-4"><select onchange="updateSchoolMeta(${s.id},'priority',this.value)" class="border rounded px-2 py-1 text-xs font-bold uppercase ${s.priority === 'High' ? 'text-rose-600 bg-rose-50 border-rose-200' : 'text-stone-600'}"><option value="Normal" ${s.priority === 'Normal' ? 'selected' : ''}>Normal Priority</option><option value="High" ${s.priority === 'High' ? 'selected' : ''}>High Priority</option><option value="Low" ${s.priority === 'Low' ? 'selected' : ''}>Low Priority</option></select></td><td class="p-4"><select onchange="updateSchoolMeta(${s.id},'status',this.value)" class="border rounded px-2 py-1 text-xs font-bold uppercase w-full"><option value="Pending" ${!s.status || s.status === 'Pending' ? 'selected' : ''}>Pending</option><option value="Measurements" ${s.status === 'Measurements' ? 'selected' : ''}>Measurements</option><option value="Production" ${s.status === 'Production' ? 'selected' : ''}>Production</option><option value="Delivered" ${s.status === 'Delivered' ? 'selected' : ''}>Delivered</option></select></td><td class="p-4 text-right"><button onclick="viewSchoolStudents('${s.name}')" class="text-xs bg-stone-100 hover:bg-stone-200 text-stone-800 font-bold px-3 py-1.5 rounded transition-colors">VIEW STUDENTS</button></td></tr>`).join('') : ''; } catch (e) { console.error(e) } }

        async function updateSchoolMeta(id, f, v) { await fetch(`${API_BASE}/data/schools/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ [f]: v }) }); }
        async function viewSchoolStudents(n) { switchTab('data'); await fetchAllStudents(); document.getElementById('date-search').value = n; renderGlobalTable(); }
        function populateDynamicFilters() { const c = [...new Set(globalStudents.map(s => s.class).filter(Boolean))].sort(), se = [...new Set(globalStudents.map(s => s.section).filter(Boolean))].sort(), h = [...new Set(globalStudents.map(s => s.house).filter(Boolean))].sort(); document.getElementById('list-class').innerHTML = c.map(x => `<option value="${x}">`).join(''); document.getElementById('list-section').innerHTML = se.map(x => `<option value="${x}">`).join(''); document.getElementById('list-house').innerHTML = h.map(x => `<option value="${x}">`).join(''); document.getElementById('filter-item').innerHTML = '<option value="all">-- Select Item --</option>' + allItems.map(i => `<option value="${i.name}">${i.name}</option>`).join(''); }
        // REMOVED handleItemFilter - now handled in renderGlobalTable directly
        function advancedMatch(r, f) { if (!f || f === 'all') return true; if (r == null || r === "") return false; const rv = String(r).trim().toUpperCase(), fv = f.toUpperCase(); if (fv.includes(',')) return fv.split(',').map(p => p.trim()).includes(rv); if (fv.includes('-')) { const p = fv.split('-').map(x => x.trim()); if (p.length === 2) { const [mn, mx] = p; if (!isNaN(mn) && !isNaN(mx)) { const n = parseFloat(r); return !isNaN(n) && n >= parseFloat(mn) && n <= parseFloat(mx) } if (mn.length === 1 && mx.length === 1 && rv.length === 1) return rv >= mn && rv <= mx } } return rv === fv; }

        function getMeasurementsSafe(s) {
            if (typeof s.measurements === 'string') { try { return JSON.parse(s.measurements); } catch (e) { return {}; } }
            return s.measurements || {};
        }

        function renderGlobalTable() {
            const pr = document.getElementById('filter-priority').value, pa = document.getElementById('filter-packed').value, cl = document.getElementById('filter-class').value, sc = document.getElementById('filter-section').value, ho = document.getElementById('filter-house').value, ge = document.getElementById('filter-gender').value, pt = document.getElementById('filter-pattern').value, it = document.getElementById('filter-item').value, se = document.getElementById('date-search').value.toLowerCase();

            // 1. Filter
            const f = globalStudents.filter(s => {
                const m = getMeasurementsSafe(s);
                if (pr !== 'all' && s.school_priority !== pr) return false;
                if (pa === 'packed' && !s.is_packed) return false;
                if (pa === 'pending' && s.is_packed) return false;
                if (!advancedMatch(s.class, cl)) return false;
                if (!advancedMatch(s.section, sc)) return false;
                if (!advancedMatch(s.house, ho)) return false;
                if (ge && s.gender !== ge) return false;
                if (pt !== 'all' && s.pattern_id != pt) return false;
                if (se && !(s.name || '').toLowerCase().includes(se) && !(s.roll_no || '').toLowerCase().includes(se) && !(s.school_name || '').toLowerCase().includes(se)) return false;
                if (it !== 'all') {
                    const i = allItems.find(x => x.name === it);
                    if (i) {
                        if ((i.type === 'Male' && s.gender === 'Female') || (i.type === 'Female' && s.gender === 'Male')) return false;
                    }
                }
                return true;
            });

            // 2. Setup Columns for Measurement
            let showCols = [];
            const measHeader = document.getElementById('th-measurements');
            const subRow = document.getElementById('th-sub-row');

            if (it !== 'all') {
                const def = allItems.find(x => x.name === it);
                if (def) {
                    showCols = def.cols;
                    measHeader.innerText = def.name;
                    measHeader.colSpan = showCols.length;
                }
            } else {
                measHeader.innerText = "Measurements (Select Item)";
                measHeader.colSpan = 1;
            }

            // 3. Render sub-headers
            if (showCols.length > 0) {
                subRow.classList.remove('hidden');
                subRow.innerHTML = `
                    <th colspan="4" class="bg-stone-50 border-r"></th>
                    ${showCols.map(c => `<th class="p-2 text-center border-x border-amber-200 text-amber-900 bg-amber-100">${c}</th>`).join('')}
                    <th></th>
                `;
            } else {
                subRow.classList.add('hidden');
            }

            // 4. Render Body
            document.getElementById('record-count').innerText = `Showing ${f.length} records`;
            document.getElementById('global-table-body').innerHTML = f.map(s => {
                const m = getMeasurementsSafe(s);
                let measCells = '';
                if (showCols.length > 0) {
                    measCells = showCols.map(k => `<td class="p-4 text-center border-b border-stone-100 font-mono font-bold text-stone-700 bg-amber-50/20">${m[k.toLowerCase()] || '-'}</td>`).join('');
                } else {
                    measCells = `<td class="p-4 border-b border-stone-100 text-xs italic text-stone-400">Select Item...</td>`;
                }

                return `<tr class="hover:bg-blue-50 transition-colors group">
                    <td class="p-4 border-b border-stone-100 sticky left-0 bg-stone-50/50">
                        <div class="font-bold text-stone-800">${s.school_name}</div>
                        <div class="text-[10px] text-stone-500">${s.school_priority || 'Normal'}</div>
                    </td>
                    <td class="p-4 border-b border-stone-100">
                        <div class="font-medium text-stone-900">${s.name}</div>
                        <div class="text-xs text-stone-500">Roll: ${s.roll_no || '-'}</div>
                    </td>
                    <td class="p-4 border-b border-stone-100">
                        <div class="text-sm">Class ${s.class || '-'} ${s.section || ''}</div>
                        <div class="text-xs text-stone-400">${s.house || ''} ${s.gender ? '(' + s.gender + ')' : ''}</div>
                    </td>
                    <td class="p-4 border-b border-stone-100 text-xs font-mono text-stone-600">
                        ${s.pattern_name ? `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md font-bold">${s.pattern_name}</span>` : '-'}
                    </td>
                    ${measCells}
                    <td class="p-4 border-b border-stone-100 text-center">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${s.is_packed ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">${s.is_packed ? 'PACKED' : 'PENDING'}</span>
                    </td>
                </tr>`;
            }).join('');

            // Store filtered data & cols for export
            window.filteredDataForExport = f;
            window.currentCols = showCols;
        }

        // Removed renderMeasurements Helper as it's now inline
        function dummy() { }

        function renderCharts() {
            const p = globalStudents.filter(s => s.is_packed).length, pe = globalStudents.length - p;
            // Destroy exists?
            new Chart(document.getElementById('chart-packing'), { type: 'doughnut', data: { labels: ['Packed', 'Pending'], datasets: [{ data: [p, pe], backgroundColor: ['#10b981', '#f59e0b'], borderWidth: 0 }] }, options: { maintainAspectRatio: false } });
            const sc = {}; globalStudents.forEach(s => { sc[s.school_name] = (sc[s.school_name] || 0) + 1 });
            new Chart(document.getElementById('chart-schools'), { type: 'bar', data: { labels: Object.keys(sc), datasets: [{ label: 'Student Count', data: Object.values(sc), backgroundColor: '#1c1917', borderRadius: 4 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        async function createUser(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/users/create`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("User Created!"); e.target.reset(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function generateCode() { const sid = document.getElementById('access-school-select').value, type = document.getElementById('access-type').value, hrs = document.getElementById('access-expiry').value; try { const r = await fetch(`${API_BASE}/data/access_codes`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ school_id: sid, type, expires_in_hours: parseFloat(hrs) }) }); if (r.ok) { alert(`Code Created: ${(await r.json()).code}`); fetchAccessCodes(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function toggleCode(id, a) { if (!confirm(a ? "Activate?" : "Revoke?")) return; await fetch(`${API_BASE}/data/access_codes/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchAccessCodes(); }
        async function toggleUserStatus(id, a, n) { if (confirm(a ? "Enable?" : "Disable?")) await fetch(`${API_BASE}/data/users/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchUsers(); }
        async function registerSchool(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/schools`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("School Registered!"); document.getElementById('school-modal').classList.add('hidden'); e.target.reset(); fetchSchoolsForSelect(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert("Failed"); } }
        function openSchoolModal() { document.getElementById('school-modal').classList.remove('hidden'); }
        function toggleSchoolSelect() { const r = document.getElementById('user-role').value, s = document.getElementById('school-select-wrapper'); if (r === 'company') s.classList.add('hidden'); else s.classList.remove('hidden'); }
        async function fixDatabase() { if (confirm("Maintain DB?")) { await fetch(`${API_BASE}/data/migrate`, { method: 'POST' }); location.reload(); } }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // CLIENT SIDE EXPORTS (Filtered)
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = window.filteredDataForExport || globalStudents;
            const cols = window.currentCols || [];

            doc.text("Tailoring Data Report", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            let head = [['School', 'Name', 'Class', 'Gender', 'Pattern']];

            if (cols.length > 0) head[0].push(...cols);
            else head[0].push("Measurements");

            head[0].push('Packed');

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name,
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.gender || '-',
                    s.pattern_name || '-'
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push("Select Item to View Details");
                }

                row.push(s.is_packed ? 'Yes' : 'No');
                return row;
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [244, 63, 94] }
            });

            doc.save("Global_Report.pdf");
        }

        function downloadExcel() {
            const data = window.filteredDataForExport || globalStudents;
            const cols = window.currentCols || [];

            const exportData = data.map(s => {
                const m = getMeasurementsSafe(s);
                const base = {
                    "School": s.school_name,
                    "Student Name": s.name,
                    "Admission No": s.admission_no,
                    "Class": s.class,
                    "Section": s.section,
                    "House": s.house,
                    "Gender": s.gender,
                    "Pattern": s.pattern_name,
                    "Status": s.is_packed ? "Packed" : "Pending"
                };

                if (cols.length > 0) {
                    cols.forEach(k => base[k] = m[k.toLowerCase()] || '');
                } else {
                    base["Measurements"] = "Select Item to View Details";
                }
                return base;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "GlobalData");
            XLSX.writeFile(wb, "Tailoring_Report.xlsx");
        }


        // COMPLAINTS LOGIC
        let currentComplaintId = null;

        // COMPLAINTS ANALYTICS LOGIC
        let rawComplaints = [];
        let filteredComplaints = [];
        let chartIssues = null;
        let chartStatus = null;

        async function fetchComplaints() {
            try {
                const res = await fetch(`${API_BASE}/data/complaints`, { headers: { 'Authorization': `Bearer ${token}` } });
                rawComplaints = await res.json();
                if (!Array.isArray(rawComplaints)) rawComplaints = [];

                // Populate Filter Dropdowns (Patterns)
                const patterns = new Set();
                rawComplaints.forEach(c => {
                    if (c.pattern_name) {
                        c.pattern_name.split(',').forEach(p => patterns.add(p.trim()));
                    }
                });
                const sel = document.getElementById('c-filter-pattern');
                const currentVal = sel.value;
                sel.innerHTML = '<option value="all">All Patterns</option>' +
                    Array.from(patterns).sort().map(p => `<option value="${p}">${p}</option>`).join('');
                sel.value = currentVal;

                renderComplaintDash();
            } catch (e) { console.error("Complaints Error", e); }
        }

        function renderComplaintDash() {
            // 1. Filter Data
            const sFil = document.getElementById('c-filter-school').value.toLowerCase();
            const pFil = document.getElementById('c-filter-pattern').value;
            const gFil = document.getElementById('c-filter-gender').value;

            filteredComplaints = rawComplaints.filter(c => {
                if (sFil && !c.school_name.toLowerCase().includes(sFil)) return false;
                if (gFil !== 'all' && c.gender !== gFil) return false;
                if (pFil !== 'all' && (!c.pattern_name || !c.pattern_name.includes(pFil))) return false;
                return true;
            });

            // 2. Update Stats
            const total = filteredComplaints.length;
            const resolved = filteredComplaints.filter(c => c.status === 'Resolved').length;
            const open = total - resolved;

            document.getElementById('c-stat-total').innerText = total;
            document.getElementById('c-stat-open').innerText = open;
            document.getElementById('c-stat-resolved').innerText = resolved;

            // 3. Update Charts
            updateComplaintCharts(filteredComplaints);

            // 4. Render School Cards (Grouping)
            const grid = document.getElementById('school-complaints-grid');
            grid.innerHTML = '';

            if (total === 0) {
                document.getElementById('c-no-data').classList.remove('hidden');
                return;
            }
            document.getElementById('c-no-data').classList.add('hidden');

            // Group by School ID
            const schools = {};
            filteredComplaints.forEach(c => {
                if (!schools[c.school_id]) {
                    schools[c.school_id] = { name: c.school_name, count: 0, open: 0, resolved: 0, tickets: [] };
                }
                schools[c.school_id].count++;
                if (c.status === 'Resolved') schools[c.school_id].resolved++;
                else schools[c.school_id].open++;
                schools[c.school_id].tickets.push(c);
            });

            Object.values(schools).sort((a, b) => b.open - a.open).forEach(s => {
                const div = document.createElement('div');
                div.className = "glass-panel p-6 rounded-xl hover:shadow-xl transition-all cursor-pointer border hover:border-rose-300 relative group overflow-hidden";
                div.onclick = () => openSchoolComplaints(s);

                div.innerHTML = `
                    <div class="absolute top-0 right-0 w-24 h-24 bg-rose-50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2 group-hover:bg-rose-100 transition-colors"></div>
                    <div class="relative z-10 flex justify-between items-start mb-4">
                        <div class="w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center text-rose-600 font-bold text-xl border border-stone-100">
                             ${s.name.charAt(0)}
                        </div>
                        ${s.open > 0 ? `<span class="bg-rose-600 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg shadow-rose-200">${s.open} Open</span>` : `<span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full text-xs font-bold">All Good</span>`}
                    </div>
                    <h3 class="relative z-10 font-ink text-xl font-bold text-stone-800 mb-1 truncate">${s.name}</h3>
                    <p class="relative z-10 text-xs text-stone-500 uppercase font-bold tracking-wider">${s.count} Total Items</p>
                `;
                grid.appendChild(div);
            });
        }

        function updateComplaintCharts(data) {
            // 1. Calculate Aggregates
            const patternCounts = {};
            const issueCounts = {};

            data.forEach(c => {
                // Patterns
                if (c.pattern_name) {
                    c.pattern_name.split(',').forEach(p => {
                        const cleanP = p.trim();
                        if (cleanP) patternCounts[cleanP] = (patternCounts[cleanP] || 0) + 1;
                    });
                }

                // Issues (Parse "Pattern (Issue)" format)
                if (c.issue_type) {
                    c.issue_type.split(',').forEach(i => {
                        let cleanI = i.trim();
                        if (cleanI.includes('(')) {
                            // Extract content between parenthesis e.g., "Size Mismatch" from "Shirt (Size Mismatch)"
                            const match = cleanI.match(/\(([^)]+)\)/);
                            if (match && match[1]) cleanI = match[1].trim();
                        }
                        if (cleanI) issueCounts[cleanI] = (issueCounts[cleanI] || 0) + 1;
                    });
                }
            });

            // 2. Identify Hotspots (Top 1)
            const topPattern = Object.entries(patternCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
            const topIssue = Object.entries(issueCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];

            document.getElementById('c-top-pattern').innerText = topPattern[0];
            document.getElementById('c-top-pattern-count').innerText = `${topPattern[1]} complaints`;

            document.getElementById('c-top-issue').innerText = topIssue[0];
            document.getElementById('c-top-issue-count').innerText = `${topIssue[1]} occurrences`;


            // 3. Render Chart 1: Top 10 Patterns (Horizontal Bar)
            const ctx1 = document.getElementById('chart-patterns');
            if (chartIssues) chartIssues.destroy(); // using same var name for convenience, represents "Patterns" now

            // Sort and Slice Top 10
            const sortedPatterns = Object.entries(patternCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            chartIssues = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedPatterns.map(x => x[0]),
                    datasets: [{
                        label: 'Complaints',
                        data: sortedPatterns.map(x => x[1]),
                        backgroundColor: '#f43f5e',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });

            // 4. Render Chart 2: Defect Types (Doughnut)
            const ctx2 = document.getElementById('chart-issues'); // using same ID in HTML, different concept
            if (chartStatus) chartStatus.destroy(); // represents "Issues" now

            const sortedIssues = Object.entries(issueCounts).sort((a, b) => b[1] - a[1]);

            chartStatus = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: sortedIssues.map(x => x[0]),
                    datasets: [{
                        data: sortedIssues.map(x => x[1]),
                        backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#6366f1', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function openSchoolComplaints(schoolData) {
            document.getElementById('tm-school-name').innerText = schoolData.name;
            document.getElementById('tm-school-stats').innerText = `${schoolData.open} Active • ${schoolData.resolved} Resolved`;

            const list = document.getElementById('tm-list');
            list.innerHTML = schoolData.tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(c => {
                const isResolved = c.status === 'Resolved';
                let images = [];
                try { images = JSON.parse(c.image_url || '[]'); } catch (e) { if (c.image_url) images = [c.image_url]; }

                return `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 mb-4 animate-in slide-in-from-bottom-2 duration-300">
                         <div class="flex justify-between items-start mb-4">
                             <div>
                                 <span class="text-[10px] bg-stone-100 text-stone-500 px-2 py-1 rounded uppercase font-bold tracking-wider">${new Date(c.created_at).toLocaleDateString()}</span>
                                 <div class="mt-2 text-sm text-stone-900 font-bold">${c.student_name || 'Generic Ticket'} <span class="text-stone-400 font-normal">(${c.student_reg_no || '-'})</span></div>
                                 <div class="text-xs text-stone-500">${c.class || ''} ${c.section || ''} ${c.house ? '• ' + c.house : ''} ${c.gender ? '• ' + c.gender : ''}</div>
                             </div>
                             <div class="text-right">
                                 <select onchange="updateTicketStatus(${c.id}, this.value)" class="text-xs font-bold uppercase rounded px-2 py-1 border ${isResolved ? 'bg-green-50 text-green-700 border-green-200' : 'bg-rose-50 text-rose-700 border-rose-200'}">
                                     <option value="Open" ${!isResolved ? 'selected' : ''}>Open</option>
                                     <option value="Resolved" ${isResolved ? 'selected' : ''}>Resolved</option>
                                 </select>
                             </div>
                         </div>
                         
                         <!-- Issue Specs -->
                         <div class="bg-stone-50 p-3 rounded border border-stone-100 mb-3 text-xs">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                  <div>
                                     <span class="block font-bold text-stone-400 uppercase text-[10px]">Patterns</span>
                                     <span class="text-stone-700">${c.pattern_name || '-'}</span>
                                  </div>
                                  <div>
                                     <span class="block font-bold text-stone-400 uppercase text-[10px]">Issues</span>
                                     <span class="text-stone-700">${c.issue_type || '-'}</span>
                                  </div>
                             </div>
                         </div>

                         <p class="text-stone-600 text-sm mb-4">"${c.comment}"</p>
                         
                         <!-- Images -->
                         ${images.length > 0 ? `<div class="flex gap-2 overflow-x-auto pb-2">${images.map(u => `<img src="${u}" onclick="window.open('${u}')" class="h-16 w-16 rounded object-cover border border-stone-200 cursor-pointer hover:border-rose-400">`).join('')}</div>` : ''}
    
                         <!-- Actions -->
                         <div class="border-t border-stone-100 pt-3 mt-3 flex justify-between items-center">
                             ${c.reply ? `<p class="text-xs text-stone-500 italic">Reply: ${c.reply}</p>` : `<button onclick="openReplyModal(${c.id}, '${c.school_name}')" class="text-xs font-bold text-rose-600 hover:underline">Reply to School</button>`}
                             
                         </div>
                    </div>
                 `;
            }).join('');

            document.getElementById('ticketModal').showModal();
        }

        async function updateTicketStatus(id, newStatus) {
            // Optimistic Update? No, let's fetch.
            try {
                // Reuse reply endpoint or new status toggler? 
                // We don't have a status toggle route yet explicitly in previous summary, 
                // but 'PUT /api/data/complaints/:id' works for full updates. 
                // Let's assume we can enable a standard update.
                // Wait, the previous code for PUT used: db.run("UPDATE complaints SET rating = ?, comment = ?, image_url = ? ...")
                // It did NOT update status. 
                // Checking backend... we need to ensure backend supports status update!
                // If not, we fall back to just display for now, or use 'reply' to resolve. 
                // Let's assume simple reply for now is the main interaction, OR use the reply endpoint to also close it if needed. 
                // Actually, let's stick to just viewing for safety unless I patch the backend. 
                // User asked for "update complaint style". I will leave status changing as visual for now or patch backend if I can.
                // Let's create a quick patch in next step if broken.
                alert("Status update requires Backend Patch. Coming soon.");
            } catch (e) { }
        }

        function generateComplaintReport() {
            downloadExcel();
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            // Header
            doc.setFontSize(18);
            doc.text("Planetsolutions - Complaint Report", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 26);

            // Stats
            const total = document.getElementById('c-stat-total')?.innerText || '0';
            const open = document.getElementById('c-stat-open')?.innerText || '0';
            doc.text(`Total: ${total} | Open: ${open}`, 14, 32);

            // Table Data
            const tableRows = filteredComplaints.map(c => [
                new Date(c.created_at).toLocaleDateString(),
                c.school_name,
                c.student_name + ` (${c.student_reg_no || '-'})`,
                c.gender,
                (c.pattern_name || '-').substring(0, 30),
                (c.issue_type || '-').substring(0, 30),
                c.status
            ]);

            doc.autoTable({
                startY: 36,
                head: [['Date', 'School', 'Student', 'Gender', 'Patterns', 'Issues', 'Status']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: [244, 63, 94] },
                styles: { fontSize: 8 },
            });

            doc.save(`complaints_report_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            const excelData = filteredComplaints.map(c => ({
                "Date": new Date(c.created_at).toLocaleDateString(),
                "School": c.school_name,
                "Student": c.student_name,
                "Reg No": c.student_reg_no,
                "Class": c.class,
                "Section": c.section,
                "Gender": c.gender,
                "Status": c.status,
                "Patterns": c.pattern_name,
                "Issues": c.issue_type,
                "Comment": c.comment,
                "Reply": c.reply || ''
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wscols = Object.keys(excelData[0] || {}).map(k => ({ wch: 20 }));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Complaints");
            XLSX.writeFile(wb, `complaints_report_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function openReplyModal(id, schoolName) {
            currentComplaintId = id;
            document.getElementById('reply-school-name').innerText = `Replying to: ${schoolName}`;
            document.getElementById('reply-text').value = '';

            // Force close ticket modal to fix stacking
            const tm = document.getElementById('ticketModal');
            if (tm) tm.close();

            const rm = document.getElementById('reply-modal');
            rm.classList.remove('hidden');
            rm.style.zIndex = '9999';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden');
            currentComplaintId = null;
        }

        async function submitReply() {
            if (!currentComplaintId) return;
            const text = document.getElementById('reply-text').value;
            if (!text.trim()) return alert("Please write a reply.");

            try {
                const res = await fetch(`${API_BASE}/data/complaints/${currentComplaintId}/reply`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ reply: text })
                });

                if (res.ok) {
                    alert("Reply Sent!");
                    closeReplyModal();
                    fetchComplaints();
                } else {
                    alert("Failed to send reply");
                }
            } catch (e) { alert(e.message); }
        }

        document.getElementById('nav-overview').classList.add('active'); init().then(() => {
            // Auto Refresh Pollers
            setInterval(() => { fetchStats(); }, 30000);
            setInterval(() => { if (!document.getElementById('view-complaints').classList.contains('hidden')) fetchComplaints(); }, 15000);
        });
    </script>

    <!-- REPLY MODAL -->
    <div id="reply-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h3 class="text-xl font-ink mb-2">Reply to Complaint</h3>
            <p class="text-xs text-stone-500 mb-4" id="reply-school-name">School Name</p>
            <textarea id="reply-text" rows="4"
                class="w-full border rounded-lg p-3 text-sm focus:border-rose-500 outline-none"
                placeholder="Write your response here..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeReplyModal()"
                    class="px-4 py-2 text-xs font-bold text-stone-500 hover:bg-stone-100 rounded">CANCEL</button>
                <button onclick="submitReply()"
                    class="px-4 py-2 text-xs font-bold bg-rose-600 text-white rounded hover:bg-rose-700">SEND
                    REPLY</button>
            </div>
        </div>
    </div>

    <script>
        async function resetDatabase() {
            if (!confirm("⚠️ DANGER: This will DELETE ALL PATTERNS, MEASUREMENTS and UNLINK STUDENTS from the database.\\n\\nThis action cannot be undone on Production.\\n\\nType 'RESET' to confirm:")) return;

            const conf = prompt("Type 'RESET' to confirm deletion:");
            if (conf !== 'RESET') return alert("Cancelled.");

            try {
                const res = await fetch(`${API_BASE}/data/reset_tables`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const d = await res.json();
                if (!res.ok) throw new Error(d.error || "Reset failed");
                alert("✅ " + d.message);
                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function fixDatabase() {
            if (!confirm("Attempt to repair database schema? (Adds missing tables/columns)")) return;
            try {
                const res = await fetch(`${API_BASE}/data/fix_db`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await res.json();
                alert(d.message);
            } catch (e) {
                alert("Repair Error: " + e.message);
            }
        }
    </script>

</body>

</html>