<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Admin | Clay Command</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            /* Snow White & Pastels */
            --clay-bg: #f2fcf0;
            --clay-surface: #ffffff;

            /* Shadows for White-on-Green (Sage Tinted) */
            --shadow-light: 10px 10px 30px rgba(160, 175, 165, 0.4),
                -10px -10px 30px rgba(255, 255, 255, 0.8);
            --shadow-pressed: inset 6px 6px 10px rgba(160, 175, 165, 0.2),
                inset -6px -6px 10px rgba(255, 255, 255, 1);

            /* Pastel Accents */
            --accent-blue: #A0C4FF;
            /* Soft Blue */
            --accent-pink: #FFADAD;
            /* Soft Pink */
            --accent-peach: #FFD6A5;
            /* Peach */
            --accent-mint: #CAFFBF;
            /* Mint */
            --accent-purple: #BDB2FF;
            /* Keep for legacy or replace */

            /* Text */
            --text-main: #4A5568;
            --text-light: #A0AEC0;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background-color: var(--clay-bg);
            color: var(--text-main);
            overflow-x: hidden;
            /* Fix layout overflow gap */
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        /* --- CLAY COMPONENTS --- */

        /* 1. Cards: Inflated, floating */
        .clay-card {
            background-color: var(--clay-surface);
            border-radius: 30px;
            /* Super rounded */
            box-shadow: var(--shadow-light);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: transform 0.3s ease;
        }

        /* 2. Buttons: Pressable 3D Objects */
        .clay-btn {
            background-color: var(--clay-surface);
            border-radius: 20px;
            padding: 12px 24px;
            font-weight: 800;
            /* Chunky text */
            color: var(--text-main);
            border: none;
            outline: none;
            cursor: pointer;
            box-shadow: var(--shadow-light);
            transition: all 0.1s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Press Animation */
        .clay-btn:active,
        .clay-btn.active {
            box-shadow: var(--shadow-pressed);
            transform: scale(0.95);
            color: var(--accent-purple);
        }

        /* Primary Button (Colored Clay) */
        .clay-primary {
            background: var(--clay-surface);
            /* Keep surface to show inset shadow well, or use gradient? */
            color: var(--accent-purple);
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .clay-primary:hover {
            color: #8854d0;
        }

        /* 3. Inputs: Deeply Pressed */
        .clay-input {
            width: 100%;
            background-color: var(--clay-surface);
            border: none;
            border-radius: 15px;
            padding: 16px 20px;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            color: var(--text-main);
            box-shadow: var(--shadow-pressed);
            /* Permanent pressed look */
            outline: none;
            transition: all 0.2s;
        }

        .clay-inner {
            box-shadow: var(--shadow-pressed);
        }

        .clay-input:focus {
            box-shadow: inset 4px 4px 8px rgba(166, 180, 200, 0.5),
                inset -4px -4px 8px rgba(255, 255, 255, 0.9),
                0 0 0 3px rgba(165, 94, 234, 0.3);
            /* Focus ring */
        }

        /* 4. Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--clay-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
            border: 3px solid var(--clay-bg);
        }

        /* Animations */
        @keyframes popIn {
            0% {
                transform: scale(0.9);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .fade-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col md:flex-row selection:bg-purple-200 selection:text-purple-900">

    <!-- Mobile Header -->
    <div class="md:hidden p-4 flex justify-between items-center z-50 sticky top-0 bg-opacity-80 backdrop-blur-md"
        style="background-color: var(--clay-bg);">
        <h1 class="text-xl font-extrabold flex items-center gap-2 text-gray-700">
            <span
                class="w-10 h-10 rounded-xl clay-primary flex items-center justify-center font-bold text-xl shadow-inner text-white"
                style="background: var(--accent-purple);">P</span>
            Planet Admin
        </h1>
        <button onclick="toggleSidebar()" class="clay-btn p-2 rounded-xl text-gray-500">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>
    </div>

    <!-- Backdrop -->
    <div id="sidebar-backdrop" onclick="toggleSidebar()"
        class="fixed inset-0 bg-gray-900/10 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300 md:hidden">
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 w-72 md:w-72 md:m-6 md:rounded-3xl clay-card transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50 flex flex-col scale-95 md:scale-100 origin-left border-none">

        <!-- Brand -->
        <div class="p-8 flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl clay-primary flex items-center justify-center text-2xl font-bold shadow-inner text-white"
                style="background: var(--accent-blue);">
                P
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-gray-700 tracking-tight">Planet</h1>
                <p
                    class="text-[10px] font-bold text-blue-400 uppercase tracking-widest bg-blue-50 px-2 py-0.5 rounded-full inline-block mt-1">
                    Clay Command</p>
            </div>
        </div>

        <!-- User Profile Mini -->
        <div class="mx-6 p-4 clay-input !w-auto flex items-center gap-3 mb-6 shadow-inner">
            <div
                class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-400 to-blue-500 text-white flex items-center justify-center font-bold text-lg shadow-lg">
                A
            </div>
            <div>
                <p class="text-sm font-bold text-gray-700">Admin User</p>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(74,222,128,0.8)]"></span>
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Online</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 space-y-3 overflow-y-auto py-2">
            <button onclick="switchTab('overview')" id="nav-overview"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Overview
            </button>
            <button onclick="switchTab('data')" id="nav-data"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
                    </path>
                    <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                    <line x1="12" y1="22.08" x2="12" y2="12"></line>
                </svg>
                Tailoring Data
            </button>
            <button onclick="switchTab('users')" id="nav-users"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                User Management
            </button>
            <button onclick="switchTab('access')" id="nav-access"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Access Codes
            </button>
            <button onclick="switchTab('schools')" id="nav-schools"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18"></path>
                    <path d="M5 21V7l8-4 8 4v14"></path>
                    <path d="M17 21v-8.5"></path>
                </svg>
                Schools
            </button>
            <button onclick="switchTab('reports')" id="nav-reports"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                Reports
            </button>
            <button onclick="switchTab('complaints'); fetchComplaints()" id="nav-complaints"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 rounded-xl text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z">
                    </path>
                </svg>
                Complaints
            </button>
            <button onclick="switchTab('settings'); fetchSettings()" id="nav-settings"
                class="nav-item clay-btn w-full flex items-center gap-4 px-6 py-4 rounded-xl text-sm mb-1 text-gray-600 hover:text-blue-600 transition-all">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
                Settings
            </button>

            <div class="h-px bg-gray-300/50 mx-4 my-2"></div>

            <button onclick="window.open('pattern_view.html', '_blank')"
                class="clay-btn w-full flex items-center gap-4 px-6 py-3 text-sm text-blue-400">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                Open Pattern Manager
            </button>
        </nav>
        <div class="p-6">
            <button onclick="logout()"
                class="w-full clay-btn py-3 text-xs font-extrabold text-gray-500 hover:text-red-500 uppercase tracking-wider">
                Sign Out
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col relative md:ml-96 transition-all duration-300 isolate">
        <!-- Background Decor (Watercolor Effect) -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none -z-10">
            <!-- Top Right Organic Blob -->
            <div
                class="absolute -top-[10%] -right-[5%] w-[700px] h-[700px] rounded-full bg-[#e2f7e7] blur-[100px] opacity-80 mix-blend-multiply">
            </div>
            <div
                class="absolute top-[5%] -right-[10%] w-[600px] h-[600px] rounded-full bg-[#dcfce7] blur-[80px] opacity-70 mix-blend-multiply">
            </div>

            <!-- Bottom Left Soft Wash -->
            <div
                class="absolute -bottom-[10%] -left-[10%] w-[800px] h-[800px] rounded-full bg-[#f0fdf4] blur-[120px] opacity-60">
            </div>
        </div>
        <!-- Header -->
        <div id="vertical-enforcer" class="flex flex-col w-full relative min-h-screen">
            <!-- Header -->
            <header id="global-header" class="px-8 py-6 flex justify-between items-center z-30 w-full gap-8">
                <div class="flex-1 min-w-0">
                    <h2 id="page-title"
                        class="text-2xl font-extrabold text-gray-700 tracking-tight whitespace-nowrap overflow-hidden text-overflow-ellipsis">
                        System Overview</h2>
                    <p id="page-subtitle" class="text-sm font-bold text-gray-400 mt-1 uppercase tracking-wide truncate">
                        Manage Planet
                        Solutions tailors & operations</p>
                </div>

            </header>

            <!-- 3. USER MANAGEMENT (Relocated to Top) -->
            <div id="view-users" class="hidden fade-in space-y-8 w-full px-8 pb-8">

                <!-- A. REGISTRATION FORM (Always Visible) -->
                <div class="clay-card p-8 w-full">
                    <div class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-700">Account Registration</h3>
                            <p class="text-sm text-gray-400">Add new administrators or staff members.</p>
                        </div>
                        <button onclick="openSchoolModal()"
                            class="clay-btn clay-primary px-4 py-2 text-xs font-bold shadow-md hover:shadow-lg border-none transition-transform active:scale-95">
                            Register New School
                        </button>
                    </div>

                    <form onsubmit="createUser(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Username</label>
                                <input type="text" name="username" required class="clay-input w-full p-3 text-sm">
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Password</label>
                                <input type="text" name="password" required class="clay-input w-full p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Role</label>
                                <select name="role" id="user-role" onchange="toggleSchoolSelect()"
                                    class="clay-input w-full p-3 text-sm">
                                    <option value="school">School Admin</option>
                                    <option value="tailor">Tailor</option>
                                    <option value="packing">Packing Unit</option>
                                    <option value="company">Company Admin</option>
                                </select>
                            </div>
                        </div>

                        <div id="school-select-wrapper" class="w-full">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Assign To
                                School</label>
                            <select name="school_id" id="school-select" class="clay-input w-full p-3 text-sm"></select>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit"
                                class="clay-btn clay-primary px-10 py-3 rounded-xl text-sm font-bold shadow-md transition-transform active:scale-95">
                                Create Account
                            </button>
                        </div>
                    </form>
                </div>

                <!-- B. EXISTING USERS TABLE -->
                <div class="clay-card p-8 w-full">
                    <h3 class="text-lg font-bold text-gray-600 mb-6">Existing Accounts</h3>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="w-full text-sm min-w-[600px]">
                            <thead>
                                <tr
                                    class="bg-slate-50/80 border-b border-indigo-100 backdrop-blur-sm sticky top-0 z-10">
                                    <th
                                        class="p-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-left pl-6">
                                        USERNAME</th>
                                    <th class="p-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-left">
                                        ROLE</th>
                                    <th class="p-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-left">
                                        SCHOOL</th>
                                    <th
                                        class="p-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-center">
                                        STATUS</th>
                                    <th
                                        class="p-4 text-xs font-bold text-slate-400 uppercase tracking-wider text-right">
                                        ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- UNIVERSAL VIEW CONTAINER (Relocated Sections) -->

            <!-- 4. ACCESS CODES -->
            <div id="view-access" class="hidden fade-in space-y-8 w-full">
                <div class="clay-card p-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-6">Generate Secure Link</h3>
                    <div class="flex flex-col md:flex-row gap-6 items-end">
                        <div class="w-full md:flex-1">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Target
                                School</label>
                            <select id="access-school-select" class="clay-input"></select>
                        </div>
                        <div class="w-full md:w-48">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Role Type</label>
                            <select id="access-type" class="clay-input">
                                <option value="tailor">Tailor (Measurements)</option>
                                <option value="packing">Packing (Status)</option>
                            </select>
                        </div>
                        <div class="w-full md:w-32">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Expires In</label>
                            <select id="access-expiry" class="clay-input">
                                <option value="24">24 Hours</option>
                                <option value="48">48 Hours</option>
                                <option value="168">7 Days</option>
                            </select>
                        </div>
                        <button onclick="generateCode()"
                            class="w-full md:w-auto clay-btn clay-primary px-8 py-3 rounded-xl font-bold uppercase text-sm shadow-xl transition-transform active:scale-95">
                            Generate
                        </button>
                    </div>
                </div>

                <div class="clay-card p-8">
                    <h3 class="text-lg font-bold text-gray-600 mb-4">Active & Inactive Codes</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[600px]">
                            <thead>
                                <tr class="border-b border-white/50 text-gray-400 font-bold uppercase text-xs">
                                    <th class="text-left pb-3">School</th>
                                    <th class="text-left pb-3">Code</th>
                                    <th class="text-left pb-3">Type</th>
                                    <th class="text-center pb-3">Status</th>
                                    <th class="text-right pb-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="access-code-list" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. SCHOOLS -->
            <div id="view-schools" class="hidden fade-in space-y-8 w-full">
                <!-- Content Preserved -->
                <div class="clay-card p-8">
                    <div class="flex items-center justify-between mb-6 border-b border-white/50 pb-4">
                        <div>
                            <div>
                                <!-- Header -->
                            </div>
                        </div>
                        <button onclick="fixDatabase()"
                            class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-2 rounded-lg font-bold text-xs uppercase shadow-sm flex items-center gap-2 transition-colors border border-blue-200">
                            <span class="text-lg">üîß</span> Repair Database
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[800px]">
                            <thead class="bg-gray-50/50 text-gray-500 uppercase text-xs font-bold rounded-lg">
                                <tr>
                                    <th class="p-3 text-left">School Name</th>
                                    <th class="p-3 text-left w-48">Priority</th>
                                    <th class="p-3 text-left w-48">Status</th>
                                    <th class="p-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="school-list-body" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>



            <!-- 7. REPORTS (LOGGING SYSTEM) -->
            <div id="view-reports" class="hidden fade-in space-y-10 w-full px-8 pb-8">

                <!-- SECTION 1: GLOBAL REPORTS -->
                <div>
                    <h2 class="font-ink text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <span class="text-emerald-600">‚óè</span> General Reports
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

                        <!-- 1. School Data Report -->
                        <div class="clay-card p-6 flex flex-col gap-4 group hover:scale-[1.02] transition-transform">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-cyan-100 text-cyan-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-700 text-lg">School Data</h3>
                                    <p class="text-xs text-gray-400 font-bold uppercase">Student Lists & Measurements
                                    </p>
                                </div>
                            </div>
                            <div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Select School</label>
                                <select id="report-school-select"
                                    class="w-full text-sm font-bold text-gray-600 bg-gray-50 border-none rounded-lg p-2 focus:ring-2 focus:ring-cyan-500/20">
                                    <option value="">Loading Schools...</option>
                                </select>
                                <div class="flex gap-2">
                                    <button onclick="downloadSchoolReportPDF()"
                                        class="flex-1 py-2 bg-red-50 text-red-600 font-bold uppercase text-xs rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        PDF
                                    </button>
                                    <button onclick="downloadSchoolReport()"
                                        class="flex-1 py-2 bg-cyan-50 text-cyan-600 font-bold uppercase text-xs rounded-lg hover:bg-cyan-100 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                        Excel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 2. User List Report -->
                        <div class="clay-card p-6 flex flex-col gap-4 group hover:scale-[1.02] transition-transform">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-700 text-lg">User Management</h3>
                                    <p class="text-xs text-gray-400 font-bold uppercase">System Access Registry</p>
                                </div>
                            </div>
                            <div class="mt-auto pt-4 border-t border-gray-100">
                                <div class="flex gap-2">
                                    <button onclick="downloadUserReportPDF()"
                                        class="flex-1 py-2 bg-red-50 text-red-600 font-bold uppercase text-xs rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        PDF
                                    </button>
                                    <button onclick="downloadUserReport()"
                                        class="flex-1 py-2 bg-orange-50 text-orange-600 font-bold uppercase text-xs rounded-lg hover:bg-orange-100 transition-colors flex items-center justify-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                        Excel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 3. AI Insights -->
                        <!-- 3. AI Insights (Dynamic) -->
                        <div
                            class="clay-card p-6 flex flex-col gap-4 group hover:scale-[1.02] transition-transform relative overflow-hidden bg-gradient-to-br from-white to-violet-50">
                            <!-- Animated Background/Pulse -->
                            <div
                                class="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-violet-400/20 rounded-full blur-2xl animate-pulse">
                            </div>

                            <div class="flex items-start justify-between relative z-10">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-12 h-12 rounded-xl bg-violet-100 text-violet-600 flex items-center justify-center shadow-inner">
                                        <svg class="w-6 h-6 animate-[spin_10s_linear_infinite]" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-700 text-lg">AI Analyst</h3>
                                        <p class="text-xs text-violet-500 font-bold uppercase tracking-wider animate-pulse"
                                            id="ai-status-text">Scanning Data...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamic Content Area -->
                            <div class="mt-auto relative z-10 min-h-[60px] flex items-center">
                                <p id="ai-insight-text" class="text-sm font-medium text-gray-600 leading-snug">
                                    Initializing predictive models...
                                </p>
                            </div>

                            <!-- Progress/Metric -->
                            <div class="pt-3 border-t border-violet-100 relative z-10">
                                <div class="flex justify-between items-end mb-1">
                                    <span class="text-[10px] font-bold text-gray-400 uppercase">Optimization
                                        Score</span>
                                    <span id="ai-score" class="text-lg font-black text-violet-500">--%</span>
                                </div>
                                <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                    <div id="ai-score-bar"
                                        class="bg-violet-500 h-full rounded-full transition-all duration-1000"
                                        style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: ACTIVITY LOGS -->
                <div>
                    <h2 class="font-ink text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                        <span class="text-blue-600">‚óè</span> Activity Logs
                    </h2>

                    <!-- Filters -->
                    <div class="clay-card p-6 flex flex-wrap gap-4 items-end mb-8">
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">School</label>
                            <select id="log-filter-school" class="clay-input w-full">
                                <option value="All">All Schools</option>
                            </select>
                        </div>
                        <div class="flex-1 min-w-[200px]">
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">User</label>
                            <select id="log-filter-user" class="clay-input w-full">
                                <option value="All">All Users</option>
                            </select>
                        </div>

                        <!-- Date Range -->
                        <div class="flex gap-2">
                            <div class="w-32">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Start
                                    Date</label>
                                <input type="date" id="log-filter-start-date" class="clay-input w-full p-2 text-xs">
                            </div>
                            <div class="w-32">
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">End
                                    Date</label>
                                <input type="date" id="log-filter-end-date" class="clay-input w-full p-2 text-xs">
                            </div>
                        </div>

                        <button onclick="fetchActivityLogs()"
                            class="clay-btn clay-primary px-6 py-3 rounded-xl font-bold uppercase text-sm shadow-md transition-transform active:scale-95 h-[42px] mt-auto">
                            Filter
                        </button>

                        <div class="flex gap-2 h-[42px] mt-auto">
                            <button onclick="downloadLogsPDF()"
                                class="clay-btn bg-red-50 text-red-600 hover:bg-red-100 px-4 py-3 rounded-xl font-bold uppercase text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                    </path>
                                </svg>
                                PDF
                            </button>
                            <button onclick="downloadLogsCSV()"
                                class="clay-btn bg-emerald-50 text-emerald-600 hover:bg-emerald-100 px-4 py-3 rounded-xl font-bold uppercase text-sm shadow-md transition-transform active:scale-95 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                CSV
                            </button>
                        </div>
                    </div>

                    <!-- Auto-Delete Alert -->
                    <div
                        class="bg-amber-50 border border-amber-100 text-amber-800 px-4 py-3 rounded-xl text-xs font-bold flex items-center gap-3 mb-6 shadow-sm">
                        <div
                            class="w-8 h-8 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="uppercase tracking-wider text-[10px] text-amber-500 block mb-1">Data Retention
                                Policy</span>
                            System logs are automatically deleted after <span class="text-amber-600 underline">7
                                days</span> to maintain performance. Download reports regularly for long-term records.
                        </div>
                    </div>

                    <!-- Logs Table -->
                    <div class="clay-card p-0 overflow-hidden">
                        <div class="bg-gray-50/50 p-4 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="text-sm font-bold text-gray-600 uppercase tracking-wide">System Activity Log</h3>
                            <span
                                class="text-xs text-gray-400 font-mono bg-white px-2 py-1 rounded border border-gray-200">Live
                                Data</span>
                        </div>
                        <div class="overflow-x-auto max-h-[600px] custom-scrollbar">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="sticky top-0 bg-white z-10 shadow-sm">
                                    <tr class="text-xs font-bold text-gray-400 uppercase tracking-wider">
                                        <th class="p-4 bg-gray-50/30">Timestamp</th>
                                        <th class="p-4 bg-gray-50/30">User</th>
                                        <th class="p-4 bg-gray-50/30">Role</th>
                                        <th class="p-4 bg-gray-50/30">School</th>
                                        <th class="p-4 bg-gray-50/30">Action</th>
                                        <th class="p-4 bg-gray-50/30">Details</th>
                                    </tr>
                                </thead>
                                <tbody id="rp-school-table" class="divide-y divide-gray-50 font-mono text-xs">
                                    <!-- Logs Injected -->
                                </tbody>
                            </table>
                        </div>
                        <p id="logs-loading" class="text-center py-8 text-gray-400 italic hidden">Loading logs...</p>
                        <p id="logs-empty" class="text-center py-8 text-gray-400 italic hidden">No logs found for
                            selection.
                        </p>
                    </div>
                </div>
            </div>



            <!-- 5.5 SCHOOL DETAILS -->
            <div id="view-school-details" class="hidden fade-in max-w-7xl mx-auto space-y-6">
                <!-- Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <button onclick="switchTab('schools')"
                            class="text-xs font-bold text-gray-400 hover:text-blue-500 uppercase flex items-center gap-1 mb-2 group">
                            <svg class="w-4 h-4 group-hover:-translate-x-1 transition-transform" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7">
                                </path>
                            </svg>
                            Back to Schools List
                        </button>
                        <h3 class="text-3xl font-extrabold text-gray-700" id="sd-school-name">-</h3>
                        <p class="text-sm text-gray-400 font-bold uppercase tracking-wider" id="sd-school-meta">School
                            Data Explorer</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-lock-school" onclick="toggleSchoolLock()"
                            class="hidden clay-btn px-4 py-2 text-xs font-bold text-gray-500 uppercase flex items-center gap-2 hover:bg-gray-100 transition-colors">
                            <span>üîí</span> <span id="lbl-lock-school">Lock Data</span>
                        </button>
                        <button onclick="downloadPDF()"
                            class="clay-btn px-4 py-2 text-xs font-bold text-rose-500 uppercase flex items-center gap-2">
                            Export PDF
                        </button>
                        <button onclick="downloadExcel()"
                            class="clay-btn px-4 py-2 text-xs font-bold text-emerald-500 uppercase flex items-center gap-2">
                            Export Excel
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex gap-4 border-b border-gray-200/50 pb-1 overflow-x-auto">
                    <button onclick="switchSchoolTab('students')" id="tab-sd-students"
                        class="clay-btn text-sm text-gray-500 hover:text-gray-700">Students List</button>
                    <button onclick="switchSchoolTab('measurements')" id="tab-sd-measurements"
                        class="clay-btn text-sm text-gray-500 hover:text-gray-700">Measurements Data</button>
                    <button onclick="switchSchoolTab('patterns')" id="tab-sd-patterns"
                        class="clay-btn text-sm active bg-blue-50 text-blue-600 border-blue-100">Patterns &
                        Consumption</button>
                </div>

                <!-- Content: Students -->
                <div id="sd-view-students" class="hidden fade-in">
                    <div class="clay-card p-6">
                        <div class="overflow-x-auto h-[650px] custom-scrollbar">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead
                                    class="sticky top-0 bg-white z-10 text-xs font-extrabold text-gray-400 uppercase tracking-wider shadow-sm">
                                    <tr>
                                        <th class="p-4 border-b">Roll No</th>
                                        <th class="p-4 border-b">Student Name</th>
                                        <th class="p-4 border-b">Class / Section</th>
                                        <th class="p-4 border-b">Gender</th>
                                        <th class="p-4 border-b">Pattern Assigned</th>
                                        <th class="p-4 border-b text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="sd-list-students" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                        <p class="text-right text-xs text-gray-400 mt-4 px-2" id="sd-count-students">0 records</p>
                    </div>
                </div>

                <!-- Content: Measurements -->
                <div id="sd-view-measurements" class="hidden fade-in">
                    <div class="clay-card p-6">
                        <p
                            class="text-xs text-sky-500 font-bold mb-4 uppercase tracking-wider bg-sky-50 inline-block px-3 py-1 rounded-lg">
                            Showing All Measurement Data</p>
                        <div class="overflow-x-auto h-[650px] custom-scrollbar">
                            <table class="w-full text-sm text-left whitespace-nowrap font-mono">
                                <thead
                                    class="sticky top-0 bg-white z-10 text-xs font-extrabold text-gray-400 uppercase tracking-wider shadow-sm">
                                    <tr>
                                        <th class="p-3 border-b bg-gray-50/80 sticky left-0 z-20">Name</th>
                                        <th class="p-3 border-b text-center">Pattern</th>
                                        <th class="p-3 border-b text-center text-orange-400">U1</th>
                                        <th class="p-3 border-b text-center text-orange-400">U2</th>
                                        <th class="p-3 border-b text-center text-orange-400">U3</th>
                                        <th class="p-3 border-b text-center text-orange-400">U4</th>
                                        <th class="p-3 border-b text-center text-orange-400">U5</th>
                                        <th class="p-3 border-b text-center text-orange-400">U6</th>
                                        <th class="p-3 border-b text-center text-indigo-400">L1</th>
                                        <th class="p-3 border-b text-center text-indigo-400">L2</th>
                                        <th class="p-3 border-b text-center text-indigo-400">L3</th>
                                        <th class="p-3 border-b text-center text-indigo-400">L4</th>
                                        <th class="p-3 border-b text-center text-indigo-400">L5</th>
                                        <th class="p-3 border-b text-center text-purple-600 bg-purple-50">Items Qty</th>
                                        <th class="p-3 border-b pl-6">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="sd-list-measurements" class="divide-y divide-gray-50"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Content: Patterns -->
                <div id="sd-view-patterns" class="hidden fade-in">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="sd-list-patterns"></div>
                    <p id="sd-no-patterns" class="hidden text-center text-gray-400 py-12 italic">No patterns found.</p>
                </div>
            </div>

            <!-- DUPLICATE VIEW REMOVED -->

            <!-- 7. COMPLAINTS -->
            <div id="view-complaints" class="hidden fade-in w-full space-y-8">
                <!-- Analytics Header -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- 1. Key Metrics (Split into 3 mini cards) -->
                    <div class="grid grid-cols-3 gap-4">
                        <!-- Total -->
                        <div
                            class="clay-card p-4 flex flex-col justify-center items-center text-center bg-gradient-to-b from-white to-gray-50">
                            <div
                                class="w-8 h-8 mb-2 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                    </path>
                                </svg>
                            </div>
                            <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest">Total</p>
                            <p class="text-2xl font-black text-gray-700 mt-1" id="c-stat-total">0</p>
                        </div>
                        <!-- Open -->
                        <div
                            class="clay-card p-4 flex flex-col justify-center items-center text-center bg-gradient-to-b from-orange-50 to-white border-b-2 border-orange-200">
                            <div
                                class="w-8 h-8 mb-2 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center animate-pulse">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p class="text-[9px] text-orange-500 font-bold uppercase tracking-widest">Open</p>
                            <p class="text-2xl font-black text-gray-700 mt-1" id="c-stat-open">0</p>
                        </div>
                        <!-- Done -->
                        <div
                            class="clay-card p-4 flex flex-col justify-center items-center text-center bg-gradient-to-b from-emerald-50 to-white border-b-2 border-emerald-200">
                            <div
                                class="w-8 h-8 mb-2 rounded-full bg-emerald-100 text-emerald-500 flex items-center justify-center">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <p class="text-[9px] text-emerald-500 font-bold uppercase tracking-widest">Done</p>
                            <p class="text-2xl font-black text-gray-700 mt-1" id="c-stat-resolved">0</p>
                        </div>
                    </div>

                    <!-- 2. Needs Attention -->
                    <div
                        class="clay-card p-6 relative overflow-hidden group bg-gradient-to-br from-rose-50 via-white to-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-24 h-24 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <span
                                    class="bg-rose-500 text-white text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider">Top
                                    Issue</span>
                            </div>
                            <h4 class="font-black text-gray-800 text-xl leading-tight mb-1" id="c-top-pattern">-</h4>
                            <p class="text-sm text-rose-500 font-bold flex items-center gap-1">
                                <span id="c-top-pattern-count" class="text-2xl">0</span>
                                <span class="text-xs font-medium text-rose-400 uppercase">complaints</span>
                            </p>
                        </div>
                    </div>

                    <!-- 3. Common Defect -->
                    <div
                        class="clay-card p-6 relative overflow-hidden group bg-gradient-to-br from-blue-50 via-white to-white">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-24 h-24 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-2 mb-3">
                                <span
                                    class="bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wider">Most
                                    Recurring</span>
                            </div>
                            <h4 class="font-black text-gray-800 text-xl leading-tight mb-1" id="c-top-issue">-</h4>
                            <p class="text-sm text-blue-500 font-bold flex items-center gap-1">
                                <span id="c-top-issue-count" class="text-2xl">0</span>
                                <span class="text-xs font-medium text-blue-400 uppercase">occurrences</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-96">
                    <div class="clay-card p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-700 flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-lg bg-rose-50 text-rose-500 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                Top Defective Patterns
                            </h3>
                        </div>
                        <div class="flex-1 relative"><canvas id="chart-patterns"></canvas></div>
                    </div>
                    <div class="clay-card p-6 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-700 flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-lg bg-amber-50 text-amber-500 flex items-center justify-center">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                                    </svg>
                                </div>
                                Common Defect Types
                            </h3>
                        </div>
                        <div class="flex-1 relative"><canvas id="chart-issues"></canvas></div>
                    </div>
                </div>

                <!-- Filters -->
                <div
                    class="clay-card p-3 flex flex-col md:flex-row gap-3 items-center bg-white/60 backdrop-blur-md border border-white/60 sticky top-24 z-20 shadow-lg">
                    <div class="w-full md:w-auto flex-1 relative group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-gray-400 group-focus-within:text-blue-500 transition-colors"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input type="text" id="c-filter-school" onkeyup="renderComplaintDash()"
                            placeholder="Search Schools..."
                            class="clay-input w-full pl-10 bg-white/80 focus:bg-white border-transparent focus:border-blue-200 focus:ring-0 placeholder-gray-400 font-medium">
                    </div>

                    <div class="h-8 w-px bg-gray-200 hidden md:block"></div>

                    <div class="w-full md:w-48 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                                </path>
                            </svg>
                        </div>
                        <select id="c-filter-pattern" onchange="renderComplaintDash()"
                            class="clay-input w-full pl-9 bg-white/80 focus:bg-white border-transparent focus:border-blue-200 focus:ring-0 text-gray-600 font-bold text-xs uppercase cursor-pointer">
                            <option value="all">All Patterns</option>
                        </select>
                    </div>

                    <div class="w-full md:w-32 relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <select id="c-filter-gender" onchange="renderComplaintDash()"
                            class="clay-input w-full pl-9 bg-white/80 focus:bg-white border-transparent focus:border-blue-200 focus:ring-0 text-gray-600 font-bold text-xs uppercase cursor-pointer">
                            <option value="all">All Genders</option>
                            <option value="Male">Boys</option>
                            <option value="Female">Girls</option>
                        </select>
                    </div>

                    <div class="h-8 w-px bg-gray-200 hidden md:block"></div>

                    <div class="flex gap-2">
                        <button onclick="downloadComplaintsPDF()"
                            class="p-2.5 rounded-xl bg-rose-50 text-rose-600 hover:bg-rose-100 font-bold text-xs uppercase tracking-wider flex items-center gap-2 transition-all shadow-sm group"
                            title="Export PDF">
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                </path>
                            </svg>
                            <span>PDF</span>
                        </button>
                        <button onclick="downloadComplaintsExcel()"
                            class="p-2.5 rounded-xl bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold text-xs uppercase tracking-wider flex items-center gap-2 transition-all shadow-sm group"
                            title="Export Excel">
                            <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            <span>XLSX</span>
                        </button>
                    </div>
                </div>

                <!-- Grid -->
                <div>
                    <h3 class="font-bold text-2xl text-gray-700 mb-6 px-2">School Tickets</h3>
                    <div id="school-complaints-grid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
                    <p id="c-no-data" class="hidden text-center text-gray-400 py-12 italic font-medium">No complaints
                        match your filters.</p>
                </div>
            </div>

            <!-- 8. SETTINGS -->
            <div id="view-settings" class="hidden fade-in w-full max-w-5xl mx-auto space-y-8">

                <!-- Header -->
                <div class="flex items-center justify-between mb-8">
                    <div>
                        <h2 class="text-3xl font-black text-slate-800">System Preferences</h2>
                        <p class="text-sm font-bold text-gray-400 uppercase tracking-widest mt-1">Configure & Manage</p>
                    </div>
                    <span
                        class="clay-card px-4 py-2 text-[10px] font-extrabold uppercase tracking-widest text-blue-500 bg-blue-50">v5.1.2
                        Stable</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                    <!-- Left Col: Profile & General -->
                    <div class="space-y-8">
                        <!-- Company Profile -->
                        <div class="clay-card p-6 relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2">
                            </div>
                            <h3 class="text-lg font-bold text-gray-700 mb-6 flex items-center gap-2 relative z-10">
                                <span class="p-2 rounded-lg bg-blue-100 text-blue-600 shadow-sm"><svg class="w-5 h-5"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                        </path>
                                    </svg></span>
                                Company Profile
                            </h3>
                            <div class="space-y-4 relative z-10">
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Global
                                        Name</label>
                                    <input type="text" value="Planet Solutions"
                                        class="clay-input w-full font-bold text-gray-700 pointer-events-none bg-gray-50/50">
                                </div>
                                <div>
                                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Support
                                        Email</label>
                                    <div class="flex gap-2">
                                        <input type="email" id="set-email" placeholder="support@planet.com"
                                            class="clay-input w-full font-medium">
                                        <button onclick="saveSupportEmail()"
                                            class="clay-btn px-4 text-xs font-bold text-blue-600 uppercase">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Theme (Visual Mock) -->
                        <div class="clay-card p-6">
                            <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wider">Appearance</h3>
                            <div class="flex gap-4">
                                <div id="theme-btn-light" onclick="setTheme('light')"
                                    class="flex-1 p-3 rounded-xl bg-blue-50 border-2 border-blue-500 cursor-pointer flex justify-center flex-col items-center gap-2 shadow-sm">
                                    <div class="w-6 h-6 rounded-full bg-white border border-blue-200"></div>
                                    <span class="text-[10px] font-bold text-blue-700 uppercase">Light</span>
                                </div>
                                <div id="theme-btn-dark" onclick="setTheme('dark')"
                                    class="flex-1 p-3 rounded-xl bg-gray-50 border border-gray-100 cursor-pointer opacity-60 flex justify-center flex-col items-center gap-2 grayscale hover:opacity-100 transition-opacity">
                                    <div class="w-6 h-6 rounded-full bg-slate-800"></div>
                                    <span class="text-[10px] font-bold text-gray-400 uppercase">Dark (Pro)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Middle Col: Notifications -->
                    <div class="clay-card p-8 lg:col-span-2 flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-3">
                                <span class="p-2 rounded-lg bg-amber-100 text-amber-600 shadow-sm"><svg class="w-5 h-5"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                        </path>
                                    </svg></span>
                                Notification Center
                            </h3>

                            <div class="space-y-4">
                                <!-- Toggle 1 -->
                                <div
                                    class="flex items-center justify-between p-4 bg-white rounded-xl border border-gray-100 shadow-sm group hover:border-blue-200 transition-colors">
                                    <div>
                                        <h4
                                            class="font-bold text-gray-800 text-sm group-hover:text-blue-600 transition-colors">
                                            Urgent Deadline Alerts</h4>
                                        <p class="text-xs text-gray-400 font-medium mt-0.5">Show browser popups when
                                            deadlines are < 3 days.</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="setting-notify"
                                            onchange="toggleNotificationSetting(this.checked, 'urgent')"
                                            class="sr-only peer">
                                        <div
                                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600 hover:scale-105 transition-transform">
                                        </div>
                                    </label>
                                </div>

                                <!-- Toggle 2 -->
                                <div
                                    class="flex items-center justify-between p-4 bg-white rounded-xl border border-gray-100 shadow-sm group hover:border-purple-200 transition-colors">
                                    <div>
                                        <h4
                                            class="font-bold text-gray-800 text-sm group-hover:text-purple-600 transition-colors">
                                            New Complaint Alerts</h4>
                                        <p class="text-xs text-gray-400 font-medium mt-0.5">Get notified immediately
                                            when a school logs a ticket.</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox"
                                            onchange="toggleNotificationSetting(this.checked, 'complaint')"
                                            id="setting-notify-complaint" class="sr-only peer">
                                        <div
                                            class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500 hover:scale-105 transition-transform">
                                        </div>
                                    </label>
                                </div>

                                <!-- Toggle 3 -->
                                <div
                                    class="flex items-center justify-between p-4 bg-white rounded-xl border border-gray-100 shadow-sm group hover:border-rose-200 transition-colors">
                                    <div>
                                        <h4
                                            class="font-bold text-gray-800 text-sm group-hover:text-rose-600 transition-colors">
                                            System Error Reports</h4>
                                        <p class="text-xs text-gray-400 font-medium mt-0.5">Auto-send crash reports to
                                            support team.</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox"
                                            onchange="toggleNotificationSetting(this.checked, 'error')"
                                            id="setting-notify-error" class="sr-only peer">
                                        <div
                                            class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:outline-none peer-checked:after:translate-x-full after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rose-500 hover:scale-105 transition-transform">
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- System Health Banner -->
                        <div
                            class="mt-8 p-4 bg-emerald-50 rounded-xl border border-emerald-100 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                                <span class="text-xs font-bold text-emerald-700 uppercase tracking-wider">System
                                    Operational</span>
                            </div>
                            <span class="text-[10px] font-bold text-emerald-400 uppercase">Uptime: 99.9%</span>
                        </div>
                    </div>

                    <!-- Bottom: Data & Maintenance (Full Width) -->
                    <div class="clay-card p-8 lg:col-span-3 border-t-4 border-rose-400">
                        <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center gap-3">
                            <span class="p-2 rounded-lg bg-rose-100 text-rose-600 shadow-sm"><svg class="w-5 h-5"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                    </path>
                                </svg></span>
                            Data Governance & Maintenance
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm mb-2">Export Data</h4>
                                <p class="text-xs text-gray-500 mb-4 leading-relaxed">Download a complete snapshot of
                                    all system logs and activities for compliance and auditing purposes.</p>
                                <button onclick="downloadReport('overview', 'pdf')"
                                    class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Export Logs (PDF)
                                </button>
                            </div>

                            <div class="border-l border-gray-100 pl-8">
                                <h4 class="font-bold text-rose-600 text-sm mb-2">Danger Zone</h4>
                                <p class="text-xs text-gray-500 mb-4 leading-relaxed">Irreversibly destructive actions.
                                    Proceed with extreme caution.</p>
                                <div class="flex gap-4">
                                    <button onclick="fixDatabase()"
                                        class="px-4 py-2 border border-orange-200 text-orange-500 hover:bg-orange-50 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors">Run
                                        Diagnostics</button>
                                    <button onclick="resetDatabase()"
                                        class="px-4 py-2 bg-rose-50 border border-rose-200 text-rose-600 hover:bg-rose-600 hover:text-white rounded-lg text-xs font-bold uppercase tracking-wider transition-colors shadow-sm">Reset
                                        Database</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>


            <!-- 1. OVERVIEW -->
            <div id="view-overview" class="space-y-8 fade-in">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Stat Card 1: Total Students (Blue/Cyan Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#eff6ff] via-white to-[#eff6ff]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z">
                                    </path>
                                </svg>
                            </div>
                            <span
                                class="bg-blue-400 text-white px-4 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wide shadow-md shadow-blue-200">+12%</span>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Total
                                Students</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-students">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-blue-100/40 rounded-full blur-2xl group-hover:bg-blue-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 2: Orders Pending (Amber/Cream Theme - REFERENCE MATCH) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#fffbeb] via-white to-[#fffbeb]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-amber-50 text-amber-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                                    <polyline points="12 6 12 12 16 14" stroke-width="2"></polyline>
                                </svg>
                            </div>
                            <span
                                class="bg-amber-400 text-white px-4 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wide shadow-md shadow-amber-200">Pending</span>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Orders
                                Pending</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-pending">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-amber-100/40 rounded-full blur-2xl group-hover:bg-amber-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 3: Completed (Emerald/Mint Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#ecfdf5] via-white to-[#ecfdf5]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <!-- Dynamic Badge for Completed (Hidden if 0 or styled differently) -->
                            <div
                                class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">
                                Completed
                            </p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-packed">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-emerald-100/40 rounded-full blur-2xl group-hover:bg-emerald-200/40 transition-colors">
                        </div>
                    </div>

                    <!-- Stat Card 4: Total Schools (Rose/Pink Theme) -->
                    <div
                        class="clay-card p-7 flex flex-col justify-between h-48 relative overflow-hidden group transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl bg-gradient-to-br from-[#fff1f2] via-white to-[#fff1f2]">
                        <div class="flex justify-between items-start z-10 relative">
                            <div
                                class="w-14 h-14 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center text-2xl clay-inner group-hover:scale-110 transition-transform duration-300">
                                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                                    </path>
                                </svg>
                            </div>
                        </div>
                        <div class="z-10 relative">
                            <p class="text-[11px] font-extrabold text-slate-400 uppercase tracking-widest mb-1.5">Total
                                Schools</p>
                            <p class="text-[42px] font-black text-slate-800 leading-none tracking-tight user-select-none"
                                id="stat-schools">0</p>
                        </div>
                        <!-- Decorative Blur -->
                        <div
                            class="absolute -bottom-6 -right-6 w-32 h-32 bg-rose-100/40 rounded-full blur-2xl group-hover:bg-rose-200/40 transition-colors">
                        </div>
                    </div>




                </div>

                <!-- URGENT DEADLINES WIDGET -->
                <div class="mt-8 animate-in slide-in-from-bottom-4 duration-500 delay-150">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="text-2xl animate-pulse">‚è≥</span> Upcoming Deadlines & Priority
                    </h3>
                    <div id="urgent-deadlines-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="clay-card p-6 flex items-center justify-center text-gray-400 italic">
                            No upcoming deadlines set.
                        </div>
                    </div>
                </div>

                <!-- Charts Row (Restored) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-96">
                    <!-- Chart 1: Schools Distribution -->
                    <div class="clay-card p-6 flex flex-col justify-between lg:col-span-2 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10">
                            <div>
                                <h3 class="font-extrabold text-lg text-slate-700">School Distribution</h3>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                    Student
                                    Capacity &
                                    Enrollment</p>
                            </div>
                            <span class="p-2 rounded-xl bg-purple-50 text-purple-500 shadow-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                    </path>
                                </svg>
                            </span>
                        </div>
                        <div class="flex-1 w-full mt-4 relative">
                            <canvas id="chart-schools"></canvas>
                        </div>
                    </div>

                    <!-- Chart 2: Packing Status -->
                    <div class="clay-card p-6 flex flex-col justify-between relative overflow-hidden">
                        <div class="flex justify-between items-start z-10">
                            <div>
                                <h3 class="font-extrabold text-lg text-slate-700">Order Status</h3>
                                <p class="text-[11px] font-bold text-slate-400 uppercase tracking-widest mt-1">
                                    Completion
                                    Rate
                                </p>
                            </div>
                            <div class="flex -space-x-2">
                                <!-- Decor -->
                            </div>
                        </div>
                        <div class="flex-1 w-full mt-4 relative flex items-center justify-center">
                            <canvas id="chart-packing"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Smart Insights Row (New) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- 1. Production Pipeline Status -->
                    <div class="clay-card p-6 flex flex-col lg:col-span-2 min-h-[450px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="p-2 rounded-lg bg-indigo-100 text-indigo-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                        </path>
                                    </svg>
                                </span>
                                Production Pipeline
                            </h3>
                            <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Live Status
                                Overview</span>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2" id="production-pipeline-list">
                            <!-- Injected JS Content -->
                            <div class="animate-pulse space-y-4">
                                <div class="h-12 bg-gray-100 rounded-xl"></div>
                                <div class="h-12 bg-gray-100 rounded-xl"></div>
                                <div class="h-12 bg-gray-100 rounded-xl"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. Recent Complaints / Quick Actions -->
                    <div class="clay-card p-6 flex flex-col lg:col-span-1 min-h-[450px]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                                <span class="p-2 rounded-lg bg-rose-100 text-rose-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                        </path>
                                    </svg>
                                </span>
                                Recent Issues
                            </h3>
                            <button onclick="switchTab('complaints')"
                                class="text-[10px] font-bold uppercase text-blue-500 hover:text-blue-700 tracking-wider transition-colors">View
                                All</button>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-3" id="recent-issues-list">
                            <div class="text-center text-gray-400 text-xs italic py-10">No recent issues found.
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End of view-overview -->

            <!-- 2. TAILORING DATA (Restructured) -->
            <div id="view-data" class="hidden space-y-6 fade-in min-h-screen">

                <!-- LEVEL 1: SCHOOL SELECTION GRID -->
                <div id="td-level-1" class="animate-in slide-in-from-left-4 duration-300">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <div class="flex justify-between items-center mb-8">
                                <!-- Header Removed: Handled globally -->
                            </div>
                        </div>
                    </div>

                    <div id="td-school-grid"
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- School Cards Injected Here -->
                    </div>
                </div>

                <!-- LEVEL 2: SCHOOL DETAILS HEADER (PREMIUM REDESIGN) -->
                <div id="td-level-2" class="hidden animate-in slide-in-from-right-4 duration-500 ease-out">
                    <!-- Modern Hero Header -->
                    <div
                        class="relative bg-white rounded-3xl p-8 mb-10 shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100 group">
                        <!-- Decorative Background Elements -->
                        <div
                            class="absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full blur-3xl opacity-50 -translate-y-1/2 translate-x-1/2 group-hover:bg-blue-100 transition-colors duration-700">
                        </div>
                        <div
                            class="absolute bottom-0 left-0 w-48 h-48 bg-purple-50 rounded-full blur-3xl opacity-50 translate-y-1/2 -translate-x-1/2 group-hover:bg-purple-100 transition-colors duration-700">
                        </div>

                        <div
                            class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            <!-- Left: Title & Meta -->
                            <div class="flex items-center gap-6">
                                <button onclick="closeSchoolDetails()"
                                    class="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-blue-600 hover:border-blue-200 hover:shadow-lg hover:shadow-blue-500/20 flex items-center justify-center transition-all duration-300 group/btn">
                                    <svg class="w-6 h-6 transform group-hover/btn:-translate-x-1 transition-transform"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                </button>

                                <div>
                                    <div class="flex items-center gap-3 mb-2">
                                        <h2 class="text-3xl font-black text-slate-800 tracking-tight"
                                            id="td-school-name">School Name</h2>
                                        <span id="td-school-badge"
                                            class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest bg-blue-50 text-blue-600 border border-blue-100">
                                            Loading
                                        </span>
                                    </div>
                                    <div
                                        class="flex items-center gap-4 text-xs font-bold uppercase tracking-wider text-slate-400">
                                        <span class="flex items-center gap-1.5">
                                            <svg class="w-4 h-4 text-slate-300" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z">
                                                </path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            <span id="td-school-meta">0 Students ‚Ä¢ 0 Patterns</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Quick Actions (Optional Placeholders) -->
                            <div class="flex gap-2">
                                <button onclick="exportSchoolSummaryXLS()"
                                    class="px-3 py-2 bg-green-50 text-green-600 rounded-xl text-[10px] font-bold uppercase tracking-wider hover:bg-green-100 transition-colors border border-green-100 flex items-center gap-2"
                                    title="Export Pattern Summary (Excel)">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Summary (XLS)
                                </button>
                                <button onclick="exportSchoolSummaryPDF()"
                                    class="px-3 py-2 bg-red-50 text-red-600 rounded-xl text-[10px] font-bold uppercase tracking-wider hover:bg-red-100 transition-colors border border-red-100 flex items-center gap-2"
                                    title="Export Pattern Summary (PDF)">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                    PDF
                                </button>
                                <button onclick="exportSchoolPackingXLS()"
                                    class="px-3 py-2 bg-purple-50 text-purple-600 rounded-xl text-[10px] font-bold uppercase tracking-wider hover:bg-purple-100 transition-colors border border-purple-100 flex items-center gap-2"
                                    title="Export Packing List">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4">
                                        </path>
                                    </svg>
                                    Packing
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LEVEL 2: CATEGORY GRID (PREMIUM REDESIGN) -->
                <div id="td-category-grid" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">

                    <!-- 1. STUDENTS CARD (Blue) -->
                    <div onclick="openLevel3('students')"
                        class="group relative bg-white rounded-3xl p-8 cursor-pointer transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(59,130,246,0.15)] border border-slate-100 overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-blue-50/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        </div>

                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-3xl shadow-sm group-hover:scale-110 group-hover:rotate-3 transition-all duration-500">
                                    <i class="fas fa-users"></i>
                                    <!-- Fallback SVG -->
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-2xl font-black text-slate-800 group-hover:text-blue-600 transition-colors">
                                        Students</h3>
                                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider mt-1"
                                        id="td-cat-students-count">Loading...</p>
                                </div>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full border border-slate-100 text-slate-300 flex items-center justify-center group-hover:bg-blue-600 group-hover:border-blue-600 group-hover:text-white transition-all duration-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 2. MEASUREMENTS CARD (Purple) -->
                    <div onclick="openLevel3('measurements')"
                        class="group relative bg-white rounded-3xl p-8 cursor-pointer transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(168,85,247,0.15)] border border-slate-100 overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-purple-50/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        </div>

                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-purple-50 text-purple-600 flex items-center justify-center text-3xl shadow-sm group-hover:scale-110 group-hover:-rotate-3 transition-all duration-500">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-2xl font-black text-slate-800 group-hover:text-purple-600 transition-colors">
                                        Measurements</h3>
                                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider mt-1">Full
                                        Matrix View</p>
                                </div>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full border border-slate-100 text-slate-300 flex items-center justify-center group-hover:bg-purple-600 group-hover:border-purple-600 group-hover:text-white transition-all duration-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 3. BOYS PATTERNS CARD (Indigo) -->
                    <div onclick="openLevel3('patterns-boys')"
                        class="group relative bg-white rounded-3xl p-8 cursor-pointer transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(79,70,229,0.15)] border border-slate-100 overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-indigo-50/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        </div>

                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center text-3xl shadow-sm group-hover:scale-110 group-hover:rotate-3 transition-all duration-500">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-2xl font-black text-slate-800 group-hover:text-indigo-600 transition-colors">
                                        Boys Patterns</h3>
                                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider mt-1"
                                        id="td-cat-boys-count">Loading...</p>
                                </div>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full border border-slate-100 text-slate-300 flex items-center justify-center group-hover:bg-indigo-600 group-hover:border-indigo-600 group-hover:text-white transition-all duration-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- 4. GIRLS PATTERNS CARD (Pink) -->
                    <div onclick="openLevel3('patterns-girls')"
                        class="group relative bg-white rounded-3xl p-8 cursor-pointer transition-all duration-500 hover:-translate-y-2 hover:shadow-[0_20px_40px_-15px_rgba(236,72,153,0.15)] border border-slate-100 overflow-hidden">
                        <div
                            class="absolute inset-0 bg-gradient-to-br from-pink-50/50 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                        </div>

                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-6">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-pink-50 text-pink-500 flex items-center justify-center text-3xl shadow-sm group-hover:scale-110 group-hover:-rotate-3 transition-all duration-500">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                                        </path>
                                    </svg>
                                </div>
                                <div>
                                    <h3
                                        class="text-2xl font-black text-slate-800 group-hover:text-pink-500 transition-colors">
                                        Girls Patterns</h3>
                                    <p class="text-sm font-bold text-slate-400 uppercase tracking-wider mt-1"
                                        id="td-cat-girls-count">Loading...</p>
                                </div>
                            </div>
                            <div
                                class="w-12 h-12 rounded-full border border-slate-100 text-slate-300 flex items-center justify-center group-hover:bg-pink-500 group-hover:border-pink-500 group-hover:text-white transition-all duration-300">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LEVEL 3: DATA VIEWS (Students, Measurements, Patterns Grid) -->
                <!-- Each View now has a Header with Back Button -->

                <!-- 1. STUDENTS LIST -->
                <div id="td-view-students" class="hidden space-y-6">
                    <div class="flex flex-col gap-6">
                        <div class="flex items-center gap-4">
                            <button onclick="closeLevel3()"
                                class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <h3 class="text-xl font-extrabold text-gray-800">Student List</h3>
                        </div>

                        <!-- Filters Relocated Here -->
                        <!-- Filters Relocated Here -->
                        <!-- Filters Re-Built Layout -->
                        <div id="td-filters-container"
                            class="bg-gray-50/50 p-4 rounded-xl border border-gray-100 flex flex-col gap-4">
                            <!-- Top Row: Search & Desktop Actions -->
                            <div class="flex flex-col md:flex-row gap-4 items-center">
                                <!-- Search -->
                                <div class="relative w-full md:max-w-md">
                                    <span class="absolute left-3 top-3 text-gray-400">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                    </span>
                                    <input type="text" id="td-filter-search" oninput="renderTdCurrentTab()"
                                        placeholder="Search (1-5, A-C...)"
                                        class="clay-input h-10 pl-10 text-sm font-bold w-full bg-white transition-colors placeholder-gray-400">
                                </div>

                                <!-- Desktop Export Buttons -->
                                <div class="hidden md:flex items-center gap-3 ml-auto">
                                    <button onclick="downloadTdPDF()"
                                        class="clay-btn h-10 px-4 bg-red-50 text-red-600 font-bold uppercase text-xs hover:bg-red-100 flex items-center gap-2"
                                        title="Download PDF Report">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                        <span>PDF</span>
                                    </button>
                                    <button onclick="exportTdCurrentData()"
                                        class="clay-btn h-10 px-4 bg-emerald-50 text-emerald-600 font-bold uppercase text-xs hover:bg-emerald-100 flex items-center gap-2"
                                        title="Download Excel">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                        <span>Excel</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Bottom Row: Filters Grid & Mobile Actions -->
                            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                                <!-- Class -->
                                <div class="relative">
                                    <select id="td-filter-class" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Class</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Section -->
                                <div class="relative">
                                    <select id="td-filter-section" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Section</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <!-- Gender -->
                                <div class="relative">
                                    <select id="td-filter-gender" onchange="renderTdCurrentTab()"
                                        class="clay-input h-12 py-3 text-sm font-bold w-full pl-3 pr-8 appearance-none border-none focus:ring-0 cursor-pointer hover:bg-white transition-colors bg-white text-gray-700 leading-tight">
                                        <option value="all">Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                    <div
                                        class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>

                                <!-- Mobile Export Buttons (Visible only on small screens) -->
                                <div class="md:hidden col-span-2 flex items-center justify-end gap-2 mt-2">
                                    <button onclick="downloadTdPDF()"
                                        class="clay-btn h-10 w-10 flex items-center justify-center bg-red-50 text-red-600 hover:bg-red-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 2H7a2 2 0 00-2 2v12a2 2 0 002 2z">
                                            </path>
                                        </svg>
                                    </button>
                                    <button onclick="exportTdCurrentData()"
                                        class="clay-btn h-10 w-10 flex items-center justify-center bg-emerald-50 text-emerald-600 hover:bg-emerald-100 rounded-lg">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl p-1 min-h-[500px] shadow-sm border border-gray-100">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b border-gray-100">
                                        <th class="p-4">Roll No</th>
                                        <th class="p-4">Name</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4">Gender</th>
                                        <th class="p-4 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="td-list-students"
                                    class="text-sm font-medium text-gray-600 divide-y divide-gray-50">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. MEASUREMENTS -->
                <div id="td-view-measurements" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Full Measurements Matrix</h3>
                    </div>
                    <div class="bg-white rounded-2xl p-1 min-h-[500px] shadow-sm border border-gray-100">
                        <div class="overflow-x-auto custom-scrollbar pb-4">
                            <table class="w-full text-left whitespace-nowrap border-collapse">
                                <thead class="bg-gray-50/50 sticky top-0 z-10">
                                    <tr
                                        class="text-[10px] font-extrabold text-gray-400 uppercase tracking-wider border-b border-gray-200">
                                        <th
                                            class="p-3 sticky left-0 bg-white z-20 border-r border-gray-100 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                                            Student Identity</th>
                                        <!-- U1-U8 -->
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U1</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U2</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U3</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U4</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U5</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U6</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U7</th>
                                        <th class="p-2 text-center text-orange-600 bg-orange-50/30">U8</th>
                                        <!-- L1-L8 -->
                                        <th
                                            class="p-2 text-center text-indigo-600 bg-indigo-50/30 border-l border-gray-100">
                                            L1</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L2</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L3</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L4</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L5</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L6</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L7</th>
                                        <th class="p-2 text-center text-indigo-600 bg-indigo-50/30">L8</th>
                                        <th
                                            class="p-3 text-center bg-purple-50/30 text-purple-600 border-l border-gray-100">
                                            Qty</th>
                                        <th class="p-3 text-center">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="td-list-measurements"
                                    class="text-xs font-mono text-gray-600 divide-y divide-gray-50">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. PATTERN BOYS GRID (Level 3) -->
                <div id="td-view-patterns-boys" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Boys Pattern Groups</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="td-list-patterns-boys">
                    </div>
                </div>

                <!-- 4. PATTERN GIRLS GRID (Level 3) -->
                <div id="td-view-patterns-girls" class="hidden space-y-6">
                    <div class="flex items-center gap-4">
                        <button onclick="closeLevel3()"
                            class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-blue-600 bg-white shadow-sm border border-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </button>
                        <h3 class="text-xl font-extrabold text-gray-800">Girls Pattern Groups</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="td-list-patterns-girls">
                    </div>
                </div>

            </div>
        </div>
    </div>


    <!-- 3. USER MANAGEMENT -> LEVEL 4: PATTERN SPECIFIC DETAILS (Premium Redesign) -->
    <div id="td-level-3-pattern" class="hidden w-full mt-4 animate-in zoom-in-95 duration-300 ease-out p-1">

        <!-- Hero Header for Pattern -->
        <div
            class="relative bg-white rounded-3xl p-8 mb-8 shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100 group">
            <div
                class="absolute top-0 right-0 w-64 h-64 bg-orange-50 rounded-full blur-3xl opacity-50 -translate-y-1/2 translate-x-1/2">
            </div>

            <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div class="flex items-center gap-6">
                    <button onclick="closePatternDetails()"
                        class="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-slate-400 hover:text-orange-600 hover:border-orange-200 hover:shadow-lg hover:shadow-orange-500/20 flex items-center justify-center transition-all duration-300 group/btn">
                        <svg class="w-6 h-6 transform group-hover/btn:-translate-x-1 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>

                    <div>
                        <div class="flex items-center gap-3 mb-2">
                            <h2 class="text-3xl font-black text-slate-800 tracking-tight" id="td-p3-title">Pattern Name
                            </h2>
                            <span id="td-p3-count"
                                class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-widest bg-orange-50 text-orange-600 border border-orange-100">
                                0 Students
                            </span>
                        </div>
                        <p class="text-xs font-bold uppercase tracking-wider text-slate-400 flex items-center gap-2"
                            id="td-p3-meta">Consumption Details</p>
                    </div>
                </div>

                <div class="flex gap-2">
                    <button onclick="exportTdCurrentData()"
                        class="px-4 py-2 bg-emerald-50 text-emerald-600 border border-emerald-100 hover:bg-emerald-100 rounded-xl text-[10px] font-bold uppercase tracking-wider shadow-sm transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        List (XLS)
                    </button>
                    <button onclick="exportTdCurrentDataPDF()"
                        class="px-4 py-2 bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 rounded-xl text-[10px] font-bold uppercase tracking-wider shadow-sm transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                            </path>
                        </svg>
                        List (PDF)
                    </button>
                </div>
            </div>
        </div>

        <!-- Student List Container -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50/50">
                        <tr
                            class="text-[11px] font-extrabold text-slate-400 uppercase tracking-wider border-b border-slate-100">
                            <th class="p-5 pl-8 w-[25%] min-w-[250px]">Student Identity</th>
                            <th class="p-5 w-[25%] min-w-[200px]">Academic & Context</th>
                            <th class="p-5 whitespace-nowrap w-[10%]">Gender</th>
                            <th class="p-5 w-[25%] min-w-[150px]">Measurement Data</th>
                            <th class="p-5 text-center whitespace-nowrap w-[10%]" id="th-qty-header">QTY</th>
                            <th class="p-5 text-center whitespace-nowrap w-[15%]">Status</th>
                        </tr>
                    </thead>
                    <tbody id="td-p3-list" class="text-sm font-medium text-slate-600 divide-y divide-slate-50">
                        <!-- JS Injected Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- 3. USER MANAGEMENT -->




    </div><!-- End Vertical Enforcer -->

    <!-- 8. TICKET DETAIL MODAL -->
    <dialog id="ticketModal" class="bg-transparent z-50">
        <div class="fixed inset-0 bg-gray-500/30 backdrop-blur-sm flex items-center justify-center p-4">
            <div
                class="clay-card w-full max-w-5xl h-[85vh] flex flex-col animate-in zoom-in-95 duration-200 outline-none">
                <!-- Header -->
                <div class="p-6 border-b border-white/50 flex justify-between items-center rounded-t-2xl">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="tm-school-name">School Name</h3>
                        <p class="text-xs text-gray-400 uppercase tracking-wider font-bold mt-1" id="tm-school-stats">5
                            Open Tickets</p>
                    </div>
                    <button onclick="document.getElementById('ticketModal').close()"
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-red-50 text-gray-500 hover:text-red-500 flex items-center justify-center transition-colors shadow-sm absolute right-6 top-6 z-50">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 bg-transparent" id="tm-list">
                    <!-- Ticket Cards Injected -->

                </div>
            </div>
        </div>
    </dialog>

    </main>

    <!-- SCHOOL REGISTRATION MODAL -->
    <div id="school-modal"
        class="fixed inset-0 bg-gray-500/30 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="clay-card w-full max-w-md p-8 transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-6 border-b border-white/50 pb-4 text-gray-700">Register New School</h3>
            <form onsubmit="registerSchool(event)" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">School Name</label>
                    <input type="text" name="name" required placeholder="e.g. Galaxy High School" class="clay-input">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Admin Username</label>
                    <input type="text" name="username" required placeholder="admin_galaxy" class="clay-input">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2 ml-2">Password</label>
                    <input type="password" name="password" required class="clay-input">
                </div>
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" onclick="document.getElementById('school-modal').classList.add('hidden')"
                        class="px-6 py-2 text-sm font-bold text-gray-500 hover:text-gray-700">CANCEL</button>
                    <button type="submit"
                        class="clay-btn clay-primary px-6 py-2 text-sm font-bold rounded-lg shadow-lg">REGISTER
                        SCHOOL</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        const API_BASE = '/api'; const token = sessionStorage.getItem('token'); if (!token) window.location.href = 'login.html';
        let globalStudents = [], globalSchools = [], globalPatterns = [], globalUsers = [], dynamicFilters = {}, sidebarOpen = false;
        let currentSchoolDetails = {}; // Initialize explicitly
        function toggleSidebar() { sidebarOpen = !sidebarOpen; const s = document.getElementById('sidebar'), b = document.getElementById('sidebar-backdrop'); if (sidebarOpen) { s.classList.remove('-translate-x-[120%]'); b.classList.remove('hidden'); setTimeout(() => b.classList.remove('opacity-0'), 10); } else { s.classList.add('-translate-x-[120%]'); b.classList.add('opacity-0'); setTimeout(() => b.classList.add('hidden'), 300); } }
        const boysItems = [{ name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" }, { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" }, { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" }, { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" }, { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" }];
        const girlsItems = [{ name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" }, { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" }, { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" }, { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" }, { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" }, { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" }, { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }];
        // Consolidated Item Definitions for Lookup
        const itemDefinitions = [...boysItems, ...girlsItems];

        // Format time ago helper
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) + " seconds ago";
        }

        // === HELPER FUNCTIONS (Missing Fix) ===
        function getStatusColor(status, isPacked) {
            if (status) {
                const s = status.toLowerCase();
                if (s === 'processing') return 'bg-yellow-100 text-yellow-600';
                if (s === 'production') return 'bg-blue-100 text-blue-600';
                if (s === 'dispatch') return 'bg-indigo-100 text-indigo-600';
                if (s === 'delivered') return 'bg-emerald-100 text-emerald-600';
            }
            if (isPacked) return 'bg-emerald-100 text-emerald-600';
            return 'bg-gray-100 text-gray-500';
        }

        // === ITEM DEFINITIONS (For Smart Measurements) ===
        const ALL_PATTERN_ITEMS = [
            // BOYS
            { name: "BOYS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Male" },
            { name: "BOYS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Male" },
            { name: "BOYS - FORMAL PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - TRACK PANT", cols: ["L1", "L2"], type: "Male" },
            { name: "BOYS - FORMAL SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - TRACK SHORTS", cols: ["L3", "L2"], type: "Male" },
            { name: "BOYS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Male" },
            // GIRLS
            { name: "GIRLS - FORMAL SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - TRACK T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - UNIFORM T-SHIRT", cols: ["U1", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - JERKIN", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - FULL SLEEVE SHIRT", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - PULLOVER", cols: ["U1", "U2", "U3", "U4", "U5"], type: "Female" },
            { name: "GIRLS - KURTHA SHIRT", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - SPECIAL FROCKS", cols: ["U7", "U2", "U3", "U4", "U6"], type: "Female" },
            { name: "GIRLS - FORMAL PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK PANT", cols: ["L1", "L2"], type: "Female" },
            { name: "GIRLS - TRACK SHORTS", cols: ["L3", "L2"], type: "Female" },
            { name: "GIRLS - PINOFORE", cols: ["L4", "L2"], type: "Female" },
            { name: "GIRLS - SKIRT", cols: ["L5", "L2"], type: "Female" },
            { name: "GIRLS - PANT SPECIAL CASE", cols: ["L1", "L2", "L6", "L7"], type: "Female" }
        ];

        function getMeasurementsSafe(s) {
            if (!s.measurements) return {};
            if (typeof s.measurements === 'string') {
                try { return JSON.parse(s.measurements); } catch (e) { return {}; }
            }
            return s.measurements || {};
        }

        function getItemQuantitiesSafe(s) {
            const m = getMeasurementsSafe(s);
            const quantities = {};
            // Basic logic to count items based on non-empty measurements might be needed, 
            // OR if you have a specific 'quantities' field. 
            // Assuming based on previous context we infer it or it's just a placeholder.
            // For now, let's map known items from column presence if needed.
            // Actually, let's look at the usage: it iterates keys.
            // If the student object has a 'quantities' field (parsed), use it? 
            // Let's implement a simple version that checks if the measurement for a standard item exists.

            // Re-using the itemDefinitions logic if possible, or simplified:
            itemDefinitions.forEach(def => {
                // Check if ANY of the required columns for this item have data
                // This is a heuristic.
                const hasData = def.cols.some(c => m[c.toLowerCase()] && m[c.toLowerCase()].trim() !== '');
                if (hasData) {
                    quantities[def.name] = 1; // Simple count
                }
            });
            return quantities;
        }

        async function init() {
            await Promise.all([fetchStats(), fetchAllStudents(), fetchSchoolsForSelect(), fetchGlobalPatterns()]);
            renderTailoringData();
            renderCharts();
            populateDynamicFilters();
            // Smart Insights
            // renderLeaderboard(); // Removed: Function definition missing
            fetchActivityLogs();
            if (window.renderUrgentDeadlines) renderUrgentDeadlines();
        }
        function switchTab(clickedId) {
            // Map Button IDs to View IDs (Corrected to match HTML)
            const map = {
                'overview': 'view-overview',
                'schools': 'view-schools',
                'data': 'view-data',
                'tailoring': 'view-data',
                'users': 'view-users',
                'access': 'view-access',
                'complaints': 'view-complaints',
                'reports': 'view-reports',
                'settings': 'view-settings'
            };

            // Allow calling with either short ID or full ID (fallback)
            const viewId = map[clickedId] || clickedId;

            if (window.Logger) window.Logger.log('VIEW_ADMIN_TAB', `Switched to ${viewId}`);

            // Hide all views (including School Details)
            const views = [
                'view-overview',
                'view-schools',
                'view-data',
                'view-users',
                'view-access',
                'view-complaints',
                'view-reports',
                'view-settings',
                'view-school-details' // Ensure this is hidden when switching main tabs
            ];

            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });

            // Show selected
            const target = document.getElementById(viewId);
            if (target) {
                target.classList.remove('hidden');
            } else {
                console.warn(`View ID '${viewId}' not found in HTML.`);
            }

            const titles = {
                'view-overview': 'Overview',
                'view-schools': 'Schools',
                'view-data': 'Tailoring Data',
                'view-users': 'User Management',
                'view-access': 'Access Codes',
                'view-complaints': 'Complaints',
                'view-reports': 'Reports',
                'view-settings': 'Settings',
                'view-school-details': 'School Details'
            };

            const subtitles = {
                'view-overview': 'Manage Planet Solutions tailors & operations',
                'view-schools': 'Manage priority and production status for each school',
                'view-data': 'Select a school to view details, measurements, and patterns',
                'view-users': 'Controls who can access the system and manage schools',
                'view-access': 'Generate and manage access codes for schools',
                'view-complaints': 'Track and resolve school complaints and issues',
                'view-reports': 'Download data and view system activity logs',
                'view-settings': 'Configure system preferences and notifications',
                'view-school-details': 'Manage locked status and data access'
            };

            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.innerText = titles[viewId] || 'Overview';

            const subTitleEl = document.getElementById('page-subtitle');
            if (subTitleEl) subTitleEl.innerText = subtitles[viewId] || 'Manage Planet Solutions tailors & operations';

            if (sidebarOpen && window.innerWidth < 768) toggleSidebar();

            // Update Navigation Highlights
            // Update Navigation Highlights
            document.querySelectorAll('.nav-item').forEach(el => {
                // Remove all possible active variations to be safe
                el.classList.remove('!bg-blue-50', '!text-blue-600', '!border-r-4', '!border-blue-600', 'active', '!shadow-inner', 'bg-blue-50', 'text-blue-600', 'border-r-4', 'border-blue-600', 'shadow-inner');
                el.classList.add('text-gray-600');
            });

            // Map viewId back to navId or use clickedId logic
            let navSuffix = clickedId;
            if (viewId === 'view-data') navSuffix = 'data';
            if (viewId === 'view-schools') navSuffix = 'schools';
            if (viewId === 'view-users') navSuffix = 'users'; // Explicit check

            const navId = 'nav-' + navSuffix;
            const activeNav = document.getElementById(navId);
            if (activeNav) {
                activeNav.classList.remove('text-gray-600');
                // Force styles with !important equivalents (Tailwind) and add pressed shadow
                activeNav.classList.add('!bg-blue-50', '!text-blue-600', '!border-r-4', '!border-blue-600', '!shadow-inner');
            }

            // Scroll to Top
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // Auto-Fetch Logic
            if (viewId === 'view-schools') fetchSchoolsManage();
            if (viewId === 'view-users') { fetchSchoolsForSelect(); fetchUsers(); }
            if (viewId === 'view-data') {
                renderTailoringData();
            }
            if (viewId === 'view-access') fetchAccessCodes();
            if (viewId === 'view-complaints') fetchComplaints();
            if (viewId === 'view-reports') {
                fetchSchoolsManage();
                if (window.initReports) initReports();
            }
        }
        function animateValue(obj, start, end, duration) { let startTimestamp = null; const step = (timestamp) => { if (!startTimestamp) startTimestamp = timestamp; const progress = Math.min((timestamp - startTimestamp) / duration, 1); obj.innerText = Math.floor(progress * (end - start) + start); if (progress < 1) { window.requestAnimationFrame(step); } }; window.requestAnimationFrame(step); }
        async function fetchStats() { try { const r = await fetch(`${API_BASE}/data/stats`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); animateValue(document.getElementById('stat-students'), parseInt(document.getElementById('stat-students').innerText) || 0, d.students || 0, 1500); animateValue(document.getElementById('stat-schools'), parseInt(document.getElementById('stat-schools').innerText) || 0, d.schools || 0, 1500); animateValue(document.getElementById('stat-packed'), parseInt(document.getElementById('stat-packed').innerText) || 0, d.packed || 0, 1500); animateValue(document.getElementById('stat-pending'), parseInt(document.getElementById('stat-pending').innerText) || 0, d.pending || 0, 1500); } catch (e) { console.error("Stats Error", e) } }
        async function fetchAllStudents() {
            try {
                const r = await fetch(`${API_BASE}/data/all_students`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();

                // Deduplicate by ID
                const uniqueStudents = new Map();
                if (Array.isArray(d)) {
                    d.forEach(s => {
                        if (!uniqueStudents.has(s.id)) {
                            uniqueStudents.set(s.id, s);
                        } else {
                            // Optional: Merge data if needed, but for now take first
                        }
                    });
                    globalStudents = Array.from(uniqueStudents.values());
                } else {
                    globalStudents = [];
                }
            } catch (e) { console.error("Student Fetch Error", e); globalStudents = []; }
        }
        async function fetchGlobalPatterns() {
            try {
                const r = await fetch(`${API_BASE}/data/patterns/all`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();
                globalPatterns = Array.isArray(d) ? d : [];

                const filterEl = document.getElementById('filter-pattern');
                if (filterEl) {
                    filterEl.innerHTML = '<option value="all">All Patterns</option>' + globalPatterns.map(p => `<option value="${p.id}">${p.name} (${p.school_name})</option>`).join('');
                }
            } catch (e) { console.error("Patterns Error", e); globalPatterns = []; }
        }
        async function fetchSchoolsForSelect() { try { const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } }); const d = await r.json(); globalSchools = Array.isArray(d) ? d : []; if (globalSchools.length > 0) { const o = globalSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); document.getElementById('school-select').innerHTML = o; document.getElementById('access-school-select').innerHTML = o; } } catch (e) { console.error("Schools Error", e); globalSchools = []; } }

        async function fetchUsers(throwOnError = false) {
            try {
                const r = await fetch(`${API_BASE}/data/users`, { headers: { 'Authorization': `Bearer ${token}` } });

                if (!r.ok) {
                    const errText = await r.text();
                    const msg = `Server Error ${r.status}: ${errText}`;
                    console.error("Fetch Users Failed:", msg);
                    if (throwOnError) throw new Error(msg);
                    return;
                }

                const u = await r.json();

                if (!Array.isArray(u)) {
                    const msg = "Invalid Data Format: Expected Array";
                    console.error("Fetch Users Invalid Format:", u);
                    if (throwOnError) throw new Error(msg);
                    return;
                }

                // Warn if data is unexpectedly empty (stale session?)
                if (u.length === 0 && throwOnError) {
                    // We don't alert here anymore to avoid spam, but the caller will handle it.
                    console.warn("API returned 0 users. Session might be stale.");
                }

                globalUsers = u;

                const listBody = document.getElementById('user-list-body');
                if (listBody) {
                    listBody.innerHTML = u.map(x => `
                        <tr class="hover:bg-gray-50/50 group border-b border-gray-50">
                            <td class="p-4 font-bold text-gray-700">${x.username}</td>
                            <td class="p-4"><span class="px-3 py-1 rounded-full text-xs bg-gray-100/80 uppercase font-bold text-gray-500 shadow-inner">${x.role}</span></td>
                            <td class="p-4 text-gray-500">${x.school_name || '-'}</td>
                            <td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-bold shadow-sm ${x.is_active !== false ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${x.is_active !== false ? 'Active' : 'Disabled'}</span></td>
                            <td class="p-4 text-right text-xs space-x-2">
                                 <button onclick="resetUserPassword(${x.id}, '${x.username}')" class="px-3 py-1.5 rounded-lg font-bold text-gray-500 hover:text-blue-600 hover:bg-blue-50 transition-colors shadow-sm border border-transparent hover:border-blue-100">Reset Pwd</button>
                                 <button onclick="toggleUserStatus(${x.id},${!(x.is_active !== false)},'${x.username}')" class="px-3 py-1.5 rounded-lg font-bold shadow-sm ${x.is_active !== false ? 'text-red-500 bg-red-50 hover:bg-red-100' : 'text-green-500 bg-green-50 hover:bg-green-100'}">${x.is_active !== false ? 'Disable' : 'Enable'}</button>
                            </td>
                        </tr>`).join('');
                }
            } catch (e) {
                console.error("Fetch Users Exception:", e);
                globalUsers = [];
                // Fix: Clear the table on error so the user doesn't see stale "Ghost" data
                const listBody = document.getElementById('user-list-body');
                if (listBody) {
                    listBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500 font-bold bg-red-50 rounded-lg">
                        Connection Failed. Please refresh the page.<br><span class="text-xs font-normal text-gray-500">${e.message}</span>
                    </td></tr>`;
                }
                if (throwOnError) throw e;
            }
        }
        async function fetchAccessCodes() { try { const r = await fetch(`${API_BASE}/data/access_codes`, { headers: { 'Authorization': `Bearer ${token}` } }); const c = await r.json(); if (Array.isArray(c)) document.getElementById('access-code-list').innerHTML = c.map(x => `<tr class="border-b border-gray-50 ${x.is_active ? '' : 'opacity-40'}"><td class="py-4 font-bold text-gray-600">${x.school_name}</td><td class="py-4 font-mono text-rose-500 font-bold tracking-wider">${x.code}</td><td class="py-4 capitalize text-gray-500 font-medium">${x.type}</td><td class="py-4 text-center"><span class="${x.is_active ? 'text-green-500' : 'text-red-400 animate-pulse'} font-extrabold text-xs uppercase tracking-wider">${x.is_active ? 'Active' : 'Revoked'}</span></td><td class="py-4 text-right space-x-2">${x.is_active ? `<button onclick="toggleCode(${x.id},false)" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded-lg text-xs font-bold transition-colors">REVOKE</button>` : `<button onclick="toggleCode(${x.id},true)" class="text-green-500 hover:bg-green-50 px-3 py-1 rounded-lg text-xs font-bold transition-colors">ACTIVATE</button>`}</td></tr>`).join(''); } catch (e) { console.error(e) } }
        async function fetchSchoolsManage() {
            try {
                const r = await fetch(`${API_BASE}/data/schools`, { headers: { 'Authorization': `Bearer ${token}` } });
                const d = await r.json();
                document.getElementById('school-list-body').innerHTML = Array.isArray(d) ? d.map(s => `
                    <tr class="hover:bg-gray-50/50 group border-b border-gray-50 ${s.priority === 'Urgent' ? 'bg-red-50/30' : ''}">
                        <td class="p-4 font-bold text-gray-700">
                             <div class="flex flex-col">
                                <span class="flex items-center gap-2">
                                    ${s.name}
                                    ${s.priority === 'Urgent' ? '<span class="animate-pulse text-xl" title="Urgent Production">üî•</span>' : ''}
                                    ${s.priority === 'High' ? '<span class="text-lg" title="High Priority">‚ö†Ô∏è</span>' : ''}
                                </span>
                                <span class="text-[10px] text-gray-400 font-mono mt-1" id="timer-${s.id}">Calculate...</span>
                             </div>
                        </td>
                        <td class="p-4">
                             <div class="flex flex-col gap-2">
                                <select onchange="updateSchoolMeta(${s.id},'priority',this.value); if(this.value==='Urgent') alert('‚ö†Ô∏è Marked as URGENT! Production team will be notified.'); fetchSchoolsManage();" 
                                    class="clay-input h-8 py-1 px-2 text-xs font-bold uppercase ${s.priority === 'Urgent' ? 'text-red-600 bg-red-100 border-red-200' : (s.priority === 'High' ? 'text-orange-500' : 'text-gray-500')}">
                                    <option value="Normal" ${s.priority === 'Normal' ? 'selected' : ''}>Normal Priority</option>
                                    <option value="High" ${s.priority === 'High' ? 'selected' : ''}>High Priority</option>
                                    <option value="Urgent" ${s.priority === 'Urgent' ? 'selected' : ''}>Urgent (Rush)</option>
                                    <option value="Low" ${s.priority === 'Low' ? 'selected' : ''}>Low Priority</option>
                                </select>
                                <div class="flex gap-2 items-center">
                                    <div class="flex flex-col">
                                        <label class="text-[9px] uppercase font-bold text-gray-400">Start</label>
                                        <input type="date" value="${s.start_date ? s.start_date.split('T')[0] : ''}" onchange="updateSchoolMeta(${s.id}, 'start_date', this.value)" class="clay-input h-6 text-[10px] w-24">
                                    </div>
                                    <div class="flex flex-col">
                                        <label class="text-[9px] uppercase font-bold text-gray-400">Deadline</label>
                                        <input type="date" value="${s.deadline ? s.deadline.split('T')[0] : ''}" onchange="updateSchoolMeta(${s.id}, 'deadline', this.value)" class="clay-input h-6 text-[10px] w-24">
                                    </div>
                                </div>
                             </div>
                        </td>
                        <td class="p-4 flex items-center gap-2">
                            <select id="status-select-${s.id}" class="clay-input h-8 py-1 px-2 text-xs font-bold uppercase w-full">
                                <option value="Measurements" ${s.status === 'Measurements' ? 'selected' : ''}>Measurements</option>
                                <option value="Processing" ${s.status === 'Processing' ? 'selected' : ''}>Processing</option>
                                <option value="Production" ${s.status === 'Production' ? 'selected' : ''}>Production</option>
                                <option value="Dispatch" ${s.status === 'Dispatch' ? 'selected' : ''}>Dispatch</option>
                                <option value="Delivered" ${s.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                            <button onclick="updateSchoolStatusManual(${s.id})" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-lg shadow-sm transition-colors" title="Update Status">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            </button>
                        </td>
                        <td class="p-4 text-right">
                             <div class="flex gap-2 justify-end">
                                <button onclick="viewSchoolData('${s.name}', ${s.id})" class="text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">STUDENTS</button>
                                <button onclick="viewSchoolDetails('${s.name}', ${s.id})" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm">DETAILS</button>
                                <button onclick="deleteSchool(${s.id}, '${s.name}')" class="text-xs bg-red-50 hover:bg-red-100 text-red-600 font-bold px-3 py-2 rounded-lg transition-colors shadow-sm" title="Delete School">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                             </div>
                        </td>
                    </tr>`).join('') : '';

                // Trigger Countdowns
                if (Array.isArray(d)) {
                    d.forEach(s => updateTimerUI(s.id, s.deadline));
                    renderUrgentDeadlines(); // Update Main Dashboard Widget too
                }
            } catch (e) { console.error(e) }
        }

        function updateTimerUI(id, deadline) {
            const el = document.getElementById(`timer-${id}`);
            if (!el) return;
            if (!deadline) { el.innerText = "No deadline set"; return; }

            const diff = new Date(deadline) - new Date();
            if (diff < 0) {
                el.innerText = "‚ö†Ô∏è Overdue!";
                el.className = "text-[10px] text-red-600 font-bold mt-1 animate-pulse";
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            el.innerText = `‚è≥ ${days} ${days === 1 ? 'day' : 'days'} remaining`;
            if (days <= 3) el.className = "text-[10px] text-orange-600 font-bold mt-1";
            else el.className = "text-[10px] text-emerald-600 font-medium mt-1";
        }

        function renderUrgentDeadlines() {
            const grid = document.getElementById('urgent-deadlines-grid');
            if (!grid || !globalSchools) return;

            // Filter schools with deadlines
            const urgent = globalSchools
                .filter(s => s.deadline)
                .map(s => ({
                    ...s,
                    diff: new Date(s.deadline) - new Date(),
                    days: Math.floor((new Date(s.deadline) - new Date()) / (1000 * 60 * 60 * 24))
                }))
                .filter(s => s.diff > -86400000 * 30) // Only show recent overdue or future
                .sort((a, b) => a.diff - b.diff) // Most urgent first
                .slice(0, 3); // Top 3

            if (urgent.length === 0) {
                grid.innerHTML = `<div class="col-span-full clay-card p-6 flex items-center justify-center text-gray-400 italic">No upcoming deadlines found. Set a deadline in School Management.</div>`;
                return;
            }

            grid.innerHTML = urgent.map(s => {
                const isOverdue = s.diff < 0;
                const statusColor = isOverdue ? 'bg-red-50 text-red-600 border-red-200' : (s.days <= 7 ? 'bg-orange-50 text-orange-600 border-orange-200' : 'bg-green-50 text-green-600 border-green-200');

                return `
                <div class="clay-card p-5 border ${isOverdue ? 'border-red-300 shadow-red-100' : 'border-white'} relative overflow-hidden group">
                    <div class="flex justify-between items-start mb-2">
                        <div class="font-bold text-gray-700 text-lg truncate">${s.name}</div>
                        ${s.priority === 'Urgent' ? '<span class="animate-pulse text-lg" title="Urgent">üî•</span>' : ''}
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex flex-col">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Time Remaining</span>
                            <span class="text-xl font-black ${isOverdue ? 'text-red-500' : 'text-gray-700'}">
                                ${isOverdue ? 'OVERDUE' : s.days + ' Days'}
                            </span>
                        </div>
                         <div class="flex flex-col text-right">
                            <span class="text-[10px] uppercase font-bold text-gray-400">Deadline</span>
                            <span class="text-sm font-bold text-gray-600">${new Date(s.deadline).toLocaleDateString()}</span>
                        </div>
                    </div>
                    
                     <!-- Progress Bar Visual -->
                     <div class="w-full h-1.5 bg-gray-100 rounded-full mt-4 overflow-hidden">
                        <div class="h-full ${isOverdue ? 'bg-red-500' : (s.days <= 7 ? 'bg-orange-400' : 'bg-emerald-400')}" style="width: ${Math.max(5, Math.min(100, 100 - (s.days * 2)))}%"></div>
                     </div>
                </div>
                `;
            }).join('');

            // Notification Logic (Simple Toast) for Urgent items
            const veryUrgent = urgent.filter(s => s.days <= 3 && s.days >= 0);
            if (veryUrgent.length > 0 && !window.hasNotifiedUrgent) {
                // Check setting: default to valid (true) if null
                const enabled = localStorage.getItem('notification_enabled') !== 'false';
                if (enabled) {
                    window.hasNotifiedUrgent = true;
                    const msg = `‚ö†Ô∏è Action Required: ${veryUrgent.length} school(s) have deadlines approaching in < 3 days.`;
                    showToast(msg, 'error');

                    // Native Browser Notification
                    if (Notification.permission === 'granted') {
                        new Notification("Planet Solutions Urgent", { body: `Action Required: ${veryUrgent.length} school(s) are near deadline!`, icon: 'https://cdn-icons-png.flaticon.com/512/564/564619.png' });
                    }
                }
            }
        }

        // Initialize Toggle
        document.addEventListener("DOMContentLoaded", () => {
            const setting = document.getElementById('setting-notify');
            if (setting) setting.checked = localStorage.getItem('notification_enabled') !== 'false';
        });

        function toggleNotificationSetting(val) {
            localStorage.setItem('notification_enabled', val);

            if (val && Notification.permission !== 'granted') {
                Notification.requestPermission().then(p => {
                    if (p === 'granted') {
                        showToast("Browser Notifications Enabled!", 'success');
                        new Notification("Planet Solutions", { body: "Browser notifications are now active." });
                    } else {
                        showToast("Browser Notifications Blocked. Check site settings.", 'error');
                    }
                });
            } else {
                showToast(`Notifications ${val ? 'Enabled' : 'Disabled'}`, 'info');
            }
        }

        function showToast(msg, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = "fixed top-4 right-4 z-[9999] flex flex-col gap-3 pointer-events-none";
                document.body.appendChild(container); // Append to body, not inside a hidden view
            }

            const el = document.createElement('div');
            // Colors based on type
            const colors = type === 'error' ? 'bg-red-50 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-200';
            const icon = type === 'error' ? 'üî•' : '‚ÑπÔ∏è';

            el.className = `clay-card p-4 rounded-xl shadow-2xl border ${colors} pointer-events-auto flex items-center gap-3 animate-in slide-in-from-right duration-300 max-w-sm`;
            el.innerHTML = `
                <span class="text-xl">${icon}</span>
                <p class="text-sm font-bold">${msg}</p>
                <button onclick="this.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">‚úï</button>
            `;

            container.appendChild(el);
            // Auto remove after 6s
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => el.remove(), 500);
            }, 6000);
        }


        async function updateSchoolMeta(id, f, v) {
            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ [f]: v })
                });
                if (!r.ok) throw new Error("Update failed");
                if (typeof fetchSchoolsManage === 'function') fetchSchoolsManage();
                // LOGGING
                Logger.log('UPDATE_SCHOOL', `Updated School ${id} ${f} to ${v}`);
            } catch (e) {
                console.error(e);
                alert("Failed to save changes. Please try again.");
            }
        }

        async function deleteSchool(id, name) {
            if (!confirm(`‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nAre you sure you want to PERMANENTLY DELETE "${name}"?\n\nThis will remove:\n- The School Account\n- All ${name} Students\n- Measurements, Orders, Patterns\n\nThis action cannot be undone.`)) return;

            const verify = prompt(`To confirm deletion, type "DELETE" below:`);
            if (verify !== 'DELETE') return alert("Deletion Cancelled.");

            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                const res = await r.json();
                if (r.ok) {
                    alert('‚úÖ ' + res.message);
                    Logger.log('DELETE_SCHOOL', `Deleted School: ${name} (ID: ${id})`);
                    fetchSchoolsManage(); // Refresh List
                    fetchStats(); // Refresh Stats
                    fetchAllStudents(); // Refresh Data
                    // If current view is this school, go back
                    if (tdCurrentSchoolId === id) switchTab('schools');
                } else {
                    alert('‚ùå Failed: ' + (res.error || 'Unknown Error'));
                }
            } catch (e) { alert('Example Error: ' + e.message); }
        }

        async function updateSchoolStatusManual(id) {
            const val = document.getElementById(`status-select-${id}`).value;
            try {
                const r = await fetch(`${API_BASE}/data/schools/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ status: val })
                });

                if (r.ok) {
                    const res = await r.json();
                    const debugInfo = res.debug ? `\n(Affected: ${res.debug.affected}, Changed: ${res.debug.changed})` : '';
                    alert("‚úÖ Status Updated Successfully!" + debugInfo);
                } else {
                    const errText = await r.text();
                    try {
                        const errJson = JSON.parse(errText);
                        alert("‚ùå Update Failed: " + (errJson.error || errText));
                    } catch (e) {
                        alert("‚ùå Update Failed: " + errText);
                    }
                }
            } catch (e) { alert("Error: " + e.message); }
        }

        // SCHOOL DETAILS LOGIC


        // NEW: Link from Schools List to Data View
        async function viewSchoolData(schoolName, schoolId) {
            switchTab('data');
            // Ensure options populated
            populateDynamicFilters();

            // If ID provided, use new Detail View directly
            if (schoolId) {
                openSchoolDetails(schoolId);
            } else {
                // Fallback for name-only (Legacy support, try to find ID)
                const s = globalSchools.find(x => x.name === schoolName);
                if (s) openSchoolDetails(s.id);
                else {
                    const fs = document.getElementById('filter-school');
                    if (fs) fs.value = schoolName;
                    renderTailoringData();
                }
            }
        }

        // MODIFIED: School Details now focuses on Settings/Patterns
        async function viewSchoolDetails(schoolName, schoolId) {
            switchTab('view-school-details');
            currentSchoolDetails = { name: schoolName, id: schoolId };
            document.getElementById('sd-school-name').innerText = schoolName;

            // Reset Lock Status (Fix ghosting issue)
            currentSchoolLocked = false;
            updateLockUI();

            // Fetch Lock Status
            if (schoolId) fetchAndSetLockStatus(schoolId);

            // Ensure data is loaded
            if (globalStudents.length === 0) await fetchAllStudents();
            if (globalPatterns.length === 0) await fetchGlobalPatterns();

            // Default to students
            switchSchoolTab('students');
            renderSchoolDetails();
        }

        // Alias for compatibility


        function switchSchoolTab(t) {
            const tabs = ['students', 'measurements', 'patterns'];
            tabs.forEach(tab => {
                const view = document.getElementById(`sd-view-${tab}`);
                const btn = document.getElementById(`tab-sd-${tab}`);
                if (view) view.classList.add('hidden');
                if (btn) btn.className = "clay-btn text-sm text-gray-500 hover:text-gray-700";
            });

            const v = document.getElementById(`sd-view-${t}`);
            const b = document.getElementById(`tab-sd-${t}`);
            if (v) v.classList.remove('hidden');
            if (b) b.className = "clay-btn text-sm active bg-blue-50 text-blue-600 border-blue-100";
        }

        function renderSchoolDetails() {
            const sName = currentSchoolDetails.name;
            const students = globalStudents.filter(s => s.school_name === sName);
            const patterns = globalPatterns.filter(p => p.school_name === sName);

            // 1. Render Students List
            document.getElementById('sd-count-students').innerText = `${students.length} records`;
            document.getElementById('sd-list-students').innerHTML = students.map(s => `
                    <tr class="hover:bg-gray-50 group transition-colors">
                        <td class="p-4 font-mono text-xs font-bold text-gray-500">${s.roll_no || '-'}</td>
                        <td class="p-4 font-bold text-gray-700">${s.name}</td>
                        <td class="p-4 text-xs font-bold text-gray-500">${s.class || ''} ${s.section || ''}</td>
                        <td class="p-4 text-xs font-bold text-gray-500 opacity-70">${s.gender || '-'}</td>
                         <td class="p-4 text-xs font-mono text-blue-500 font-bold">${s.pattern_name || '-'}</td>
                        <td class="p-4 text-center">
                             <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wide ${getStatusColor(s.order_status, s.is_packed)}">
                                ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                             </span>
                        </td>
                    </tr>
                `).join('');

            // 2. Render Measurements (Detailed)
            document.getElementById('sd-list-measurements').innerHTML = students.map(s => {
                const m = getMeasurementsSafe(s);
                const iq = getItemQuantitiesSafe(s);
                const qtyStr = Object.entries(iq).map(([k, v]) => `${k}: ${v}`).join(', ');

                return `
                    <tr class="hover:bg-gray-50 group border-b border-gray-50">
                        <td class="p-3 font-bold text-gray-700 bg-white sticky left-0 shadow-sm">${s.name}</td>
                        <td class="p-3 text-center text-xs text-blue-500 font-bold">${s.pattern_name || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u1 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u2 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u3 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u4 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u5 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-orange-600 bg-orange-50/30">${m.u6 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l1 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l2 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l3 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l4 || '-'}</td>
                        <td class="p-3 text-center text-xs font-mono text-indigo-600 bg-indigo-50/30">${m.l5 || '-'}</td>
                        <td class="p-3 text-xs text-purple-600 font-bold bg-purple-50/50 max-w-[200px] truncate" title="${qtyStr}">${qtyStr || '-'}</td>
                        <td class="p-3 text-xs text-gray-400 italic pl-6 max-w-[150px] truncate" title="${m.remarks || ''}">${m.remarks || '-'}</td>
                    </tr>`;
            }).join('');

            // 3. Render Patterns
            if (patterns.length === 0) {
                document.getElementById('sd-no-patterns').classList.remove('hidden');
                document.getElementById('sd-list-patterns').innerHTML = '';
            } else {
                document.getElementById('sd-no-patterns').classList.add('hidden');
                document.getElementById('sd-list-patterns').innerHTML = patterns.map(p => `
                        <div class="clay-card p-6 flex flex-col justify-between hover:scale-[1.02] transition-transform">
                            <div>
                                <h4 class="font-bold text-lg text-gray-700 mb-2">${p.name}</h4>
                                <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-4">Consumption: <span class="text-blue-500 text-lg">${p.consumption}m</span></p>
                                <div class="bg-gray-50 p-3 rounded-xl mb-4">
                                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Cloth Details</p>
                                    <p class="text-xs text-gray-600 font-medium line-clamp-2">${p.cloth_details || 'No details provided.'}</p>
                                </div>
                            </div>
                            <button onclick="window.open('pattern_view.html', '_blank')" class="text-xs font-bold text-center w-full py-3 rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors uppercase tracking-wider">
                                Manage in Editor
                            </button>
                        </div>
                    `).join('');
            }
        }
        function populateDynamicFilters() {
            // Get unique values from Global Students
            const c = [...new Set(globalStudents.map(s => s.class).filter(Boolean))].sort();
            const se = [...new Set(globalStudents.map(s => s.section).filter(Boolean))].sort();

            // Populate Class Filter (New ID: td-filter-class)
            const classSelect = document.getElementById('td-filter-class');
            if (classSelect) {
                const current = classSelect.value;
                classSelect.innerHTML = '<option value="all">Class</option>' + c.map(x => `<option value="${x}">${x}</option>`).join('');
                if (c.includes(current)) classSelect.value = current;
            }

            // Populate Section Filter (New ID: td-filter-section)
            const sectionSelect = document.getElementById('td-filter-section');
            if (sectionSelect) {
                const current = sectionSelect.value;
                sectionSelect.innerHTML = '<option value="all">Section</option>' + se.map(x => `<option value="${x}">${x}</option>`).join('');
                if (se.includes(current)) sectionSelect.value = current;
            }

            // Populate School Filter (if exists in sidebar or elsewhere)
            const schoolSelect = document.getElementById('filter-school');
            if (schoolSelect) {
                const schools = globalSchools.length > 0 ? globalSchools.map(s => s.name).sort() : [...new Set(globalStudents.map(s => s.school_name).filter(Boolean))].sort();
                schoolSelect.innerHTML = '<option value="all">All Schools</option>' + schools.map(s => `<option value="${s.replace(/"/g, '&quot;')}">${s}</option>`).join('');
            }
        }
        // === NEW TAILORING DATA LOGIC (School-Centric) ===
        let tdCurrentSchoolId = null;
        let tdCurrentTab = 'students';

        // HELPER: Reset all visibility to prevent "leaking" views
        function resetTdViews() {
            const views = [
                'td-level-1',
                'td-level-2',
                'td-category-grid',
                'td-view-students',
                'td-view-measurements',
                'td-view-patterns-boys',
                'td-view-patterns-girls'
            ];
            views.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        async function renderTailoringData() {
            try {
                console.log("Rendering Tailoring Data...");
                resetTdViews();
                const container = document.getElementById('td-level-1');
                if (container) container.classList.remove('hidden');

                const grid = document.getElementById('td-school-grid');
                if (!grid) { console.error("Grid ID not found"); return; }

                // Show loading state
                grid.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="text-gray-400 mt-2">Loading data...</p></div>';

                // Safety check for students
                if (!globalStudents || globalStudents.length === 0) {
                    try { await fetchAllStudents(); } catch (e) { console.error("Student fetch failed", e); }
                }

                // Safety check for schools
                if (!globalSchools || globalSchools.length === 0) {
                    try { await fetchSchoolsForSelect(); } catch (e) { console.error("School fetch failed", e); }
                }

                if (!globalSchools || globalSchools.length === 0) {
                    grid.innerHTML = `<div class="col-span-full text-center py-20">
                        <div class="inline-block p-4 rounded-full bg-gray-50 mb-4 text-gray-300">
                            <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-gray-400">No Schools Found</h3>
                        <p class="text-xs text-gray-400 mt-2">Add schools in the "Schools" tab to see them here.</p>
                        <button onclick="renderTailoringData()" class="mt-4 text-blue-500 hover:underline text-xs">Retry</button>
                    </div>`;
                    return;
                }

                grid.innerHTML = globalSchools.map(s => {
                    // Safe access to students
                    const schoolStudents = Array.isArray(globalStudents) ? globalStudents.filter(st => st.school_name === s.name) : [];
                    const count = schoolStudents.length;
                    const takingMeas = schoolStudents.filter(st => st.measurements && Object.keys(st.measurements).length > 0).length;

                    return `
                         <div onclick="openSchoolDetails(${s.id})" class="clay-card p-6 flex flex-col cursor-pointer hover:scale-[1.03] transition-transform group">
                             <div class="flex justify-between items-start mb-6">
                                  <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-extrabold text-2xl shadow-lg shadow-blue-200">
                                      ${s.name ? s.name.charAt(0) : '?'}
                                  </div>
                                  <span class="px-3 py-1 rounded-lg bg-gray-50 text-gray-400 text-[10px] font-bold uppercase tracking-wider group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">View Data</span>
                             </div>
                             <h3 class="text-xl font-bold text-gray-800 mb-1 line-clamp-1" title="${s.name}">${s.name}</h3>
                             <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-6">${s.priority || 'Normal'} Priority</p>
                             
                             <div class="mt-auto grid grid-cols-2 gap-4">
                                  <div class="bg-gray-50 rounded-xl p-3">
                                      <p class="text-[10px] text-gray-400 uppercase font-bold">Students</p>
                                      <p class="text-lg font-extrabold text-gray-700">${count}</p>
                                  </div>
                                  <div class="bg-gray-50 rounded-xl p-3">
                                      <p class="text-[10px] text-gray-400 uppercase font-bold">Meas. Taken</p>
                                      <p class="text-lg font-extrabold text-emerald-500">${takingMeas}</p>
                                  </div>
                             </div>
                         </div>
                         `;
                }).join('');
            } catch (e) {
                console.error("Render Error:", e);
                const grid = document.getElementById('td-school-grid');
                if (grid) grid.innerHTML = `<div class="col-span-full p-4 bg-red-50 text-red-500 rounded-xl text-center">
                    <p class="font-bold">Error loading view</p>
                    <p class="text-xs font-mono mt-2">${e.message}</p>
                    <button onclick="location.reload()" class="mt-4 px-4 py-2 bg-red-100 rounded-lg hover:bg-red-200 transition-colors text-xs font-bold">Reload Page</button>
                </div>`;
            }
        }

        async function openSchoolDetails(id) {
            if (globalStudents.length === 0) await fetchAllStudents();
            if (globalPatterns.length === 0) await fetchGlobalPatterns();

            tdCurrentSchoolId = id;
            const s = globalSchools.find(x => x.id == id);
            if (!s) return;

            resetTdViews();
            document.getElementById('td-level-2').classList.remove('hidden');
            document.getElementById('td-category-grid').classList.remove('hidden');

            document.getElementById('td-school-name').innerText = s.name;
            document.getElementById('td-school-badge').innerText = s.status || 'Pending';
            document.getElementById('td-school-badge').className = `px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider ${getStatusColor(s.status, false)}`;

            // Reset Filters & Populate Counts - Use School Name match
            const schoolStudents = globalStudents.filter(st => st.school_name === s.name);
            document.getElementById('td-cat-students-count').innerText = `${schoolStudents.length} Students`;

            // Pattern Counts (Fixed: Use ID if available, else Name)
            const schoolPatterns = globalPatterns.filter(p =>
                (p.school_id && p.school_id == s.id) ||
                (p.school_name === s.name)
            );

            // New Robust Gender Resolver
            // 1. Explicit Filter -> 2. Keyword -> 3. Usage (Students) -> 4. Unisex
            const resolvePatternGender = (p) => {
                // 1. Explicit Filter
                if (p.filters) {
                    try {
                        const f = typeof p.filters === 'string' ? JSON.parse(p.filters) : p.filters;
                        if (f.gender) return f.gender; // 'Male', 'Female', 'Unisex'
                    } catch (e) { }
                }

                // 2. Student Usage Check (Real World Data - Most Accurate)
                if (schoolStudents.length > 0) {
                    const linked = schoolStudents.filter(s => s.pattern_name === p.name);
                    if (linked.length > 0) {
                        const hasBoys = linked.some(s => (s.gender || '').toLowerCase().startsWith('m') || (s.gender || '').toLowerCase() === 'boy');
                        const hasGirls = linked.some(s => (s.gender || '').toLowerCase().startsWith('f') || (s.gender || '').toLowerCase() === 'girl');

                        if (hasBoys && !hasGirls) return 'Male';
                        if (!hasBoys && hasGirls) return 'Female';
                    }
                }

                // 3. Dress Type (Item) Check - Refined
                if (p.filters) {
                    try {
                        const f = typeof p.filters === 'string' ? JSON.parse(f.filters) : f.filters;
                        if (f.item) {
                            const iName = f.item.toUpperCase();
                            // Females have specific items
                            if (iName.includes('GIRLS') || iName.includes('FEMALE') || iName.includes('SKIRT') || iName.includes('FROCK') || iName.includes('KURTHA') || iName.includes('PINAFORE')) return 'Female';
                            // "Boys" is specific, but "Pant/Shirt" matches both. Only use strong male keywords.
                            if (iName.includes('BOYS') || iName.includes('MALE')) return 'Male';
                            // Note: "Pant", "Trouser", "Shirt" are now NEUTRAL (Unisex) by default unless usage proves otherwise.
                        }
                    } catch (e) { }
                }

                // 4. Keyword Check (Strong)
                const name = (p.name || '').toUpperCase();
                // Check Female First
                if (name.includes('GIRLS') || name.includes('FEMALE') || name.includes('SKIRT') || name.includes('FROCK') || name.includes('KURTHA') || name.includes('PINAFORE')) return 'Female';
                if (name.includes('BOYS') || name.includes('MALE')) return 'Male';
                // Removed: SHIRT, PANT, TROUSER from automatic Male inference.

                return 'Unisex'; // Shows in both
            };

            // Calculate Counts based on Resolved Gender
            let boysCount = 0;
            let girlsCount = 0;

            schoolPatterns.forEach(p => {
                const g = resolvePatternGender(p);
                if (g === 'Male' || g === 'Unisex') boysCount++;
                if (g === 'Female' || g === 'Unisex') girlsCount++;
            });

            // Update UI
            document.getElementById('td-cat-boys-count').innerText = `${boysCount} Groups`;
            document.getElementById('td-cat-girls-count').innerText = `${girlsCount} Groups`;

            // Store resolver for other functions to use (Global Helper wouldn't be scoped to schoolStudents unless passed)
            // Ideally we make resolvePatternGender global but it needs schoolStudents.
            // Let's attach it to window temporarily or just duplicate the logic in renderTdPatterns?
            // Better: Make it a global helper that takes schoolStudents as arg.
            // For now, I'll define it here and Duplicate in renderTdPatterns (or refactor). 
            // Refactoring to Global Helper is cleaner.
            window.resolvePatternGenderHelper = (p, students) => {
                // 1. Explicit Filter
                if (p.filters) {
                    try {
                        const f = typeof p.filters === 'string' ? JSON.parse(p.filters) : p.filters;
                        if (f.gender) return f.gender;
                    } catch (e) { }
                }

                // 2. Usage (Prioritized)
                if (students && students.length > 0) {
                    const linked = students.filter(s => s.pattern_name === p.name);
                    if (linked.length > 0) {
                        const hasBoys = linked.some(s => (s.gender || '').toLowerCase().startsWith('m') || (s.gender || '').toLowerCase() === 'boy');
                        const hasGirls = linked.some(s => (s.gender || '').toLowerCase().startsWith('f') || (s.gender || '').toLowerCase() === 'girl');
                        if (hasBoys && !hasGirls) return 'Male';
                        if (!hasBoys && hasGirls) return 'Female';
                    }
                }

                // 3. Dress Type (Item) Check
                if (p.filters) {
                    try {
                        const f = typeof p.filters === 'string' ? JSON.parse(p.filters) : p.filters;
                        if (f.item) {
                            const iName = f.item.toUpperCase();
                            if (iName.includes('GIRLS') || iName.includes('FEMALE') || iName.includes('SKIRT') || iName.includes('FROCK') || iName.includes('KURTHA') || iName.includes('PINAFORE')) return 'Female';
                            if (iName.includes('BOYS') || iName.includes('MALE')) return 'Male';
                        }
                    } catch (e) { }
                }

                // 4. Keyword
                const name = (p.name || '').toUpperCase();
                if (name.includes('GIRLS') || name.includes('FEMALE') || name.includes('SKIRT') || name.includes('FROCK') || name.includes('KURTHA') || name.includes('PINAFORE')) return 'Female';
                if (name.includes('BOYS') || name.includes('MALE')) return 'Male';

                return 'Unisex';
            };

            const classes = [...new Set(schoolStudents.map(st => st.class).filter(Boolean))].sort();
            const sections = [...new Set(schoolStudents.map(st => st.section).filter(Boolean))].sort();
            const genders = [...new Set(schoolStudents.map(st => st.gender).filter(Boolean))].sort();

            document.getElementById('td-filter-class').innerHTML = '<option value="all">Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('td-filter-section').innerHTML = '<option value="all">Section</option>' + sections.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function closeSchoolDetails() {
            tdCurrentSchoolId = null;
            renderTailoringData(); // Re-render grid to update stats if changed (though unlikely here)
        }

        // Level 2 -> Level 3 Transition
        function openLevel3(category) {
            resetTdViews();
            document.getElementById('td-level-2').classList.remove('hidden'); // Header remains visible
            const view = document.getElementById(`td-view-${category}`);
            if (view) {
                view.classList.remove('hidden');
                tdCurrentTab = category; // Maintain state for filters
                renderTdCurrentTab();
            }
        }

        function closeLevel3() {
            document.querySelectorAll('div[id^="td-view-"]').forEach(d => d.classList.add('hidden'));
            document.getElementById('td-category-grid').classList.remove('hidden');
            tdCurrentTab = null;
        }

        // Replaces switchTdTab for the new flow
        function switchTdTab(tab) {
            // Legacy support or direct link if needed, now directs to openLevel3
            openLevel3(tab);
        }
        // Helper to parse range queries (e.g. "1-5", "A-C")
        function parseRange(query) {
            query = query.toUpperCase().trim();
            if (!query) return null;

            // Numeric Range: "1-5"
            // Start of string, digit, dash, digit, end of string (simple)
            const numRange = query.match(/^(\d+)-(\d+)$/);
            if (numRange) {
                const start = parseInt(numRange[1]);
                const end = parseInt(numRange[2]);
                if (!isNaN(start) && !isNaN(end)) {
                    const res = [];
                    for (let i = Math.min(start, end); i <= Math.max(start, end); i++) res.push(String(i));
                    return res;
                }
            }

            // Alpha Range: "A-C"
            const charRange = query.match(/^([A-Z])-([A-Z])$/);
            if (charRange) {
                const start = charRange[1].charCodeAt(0);
                const end = charRange[2].charCodeAt(0);
                const res = [];
                for (let i = Math.min(start, end); i <= Math.max(start, end); i++) res.push(String.fromCharCode(i));
                return res;
            }

            return null; // Not a range
        }

        function renderTdCurrentTab() {
            if (!tdCurrentSchoolId) return;

            // 1. Get Base Data
            // 1. Get Base Data (Use Name for consistency with other fixes)
            const schoolName = document.getElementById('td-school-name').innerText;
            let data = globalStudents.filter(st => st.school_name === schoolName);

            // 2. Apply Filters
            const cls = document.getElementById('td-filter-class').value;
            const sec = document.getElementById('td-filter-section').value;
            const gender = document.getElementById('td-filter-gender').value;
            const search = document.getElementById('td-filter-search').value.trim();

            if (cls !== 'all') data = data.filter(st => st.class == cls);
            if (sec !== 'all') data = data.filter(st => st.section == sec);
            if (gender !== 'all') data = data.filter(st => st.gender && st.gender.toLowerCase() === gender.toLowerCase());

            // 3. Search Logic (Range + Keyword)
            if (search) {
                const rangeFilter = parseRange(search);
                if (rangeFilter) {
                    // Try to match Class OR Section
                    // If range is numeric [1,2,3], likely class.
                    // If range is alpha [A,B,C], likely section.
                    // But simpler: Check if Class OR Section is IN the range list.
                    data = data.filter(st =>
                        rangeFilter.includes(String(st.class).toUpperCase()) ||
                        rangeFilter.includes(String(st.section).toUpperCase())
                    );
                } else {
                    // Normal Text Search
                    const lowerQ = search.toLowerCase();
                    data = data.filter(st =>
                        st.name.toLowerCase().includes(lowerQ) ||
                        (st.roll_no && st.roll_no.toLowerCase().includes(lowerQ))
                    );
                }
            }

            // Store filtered data for Export
            window.filteredDataForExport = data;

            // 4. Render Specific Tab
            if (tdCurrentTab === 'students') renderTdStudents(data);
            if (tdCurrentTab === 'measurements') renderTdMeasurements(data);
            if (tdCurrentTab === 'patterns-boys') renderTdPatterns(data, 'Male');
            if (tdCurrentTab === 'patterns-girls') renderTdPatterns(data, 'Female');
        }

        // PDF Export Implementation
        function downloadTdPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const data = window.filteredDataForExport || globalStudents.filter(st => st.school_id == tdCurrentSchoolId);
            const schoolName = document.getElementById('td-school-name').innerText;

            doc.setFontSize(18);
            doc.text(`${schoolName} - Student Report`, 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()} ‚Ä¢ Records: ${data.length}`, 14, 28);

            // AutoTable - Simplified Columns
            const headers = [['Roll No', 'Name', 'Class', 'Gender', 'Status']];
            const rows = data.map(s => {
                return [
                    s.roll_no || '-',
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.gender,
                    s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')
                ];
            });

            doc.autoTable({
                head: headers,
                body: rows,
                startY: 35,
                theme: 'grid',
                styles: { fontSize: 9 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save(`${schoolName}_Student_List.pdf`);
        }

        function renderTdStudents(data) {
            document.getElementById('td-list-students').innerHTML = data.map(s => `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                        <td class="p-4 font-mono text-xs text-gray-500">${s.roll_no || '-'}</td>
                        <td class="p-4 text-gray-800">${s.name}</td>
                        <td class="p-4 text-xs font-bold text-gray-500">${s.class || ''} ${s.section || ''}</td>
                        <td class="p-4 text-xs">${s.gender || '-'}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 rounded-full text-[10px] font-extrabold uppercase tracking-wide ${getStatusColor(s.order_status, s.is_packed)}">
                                ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                            </span>
                        </td>
                    </tr>
                `).join('');
            document.getElementById('td-school-meta').innerText = `${data.length} Students Shown`;
        }

        function renderLogsTable(logs) {
            const tbody = document.getElementById('logsTableBody');
            if (tbody) {
                tbody.innerHTML = logs.map(l => {
                    const roleBadge = l.role
                        ? `<span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider ${l.role === 'company' ? 'bg-indigo-100 text-indigo-700' : 'bg-emerald-100 text-emerald-700'}">${l.role}</span>`
                        : `<span class="text-slate-300 text-xs">-</span>`;

                    const schoolDisplay = l.school_name || l.school_id
                        ? `<span class="font-medium text-slate-600">${l.school_name || 'ID: ' + l.school_id}</span>`
                        : `<span class="text-slate-300">-</span>`;

                    return `
                    <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50">
                        <td class="p-4 text-xs font-medium text-slate-500 font-mono">${new Date(l.created_at).toLocaleString()}</td>
                        <td class="p-4">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500">
                                    ${l.username ? l.username[0].toUpperCase() : '?'}
                                </div>
                                <span class="text-sm font-bold text-slate-700">${l.username}</span>
                            </div>
                        </td>
                        <td class="p-4">${roleBadge}</td>
                        <td class="p-4 text-xs">${schoolDisplay}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-slate-100 text-slate-600 border border-slate-200">
                                ${l.action}
                            </span>
                        </td>
                        <td class="p-4 text-sm text-slate-500 break-all max-w-xs truncate" title="${l.details}">${l.details}</td>
                    </tr>
                `}).join('');
            }
        }

        function renderTdMeasurements(data) {
            document.getElementById('td-list-measurements').innerHTML = data.map(s => {
                const m = getMeasurementsSafe(s);
                return `
                     <tr class="hover:bg-blue-50/30 transition-colors border-b border-gray-50">
                         <td class="p-3 bg-white sticky left-0 border-r border-gray-100 shadow-[4px_0_8px_-4px_rgba(0,0,0,0.05)]">
                             <div class="font-bold text-gray-700 text-xs">${s.name}</div>
                             <div class="text-[9px] text-gray-400 font-mono">${s.roll_no || '-'}</div>
                         </td>
                         ${['u1', 'u2', 'u3', 'u4', 'u5', 'u6', 'u7', 'u8'].map(k => `<td class="p-2 text-center text-orange-600 bg-orange-50/10">${m[k] || '-'}</td>`).join('')}
                         ${['l1', 'l2', 'l3', 'l4', 'l5', 'l6', 'l7', 'l8'].map((k, i) => `<td class="p-2 text-center text-indigo-600 bg-indigo-50/10 ${i === 0 ? 'border-l border-gray-100' : ''}">${m[k] || '-'}</td>`).join('')}
                         <td class="p-3 text-xs bg-purple-50/30 text-purple-600 font-bold border-l border-gray-100 max-w-[120px] truncate" title="${Object.entries(getItemQuantitiesSafe(s)).map(([k, v]) => `${k}:${v}`).join(', ')}">
                             ${Object.entries(getItemQuantitiesSafe(s)).map(([k, v]) => `${k}:${v}`).join(', ')}
                         </td>
                         <td class="p-3 text-xs italic text-gray-400 truncate max-w-[150px]" title="${m.remarks || ''}">${m.remarks || '-'}</td>
                     </tr>
                     `;
            }).join('');
        }

        function renderTdPatterns(data, gender) {
            const container = document.getElementById(gender === 'Male' ? 'td-list-patterns-boys' : 'td-list-patterns-girls');

            // Get Patterns from Global DB for this school (Robust Match)
            const schoolName = document.getElementById('td-school-name').innerText;
            const schoolId = tdCurrentSchoolId; // Use the stored ID

            const relevantPatterns = globalPatterns.filter(p =>
                (p.school_id && p.school_id == schoolId) ||
                (p.school_name === schoolName)
            );

            // Detailed Gender Filter using Global Helper
            const allSchoolStudents = globalStudents.filter(st => st.school_name === schoolName);

            const displayPatterns = relevantPatterns.filter(p => {
                const resolved = window.resolvePatternGenderHelper ? window.resolvePatternGenderHelper(p, allSchoolStudents) : 'Unisex';

                if (gender === 'Male') return resolved === 'Male' || resolved === 'Unisex';
                if (gender === 'Female') return resolved === 'Female' || resolved === 'Unisex';
                return false;
            });

            if (displayPatterns.length === 0) {
                // Fallback Debug Info - List names to help user debug
                const totalForSchool = relevantPatterns.length;
                const exampleNames = relevantPatterns.slice(0, 3).map(p => p.name).join(', ');
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-300 italic">
                        No patterns found for ${gender}.<br>
                        <span class="text-xs text-gray-400 font-mono mt-2 block">
                            (Found ${totalForSchool} total. Examples: ${exampleNames || 'None'})
                        </span>
                    </div>`;
                return;
            }

            // Export Buttons Header
            const header = `
                <div class="col-span-full flex justify-end gap-2 mb-4">
                    <button onclick="downloadTdPatternsPDF('${gender}')" class="clay-btn text-xs bg-red-50 text-red-600 hover:bg-red-100 font-bold px-3 py-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        PDF Summary
                    </button>
                    <button onclick="downloadTdPatternsExcel('${gender}')" class="clay-btn text-xs bg-green-50 text-green-600 hover:bg-green-100 font-bold px-3 py-2 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Excel Export
                    </button>
                </div>
            `;

            // Table View
            const table = `
                <div class="col-span-full overflow-x-auto rounded-xl shadow-sm border border-gray-100">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-xs text-gray-500 uppercase tracking-wider">
                                <th class="p-4 font-bold border-b border-gray-100">Pattern Name</th>
                                <th class="p-4 font-bold border-b border-gray-100">Consumption</th>
                                <th class="p-4 font-bold border-b border-gray-100">Cloth Details</th>
                                <th class="p-4 font-bold border-b border-gray-100">Special Req</th>
                                <th class="p-4 font-bold border-b border-gray-100 text-center">Linked Students</th>
                                <th class="p-4 font-bold border-b border-gray-100 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white text-sm divide-y divide-gray-50">
                            ${relevantPatterns.map(p => {
                // Calculate Linked Students Count
                // Filter current data (which might already be filtered by class/section) matching this pattern
                const linkedCount = data.filter(s => s.pattern_name === p.name).length;

                return `
                                <tr class="hover:bg-blue-50/20 transition-colors group">
                                    <td class="p-4 font-bold text-gray-700">${p.name}</td>
                                    <td class="p-4 text-emerald-600 font-mono font-bold">${p.consumption || '-'} m</td>
                                    <td class="p-4 text-gray-500 max-w-xs truncate" title="${p.cloth_details}">${p.cloth_details || '-'}</td>
                                    <td class="p-4 text-gray-400 italic max-w-xs truncate" title="${p.special_req}">${p.special_req || '-'}</td>
                                    <td class="p-4 text-center">
                                        <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-bold">${linkedCount}</span>
                                    </td>
                                    <td class="p-4 text-right">
                                        <button onclick="openPatternDetails('${p.name}', '${gender}')" class="text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 px-3 py-1.5 rounded-lg font-bold transition-colors">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                `;
            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = header + table;
        }

        // --- NEW EXPORT FUNCTIONS ---

        function downloadTdPatternsPDF(gender) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const schoolName = document.getElementById('td-school-name').innerText;

            // Filter Patterns
            // Filter Patterns (Consistent Logic)
            const allSchoolStudents = globalStudents.filter(st => st.school_name === schoolName);
            const relevantPatterns = globalPatterns.filter(p => p.school_name === schoolName).filter(p => {
                const resolved = window.resolvePatternGenderHelper ? window.resolvePatternGenderHelper(p, allSchoolStudents) : 'Unisex';
                if (gender === 'Male') return resolved === 'Male' || resolved === 'Unisex';
                return resolved === 'Female' || resolved === 'Unisex';
            });

            doc.setFontSize(16);
            doc.text(`${schoolName} - ${gender} Patterns Summary`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            const headers = [['Name', 'Consumption (m)', 'Cloth Details', 'Special Req']];
            const rows = relevantPatterns.map(p => [
                p.name,
                p.consumption || '-',
                p.cloth_details || '-',
                p.special_req || '-'
            ]);

            doc.autoTable({
                head: headers,
                body: rows,
                startY: 30,
                styles: { fontSize: 9 },
                headStyles: { fillColor: gender === 'Male' ? [59, 130, 246] : [236, 72, 153] }, // Blue for Boys, Pink for Girls
                columnStyles: { 0: { fontStyle: 'bold' } }
            });

            doc.save(`${schoolName}_${gender}_Patterns.pdf`);
        }

        function downloadTdPatternsExcel(gender) {
            const schoolName = document.getElementById('td-school-name').innerText;

            // Filter Patterns
            // Filter Patterns (Consistent Logic)
            const allSchoolStudents = globalStudents.filter(st => st.school_name === schoolName);
            const relevantPatterns = globalPatterns.filter(p => p.school_name === schoolName).filter(p => {
                const resolved = window.resolvePatternGenderHelper ? window.resolvePatternGenderHelper(p, allSchoolStudents) : 'Unisex';
                if (gender === 'Male') return resolved === 'Male' || resolved === 'Unisex';
                return resolved === 'Female' || resolved === 'Unisex';
            });

            const exportData = relevantPatterns.map(p => ({
                "School": schoolName,
                "Pattern Name": p.name,
                "Gender": gender,
                "Consumption (m)": p.consumption || '-',
                "Cloth Details": p.cloth_details || '-',
                "Special Requirements": p.special_req || '-',
                "Defined At": p.created_at ? new Date(p.created_at).toLocaleDateString() : '-'
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${gender} Patterns`);
            XLSX.writeFile(wb, `${schoolName}_${gender}_Patterns.xlsx`);
        }

        function openPatternDetails(patternName, gender) {
            // Find data
            // Fix: Remove strict gender filtering. Show ALL students linked to this pattern name for this school.
            // This allows 'Male' views to show students even if their gender record is messy (e.g. 'm', 'Boy', etc)
            // or if the pattern was misclassified but the student link is valid.
            const schoolStudents = globalStudents.filter(st => st.school_id == tdCurrentSchoolId);
            const students = schoolStudents.filter(s => (s.pattern_name || 'Unassigned') === patternName);
            const meta = globalPatterns.find(p => p.name === patternName && p.school_id == tdCurrentSchoolId) || {};

            // UI
            // Bug Fix: Hide Level 2 Container AND All Level 3 Views to prevent overlap
            // Hide Level 1 (School List) to clear layout space
            document.getElementById('td-level-1').classList.add('hidden');
            document.getElementById('td-level-2').classList.add('hidden');
            document.querySelectorAll('[id^="td-view-"]').forEach(el => el.classList.add('hidden'));

            // Hide Global Header to give full focus to Pattern Details
            const globalHeader = document.getElementById('global-header');
            if (globalHeader) globalHeader.classList.add('hidden');

            // Show Level 4 (Pattern Details)
            document.getElementById('td-level-3-pattern').classList.remove('hidden');

            document.getElementById('td-p3-title').innerText = patternName;
            document.getElementById('td-p3-title').setAttribute('data-gender', gender);
            document.getElementById('td-p3-count').innerText = `${students.length} Students`;
            document.getElementById('td-p3-meta').innerText = meta.consumption ? `Consumption: ${meta.consumption}m ‚Ä¢ ${meta.cloth_details || ''}` : 'No additional metadata available';

            // Update the table header for QTY
            const qtyHeader = document.getElementById('th-qty-header');
            if (qtyHeader) {
                qtyHeader.innerText = 'QTY';
            }

            document.getElementById('td-p3-list').innerHTML = students.map(s => {
                const m = getMeasurementsSafe(s);

                // --- SMART MEASUREMENT LOGIC ---
                let activeCols = null;
                if (meta.filters) {
                    try {
                        const f = typeof meta.filters === 'string' ? JSON.parse(meta.filters) : meta.filters;
                        if (f.item) {
                            const matchedItem = ALL_PATTERN_ITEMS.find(i => i.name === f.item);
                            if (matchedItem) activeCols = matchedItem.cols;
                        }
                    } catch (e) { }
                }

                let uContent = '';
                let lContent = '';

                if (activeCols) {
                    // STRICT MODE: Show only specific columns defined for this Item
                    const uCols = activeCols.filter(c => c.startsWith('U'));
                    const lCols = activeCols.filter(c => c.startsWith('L'));

                    if (uCols.length > 0) {
                        const valStr = uCols.map(c => {
                            const k = c.toLowerCase();
                            const v = m[k] || m[c] || '-'; // Try lower and upper case keys
                            return `<span class="mr-1.5"><strong class="opacity-60">${c}:</strong>${v}</span>`;
                        }).join('');
                        uContent = `<span class="font-mono text-[10px] text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded border border-orange-100 w-fit whitespace-nowrap block mb-1">
                                        ${valStr}
                                    </span>`;
                    }

                    if (lCols.length > 0) {
                        const valStr = lCols.map(c => {
                            const k = c.toLowerCase();
                            const v = m[k] || m[c] || '-';
                            return `<span class="mr-1.5"><strong class="opacity-60">${c}:</strong>${v}</span>`;
                        }).join('');
                        lContent = `<span class="font-mono text-[10px] text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 w-fit whitespace-nowrap block">
                                        ${valStr}
                                    </span>`;
                    }

                } else {
                    // FALLBACK: Standard behavior (Upper/Lower Grouped)
                    uContent = `<span class="font-mono text-[10px] text-orange-600 bg-orange-50 px-1.5 py-0.5 rounded border border-orange-100 w-fit whitespace-nowrap block mb-1">
                                    <span class="font-bold opacity-50 mr-1">UPPER:</span>${m.u1 || '-'}-${m.u2 || '-'}...
                                </span>`;
                    lContent = `<span class="font-mono text-[10px] text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 w-fit whitespace-nowrap block">
                                    <span class="font-bold opacity-50 mr-1">LOWER:</span>${m.l1 || '-'}-${m.l2 || '-'}...
                                </span>`;
                }

                const measStr = `<div class="flex flex-col">${uContent}${lContent}</div>`;
                // -------------------------------

                // QTY Calculation (Default to 1)
                const qty = 1;

                // Avatar Generation
                const initials = s.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const avatarColor = s.gender && s.gender.toLowerCase().startsWith('f') ? 'bg-pink-100 text-pink-600' : 'bg-blue-100 text-blue-600';

                // Filters Context
                let filterStr = 'Standard';
                if (meta.filters) {
                    try {
                        const f = typeof meta.filters === 'string' ? JSON.parse(meta.filters) : meta.filters;
                        const parts = [];
                        if (f.item) parts.push(f.item);
                        if (parts.length > 0) filterStr = parts.join(' ‚Ä¢ ');
                    } catch (e) { }
                }

                return `
            <tr class="hover:bg-slate-50 transition-colors border-b border-slate-50 group">
                <td class="p-5 pl-8">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center text-xs font-extra-bold tracking-wider shadow-sm border border-white ring-1 ring-slate-100 shrink-0">
                            ${initials}
                        </div>
                        <div class="min-w-0">
                            <div class="font-bold text-slate-700 group-hover:text-blue-600 transition-colors truncate max-w-[180px]" title="${s.name}">${s.name}</div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Roll: ${s.roll_no || '-'}</span>
                                <span class="text-[9px] font-bold text-slate-300">‚Ä¢</span>
                                <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Reg: ${s.admission_no || '-'}</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td class="p-5">
                    <div class="font-bold text-slate-600 text-xs mb-1 truncate max-w-[180px]" title="${s.school_name || ''}">${s.school_name || 'N/A'}</div>
                    <div class="flex flex-wrap gap-1.5">
                         <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold bg-slate-100 text-slate-600 border border-slate-200">
                            Cls ${s.class || '-'} ‚Ä¢ ${s.section || '-'}
                        </span>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-bold bg-white text-slate-400 border border-slate-200" title="House / Choosed Filters">
                            ${s.house || 'No House'}
                        </span>
                    </div>
                     <div class="text-[9px] text-slate-400 mt-1 truncate" title="Filters: ${filterStr}">Type: ${filterStr}</div>
                </td>
                <td class="p-5 text-xs font-bold text-slate-500 uppercase">${s.gender || '-'}</td>
                <td class="p-5">
                    ${measStr}
                </td>
                 <td class="p-5 text-center text-xs font-bold text-slate-600">
                    ${qty}
                </td>
                <td class="p-5 text-center">
                    <span class="px-3 py-1.5 rounded-lg text-[10px] font-extrabold uppercase tracking-wider ${getStatusColor(s.order_status, s.is_packed)} shadow-sm">
                        ${s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')}
                    </span>
                </td>
            </tr>`;
            }).join('');
        }

        function closePatternDetails() {
            // Hide Level 4
            document.getElementById('td-level-3-pattern').classList.add('hidden');

            // Restore Level 2 (School Header)
            document.getElementById('td-level-2').classList.remove('hidden');

            // Restore Global Header
            const globalHeader = document.getElementById('global-header');
            if (globalHeader) globalHeader.classList.remove('hidden');

            // Restore the correct Level 3 View
            if (tdCurrentTab) openLevel3(tdCurrentTab);
        }

        function exportTdCurrentData() {
            // Simple redirect to existing export logic but context sensitive?
            // Or re-implement for specific formatted export.
            // For now, let's reuse the global downloadExcel but filtered to current view data.
            window.filteredDataForExport = globalStudents.filter(st => st.school_id === tdCurrentSchoolId);
            // Apply filters
            const cls = document.getElementById('td-filter-class').value;
            const sec = document.getElementById('td-filter-section').value;
            if (cls !== 'all') window.filteredDataForExport = window.filteredDataForExport.filter(st => st.class == cls);
            if (sec !== 'all') window.filteredDataForExport = window.filteredDataForExport.filter(st => st.section == sec);

            downloadExcel(); // Reuses global function
        }


        async function fetchActivityLogs() {
            try {
                const r = await fetch(`${API_BASE}/data/logs`, { headers: { 'Authorization': `Bearer ${token}` } });
                const logs = await r.json();

                if (!Array.isArray(logs)) return;

                // Update Reports Table (if function exists)
                if (typeof renderLogTable === 'function') renderLogTable('rp-school-table', logs);

                // Update Dashboard Widget (if element exists)
                const feed = document.getElementById('activity-feed');
                if (!feed) return;

                const iconMap = {
                    'CREATE': '<span class="bg-green-100 text-green-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></span>',
                    'UPDATE': '<span class="bg-blue-100 text-blue-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></span>',
                    'DELETE': '<span class="bg-red-100 text-red-600 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></span>',
                    'DEFAULT': '<span class="bg-gray-100 text-gray-500 p-2 rounded-lg"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>'
                };

                feed.innerHTML = '<div class="absolute left-6 top-4 bottom-4 w-0.5 bg-gray-100"></div>' + logs.map(l => {
                    let type = 'DEFAULT';
                    if (l.action.includes('CREATE')) type = 'CREATE';
                    if (l.action.includes('UPDATE')) type = 'UPDATE';
                    if (l.action.includes('DELETE')) type = 'DELETE';

                    return `
                        <div class="relative pl-14 py-2 group">
                             <!-- Dot on Line -->
                             <div class="absolute left-[1.35rem] top-6 w-3 h-3 bg-white border-2 border-gray-300 rounded-full group-hover:border-blue-500 group-hover:scale-110 transition-all z-10"></div>
                             
                             <div class="flex items-start gap-4">
                                 <!-- Icon User -->
                                 ${iconMap[type]}
                                 <div>
                                     <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-0.5 flex items-center gap-2">
                                        ${l.username} 
                                        <span class="text-[10px] text-gray-300">‚Ä¢ ${timeAgo(l.created_at)}</span>
                                     </p>
                                     <p class="text-sm font-bold text-gray-700">${l.details}</p>
                                 </div>
                             </div>
                        </div>`;
                }).join('');

            } catch (e) { console.error("Logs Error", e); }
        }

        // Removed dummy renderMeasurements Helper as it's now inline
        function dummy() { }

        function renderCharts() {
            const p = globalStudents.filter(s => s.is_packed).length, pe = globalStudents.length - p;
            // Destroy exists?
            new Chart(document.getElementById('chart-packing'), { type: 'doughnut', data: { labels: ['Packed', 'Pending'], datasets: [{ data: [p, pe], backgroundColor: ['#A8E6CF', '#FFD3B6'], borderWidth: 0 }] }, options: { maintainAspectRatio: false } });
            const sc = {}; globalStudents.forEach(s => { sc[s.school_name] = (sc[s.school_name] || 0) + 1 });
            new Chart(document.getElementById('chart-schools'), { type: 'bar', data: { labels: Object.keys(sc), datasets: [{ label: 'Student Count', data: Object.values(sc), backgroundColor: '#AA96DA', borderRadius: 4 }] }, options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }

        async function createUser(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/users/create`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("User Created!"); e.target.reset(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function generateCode() { const sid = document.getElementById('access-school-select').value, type = document.getElementById('access-type').value, hrs = document.getElementById('access-expiry').value; try { const r = await fetch(`${API_BASE}/data/access_codes`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ school_id: sid, type, expires_in_hours: parseFloat(hrs) }) }); if (r.ok) { alert(`Code Created: ${(await r.json()).code}`); fetchAccessCodes(); } else alert((await r.json()).error); } catch (e) { alert(e.message); } }
        async function toggleCode(id, a) { if (!confirm(a ? "Activate?" : "Revoke?")) return; await fetch(`${API_BASE}/data/access_codes/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchAccessCodes(); }
        async function toggleUserStatus(id, a, n) { if (confirm(a ? "Enable?" : "Disable?")) await fetch(`${API_BASE}/data/users/${id}/toggle`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ is_active: a }) }); fetchUsers(); }
        async function registerSchool(e) { e.preventDefault(); try { const r = await fetch(`${API_BASE}/data/schools`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(Object.fromEntries(new FormData(e.target).entries())) }); if (r.ok) { alert("School Registered!"); document.getElementById('school-modal').classList.add('hidden'); e.target.reset(); fetchSchoolsForSelect(); fetchUsers(); } else alert((await r.json()).error); } catch (e) { alert("Failed"); } }
        function openSchoolModal() { document.getElementById('school-modal').classList.remove('hidden'); }
        function toggleSchoolSelect() { const r = document.getElementById('user-role').value, s = document.getElementById('school-select-wrapper'); if (r === 'company') s.classList.add('hidden'); else s.classList.remove('hidden'); }
        async function fixDatabase() { if (confirm("Maintain DB?")) { await fetch(`${API_BASE}/data/migrate`, { method: 'POST' }); location.reload(); } }
        function logout() { sessionStorage.clear(); window.location.href = 'login.html'; }

        // CLIENT SIDE EXPORTS (Filtered)
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Determine Data Source
            let data = window.filteredDataForExport || globalStudents;
            let title = "Tailoring Data Report";
            const isSchoolView = !document.getElementById('view-school-details').classList.contains('hidden');

            // Active Columns
            let cols = window.currentCols || [];
            if (isSchoolView && cols.length === 0) {
                // In school view, default to showing all raw measurements if no specific item filter active (which isn't in details view usually)
                cols = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'L1', 'L2', 'L3', 'L4', 'L5'];
            }

            if (isSchoolView && currentSchoolDetails.name) {
                data = globalStudents.filter(s => s.school_name === currentSchoolDetails.name);
                title = `${currentSchoolDetails.name} - Student Data`;
            }

            doc.text(title, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            let head = [['School', 'Name', 'Class', 'Gender', 'Pattern']];

            if (cols.length > 0) head[0].push(...cols);
            else head[0].push("Measurements");

            head[0].push('Packed');

            const body = data.map(s => {
                const m = getMeasurementsSafe(s);
                const row = [
                    s.school_name,
                    s.name,
                    `${s.class || ''} ${s.section || ''}`,
                    s.gender || '-',
                    s.pattern_name || '-'
                ];

                if (cols.length > 0) {
                    cols.forEach(k => row.push(m[k.toLowerCase()] || '-'));
                } else {
                    row.push("Select Item to View Details");
                }

                row.push(s.is_packed ? 'Yes' : 'No');
                return row;
            });

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [244, 63, 94] }
            });

            doc.save("Global_Report.pdf");
        }

        function downloadExcel() {
            // Priority: Filtered Data -> School View Data -> Global Data
            let data = window.filteredDataForExport || globalStudents;
            let filename = "Tailoring_Data_Report";

            // Check if we are doing a Student Details Export (Special Case: Simplified)
            // If filteredDataForExport is present, it means we are likely in the Student Details view
            const isStudentDetailsExport = !!window.filteredDataForExport;

            // If we are in School Details View but filteredDataForExport is not set (legacy check)
            const isSchoolView = !document.getElementById('view-school-details').classList.contains('hidden');
            if (isSchoolView && !window.filteredDataForExport && currentSchoolDetails.name) {
                data = globalStudents.filter(s => s.school_name === currentSchoolDetails.name);
                filename = `${currentSchoolDetails.name}_Report`;
            } else if (window.filteredDataForExport) {
                // If filtered data exists, customize filename if possible
                if (tdCurrentSchoolId) {
                    const s = globalSchools.find(x => x.id == tdCurrentSchoolId);
                    if (s) filename = `${s.name}_Filtered_List`;
                }
            }

            // Active Columns
            let cols = window.currentCols || [];

            // Simplified Logic: If no specific measurement columns selected, and it's a filtered list, default to BASIC info only.
            // Unless the user explicitly asked for measurements (which they can't yet in this view).

            // The sheet name for Excel has a max of 31 characters.
            const sheetName = filename.substring(0, 30);

            const exportData = data.map(s => {
                const base = {
                    "Roll No": s.roll_no || '-',
                    "Name": s.name,
                    "Class": s.class,
                    "Section": s.section,
                    "Gender": s.gender,
                    "Status": s.order_status || (s.is_packed ? 'PACKED' : 'PENDING')
                };

                // Add Measurements ONLY if NOT in simplified mode
                if (!isStudentDetailsExport) {
                    const m = getMeasurementsSafe(s);
                    base["Pattern"] = s.pattern_name || '-';
                    if (cols.length > 0) {
                        cols.forEach(c => base[c] = m[c.toLowerCase()] || '-');
                    } else {
                        // Default full measurements
                        base["U1"] = m.u1; base["U2"] = m.u2; base["U3"] = m.u3;
                        base["L1"] = m.l1; base["L2"] = m.l2; base["L3"] = m.l3;
                    }
                    base["Packed"] = s.is_packed ? 'Yes' : 'No';
                }

                return base;
            });

            // Generate Worksheet
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, sheetName);
            XLSX.writeFile(wb, `${filename}.xlsx`);
        }


        // COMPLAINTS LOGIC
        let currentComplaintId = null;

        // COMPLAINTS ANALYTICS LOGIC
        let rawComplaints = [];
        let filteredComplaints = [];
        let chartIssues = null;
        let chartStatus = null;

        async function fetchComplaints() {
            try {
                const res = await fetch(`${API_BASE}/data/complaints`, { headers: { 'Authorization': `Bearer ${token}` } });
                rawComplaints = await res.json();
                if (!Array.isArray(rawComplaints)) rawComplaints = [];

                // Populate Filter Dropdowns (Patterns)
                const patterns = new Set();
                rawComplaints.forEach(c => {
                    if (c.pattern_name) {
                        c.pattern_name.split(',').forEach(p => patterns.add(p.trim()));
                    }
                });
                const sel = document.getElementById('c-filter-pattern');
                const currentVal = sel.value;
                sel.innerHTML = '<option value="all">All Patterns</option>' +
                    Array.from(patterns).sort().map(p => `<option value="${p}">${p}</option>`).join('');
                sel.value = currentVal;

                renderComplaintDash();
            } catch (e) { console.error("Complaints Error", e); }
        }

        function renderComplaintDash() {
            // 1. Filter Data
            const sFil = document.getElementById('c-filter-school').value.toLowerCase();
            const pFil = document.getElementById('c-filter-pattern').value;
            const gFil = document.getElementById('c-filter-gender').value;

            filteredComplaints = rawComplaints.filter(c => {
                if (sFil && !c.school_name.toLowerCase().includes(sFil)) return false;
                if (gFil !== 'all' && c.gender !== gFil) return false;
                if (pFil !== 'all' && (!c.pattern_name || !c.pattern_name.includes(pFil))) return false;
                return true;
            });

            // 2. Update Stats
            const total = filteredComplaints.length;
            const resolved = filteredComplaints.filter(c => c.status === 'Resolved').length;
            const open = total - resolved;

            document.getElementById('c-stat-total').innerText = total;
            document.getElementById('c-stat-open').innerText = open;
            document.getElementById('c-stat-resolved').innerText = resolved;

            // 3. Update Charts
            updateComplaintCharts(filteredComplaints);

            // 4. Render School Cards (Grouping)
            const grid = document.getElementById('school-complaints-grid');
            grid.innerHTML = '';

            if (total === 0) {
                document.getElementById('c-no-data').classList.remove('hidden');
                return;
            }
            document.getElementById('c-no-data').classList.add('hidden');

            // Group by School ID
            const schools = {};
            filteredComplaints.forEach(c => {
                if (!schools[c.school_id]) {
                    schools[c.school_id] = {
                        id: c.school_id, // Fix: Added ID property
                        name: c.school_name,
                        count: 0,
                        open: 0,
                        resolved: 0,
                        tickets: []
                    };
                }
                schools[c.school_id].count++;
                if (c.status === 'Resolved') schools[c.school_id].resolved++;
                else schools[c.school_id].open++;
                schools[c.school_id].tickets.push(c);
            });

            Object.values(schools).sort((a, b) => b.open - a.open).forEach(s => {
                const div = document.createElement('div');
                const completionRate = Math.round((s.resolved / s.count) * 100) || 0;

                // Dynamic Styles based on Status
                const isUrgent = s.open > 0;
                const statusColor = isUrgent ? 'rose' : 'emerald';
                const statusBg = isUrgent ? 'bg-rose-50' : 'bg-emerald-50';
                const statusBorder = isUrgent ? 'hover:border-rose-300' : 'hover:border-emerald-300';

                // Fix: Added h-full and flex column to ensure equal height behavior in grid
                div.className = `clay-card p-6 rounded-2xl hover:shadow-2xl transition-all duration-300 cursor-pointer border border-transparent ${statusBorder} relative group overflow-hidden bg-white flex flex-col`;
                div.onclick = () => openSchoolComplaints(s);

                div.innerHTML = `
                    <!-- Decorative Background Element -->
                    <div class="absolute top-0 right-0 w-32 h-32 ${statusBg} rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:scale-110 transition-transform duration-500 opacity-60 pointer-events-none"></div>
                    
                    <div class="relative z-10 w-full">
                        <!-- Header with Flex handling for badges -->
                        <div class="flex justify-between items-start mb-6 gap-3">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div class="w-12 h-12 rounded-xl bg-white shadow-sm border border-gray-100 flex items-center justify-center text-${statusColor}-500 font-black text-xl flex-shrink-0">
                                     ${s.name.charAt(0)}
                                </div>
                                <div class="min-w-0 flex-1">
                                    <h3 class="font-bold text-gray-800 text-lg leading-tight truncate pr-2" title="${s.name}">${s.name}</h3>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">ID: #${s.id}</p>
                                </div>
                            </div>
                            
                            <!-- Badge: Prevent Shrink & ensure visibility -->
                            ${isUrgent
                        ? `<span class="flex-shrink-0 whitespace-nowrap bg-rose-500 text-white px-3 py-1 rounded-lg text-[10px] font-extrabold uppercase tracking-wide shadow-lg shadow-rose-200 animate-pulse">Action Req</span>`
                        : `<span class="flex-shrink-0 whitespace-nowrap bg-emerald-100 text-emerald-600 px-3 py-1 rounded-lg text-[10px] font-extrabold uppercase tracking-wide">All Clear</span>`}
                        </div>

                        <!-- Mini Stats Grid -->
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="bg-gray-50 rounded-lg p-2 text-center group-hover:bg-${statusColor}-50/30 transition-colors">
                                <p class="text-2xl font-black text-gray-700 group-hover:text-${statusColor}-600 transition-colors">${s.open}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Open</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-2 text-center">
                                <p class="text-2xl font-black text-gray-400">${s.resolved}</p>
                                <p class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">Resolved</p>
                            </div>
                        </div>

                        <!-- Progress Bar (Pushed to bottom if needed, but here simplified) -->
                        <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-${statusColor}-500 h-full rounded-full" style="width: ${completionRate}%"></div>
                        </div>
                        <div class="flex justify-between mt-2">
                             <p class="text-[10px] font-bold text-gray-400 uppercase">Resolution Rate</p>
                             <p class="text-[10px] font-bold text-${statusColor}-500">${completionRate}%</p>
                        </div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        // === USER MANAGEMENT FUNCTIONS ===
        function toggleUserForm() {
            const container = document.getElementById('user-create-form-container');
            const chevron = document.getElementById('user-form-chevron');
            if (container.classList.contains('max-h-0')) {
                // Expand
                container.classList.remove('max-h-0');
                container.classList.add('max-h-[1000px]', 'mt-4');
                chevron.classList.add('rotate-180');
            } else {
                // Collapse
                container.classList.add('max-h-0');
                container.classList.remove('max-h-[1000px]', 'mt-4');
                chevron.classList.remove('rotate-180');
            }
        }

        function openSchoolModal() {
            document.getElementById('school-modal').classList.remove('hidden');
        }

        function toggleSchoolSelect() {
            const role = document.getElementById('user-role').value;
            const schoolSelect = document.getElementById('school-select-wrapper');
            if (role === 'company') {
                schoolSelect.classList.add('hidden');
            } else {
                schoolSelect.classList.remove('hidden');
            }
        }

        async function createUser(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                username: form.username.value,
                password: form.password.value,
                role: form.role.value,
                schoolId: (form.role.value !== 'company' && form.school_id) ? form.school_id.value : null
            };

            try {
                const r = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const d = await r.json();
                if (r.ok) {
                    alert('‚úÖ User Created Successfully');
                    form.reset();
                    fetchUsers();
                } else {
                    alert('‚ùå ' + (d.error || 'Failed to create user'));
                }
            } catch (err) { console.error(err); alert('Error creating user'); }
        }

        async function registerSchool(e) {
            e.preventDefault();
            const form = e.target;
            const body = {
                name: form.name.value,
                username: form.username.value,
                password: form.password.value
            };

            try {
                // Server handles both School and Admin User creation in one transaction
                const r = await fetch(`${API_BASE}/data/schools`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(body)
                });
                const d = await r.json();

                if (r.ok) {
                    alert('‚úÖ School & Admin Registered Successfully!');
                    document.getElementById('school-modal').classList.add('hidden');
                    form.reset();
                    fetchSchoolsForSelect(); // Refresh dropdowns
                    fetchSchoolsManage(); // Refresh list
                    fetchUsers(); // Refresh users
                } else {
                    alert('‚ùå Error: ' + (d.error || 'Failed to register school'));
                }
            } catch (err) {
                console.error(err);
                alert('‚ùå Network Error: ' + err.message);
            }
        }



        async function toggleUserStatus(id, active, username) {
            // Note: We need an endpoint to update user status. 
            // Assuming PUT /api/data/users/:id exists.
            if (!confirm(`Are you sure you want to ${active ? 'ENABLE' : 'DISABLE'} user ${username}?`)) return;
            try {
                const r = await fetch(`${API_BASE}/data/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ is_active: active })
                });
                const d = await r.json();
                if (r.ok) fetchUsers();
                else alert("‚ùå Update Failed: " + (d.error || "Unknown Error"));
            } catch (e) { console.error(e); alert("Client Error: " + e.message); }
        }

        async function fixDatabase() {
            if (!confirm("Attempt to fix database schema issues (missing columns)?")) return;
            try {
                const r = await fetch(`${API_BASE} / data / migrate`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await r.json();
                alert(d.message || d.error);
            } catch (e) { alert("Migration Failed: " + e.message); }
        }

        function updateComplaintCharts(data) {
            // 1. Calculate Aggregates
            const patternCounts = {};
            const issueCounts = {};

            data.forEach(c => {
                // Patterns
                if (c.pattern_name) {
                    c.pattern_name.split(',').forEach(p => {
                        const cleanP = p.trim();
                        if (cleanP) patternCounts[cleanP] = (patternCounts[cleanP] || 0) + 1;
                    });
                }

                // Issues (Parse "Pattern (Issue)" format)
                if (c.issue_type) {
                    c.issue_type.split(',').forEach(i => {
                        let cleanI = i.trim();
                        if (cleanI.includes('(')) {
                            // Extract content between parenthesis e.g., "Size Mismatch" from "Shirt (Size Mismatch)"
                            const match = cleanI.match(/\(([^)]+)\)/);
                            if (match && match[1]) cleanI = match[1].trim();
                        }
                        if (cleanI) issueCounts[cleanI] = (issueCounts[cleanI] || 0) + 1;
                    });
                }
            });

            // 2. Identify Hotspots (Top 1)
            const topPattern = Object.entries(patternCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];
            const topIssue = Object.entries(issueCounts).sort((a, b) => b[1] - a[1])[0] || ['-', 0];

            document.getElementById('c-top-pattern').innerText = topPattern[0];
            document.getElementById('c-top-pattern-count').innerText = `${topPattern[1]} complaints`;

            document.getElementById('c-top-issue').innerText = topIssue[0];
            document.getElementById('c-top-issue-count').innerText = `${topIssue[1]} occurrences`;


            // 3. Render Chart 1: Top 10 Patterns (Horizontal Bar)
            const ctx1 = document.getElementById('chart-patterns');
            if (chartIssues) chartIssues.destroy(); // using same var name for convenience, represents "Patterns" now

            // Sort and Slice Top 10
            const sortedPatterns = Object.entries(patternCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

            chartIssues = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: sortedPatterns.map(x => x[0]),
                    datasets: [{
                        label: 'Complaints',
                        data: sortedPatterns.map(x => x[1]),
                        backgroundColor: '#f43f5e',
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });

            // 4. Render Chart 2: Defect Types (Doughnut)
            const ctx2 = document.getElementById('chart-issues'); // using same ID in HTML, different concept
            if (chartStatus) chartStatus.destroy(); // represents "Issues" now

            const sortedIssues = Object.entries(issueCounts).sort((a, b) => b[1] - a[1]);

            chartStatus = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: sortedIssues.map(x => x[0]),
                    datasets: [{
                        data: sortedIssues.map(x => x[1]),
                        backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981', '#6366f1', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function openSchoolComplaints(schoolData) {
            document.getElementById('tm-school-name').innerText = schoolData.name;
            document.getElementById('tm-school-stats').innerText = `${schoolData.open} Active ‚Ä¢ ${schoolData.resolved} Resolved`;

            const list = document.getElementById('tm-list');
            list.innerHTML = schoolData.tickets.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(c => {
                const isResolved = c.status === 'Resolved';
                let images = [];
                // Handle various image formats (JSON string, single string, or empty)
                try {
                    if (c.image_url && c.image_url.startsWith('[')) {
                        images = JSON.parse(c.image_url);
                    } else if (c.image_url) {
                        images = [c.image_url];
                    }
                } catch (e) { images = []; }

                // Ensure basic image path correction if needed (assuming relative uploads/)
                images = images.map(img => img.startsWith('http') ? img : (img.startsWith('/') ? img : `/${img}`));

                return `
                <div class="group relative mb-6">
                    <!-- Premium Glass Card -->
                    <div class="relative overflow-hidden rounded-2xl bg-white/80 backdrop-blur-xl border border-white/60 shadow-xl hover:shadow-2xl hover:shadow-blue-200/50 transition-all duration-500 hover:-translate-y-1">

                        <!-- Decoration -->
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/5 to-purple-500/5 rounded-bl-full -mr-10 -mt-10 pointer-events-none"></div>

                        <!-- Header Section -->
                        <div class="p-6 border-b border-gray-100/50 flex justify-between items-start relative z-10">
                            <div class="flex gap-4">
                                <!-- Avatar -->
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-2xl flex items-center justify-center text-lg font-bold shadow-lg ${c.gender === 'Female' ? 'bg-gradient-to-br from-pink-400 to-rose-500 text-white shadow-rose-200' : 'bg-gradient-to-br from-blue-400 to-indigo-500 text-white shadow-blue-200'}">
                                        ${c.student_name ? c.student_name.charAt(0) : '?'}
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow-sm">
                                        <div class="w-3 h-3 rounded-full ${isResolved ? 'bg-emerald-400' : 'bg-rose-500'} animate-pulse"></div>
                                    </div>
                                </div>

                                <!-- Info -->
                                <div>
                                    <h4 class="font-black text-gray-800 text-base tracking-tight mb-0.5">${c.student_name || 'Generic Ticket'}</h4>
                                    <div class="flex items-center gap-2">
                                        <span class="px-2 py-0.5 rounded-md bg-gray-100/80 text-gray-500 text-[10px] font-bold font-mono tracking-wider border border-gray-200">${c.student_reg_no || 'NO REG'}</span>
                                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">
                                            ${new Date(c.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}
                                            ${c.class ? `‚Ä¢ ${c.class}` : ''}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Status & Actions -->
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <select onchange="updateTicketStatus(${c.id}, this.value)"
                                        class="appearance-none pl-3 pr-8 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider cursor-pointer border-0 shadow-sm focus:ring-2 transition-all ${isResolved ? 'bg-emerald-50 text-emerald-600 focus:ring-emerald-200' : 'bg-rose-50 text-rose-600 focus:ring-rose-200'}">
                                        <option value="Open" ${!isResolved ? 'selected' : ''}>Open Issue</option>
                                        <option value="Resolved" ${isResolved ? 'selected' : ''}>Resolved</option>
                                    </select>
                                    <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none">
                                        <svg class="w-3 h-3 ${isResolved ? 'text-emerald-500' : 'text-rose-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Body Section -->
                        <div class="p-6 relative z-10">

                            <!-- Issue Details Grid -->
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div class="bg-indigo-50/50 p-3 rounded-xl border border-indigo-100/50 hover:bg-indigo-50 transition-colors">
                                    <span class="block text-[9px] font-extrabold text-indigo-400 uppercase tracking-widest mb-1">Defective Pattern</span>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                                        <span class="text-xs font-bold text-indigo-900 truncate">${c.pattern_name || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="bg-rose-50/50 p-3 rounded-xl border border-rose-100/50 hover:bg-rose-50 transition-colors">
                                    <span class="block text-[9px] font-extrabold text-rose-400 uppercase tracking-widest mb-1">Issue Type</span>
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                                        <span class="text-xs font-bold text-rose-900 truncate">${c.issue_type || 'General'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Comment Bubble -->
                            <div class="relative bg-gray-50 p-4 rounded-xl rounded-tl-none border border-gray-100 mb-6">
                                <div class="absolute -top-2 left-0 w-4 h-4 bg-gray-50 border-t border-l border-gray-100 transform -skew-y-12"></div>
                                <p class="text-gray-600 text-sm font-medium leading-relaxed italic">"${c.comment}"</p>
                            </div>

                            <!-- Images Gallery -->
                            ${images.length > 0 ? `
                                <div class="mb-6">
                                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-2">Attached Proof</p>
                                    <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-200">
                                        ${images.map(u => `
                                            <div class="relative group/img cursor-pointer shrink-0" onclick="window.open('${u}')">
                                                <img src="${u}" class="h-24 w-24 rounded-xl object-cover shadow-sm border-2 border-white hover:border-blue-400 hover:shadow-md transition-all">
                                                <div class="absolute inset-0 bg-black/0 group-hover/img:bg-black/10 rounded-xl transition-colors flex items-center justify-center opacity-0 group-hover/img:opacity-100">
                                                    <svg class="w-6 h-6 text-white drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>` : ''}

                            <!-- Actions / Reply -->
                            <div class="border-t border-gray-100 pt-5">
                                ${c.reply ? `
                                    <div class="flex gap-4 items-start animate-in fade-in duration-500">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center shrink-0 border border-blue-200">
                                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                                        </div>
                                        <div class="flex-1 bg-blue-50/50 p-4 rounded-2xl rounded-tl-none border border-blue-100">
                                            <div class="flex justify-between items-center mb-1">
                                                <span class="text-[9px] font-extrabold text-blue-400 uppercase tracking-widest">Official Response</span>
                                                <span class="text-[9px] font-bold text-blue-300">Sent just now</span> <!-- Timestamp if avail -->
                                            </div>
                                            <p class="text-xs text-blue-900 font-medium leading-relaxed">${c.reply}</p>
                                        </div>
                                    </div>`
                        : `
                                    <button onclick="openReplyModal(${c.id}, '${c.school_name}')" 
                                        class="w-full py-3 bg-gradient-to-r from-gray-50 to-white hover:from-blue-500 hover:to-blue-600 text-gray-500 hover:text-white border border-gray-200 hover:border-transparent rounded-xl text-xs font-bold uppercase tracking-widest shadow-sm hover:shadow-lg hover:shadow-blue-200 transition-all duration-300 flex items-center justify-center gap-2 group/btn">
                                        <span class="group-hover/btn:-translate-x-1 transition-transform">Write a Reply</span>
                                        <svg class="w-4 h-4 group-hover/btn:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                    </button>`
                    }
                            </div>
                        </div>
                    </div>
                </div>
                    `;
            }).join('');

            document.getElementById('ticketModal').showModal();
        }

        async function updateTicketStatus(id, newStatus) {
            // Optimistic Update? No, let's fetch.
            try {
                // Reuse reply endpoint or new status toggler? 
                // We don't have a status toggle route yet explicitly in previous summary, 
                // but 'PUT /api/data/complaints/:id' works for full updates. 
                // Let's assume we can enable a standard update.
                // Wait, the previous code for PUT used: db.run("UPDATE complaints SET rating = ?, comment = ?, image_url = ? ...")
                // It did NOT update status. 
                // Checking backend... we need to ensure backend supports status update!
                // If not, we fall back to just display for now, or use 'reply' to resolve. 
                // Let's assume simple reply for now is the main interaction, OR use the reply endpoint to also close it if needed. 
                // Actually, let's stick to just viewing for safety unless I patch the backend. 
                // User asked for "update complaint style". I will leave status changing as visual for now or patch backend if I can.
                // Let's create a quick patch in next step if broken.
                alert("Status update requires Backend Patch. Coming soon.");
            } catch (e) { }
        }

        function generateComplaintReport() {
            downloadComplaintsExcel();
        }

        function downloadComplaintsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            // Header
            doc.setFontSize(18);
            doc.text("Planetsolutions - Complaint Report", 14, 20);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()} `, 14, 26);

            // Stats
            const total = document.getElementById('c-stat-total')?.innerText || '0';
            const open = document.getElementById('c-stat-open')?.innerText || '0';
            doc.text(`Total: ${total} | Open: ${open} `, 14, 32);

            // Table Data
            const tableRows = filteredComplaints.map(c => [
                new Date(c.created_at).toLocaleDateString(),
                c.school_name,
                c.student_name + ` (${c.student_reg_no || '-'})`,
                c.gender,
                (c.pattern_name || '-').substring(0, 30),
                (c.issue_type || '-').substring(0, 30),
                c.status
            ]);

            doc.autoTable({
                startY: 36,
                head: [['Date', 'School', 'Student', 'Gender', 'Patterns', 'Issues', 'Status']],
                body: tableRows,
                theme: 'grid',
                headStyles: { fillColor: [244, 63, 94] },
                styles: { fontSize: 8 },
            });

            doc.save(`complaints_report_${new Date().toISOString().slice(0, 10)}.pdf`);
        }

        function downloadComplaintsExcel() {
            const wb = XLSX.utils.book_new();
            const excelData = filteredComplaints.map(c => ({
                "Date": new Date(c.created_at).toLocaleDateString(),
                "School": c.school_name,
                "Student": c.student_name,
                "Reg No": c.student_reg_no,
                "Class": c.class,
                "Section": c.section,
                "Gender": c.gender,
                "Status": c.status,
                "Patterns": c.pattern_name,
                "Issues": c.issue_type,
                "Comment": c.comment,
                "Reply": c.reply || ''
            }));
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wscols = Object.keys(excelData[0] || {}).map(k => ({ wch: 20 }));
            ws['!cols'] = wscols;
            XLSX.utils.book_append_sheet(wb, ws, "Complaints");
            XLSX.writeFile(wb, `complaints_report_${new Date().toISOString().slice(0, 10)}.xlsx`);
            if (window.Logger) window.Logger.log('EXPORT_COMPLAINTS', `Downloaded Complaints Excel Report`);
        }

        function openReplyModal(id, schoolName) {
            currentComplaintId = id;
            document.getElementById('reply-school-name').innerText = `Replying to: ${schoolName} `;
            document.getElementById('reply-text').value = '';

            // Force close ticket modal to fix stacking
            const tm = document.getElementById('ticketModal');
            if (tm) tm.close();

            const rm = document.getElementById('reply-modal');
            rm.classList.remove('hidden');
            rm.style.zIndex = '9999';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.add('hidden');
            currentComplaintId = null;
        }

        async function submitReply() {
            if (!currentComplaintId) return;
            const text = document.getElementById('reply-text').value;
            if (!text.trim()) return alert("Please write a reply.");

            try {
                const res = await fetch(`${API_BASE} /data/complaints / ${currentComplaintId}/reply`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ reply: text })
                });

                if (res.ok) {
                    alert("Reply Sent!");
                    closeReplyModal();
                    fetchComplaints();
                } else {
                    alert("Failed to send reply");
                }
            } catch (e) { alert(e.message); }
        }

        // === SECURITY FEATURES ===

        // 1. Password Reset
        async function resetUserPassword(userId, username) {
            const newPwd = prompt(`Enter NEW PASSWORD for user '${username}':`);
            if (!newPwd) return;
            if (newPwd.length < 4) return alert("Password must be at least 4 characters.");

            if (!confirm(`Are you sure you want to reset password for ${username}?`)) return;

            try {
                const res = await fetch(`${API_BASE}/data/users/${userId}/reset-password`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ new_password: newPwd })
                });

                const d = await res.json();
                if (res.ok) {
                    alert('‚úÖ ' + d.message);
                } else {
                    alert('‚ùå Failed: ' + (d.error || 'Unknown error'));
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        // 2. School Data Lock
        let currentSchoolLocked = false;

        async function fetchAndSetLockStatus(schoolId) {
            const btn = document.getElementById('btn-lock-school');
            const lbl = document.getElementById('lbl-lock-school');

            // Allow button to show while loading?
            if (btn) btn.classList.remove('hidden');

            try {
                const res = await fetch(`${API_BASE}/schools/${schoolId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data && typeof data.is_locked !== 'undefined') {
                    currentSchoolLocked = (data.is_locked === 1 || data.is_locked === true);
                    updateLockUI();
                }
            } catch (e) {
                console.error("Failed to fetch lock status", e);
            }
        }

        function updateLockUI() {
            const btn = document.getElementById('btn-lock-school');
            const lbl = document.getElementById('lbl-lock-school');
            if (!btn || !lbl) return;

            if (currentSchoolLocked) {
                btn.className = "clay-btn px-4 py-2 text-xs font-bold text-rose-500 bg-rose-50 uppercase flex items-center gap-2 border border-rose-200 shadow-inner";
                lbl.innerText = "Data Locked";
                btn.title = "Click to Unlock";
            } else {
                btn.className = "clay-btn px-4 py-2 text-xs font-bold text-gray-500 bg-white uppercase flex items-center gap-2 hover:bg-gray-50";
                lbl.innerText = "Lock Data";
                btn.title = "Click to Lock (Read-Only Mode)";
            }
        }



        async function toggleSchoolLock(isRetry = false) {
            if (!currentSchoolDetails.id) return;

            // Skipping prompt on retry
            let action, lockMsg;
            if (!isRetry) {
                action = currentSchoolLocked ? "UNLOCK" : "LOCK";
                if (!confirm(`Are you sure you want to ${action} this school?\n\n${currentSchoolLocked ? 'Teachers will be able to edit data again.' : 'Teachers will be BLOCKED from editing data.'}`)) return;

                if (!currentSchoolLocked) {
                    lockMsg = prompt("Optional: Enter a message for the school (e.g., 'Payment Overdue'). Leave empty for default.");
                }
            } else {
                // On retry, just invert current local state which hasn't swapped yet
                lockMsg = null; // Can't easily persist prompt value on retry without complex refactor, assume empty for auto-retry
            }

            try {
                const res = await fetch(`${API_BASE}/data/schools/${currentSchoolDetails.id}/lock`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ is_locked: !currentSchoolLocked, message: lockMsg })
                });
                const d = await res.json();

                if (res.ok) {
                    currentSchoolLocked = !currentSchoolLocked;
                    updateLockUI();
                    showToast(`School ${isRetry ? 'Locked' : action + 'ED'} successfully`, 'success');
                    if (window.Logger) window.Logger.log('TOGGLE_SCHOOL_LOCK', `School ${currentSchoolDetails.id} is now ${!currentSchoolLocked ? 'LOCKED' : 'UNLOCKED'}`);
                } else {
                    // AUTO-FIX: Check for Schema Error
                    if (d.error && d.error.includes("Unknown column") && d.error.includes("lock_message") && !isRetry) {
                        const fixRes = await fetch(`${API_BASE}/data/fix_db`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (fixRes.ok) {
                            showToast("Applying Database Patch...", "info");
                            await new Promise(r => setTimeout(r, 1000));
                            return toggleSchoolLock(true); // RETRY ONCE
                        }
                    }
                    alert("Failed: " + (d.error || "Unknown"));
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }


        // === SETTINGS & ERROR HANDLING ===

        let appSettings = {
            urgentAlerts: true,
            complaintAlerts: true,
            errorReporting: false
        };

        function initSettings() {
            try {
                const saved = localStorage.getItem('planet_settings');
                if (saved) appSettings = { ...appSettings, ...JSON.parse(saved) };

                // Update UI
                const chkUrgent = document.getElementById('setting-notify');
                const chkComplaint = document.getElementById('setting-notify-complaint');
                const chkError = document.getElementById('setting-notify-error');

                if (chkUrgent) chkUrgent.checked = appSettings.urgentAlerts;
                if (chkComplaint) chkComplaint.checked = appSettings.complaintAlerts;
                if (chkError) chkError.checked = appSettings.errorReporting;

                // Apply Initial State
                if (appSettings.errorReporting) enableErrorReporting();

            } catch (e) { console.error("Settings Init Error", e); }
        }

        function toggleNotificationSetting(checked, type) {
            if (type === 'urgent') appSettings.urgentAlerts = checked;
            if (type === 'complaint') appSettings.complaintAlerts = checked;
            if (type === 'error') {
                appSettings.errorReporting = checked;
                if (checked) {
                    enableErrorReporting();
                    alert("System Error Reports Enabled.\n\nCrash logs will be automatically sent to the server.");
                } else {
                    disableErrorReporting();
                }
            }
            // Save
            localStorage.setItem('planet_settings', JSON.stringify(appSettings));
            if (window.Logger) window.Logger.log('UPDATE_SETTINGS', `Settings changed: ${type}=${checked}`);
        }

        // Global Error Handlers
        let errorHandlersAttached = false;
        function enableErrorReporting() {
            if (errorHandlersAttached) return;

            window.onerror = function (msg, url, lineNo, columnNo, error) {
                if (!appSettings.errorReporting) return;
                const details = `Crash: ${msg} @ ${url}:${lineNo}:${columnNo}`;
                if (window.Logger) window.Logger.log('SYSTEM_ERROR', details);
                else console.error("Logger not ready for error report", details);
            };

            window.onunhandledrejection = function (event) {
                if (!appSettings.errorReporting) return;
                const reason = event.reason ? (event.reason.stack || event.reason) : 'Unknown Promise Error';
                const details = `Unhandled Promise: ${reason}`;
                if (window.Logger) window.Logger.log('SYSTEM_ERROR', details);
            };

            errorHandlersAttached = true;
            console.log("System Error Reporting Active");
        }

        function disableErrorReporting() {
            console.log("System Error Reporting Paused");
        }

        async function fetchGlobalPatterns() {
            try {
                const res = await fetch(`${API_BASE}/data/patterns/all`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    globalPatterns = await res.json();
                } else {
                    console.error("Failed to fetch global patterns");
                    globalPatterns = [];
                }
            } catch (e) {
                console.error("Pattern Fetch Error", e);
                globalPatterns = [];
            }
        }

        document.getElementById('nav-overview').classList.add('active'); init().then(() => {
            initSettings(); // LOAD SETTINGS
            // Auto Refresh Pollers
            setInterval(() => { fetchStats(); }, 30000);
            setInterval(() => { if (!document.getElementById('view-complaints').classList.contains('hidden')) fetchComplaints(); }, 15000);
        });

        async function resetDatabase() {
            if (!confirm("‚ö†Ô∏è DANGER: This will DELETE ALL PATTERNS, MEASUREMENTS and UNLINK STUDENTS from the database.\\n\\nThis action cannot be undone on Production.\\n\\nType 'RESET' to confirm:")) return;

            const conf = prompt("Type 'RESET' to confirm deletion:");
            if (conf !== 'RESET') return alert("Cancelled.");

            try {
                const res = await fetch(`${API_BASE}/data/reset_tables`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const d = await res.json();
                if (!res.ok) throw new Error(d.error || "Reset failed");
                alert("‚úÖ " + d.message);

                if (window.Logger) window.Logger.log('RESET_DATABASE', `DATABASE WIPED BY ADMIN`);

                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        async function fixDatabase() {
            if (!confirm("Attempt to repair database schema? (Adds missing tables/columns)")) return;
            try {
                const res = await fetch(`${API_BASE}/data/fix_db`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await res.json();
                alert(d.message);
                if (window.Logger) window.Logger.log('FIX_DATABASE', `Database Fix Tool Ran`);
            } catch (e) {
                alert("Repair Error: " + e.message);
            }
        }

        // === SMART REPORTS LOGIC ===
        let globalLogs = [];
        let charts = { vol: null, role: null };
        let debounceTimer;

        async function initReports() {
            // Ensure dependencies are loaded for Reports
            if (!globalSchools || globalSchools.length === 0) await fetchSchoolsForSelect();
            if (!globalUsers || globalUsers.length === 0) await fetchUsers();

            // Populate School Dropdowns (All Reports View Dropdowns)
            const selectors = ['#log-filter-school', '#rp-export-school-select', '#report-school-select'];

            const populate = () => {
                if (!globalSchools || globalSchools.length === 0) return;
                const opts = globalSchools.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                selectors.forEach(sel => {
                    const el = document.querySelector(sel);
                    if (el) {
                        const current = el.value;
                        el.innerHTML = `<option value="All">-- All Schools --</option>` + opts;
                        if (current && current !== 'All') el.value = current;
                    }
                });
            };

            populate();
            // Retry not needed if we await, but good for safety if fetch fails silently
            // setTimeout(populate, 1000); 

            // Initial Fetch
            fetchReportLogs();
        }

        // Wrapper for the HTML Filter Button
        window.fetchActivityLogs = function () {
            fetchReportLogs();
        }

        function debounceLogFetch() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => fetchReportLogs(), 500);
        }

        async function fetchReportLogs() {
            // Capture Filters with correct IDs
            const schoolId = document.getElementById('log-filter-school')?.value;
            const userId = document.getElementById('log-filter-user')?.value;
            const startDate = document.getElementById('log-filter-start-date')?.value;
            const endDate = document.getElementById('log-filter-end-date')?.value;

            const params = new URLSearchParams();
            if (schoolId && schoolId !== 'All') params.append('school_id', schoolId);
            if (userId && userId !== 'All') params.append('username', userId);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            // Fetch
            try {
                const tbody = document.getElementById('rp-school-table');
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-blue-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading System Logs...</td></tr>';

                // Update AI Analyst (Loading)
                updateAIComponents({}, true);

                const r = await fetch(`${API_BASE}/data/logs?${params}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await r.json();
                globalLogs = data.error ? [] : data;

                // Render
                renderLogTable('rp-school-table', globalLogs);
                updateAIComponents(globalLogs, false);

            } catch (e) {
                console.error("Log Fetch Error", e);
                const tbody = document.getElementById('rp-school-table');
                if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Log Fetch Error: ${e.message}</td></tr>`;
            }
        }

        // === DOWNLOAD FUNCTIONS ===
        function downloadLogsPDF() {
            if (!globalLogs || globalLogs.length === 0) { alert("No logs to export!"); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text("System Activity Logs", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            const head = [['Timestamp', 'User', 'Role', 'School', 'Action', 'Details']];
            const body = globalLogs.map(l => [
                new Date(l.created_at).toLocaleString(),
                l.username,
                l.role || '-',
                l.school_name || l.school_id || '-',
                l.action,
                l.details
            ]);

            doc.autoTable({
                head: head,
                body: body,
                startY: 25,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save("System_Logs.pdf");
        }

        function downloadLogsCSV() {
            if (!globalLogs || globalLogs.length === 0) { alert("No logs to export!"); return; }

            const headers = ['Timestamp', 'User', 'Role', 'School', 'Action', 'Details'];
            const rows = globalLogs.map(l => [
                `"${new Date(l.created_at).toLocaleString()}"`,
                `"${l.username}"`,
                `"${l.role || '-'}"`,
                `"${l.school_name || l.school_id || '-'}"`,
                `"${l.action}"`,
                `"${l.details.replace(/"/g, '""')}"`
            ]);

            const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "System_Logs.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // === GENERAL REPORT DOWNLOADS ===
        function downloadSchoolReportPDF() {
            const sid = document.getElementById('report-school-select')?.value;
            if (!sid) { alert("Please select a school first."); return; }

            const s = globalSchools.find(x => x.id == sid);
            if (!s) return;

            let data = globalStudents.filter(st => st.school_id == sid);
            if (data.length === 0) {
                alert("No loaded student data for this school. Please visit the 'Schools' tab to load data first, or wait for background sync.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`${s.name} - Student Report`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);

            const head = [['Name', 'Class', 'Gender', 'Status']];
            const body = data.map(st => [st.name, `${st.class}-${st.section}`, st.gender, st.is_packed ? 'Packed' : 'Pending']);

            doc.autoTable({ head, body, startY: 25 });
            doc.save(`${s.name}_Report.pdf`);
        }

        function downloadSchoolReport() {
            const sid = document.getElementById('report-school-select')?.value;
            if (!sid) { alert("Please select a school first."); return; }
            const s = globalSchools.find(x => x.id == sid);

            let data = globalStudents.filter(st => st.school_id == sid);
            if (data.length === 0) { alert("No student data found for this school."); return; }

            const headers = ['Name', 'Class', 'Section', 'Gender', 'Status', 'Roll No'];
            const rows = data.map(st => [
                `"${st.name}"`, `"${st.class}"`, `"${st.section}"`, `"${st.gender}"`,
                `"${st.is_packed ? 'Packed' : 'Pending'}"`, `"${st.roll_no || ''}"`
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${s.name}_Data.csv`;
            link.click();
        }

        async function downloadUserReportPDF() {
            // 1. Check Data Presence & Auto-Fetch
            if (!globalUsers || globalUsers.length === 0) {
                console.warn("downloadUserReportPDF: globalUsers Empty, attempting force fetch...");
                try {
                    await fetchUsers(true); // Retry
                } catch (e) {
                    alert("Report Generation Failed: Could not fetch user data.\n" + e.message);
                    return;
                }
            }

            // 2. Final Verification
            if (!globalUsers || globalUsers.length === 0) {
                alert("Report Empty: No users found in the database.\nIf you believe this is an error, please try logging out and back in.");
                return;
            }

            // 3. Generate PDF
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(16);
                doc.text("Planetsolutions - User Management Report", 14, 15);

                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
                doc.text(`Total Users: ${globalUsers.length}`, 14, 27);

                const head = [['ID', 'Username', 'Role', 'School', 'Status', 'Created']];
                const body = globalUsers.map(u => [
                    u.id,
                    u.username,
                    u.role,
                    u.school_name || (u.role === 'company' ? 'HQ' : '-'),
                    u.is_active ? 'Active' : 'Disabled',
                    new Date(u.created_at).toLocaleDateString()
                ]);

                doc.autoTable({
                    head,
                    body,
                    startY: 32,
                    theme: 'grid',
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [63, 81, 181] }
                });

                doc.save(`User_Registry_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
            } catch (e) {
                console.error(e);
                alert("PDF Generation Error: " + e.message);
            }
        }

        async function downloadUserReport() {
            // 1. Check Data Presence & Auto-Fetch
            if (!globalUsers || globalUsers.length === 0) {
                console.warn("downloadUserReport (CSV): globalUsers Empty, attempting force fetch...");
                try {
                    await fetchUsers(true); // Retry
                } catch (e) {
                    alert("Report Generation Failed: Could not fetch user data.\n" + e.message);
                    return;
                }
            }

            // 2. Final Verification
            if (!globalUsers || globalUsers.length === 0) {
                alert("Report Empty: No users found in the database.");
                return;
            }

            // 3. Generate CSV
            try {
                const headers = ['ID', 'Username', 'Role', 'School', 'Active', 'Created At'];
                const rows = globalUsers.map(u => [
                    `${u.id}`,
                    `"${u.username}"`,
                    `"${u.role}"`,
                    `"${u.school_name || ''}"`,
                    `"${u.is_active ? 'Yes' : 'No'}"`,
                    `"${new Date(u.created_at).toLocaleString()}"`
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `User_Registry_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (e) {
                console.error(e);
                alert("CSV Generation Error: " + e.message);
            }
        }

        function updateAIComponents(logs, isLoading) {
            const statusEl = document.getElementById('ai-status-text');
            const insightEl = document.getElementById('ai-insight-text');
            const scoreEl = document.getElementById('ai-score');
            const barEl = document.getElementById('ai-score-bar');

            if (isLoading) {
                if (statusEl) statusEl.innerText = "SCANNING SYSTEM...";
                if (insightEl) insightEl.innerText = "Running heuristic analysis on system logs...";
                return;
            }

            const total = logs.length || 0;
            if (total === 0) {
                if (statusEl) statusEl.innerText = "NO DATA";
                if (insightEl) insightEl.innerText = "Insufficient data for analysis.";
                return;
            }

            // --- AI ANALYST LOGIC ---

            // 1. Vulnerability Finder (Security Risks)
            const secKeywords = ['Login Failed', 'Unauthorized', 'Forbidden', 'Access Denied', 'Revoked'];
            const vulnEvents = logs.filter(l => secKeywords.some(k => (l.action + l.details).includes(k)));
            const vulnScore = Math.max(0, 100 - (vulnEvents.length * 10)); // -10 per event

            // 2. Bug Finder (System Stability)
            const bugKeywords = ['Error', 'Exception', 'Failed', '500', 'undefined', 'null'];
            const bugEvents = logs.filter(l => bugKeywords.some(k => (l.action + l.details).includes(k)));
            const bugScore = Math.max(0, 100 - (bugEvents.length * 5)); // -5 per bug

            // 3. Data Leakage Finder (Exfiltration Risks)
            const leakKeywords = ['Export', 'Download', 'Bulk', 'Report', 'All Users'];
            const leakEvents = logs.filter(l => leakKeywords.some(k => (l.action + l.details).includes(k)));
            const leakScore = Math.max(0, 100 - (leakEvents.length * 2)); // -2 per export (sensitive)

            // Overall Logic
            const minScore = Math.min(vulnScore, bugScore, leakScore);
            const avgScore = Math.floor((vulnScore + bugScore + leakScore) / 3);

            // Insight Generation
            let status = "SYSTEM OPTIMAL";
            let statusColor = "text-emerald-500";
            let insights = [];

            if (minScore < 50) { status = "CRITICAL RISK"; statusColor = "text-red-600"; }
            else if (minScore < 80) { status = "ATTENTION NEEDED"; statusColor = "text-orange-500"; }
            else if (minScore < 95) { status = "MINOR ISSUES"; statusColor = "text-blue-500"; }

            if (vulnEvents.length > 0) insights.push(`<span class="text-red-500 font-bold">‚ö†Ô∏è ${vulnEvents.length} Security Alert(s)</span> detected.`);
            if (bugEvents.length > 0) insights.push(`<span class="text-orange-500 font-bold">üêû ${bugEvents.length} System Error(s)</span> found.`);
            if (leakEvents.length > 0) insights.push(`<span class="text-blue-500 font-bold">üíæ ${leakEvents.length} Data Export(s)</span> monitored.`);

            if (insights.length === 0) insights.push("No anomalies detected across all vectors.");

            // UI Update
            if (statusEl) {
                statusEl.innerText = status;
                statusEl.className = `text-xs font-bold uppercase tracking-wider ${statusColor}`;
            }

            if (insightEl) {
                insightEl.innerHTML = `
                    <div class="flex flex-col gap-1 mt-1">
                        <div>${insights.join(' ')}</div>
                        <div class="grid grid-cols-3 gap-2 mt-2 text-[10px] uppercase font-bold text-gray-400">
                            <div>Security: <span class="${vulnScore < 80 ? 'text-red-500' : 'text-emerald-500'}">${vulnScore}%</span></div>
                            <div>Stability: <span class="${bugScore < 80 ? 'text-orange-500' : 'text-emerald-500'}">${bugScore}%</span></div>
                            <div>Privacy: <span class="${leakScore < 80 ? 'text-blue-500' : 'text-emerald-500'}">${leakScore}%</span></div>
                        </div>
                    </div>
                `;
            }

            if (scoreEl) scoreEl.innerText = `${avgScore}%`;
            if (barEl) {
                barEl.style.width = `${avgScore}%`;
                barEl.className = `h-full rounded-full transition-all duration-1000 ${avgScore < 70 ? 'bg-red-500' : (avgScore < 90 ? 'bg-orange-400' : 'bg-violet-500')}`;
            }
        }

        function renderAnalytics() {
            // Legacy function kept as stub
            updateAIComponents(globalLogs, false);
        }

        // Chart Data Prep
        function prepCharts() {
            const dates = {};
            globalLogs.forEach(l => {
                const d = new Date(l.created_at).toLocaleDateString();
                dates[d] = (dates[d] || 0) + 1;
            });

            const volCanvas = document.getElementById('chart-logs-volume');
            if (volCanvas) {
                if (charts.vol) charts.vol.destroy();
                charts.vol = new Chart(volCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dates),
                        datasets: [{ label: 'Events', data: Object.values(dates), backgroundColor: '#818cf8', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { display: false } } }
                });
            }

            // 3. Role Chart (Pie)
            const roleCanvas = document.getElementById('chart-logs-role');
            if (roleCanvas) {
                if (charts.role) charts.role.destroy();
                charts.role = new Chart(roleCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats.roles),
                        datasets: [{ data: Object.values(stats.roles), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
                });
            }
        }

        function renderLogTable(id, logs) {
            const tbody = document.getElementById(id);
            if (!tbody) { console.error("Log Table Body Not Found:", id); return; }
            if (logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-400 italic">No logs found matching criteria.</td></tr>`;
                return;
            }
            tbody.innerHTML = logs.map(l => `
                <tr class="hover:bg-gray-50 border-b border-gray-50">
                    <td class="p-4 whitespace-nowrap text-gray-400 text-[10px] font-mono">${new Date(l.created_at).toLocaleString()}</td>
                    <td class="p-4 font-bold text-gray-700 text-xs">${l.username}</td>
                    <td class="p-4 text-xs text-gray-500">${l.role || '-'}</td>
                    <td class="p-4 text-xs text-blue-600 font-medium">${l.school_name || l.school_id || '-'}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-[10px] font-bold bg-gray-100 text-gray-600 border border-gray-200">${l.action}</span></td>
                    <td class="p-4 text-xs text-gray-500 truncate max-w-xs" title="${l.details}">${l.details}</td>
                </tr>
            `).join('');
        }

        async function cleanupLogs() {
            if (!confirm("Are you sure? This will delete all logs older than 7 days.")) return;
            try {
                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/logs/cleanup`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const d = await r.json();
                showToast(d.message);
                fetchReportLogs('overview'); // Refresh
            } catch (e) { showToast("Cleanup failed", true); }
        }

        // === SETTINGS LOGIC ===
        async function initSettings() {
            // 1. Load Support Email
            const email = localStorage.getItem('ps_support_email');
            if (email) {
                const el = document.getElementById('set-email');
                if (el) el.value = email;
            }

            // 2. Load Notification Preferences
            const nUrgent = localStorage.getItem('ps_notify_urgent') !== 'false';
            const nComplaint = localStorage.getItem('ps_notify_complaint') !== 'false';
            const nError = localStorage.getItem('ps_notify_error') !== 'false';

            setCheck('setting-notify', nUrgent);
            setCheck('setting-notify-complaint', nComplaint);
            setCheck('setting-notify-error', nError);

            // 3. Load Theme
            const theme = localStorage.getItem('ps_theme') || 'light';
            toggleThemeUI(theme);
        }

        function setCheck(id, val) {
            const el = document.getElementById(id);
            if (el) el.checked = val;
        }

        function toggleNotificationSetting(checked, type = 'urgent') {
            localStorage.setItem(`ps_notify_${type}`, checked);
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} alerts ${checked ? 'enabled' : 'disabled'}`, 'info');
        }

        function saveSupportEmail() {
            const email = document.getElementById('set-email').value;
            if (!email) return alert("Please enter an email");
            localStorage.setItem('ps_support_email', email);
            showToast("Support email saved!", "success");
        }

        function setTheme(mode) {
            localStorage.setItem('ps_theme', mode);
            toggleThemeUI(mode);
            showToast(`Theme set to ${mode.toUpperCase()}`, 'success');
        }

        function toggleThemeUI(mode) {
            const lightBtn = document.getElementById('theme-btn-light');
            const darkBtn = document.getElementById('theme-btn-dark');

            if (mode === 'light') {
                if (lightBtn) lightBtn.className = "flex-1 p-3 rounded-xl bg-blue-50 border-2 border-blue-500 cursor-pointer flex justify-center flex-col items-center gap-2 shadow-sm";
                if (darkBtn) darkBtn.className = "flex-1 p-3 rounded-xl bg-gray-50 border border-gray-100 cursor-pointer opacity-60 flex justify-center flex-col items-center gap-2 grayscale hover:opacity-100 transition-opacity";
                document.documentElement.classList.remove('dark');
            } else {
                if (lightBtn) lightBtn.className = "flex-1 p-3 rounded-xl bg-gray-50 border border-gray-100 cursor-pointer opacity-60 flex justify-center flex-col items-center gap-2 grayscale hover:opacity-100 transition-opacity";
                if (darkBtn) darkBtn.className = "flex-1 p-3 rounded-xl bg-slate-800 border-2 border-slate-600 cursor-pointer flex justify-center flex-col items-center gap-2 shadow-sm text-white";
                document.documentElement.classList.add('dark');
            }
        }

        async function downloadReport(type, format) {
            const { jsPDF } = window.jspdf;

            // 0. SYSTEM OVERVIEW LOGS (New Case)
            if (type === 'overview') {
                return downloadLogsPDF(); // Use shared function from company_logging.js
            }

            // 1. SCHOOL SPECIFIC DATA
            if (type === 'school') {
                const schoolId = document.getElementById('rp-export-school-select').value;
                if (!schoolId) return alert("Please select a school first.");

                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/schools/${schoolId}/export`, { headers: { 'Authorization': `Bearer ${token}` } });
                const students = await r.json();
                if (students.length === 0) return alert("No data found for this school.");

                if (format === 'xls') {
                    // Simple CSV Export
                    let csv = "Admission No,Name,Class,Section,Gender,Measurements\n";
                    students.forEach(s => {
                        const m = s.measurements || {};
                        csv += `${s.admission_no},${s.name},${s.class},${s.section},${s.gender},"${JSON.stringify(m).replace(/"/g, '""')}"\n`;
                    });
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `School_Data_${schoolId}.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text(`Student Data: School ${schoolId}`, 14, 15);
                    const headers = [["Adm No", "Name", "Class", "Section", "Gender"]];
                    const data = students.map(s => [s.admission_no, s.name, s.class, s.section, s.gender]);

                    doc.autoTable({
                        head: headers,
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8 },
                        theme: 'grid'
                    });
                    doc.save(`School_Data_${schoolId}.pdf`);
                }
            }

            // 2. USER REGISTRY
            if (type === 'users') {
                // FIXED: API Path was missing /data
                const r = await fetch(`${API_BASE}/data/users_report`, { headers: { 'Authorization': `Bearer ${token}` } });
                const users = await r.json();

                if (format === 'xls') {
                    let csv = "ID,Username,Role,School,Created At\n";
                    users.forEach(u => csv += `${u.id},${u.username},${u.role},${u.school_name || 'N/A'},${u.created_at}\n`);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `User_Registry.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text("User Registry", 14, 15);
                    doc.autoTable({
                        head: [['ID', 'Username', 'Role', 'School', 'Created At']],
                        body: users.map(u => [u.id, u.username, u.role, u.school_name || 'N/A', new Date(u.created_at).toLocaleDateString()]),
                        startY: 20,
                        theme: 'striped'
                    });
                    doc.save('User_Registry.pdf');
                }
            }

            // 3. REGISTERED SCHOOLS LIST
            if (type === 'schools_list') {
                if (!globalSchools || globalSchools.length === 0) return alert("No school data loaded.");

                if (format === 'xls') {
                    let csv = "ID,School Name,Username,Priority,Status,Start Date,Deadline\n";
                    globalSchools.forEach(s => csv += `${s.id},${s.name},${s.username},${s.priority},${s.status},${s.start_date || ''},${s.deadline || ''}\n`);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Registered_Schools_Registry.csv`;
                    a.click();
                } else if (format === 'pdf') {
                    const doc = new jsPDF();
                    doc.text("Registered Schools Registry", 14, 15);
                    const data = globalSchools.map(s => [s.name, s.username, s.status, s.start_date || '-', s.deadline || '-']);
                    doc.autoTable({
                        head: [['School Name', 'Admin', 'Status', 'Start', 'Deadline']],
                        body: data,
                        startY: 20,
                        styles: { fontSize: 8 },
                        theme: 'grid',
                        columnStyles: { 0: { cellWidth: 50 } } // Wider column for name
                    });
                    doc.save('Registered_Schools.pdf');
                }
            }
        }

        function downloadLogsXls() {
            if (globalLogs.length === 0) return alert("No logs to download.");
            let csv = "Time,User,Role,School ID,Action,Details\n";
            globalLogs.forEach(l => {
                csv += `${l.created_at},${l.username},${l.role || ''},${l.school_id || ''},${l.action},"${l.details.replace(/"/g, '""')}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `System_Logs.csv`;
            a.click();
        }

        // === SETTINGS LOGIC ===
        async function fetchSettings() {
            try {
                const res = await fetch(`${API_BASE}/data/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const settings = await res.json();
                if (settings && settings.support_email) {
                    document.getElementById('set-email').value = settings.support_email;
                }
            } catch (e) {
                console.error("Failed to load settings", e);
            }
        }

        async function saveSupportEmail() {
            const email = document.getElementById('set-email').value;
            if (!email || !email.includes('@')) return alert("Please enter a valid email.");

            try {
                const btn = document.querySelector('button[onclick="saveSupportEmail()"]');
                const originalText = btn.innerText;
                btn.innerText = "Saving...";
                btn.disabled = true;

                const res = await fetch(`${API_BASE}/data/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ key: 'support_email', value: email })
                });

                if (res.ok) {
                    showToast("Support Email Updated!", 'success');
                } else {
                    const errClone = res.clone();
                    const errText = await errClone.text();
                    throw new Error("Server Error: " + errText); // Throw actual server error
                }

                btn.innerText = originalText;
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                alert("Failed to save: " + e.message); // Alert the actual error
            }
        }

        // ==========================================
        // EXPORT FUNCTIONS (Added for Feature Parity)
        // ==========================================

        function exportTdCurrentData() {
            const patternName = document.getElementById('td-p3-title').innerText;
            const students = globalStudents.filter(st => st.school_id == tdCurrentSchoolId && (st.pattern_name || 'Unassigned') === patternName);
            const meta = globalPatterns.find(p => p.name === patternName && p.school_id == tdCurrentSchoolId) || {};

            if (students.length === 0) return alert("No students to export.");

            // --- DATA PREPARATION (Match PDF Logic) ---
            const filters = meta.filters ? (typeof meta.filters === 'string' ? JSON.parse(meta.filters) : meta.filters) : {};
            const activeItemName = filters.item;
            const measureCols = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'];
            const itemHeaders = activeItemName ? [activeItemName, "Quantity"] : [];

            // Helper: Calculate Item Value
            function calculateItemValue(r, item) {
                const m = getMeasurementsSafe(r);
                if (!item || !item.cols) return "";
                return item.cols.map(c => {
                    const k = c.toLowerCase();
                    let val = m[k] || m[c] || "00";
                    if (!val || val === '-') val = "00";
                    return val;
                }).join(',');
            }

            // Construct Header Block
            const specs = [];
            if (filters.class) specs.push(`Class: ${filters.class}`);
            if (filters.section) specs.push(`Sec: ${filters.section}`);
            if (filters.house) specs.push(`House: ${filters.house}`);
            if (filters.gender) specs.push(`Gender: ${filters.gender}`);
            if (filters.item) specs.push(`Item: ${filters.item}`);

            const wsData = [
                ["PATTERN LIST EXPORT"],
                ["Pattern Code", patternName],
                ["School Name", document.getElementById('td-school-name').innerText],
                ["Description", meta.metadata?.desc || ""], // Access nested metadata if present, or fallback
                ["Cloth Details", meta.cloth_details || ""],
                ["Special Requirements", ""], // Field not fully available in simple meta, leave blank or map if found
                ["Pattern Specifications", specs.join(', ')],
                ["Total Qty", students.length],
                ["Total Cloth Needed", (students.length * parseFloat(meta.consumption || 0)).toFixed(2) + " M"],
                [], // Empty Row
                ["S.No", "Roll No", "Student Name", "Admission No", "House", "Class", "Section", "Gender", ...measureCols, ...itemHeaders] // Table Headers
            ];

            // Rows
            students.forEach((s, i) => {
                const m = getMeasurementsSafe(s);
                const row = [
                    i + 1,
                    s.roll_no || '-',
                    s.name,
                    s.admission_no || '-',
                    s.house || '-',
                    s.class || '-',
                    s.section || '-',
                    s.gender,
                    ...measureCols.map(c => m[c.toLowerCase()] || '00')
                ];

                if (activeItemName) {
                    const item = ALL_PATTERN_ITEMS.find(it => it.name === activeItemName);
                    if (item) {
                        row.push(calculateItemValue(s, item));
                        row.push(1); // Default Qty 1
                    }
                }
                wsData.push(row);
            });

            // WRITE
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            XLSX.writeFile(wb, `${patternName}_Detailed_List.xlsx`);
        }

        function exportSchoolSummaryXLS() {
            if (!tdCurrentSchoolId) return alert("Please select a school first.");
            const patterns = globalPatterns.filter(p => p.school_id == tdCurrentSchoolId);
            const schoolName = document.getElementById('td-school-name').innerText;

            const wsData = [
                ["Pattern Name", "School", "Description", "Cloth Details", "Special Req", "Item Type", "M/Size of Pattern", "Cutting Quantity", "Total Cloth (M)", "Pattern Specifications"]
            ];

            patterns.forEach(p => {
                const count = globalStudents.filter(s => s.school_id == tdCurrentSchoolId && s.pattern_name === p.name).length;
                const meta = p.metadata || {};
                // Fallback to meta if top-level is missing (for legacy data), but prefer top-level DB columns
                const desc = p.description || p.desc || meta.desc || "";
                const req = p.special_req || p.req || meta.req || "";
                const cons = parseFloat(p.consumption || meta.consumption || 0);
                const filters = p.filters ? (typeof p.filters === 'string' ? JSON.parse(p.filters) : p.filters) : {};

                let specs = [];
                if (filters.class) specs.push(`Class: ${filters.class}`);
                if (filters.section) specs.push(`Sec: ${filters.section}`);
                if (filters.house) specs.push(`House: ${filters.house}`);
                if (filters.gender) specs.push(`Gender: ${filters.gender}`);
                if (filters.item) specs.push(`${filters.item}`);
                if (filters.components) {
                    for (const [key, val] of Object.entries(filters.components)) {
                        if (val) specs.push(`${key}: ${val}`);
                    }
                }

                wsData.push([
                    p.name,
                    p.school_name || schoolName,
                    desc,
                    p.cloth_details || meta.cloth || "",
                    req,
                    filters.item || "Mixed",
                    cons,
                    count,
                    (count * cons).toFixed(2),
                    specs.join(', ')
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Summary");
            XLSX.writeFile(wb, `${schoolName}_Pattern_Summary.xlsx`);
        }

        function exportSchoolSummaryPDF() {
            if (!tdCurrentSchoolId) return alert("Please select a school first.");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            const schoolName = document.getElementById('td-school-name').innerText;

            doc.setFontSize(16);
            doc.text(`${schoolName} - All Patterns Summary`, 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 22);

            const patterns = globalPatterns.filter(p => p.school_id == tdCurrentSchoolId);

            const headers = [["Pattern Name", "School", "Desc", "Cloth Details", "Special Req", "M/Size", "Qty", "Total Cloth", "Specs"]];

            const body = patterns.map(p => {
                const count = globalStudents.filter(s => s.school_id == tdCurrentSchoolId && s.pattern_name === p.name).length;
                const meta = p.metadata || {};
                const desc = p.description || p.desc || meta.desc || "-";
                const req = p.special_req || p.req || meta.req || "-";
                const cons = parseFloat(p.consumption || meta.consumption || 0);
                const filters = p.filters ? (typeof p.filters === 'string' ? JSON.parse(p.filters) : p.filters) : {};

                let specs = [];
                if (filters.class) specs.push(`Class: ${filters.class}`);
                if (filters.house) specs.push(`House: ${filters.house}`);
                if (filters.gender) specs.push(`Gen: ${filters.gender}`);
                if (filters.item) specs.push(`${filters.item}`);

                return [
                    p.name,
                    p.school_name || schoolName,
                    desc,
                    p.cloth_details || meta.cloth || "-",
                    req,
                    cons.toFixed(2),
                    count,
                    (count * cons).toFixed(2) + ' M',
                    specs.join(', ')
                ];
            });

            doc.autoTable({
                head: headers,
                body: body,
                startY: 28,
                theme: 'grid',
                headStyles: { fillColor: [44, 62, 80], fontSize: 9 },
                styles: { fontSize: 8, cellPadding: 2 },
                columnStyles: {
                    8: { cellWidth: 50 }
                }
            });

            doc.save(`${schoolName}_Summary.pdf`);
        }

        function exportSchoolPackingXLS() {
            if (!tdCurrentSchoolId) return alert("Please select a school first.");
            const schoolName = document.getElementById('td-school-name').innerText;
            const students = globalStudents.filter(s => s.school_id == tdCurrentSchoolId);
            students.sort((a, b) => (a.pattern_name || 'Z').localeCompare(b.pattern_name || 'Z'));

            const data = students.map((s, i) => {
                const m = getMeasurementsSafe(s);
                return {
                    "S.No": i + 1,
                    "Pattern Group": s.pattern_name || 'Unassigned',
                    "Name": s.name,
                    "Roll No": s.roll_no,
                    "Class": s.class + ' ' + s.section,
                    "Gender": s.gender,
                    "U1": m.u1 || '', "U2": m.u2 || '', "L1": m.l1 || '', "L2": m.l2 || '',
                    "Status": s.order_status || 'PENDING',
                    "Packed": s.is_packed ? 'YES' : 'NO'
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Packing List");
            XLSX.writeFile(wb, `${schoolName}_Packing_List.xlsx`);
        }

        function exportTdCurrentDataPDF() {
            const patternName = document.getElementById('td-p3-title').innerText;
            const students = globalStudents.filter(st => st.school_id == tdCurrentSchoolId && (st.pattern_name || 'Unassigned') === patternName);
            const meta = globalPatterns.find(p => p.name === patternName && p.school_id == tdCurrentSchoolId) || {};

            if (students.length === 0) return alert("No students to export.");

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });

            // --- METADATA HEADER (Matching Local Dashboard) ---
            const schoolName = document.getElementById('td-school-name').innerText;
            const filters = meta.filters ? (typeof meta.filters === 'string' ? JSON.parse(meta.filters) : meta.filters) : {};
            const code = patternName;
            const desc = meta.metadata?.desc || ''; // Meta structure might differ slightly in company DB? Using patterns fields directly usually.
            // In company dashboard, `meta` IS the pattern object.
            // Let's assume keys: `cloth_details` (mapped to cloth), `req`? 
            // Company DB simplified schema: consumption, cloth_details.
            const cloth = meta.cloth_details || '';
            const consumption = parseFloat(meta.consumption || 0);

            // Construct Specs String
            let specs = [];
            if (filters.class) specs.push(`Class: ${filters.class}`);
            if (filters.section) specs.push(`Sec: ${filters.section}`);
            if (filters.house) specs.push(`House: ${filters.house}`);
            if (filters.gender) specs.push(`Gender: ${filters.gender}`);
            if (filters.item) specs.push(`Item: ${filters.item}`);
            if (filters.components) {
                for (const [key, val] of Object.entries(filters.components)) {
                    if (val) specs.push(`${key}: ${val}`);
                }
            }

            const totalQty = students.length;
            const totalCloth = (totalQty * consumption).toFixed(2);

            let y = 15;
            doc.setFontSize(14); doc.text(`Pattern List`, 14, y); y += 8;
            doc.setFontSize(12); doc.text(`Pattern Code: ${code}`, 14, y); y += 6;
            doc.setFontSize(10);
            doc.text(`School: ${schoolName}`, 14, y); y += 6;
            if (desc) { doc.text(`Desc: ${desc}`, 14, y); y += 6; }
            if (cloth) { doc.text(`Cloth: ${cloth}`, 14, y); y += 6; }

            if (specs.length > 0) {
                doc.text(`Specs: ${specs.join(', ')}`, 14, y); y += 6;
            }
            // Add Timestamp
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, y); y += 8;

            doc.setFont(undefined, 'bold');
            doc.text(`Total Qty: ${totalQty} Students | Total Cloth: ${totalCloth} M`, 14, y); y += 10;
            doc.setFont(undefined, 'normal');

            // --- TABLE GENERATION (Full Matrix) ---
            const measureCols = ['U1', 'U2', 'U3', 'U4', 'U5', 'U6', 'U7', 'U8', 'L1', 'L2', 'L3', 'L4', 'L5', 'L6', 'L7', 'L8'];
            const activeItemName = filters.item;
            const itemHeaders = activeItemName ? [activeItemName, "Qty"] : [];

            // Helper: Calculate Item Value (e.g. "16,22,00,00...")
            function calculateItemValue(r, item) {
                const m = getMeasurementsSafe(r);
                if (!item || !item.cols) return "";
                return item.cols.map(c => {
                    const k = c.toLowerCase();
                    let val = m[k] || m[c] || "00";
                    if (!val || val === '-') val = "00";
                    return val;
                }).join(',');
            }

            const body = students.map((s, i) => {
                const m = getMeasurementsSafe(s);

                const base = [
                    i + 1, // S.No instead of Roll as primary index? No, let's follow local: Roll, Name
                    s.roll_no || '-',
                    s.name,
                    s.admission_no || '-',
                    s.house || '-',
                    s.class || '-',
                    s.section || '-',
                    // Spread all measurements
                    ...measureCols.map(c => m[c.toLowerCase()] || '00')
                ];

                if (activeItemName) {
                    const item = ALL_PATTERN_ITEMS.find(i => i.name === activeItemName);
                    if (item) {
                        base.push(calculateItemValue(s, item));
                        // Qty Logic: Check if explicit Qty exists, else 1
                        // In company DB `s` might not have `Qty_ItemName` usually. 
                        // But `getItemQuantitiesSafe` suggests we might have it or default to 1?
                        // Let's assume 1 per student for standard lists unless parsed from imports.
                        base.push("1");
                    }
                }
                return base;
            });

            // Headers
            const headRow = [['S.No', 'Roll', 'Name', 'Adm No', 'House', 'Class', 'Sec', ...measureCols, ...itemHeaders]];

            doc.autoTable({
                head: headRow,
                body: body,
                startY: y,
                theme: 'grid',
                headStyles: {
                    fillColor: [22, 160, 133],
                    fontSize: 7,
                    cellPadding: 1
                },
                styles: {
                    fontSize: 6,
                    cellPadding: 1,
                    overflow: 'linebreak'
                },
                columnStyles: {
                    2: { cellWidth: 25 }, // Name
                    // Squeeze measurement cols
                }
            });

            doc.save(`${patternName}_Detailed_Report.pdf`);
        }

    </script>
    <!-- LOGGING SCRIPTS -->
    <script src="js/logger.js"></script>
    <script src="js/company_logging.js"></script>

    <!-- REPLY MODAL -->
    <div id="reply-modal"
        class="fixed inset-0 bg-slate-900/40 backdrop-blur-md hidden z-[9999] flex items-center justify-center p-4 transition-all duration-300">
        <!-- Modal Card -->
        <div
            class="clay-card relative w-full max-w-xl p-0 overflow-hidden shadow-2xl animate-in zoom-in-95 duration-300">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-50 to-white p-8 border-b border-blue-100/50">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-2xl font-black text-gray-800 mb-2 tracking-tight">Reply to School</h3>
                        <div class="flex items-center gap-2 text-sm text-gray-500 font-medium">
                            <span
                                class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">Ticket
                                Response</span>
                            <span id="reply-school-name">Target School</span>
                        </div>
                    </div>
                    <div
                        class="w-12 h-12 rounded-2xl bg-white shadow-sm flex items-center justify-center text-blue-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                        </svg>
                    </div>
                </div>
            </div>
            <!-- Body -->
            <div class="p-8 bg-white/60">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-3 ml-1">Your
                    Message</label>
                <div class="relative">
                    <textarea id="reply-text" rows="5"
                        class="w-full bg-white border-0 rounded-xl shadow-inner text-gray-700 p-4 text-sm font-medium focus:ring-2 focus:ring-blue-400/30 resize-none placeholder-gray-300 outline-none transition-all"
                        placeholder="Type your official response to the school here..."></textarea>
                    <div
                        class="absolute bottom-3 right-3 text-[10px] text-gray-300 font-bold uppercase pointer-events-none">
                        Admin Official</div>
                </div>
                <div
                    class="mt-4 flex items-center gap-2 text-xs text-gray-400 bg-blue-50/50 p-3 rounded-lg border border-blue-50">
                    <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>This response will be visible to the school admin immediately.</span>
                </div>
            </div>
            <!-- Footer -->
            <div class="p-6 bg-gray-50/80 border-t border-white/60 flex justify-end gap-3 backdrop-blur-sm">
                <button onclick="closeReplyModal()"
                    class="px-6 py-3 rounded-xl text-xs font-bold text-gray-500 hover:text-gray-700 hover:bg-white hover:shadow-sm transition-all uppercase tracking-wider">Cancel</button>
                <button onclick="submitReply()"
                    class="px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-xs font-bold shadow-lg shadow-blue-200 uppercase tracking-widest hover:scale-105 transition-all flex items-center gap-2">
                    <span>Send Reply</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- DASHBOARD WIDGETS INIT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Give a small delay to ensure globalSchools might be populated if it's race-conditional, 
            // but fetchProductionPipeline handles its own fetching if needed.
            setTimeout(() => {
                if (typeof fetchProductionPipeline === 'function') fetchProductionPipeline();
                if (typeof fetchRecentIssues === 'function') fetchRecentIssues();
            }, 1000); // 1s delay to be safe with other inits

            // Poll for activity every 30s
            setInterval(() => {
                if (typeof fetchProductionPipeline === 'function') fetchProductionPipeline();
                if (typeof fetchRecentIssues === 'function') fetchRecentIssues();
            }, 30000);
        });
    </script>
</body>

</html>
```